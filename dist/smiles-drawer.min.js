"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function SmilesDrawer(){this.width=800,this.height=500,this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.canvas,this.ctx,this.drawingWidth=0,this.drawingHeight=0,this.offsetX=0,this.offsetY=0,this.colors={C:"#fff",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#141414"},this.colorsLight={C:"#222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#fff"}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),ArrayHelper=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"clone",value:function(e){var i=Array.isArray(e)?[]:{};for(var r in e){var n=e[r];"function"==typeof n.clone?i[r]=n.clone():i[r]="object"===("undefined"==typeof n?"undefined":_typeof(n))?t.clone(n):n}return i}},{key:"print",value:function(t){if(0==t.length)return"";for(var e="(",i=0;i<t.length;i++)e+=t[i].id+", ";return e=e.substring(0,e.length-2),e+")"}},{key:"each",value:function(t,e){for(var i=0;i<t.length;i++)e(t[i])}},{key:"get",value:function(t,e,i){for(var r=0;r<t.length;r++)if(t[r][e]==i)return t[r]}},{key:"contains",value:function(t,e){if(e.property||e.func){if(e.func){for(var i=0;i<t.length;i++)if(e.func(t[i]))return!0}else for(var i=0;i<t.length;i++)if(t[i][e.property]==e.value)return!0}else for(var i=0;i<t.length;i++)if(t[i]==e.value)return!0;return!1}},{key:"intersection",value:function t(e,i){for(var t=new Array,r=0;r<e.length;r++)for(var n=0;n<i.length;n++)e[r]==i[n]&&t.push(e[r]);return t}},{key:"unique",value:function(t){var e={};return t.filter(function(t){return void 0===e[t]&&(e[t]=!0)})}},{key:"count",value:function t(e,i){for(var t=0,r=0;r<e.length;r++)e[r]==i&&t++;return t}},{key:"toggle",value:function(t,e){for(var i=[],r=!1,n=0;n<t.length;n++)t[n]!=e?i.push(t[n]):r=!0;return r||i.push(e),i}},{key:"remove",value:function(t,e){for(var i=[],r=0;r<t.length;r++)t[r]!=e&&i.push(t[r]);return i}},{key:"removeAll",value:function(t,e){return t.filter(function(t){return e.indexOf(t)===-1})}},{key:"merge",value:function(t,e){for(var i=new Array(t.length+e.length),r=0;r<t.length;r++)i[r]=t[r];for(var r=0;r<e.length;r++)i[t.length+r]=e[r];return i}},{key:"containsAll",value:function(t,e){for(var i=0,r=0;r<t.length;r++)for(var n=0;n<e.length;n++)t[r]===e[n]&&i++;return i==e.length}}]),t}(),Atom=function(){function t(e,i){_classCallCheck(this,t),this.element=e,this.ringbonds=new Array,this.rings=new Array,this.bond="-",this.isTerminal=!1,this.isBridge=!1,this.isBridgeNode=!1,this.bridgedRing=null,this.anchoredRings=new Array,this.bracket=null}return _createClass(t,[{key:"addAnchoredRing",value:function(t){ArrayHelper.contains(this.anchoredRings,{value:t.id})||this.anchoredRings.push(t.id)}},{key:"getRingbondCount",value:function(){return this.ringbonds.length}},{key:"canRotate",value:function(){return"-"==this.bond&&0==this.rings.length}},{key:"hasRingbonds",value:function(){return this.ringbonds.length>0}},{key:"getMaxRingbond",value:function(){for(var t=0,e=0;e<this.ringbonds.length;e++)this.ringbonds[e].id>t&&(t=this.ringbonds[e].id);return t}},{key:"hasRing",value:function(t){for(var e=0;e<this.rings;e++)if(t===this.rings[e])return!0;return!1}},{key:"haveCommonRingbond",value:function(t,e){for(var i=0;i<t.ringbonds.length;i++)for(var r=0;r<e.ringbonds.length;r++)if(t.ringbonds[i].id==e.ringbonds[r].id)return!0;return!1}},{key:"maxCommonRingbond",value:function(t,e){for(var i=0,r=0,n=0,s=0;s<t.ringbonds.length;s++){t.ringbonds[s].id>r&&(r=t.ringbonds[s].id);for(var o=0;o<e.ringbonds.length;o++)e.ringbonds[o].id>n&&(n=e.ringbonds[o].id),r==n&&(i=r)}return i}}]),t}();SmilesDrawer.prototype.draw=function(t,e,i,r){if(this.data=t,this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.vertices=[],this.edges=[],this.rings=[],this.ringConnections=[],this.backupVertices=[],this.backupRings=[],r&&(this.colors=this.colorsLight),this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight),this.createVertices(t,null),this.discoverRings(),!i){this.position();for(var n=this.getOverlapScore(),s=0;n.total>this.settings.bondLength/2&&s<10;){this.clearPositions(),this.position();var o=this.getOverlapScore();o.total<n.total?n=o:this.restorePositions(),s++}this.resolveSecondaryOverlaps(n.scores);for(var a={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},h={x:Number.MAX_VALUE,y:Number.MAX_VALUE},l=0;l<this.vertices.length;l++){var u=this.vertices[l].position;a.x<u.x&&(a.x=u.x),a.y<u.y&&(a.y=u.y),h.x>u.x&&(h.x=u.x),h.y>u.y&&(h.y=u.y)}var c=20;a.x+=c,a.y+=c,h.x-=c,h.y-=c,this.drawingWidth=a.x-h.x,this.drawingHeight=a.y-h.y;var g=this.canvas.offsetWidth/this.drawingWidth,v=this.canvas.offsetHeight/this.drawingHeight,d=g<v?g:v;this.ctx.scale(d,d),this.offsetX=-h.x,this.offsetY=-h.y,g<v?this.offsetY+=this.canvas.offsetHeight/(2*d)-this.drawingHeight/2:this.offsetX+=this.canvas.offsetWidth/(2*d)-this.drawingWidth/2,this.drawEdges(),this.drawVertices(this.settings.debug),this.ctx.setTransform(1,0,0,1,0,0)}},SmilesDrawer.prototype.settings={shortBondLength:20,bondLength:25,bondSpacing:4,defaultDir:-1,debug:!1},SmilesDrawer.prototype.edgeRingCount=function(t){var e=this.edges[t],i=this.vertices[e.source],r=this.vertices[e.target];return Math.min(i.value.rings.length,r.value.rings.length)},SmilesDrawer.prototype.getBridgedRings=function(){for(var t=[],e=0;e<this.rings.length;e++)this.rings[e].isBridged&&t.push(this.rings[e]);return t},SmilesDrawer.prototype.getFusedRings=function(){for(var t=[],e=0;e<this.rings.length;e++)this.rings[e].isFused&&t.push(this.rings[e]);return t},SmilesDrawer.prototype.getSpiros=function(){for(var t=[],e=0;e<this.rings.length;e++)this.rings[e].isSpiro&&t.push(this.rings[e]);return SmilesDrawer.prototype.ringIdCounter=0,t},SmilesDrawer.prototype.printRingInfo=function(t){for(var e="",i=0;i<this.rings.length;i++){var r=this.rings[i];e+=t?t+";":"",e+=r.members.length+";",e+=r.neighbours.length+";",e+=r.isSpiro?"true;":"false;",e+=r.isFused?"true;":"false;",e+=r.isBridged?"true;":"false;",e+=r.rings.length+";",e+=r.insiders.length+";",e+="\n"}return e},SmilesDrawer.prototype.createVertices=function(t,e,i){var r=new Atom(t.atom.element?t.atom.element:t.atom);r.bond=t.bond,r.branchBond=t.branchBond,r.ringbonds=t.ringbonds,r.bracket=t.atom.element?t.atom:null;var n=new Vertex(r),s=this.vertices[e];if(n.parent=e,this.addVertex(n),null!=e){this.vertices[e].children.push(n.id),this.vertices[e].spanningTreeChildren.push(n.id);var o=new Edge(e,n.id,1);i?o.bond=n.value.branchBond:o.bond=this.vertices[e].value.bond;var a=this.addEdge(o);n.edges.push(a),s.edges.push(a)}for(var h=0;h<t.branchCount;h++)this.createVertices(t.branches[h],n.id,!0);t.hasNext&&this.createVertices(t.next,n.id)},SmilesDrawer.prototype.matchRingBonds=function(t,e){if(t.value.getRingbondCount()<1||e.value.getRingbondCount()<1)return null;for(var i=0;i<t.value.ringbonds.length;i++)for(var r=0;r<e.value.ringbonds.length;r++)if(t.value.ringbonds[i].id==e.value.ringbonds[r].id)return"-"==t.value.ringbonds[i].bond?e.value.ringbonds[r].bond:t.value.ringbonds[i].bond;return null},SmilesDrawer.prototype.hasRingWithoutTarget=function(t){for(var e=0;e<this.rings.length;e++){var i=this.rings[e];if(i.ringbond==t&&!i.hasTarget())return!0}return!1},SmilesDrawer.prototype.getRingWithoutTarget=function(t){for(var e=0;e<this.rings.length;e++){var i=this.rings[e];if(i.ringbond==t&&!i.hasTarget())return i}},SmilesDrawer.prototype.discoverRings=function(){for(var t={},e=this,i=this.vertices.length-1;i>=0;i--){var r=this.vertices[i];if(0!==r.value.ringbonds.length)for(var n=0;n<r.value.ringbonds.length;n++){var s=r.value.ringbonds[n].id;if(void 0===t[s])t[s]=r.id;else{var o=t[s],a=r.id,h=e.addEdge(new Edge(a,o,1));e.vertices[a].children.push(o),e.vertices[o].children.push(a),e.vertices[a].edges.push(h),e.vertices[o].edges.push(h);var l=new Ring(s,a,o);e.addRing(l);for(var u=e.annotateRing(l.id,l.source,l.target),c=0;c<u.length;c++)l.members.push(u[c]),e.vertices[u[c]].value.rings.push(l.id);t[s]=void 0}}}for(var i=0;i<this.rings.length-1;i++)for(var c=i+1;c<this.rings.length;c++){for(var g=this.rings[i],v=this.rings[c],d=new RingConnection(g.id,v.id),f=0;f<g.members.length;f++)for(var p=0;p<v.members.length;p++){var y=g.members[f],m=v.members[p];y===m&&d.addVertex(y)}d.vertices.length>0&&this.addRingConnection(d)}for(var i=0;i<this.rings.length;i++){var l=this.rings[i];l.neighbours=RingConnection.getNeighbours(this.ringConnections,l.id)}for(;this.rings.length>0;){for(var b=-1,i=0;i<this.rings.length;i++){var l=this.rings[i];this.isPartOfBridgedRing(l.id)&&(b=l.id)}if(b===-1)break;var l=this.getRing(b),x=this.getBridgedRingRings(l.id);this.createBridgedRing(x,l.source);for(var i=0;i<x.length;i++)this.removeRing(x[i])}},SmilesDrawer.prototype.getBridgedRingRings=function(t){var e=new Array,i=this,r=function t(r){var n=i.getRing(r);e.push(r);for(var s=0;s<n.neighbours.length;s++){var o=n.neighbours[s];e.indexOf(o)===-1&&o!==r&&RingConnection.isBridge(i.ringConnections,i.vertices,r,o)&&t(o)}};return r(t),ArrayHelper.unique(e)},SmilesDrawer.prototype.isPartOfBridgedRing=function(t){for(var e=0;e<this.ringConnections.length;e++)if(this.ringConnections[e].rings.contains(t)&&this.ringConnections[e].isBridge(this.vertices))return!0;return!1},SmilesDrawer.prototype.createBridgedRing=function(t,e){for(var i=new Array,r=new Array,n=new Array,s=(new Array,0);s<t.length;s++){for(var o=this.getRing(t[s]),a=0;a<o.members.length;a++)r.push(o.members[a]);for(var a=0;a<o.neighbours.length;a++)n.push(o.neighbours[a])}r=ArrayHelper.unique(r);for(var h=new Array,s=0;s<r.length;s++){var l=this.vertices[r[s]],u=ArrayHelper.intersection(t,l.value.rings);1==l.value.rings.length||1==u.length?i.push(l.id):h.push(l.id)}for(var c=new Array,g=new Array,s=0;s<h.length;s++){for(var l=this.vertices[h[s]],v=!1,a=0;a<l.edges.length;a++)1==this.edgeRingCount(l.edges[a])&&(v=!0);v?(l.value.isBridgeNode=!0,c.push(l.id)):(l.value.isBridge=!0,g.push(l.id))}var d=ArrayHelper.merge(i,c);n=ArrayHelper.unique(n),n=ArrayHelper.removeAll(n,t);for(var f=this.vertices[e],p=f.getNeighbours(),y=null,s=0;s<p.length;s++){var m=p[s];d.indexOf(m)!==-1&&(y=m)}var o=new Ring(-1,e,y);o.isBridged=!0,o.members=d,o.neighbours=n,o.insiders=g;for(var s=0;s<t.length;s++)o.rings.push(this.getRing(t[s]).clone());this.addRing(o);for(var s=0;s<g.length;s++){var l=this.vertices[g[s]];l.value.rings=new Array,l.value.bridgedRing=o.id}for(var s=0;s<d.length;s++){var l=this.vertices[d[s]];l.value.rings=ArrayHelper.removeAll(l.value.rings,t),l.value.rings.push(o.id)}for(var s=0;s<t.length;s++)for(var a=s+1;a<t.length;a++)this.removeRingConnectionBetween(t[s],t[a]);for(var s=0;s<n.length;s++)for(var b=this.getRingConnections(n[s],t),a=0;a<b.length;a++)this.getRingConnection(b[a]).updateOther(o.id,n[s]);return o},SmilesDrawer.prototype.ringCounter=function(t,e){for(var i=0;i<t.getRingbondCount();i++){var r=t.ringbonds[i].id;this.arrayContains(e,{value:r})||e.push(r)}for(var i=0;i<t.branchCount;i++)this.ringCounter(t.branches[i],e);return t.hasNext&&this.ringCounter(t.next,e),e},SmilesDrawer.prototype.annotateRing=function(t,e,i){for(var r=this.dijkstra(e,i),n=[],s=[],o=i;null!=o;)n.push(o),o=r[o];for(var a=n.length-1;a>=0;a--)s.push(n[a]);return s},SmilesDrawer.prototype.dijkstra=function(t,e){for(var i=new Array(this.vertices.length),r=new Array(this.vertices.length),n=new Array(this.vertices.length),s=new Array(this.vertices.length),o=0;o<this.vertices.length;o++)r[o]=o==t?0:Number.MAX_VALUE,i[o]=null,n[o]=!1,s[o]=this.vertices[o].getNeighbours();for(;ArrayHelper.count(n,!1)>0;){var a=this.getMinDist(r,n);if(a==e)return i;n[a]=!0;for(var o=0;o<s[a].length;o++){var h=s[a][o],l=r[a]+this.getEdgeWeight(a,h);a==t&&h==e||a==e&&h==t||l<r[h]&&(r[h]=l,i[h]=a)}}},SmilesDrawer.prototype.areVerticesInSameRing=function(t,e){for(var i=0;i<t.value.rings.length;i++)for(var r=0;r<e.value.rings.length;r++)if(t.value.rings[i]==e.value.rings[r])return!0;return!1},SmilesDrawer.prototype.getCommonRings=function(t,e){for(var i=[],r=0;r<t.value.rings.length;r++)for(var n=0;n<e.value.rings.length;n++)t.value.rings[r]==e.value.rings[n]&&i.push(t.value.rings[r]);return i},SmilesDrawer.prototype.getSmallestCommonRing=function(t,e){for(var i=this.getCommonRings(t,e),r=Number.MAX_VALUE,n=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).size();o<r&&(r=o,n=this.getRing(i[s]))}return n},SmilesDrawer.prototype.getLargestCommonRing=function(t,e){for(var i=this.getCommonRings(t,e),r=0,n=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).size();o>r&&(r=o,n=this.getRing(i[s]))}return n},SmilesDrawer.prototype.getMinDist=function(t,e){for(var i=Number.MAX_VALUE,r=null,n=0;n<t.length;n++)e[n]||t[n]<i&&(r=n,i=t[r]);return r},SmilesDrawer.prototype.getEdgeWeight=function(t,e){for(var i=0;i<this.edges.length;i++){var r=this.edges[i];if(r.source==t&&r.target==e||r.target==t&&r.source==e)return r.weight}},SmilesDrawer.prototype.addVertex=function(t){var e=this.vertices.length;return t.id=e,this.vertices.push(t),e},SmilesDrawer.prototype.getVerticesAt=function(t,e,i){for(var r=new Array,n=0;n<this.vertices.length;n++){var s=this.vertices[n];if(s.id!==i&&s.positioned){var o=t.distance(s.position);o<=e&&r.push(s.id)}}return r},SmilesDrawer.prototype.getBranch=function(t,e){var i=new Array,r=new Array,n=this,s=function t(e,s){for(var o=n.vertices[e],a=0;a<o.value.rings.length;a++)r.push(o.value.rings[a]);for(var a=0;a<o.children.length;a++){var h=o.children[a];h===s||ArrayHelper.contains(i,{value:h})||(i.push(h),t(h,e))}var l=o.parent;l===s||null===l||ArrayHelper.contains(i,{value:l})||(i.push(l),t(l,e))};return i.push(t),s(t,e),{vertices:i,rings:ArrayHelper.unique(r)}},SmilesDrawer.prototype.addEdge=function(t){var e=this.edges.length;return t.id=e,this.edges.push(t),e},SmilesDrawer.prototype.addRing=function(t){return t.id=this.ringIdCounter++,this.rings.push(t),t.id},SmilesDrawer.prototype.removeRing=function(t){this.rings=this.rings.filter(function(e){return e.id!==t}),this.ringConnections=this.ringConnections.filter(function(e){return e.rings.first!==t&&e.rings.second!==t});for(var e=0;e<this.rings.length;e++){var i=this.rings[e];i.neighbours=i.neighbours.filter(function(e){return e!==t})}},SmilesDrawer.prototype.getRing=function(t){for(var e=0;e<this.rings.length;e++)if(this.rings[e].id==t)return this.rings[e]},SmilesDrawer.prototype.addRingConnection=function(t){return t.id=this.ringConnectionIdCounter++,this.ringConnections.push(t),t.id},SmilesDrawer.prototype.removeRingConnection=function(t){this.ringConnections=this.ringConnections.filter(function(e){return e.id!==t})},SmilesDrawer.prototype.removeRingConnectionBetween=function(t,e){for(var i=new Array,r=0;r<this.ringConnections.length;r++){var n=this.ringConnections[r];(n.rings.first===t&&n.rings.second===e||n.rings.first===e&&n.rings.second===t)&&i.push(n.id)}for(var r=0;r<i.length;r++)this.removeRingConnection(i[r])},SmilesDrawer.prototype.getRingConnection=function(t){for(var e=0;e<this.ringConnections.length;e++)if(this.ringConnections[e].id==t)return this.ringConnections[e]},SmilesDrawer.prototype.getRingConnections=function(t,e){var i=new Array;if(1===arguments.length)for(var r=0;r<this.ringConnections.length;r++){var n=this.ringConnections[r];n.rings.first!==t&&n.rings.second!==t||i.push(n.id)}else if(e.constructor!==Array)for(var r=0;r<this.ringConnections.length;r++){var n=this.ringConnections[r];(n.rings.first===t&&n.rings.second===e||n.rings.first===e&&n.rings.second===t)&&i.push(n.id)}else for(var r=0;r<this.ringConnections.length;r++)for(var s=0;s<e.length;s++){var o=e[s],n=this.ringConnections[r];(n.rings.first===t&&n.rings.second===o||n.rings.first===o&&n.rings.second===t)&&i.push(n.id)}return i},SmilesDrawer.prototype.getOverlapScore=function(){for(var t=0,e=new Float32Array(this.vertices.length),i=0;i<this.vertices.length;i++)e[i]=0;for(var i=0;i<this.vertices.length;i++)for(var r=i+1;r<this.vertices.length;r++){var n=this.vertices[i],s=this.vertices[r],o=Vector2.subtract(n.position,s.position).length();if(o<this.settings.bondLength){var a=this.settings.bondLength-o;t+=a,e[i]+=a,e[r]+=a}}for(var h=[],i=0;i<this.vertices.length;i++)h.push({id:i,score:e[i]});return h.sort(function(t,e){return e.score-t.score}),{total:t,scores:h}},SmilesDrawer.prototype.getColor=function(t){return t in this.colors?this.colors[t]:this.colors.C},SmilesDrawer.prototype.circle=function(t,e,i,r,n,s){isNaN(e)||isNaN(i)||(this.ctx.save(),this.ctx.lineWidth=1.5,this.ctx.beginPath(),this.ctx.arc(e+this.offsetX,i+this.offsetY,t,0,2*Math.PI,!0),this.ctx.closePath(),s?n?(this.ctx.fillStyle="#ff0000",this.ctx.fill()):(this.ctx.strokeStyle="#ff0000",this.ctx.stroke()):n?(this.ctx.fillStyle=this.colors.C,this.ctx.fill()):(this.ctx.strokeStyle=this.colors.C,this.ctx.stroke()),this.ctx.restore())},SmilesDrawer.prototype.line=function(t,e,i,r,n,s,o){if(!(isNaN(t)||isNaN(e)||isNaN(i)||isNaN(r))){var a=new Line(new Vector2(t,e),new Vector2(i,r),n,s),h=a.getLeftVector().clone(),l=a.getRightVector().clone();h.x+=this.offsetX,h.y+=this.offsetY,l.x+=this.offsetX,l.y+=this.offsetY,this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(h.x,h.y),this.ctx.lineTo(l.x,l.y),this.ctx.lineCap="round",this.ctx.lineWidth=1.5;var u=this.ctx.createLinearGradient(h.x,h.y,l.x,l.y);u.addColorStop(.4,this.colors[a.getLeftElement().toUpperCase()]||this.colors.C),u.addColorStop(.6,this.colors[a.getRightElement().toUpperCase()]||this.colors.C),this.ctx.strokeStyle=u,this.ctx.stroke(),this.ctx.restore()}},SmilesDrawer.prototype.debugText=function(t,e,i){this.ctx.save();var r="5px Arial";this.ctx.font=r,this.ctx.textAlign="start",this.ctx.textBaseline="top",this.ctx.fillStyle="#ff0000",this.ctx.fillText(i,t+this.offsetX,e+this.offsetY),this.ctx.restore()},SmilesDrawer.prototype.text=function(t,e,i,r,n,s,o,a,h){if(!isNaN(t)&&!isNaN(e)){this.ctx.save();var l="10px Arial",u="6px Arial";this.ctx.textAlign="start",this.ctx.textBaseline="top";var c=0;if(h){var g="+";2===h&&(g="2+"),h===-1&&(g="-"),h===-2&&(g="2-"),this.ctx.font=u,c=this.ctx.measureText(g).width}this.ctx.font=l,this.ctx.fillStyle=this.colors.BACKGROUND;var v=this.ctx.measureText(i);v.totalWidth=v.width+c,v.height=parseInt(l,10);var d=v.totalWidth>v.height?v.totalWidth:v.height;d/=2,this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(t+this.offsetX,e+this.offsetY+v.height/20,d+1,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalCompositeOperation="source-over",e-=2,this.ctx.fillStyle=this.getColor(i.toUpperCase()),this.ctx.fillText(i,t-v.totalWidth/2+this.offsetX,e-v.height/2+this.offsetY),h&&(this.ctx.font=u,this.ctx.fillText(g,t-v.totalWidth/2+v.width+this.offsetX,e-v.height/2+this.offsetY)),this.ctx.font=l;var f=this.ctx.measureText("H");if(f.height=parseInt(l,10),1===s){var p=t-v.totalWidth/2+this.offsetX,y=e-v.height/2+this.offsetY;"left"===o&&(p-=v.totalWidth),"right"===o&&(p+=v.totalWidth),"up"===o&&a&&(p+=v.totalWidth),"down"===o&&a&&(p+=v.totalWidth),"up"!==o||a||(y-=v.height),"down"!==o||a||(y+=v.height),this.ctx.fillText("H",p,y)}else if(s>1){var p=t-v.totalWidth/2+this.offsetX,y=e-v.height/2+this.offsetY;this.ctx.font=u;var m=this.ctx.measureText(s);m.height=parseInt(u,10),"left"===o&&(p-=f.width+m.width),"right"===o&&(p+=v.totalWidth),"up"===o&&a&&(p+=v.totalWidth),"down"===o&&a&&(p+=v.totalWidth),"up"!==o||a||(y-=v.height),"down"!==o||a||(y+=v.height),this.ctx.font=l,this.ctx.fillText("H",p,y),this.ctx.font=u,this.ctx.fillText(s,p+f.width,y+f.height/2)}this.ctx.restore()}},SmilesDrawer.prototype.drawPoint=function(t,e){this.circle(2,t.x,t.y,"helper",!0,!0),e&&this.debugText(t.x,t.y,e,"id",!0)},SmilesDrawer.prototype.chooseSide=function(t,e,i){for(var r=t.getNeighbours(e.id),n=e.getNeighbours(t.id),s=r.length,o=n.length,a=ArrayHelper.merge(r,n),h=[0,0],l=0;l<a.length;l++){var u=this.vertices[a[l]].position;u.sameSideAs(t.position,e.position,i[0])?h[0]++:h[1]++}for(var c=[0,0],l=0;l<this.vertices.length;l++){var u=this.vertices[l].position;u.sameSideAs(t.position,e.position,i[0])?c[0]++:c[1]++}return{totalSideCount:c,totalPosition:c[0]>c[1]?0:1,sideCount:h,position:h[0]>h[1]?0:1,anCount:s,bnCount:o}},SmilesDrawer.prototype.connected=function(t,e){for(var i=0;i<this.edges.length;i++){var r=this.edges[i];if(r.source===t&&r.target===e||r.source===e&&r.target===t)return!0}return!1},SmilesDrawer.prototype.forceLayout=function(t,e,i,r){var n=this.settings.bondLength,s=6e3,o=5,a=.5;r.rings.length>2&&(s=1e3,o=1.5,a=0),this.vertices[i].positioned=!1;for(var h=0;h<t.length;h++){var l=this.vertices[t[h]];l.positioned||(l.position.x=e.x+Math.random(),l.position.y=e.y+Math.random())}for(var u={},h=0;h<t.length;h++)u[t[h]]=new Vector2;for(var c=0;c<1e3;c++){for(var h=0;h<t.length;h++)u[t[h]].set(0,0);for(var g=0;g<t.length-1;g++)for(var v=this.vertices[t[g]],d=g+1;d<t.length;d++){var f=this.vertices[t[d]],p=f.position.x-v.position.x,y=f.position.y-v.position.y;if(0!==p&&0!==y){var m=p*p+y*y,b=Math.sqrt(m),x=s/m,A=x*p/b,C=x*y/b;v.positioned||(u[v.id].x-=A,u[v.id].y-=C),f.positioned||(u[f.id].x+=A,u[f.id].y+=C)}}if(r.rings.length>2)for(var w=new Array(r.rings.length),h=0;h<r.rings.length;h++){w[h]=new Vector2;for(var R=0;R<r.rings[h].members.length;R++)w[h].x+=this.vertices[r.rings[h].members[R]].position.x,w[h].y+=this.vertices[r.rings[h].members[R]].position.y;w[h].x/=r.rings[h].members.length,w[h].y/=r.rings[h].members.length;for(var g=0;g<r.rings[h].members.length;g++){var v=this.vertices[r.rings[h].members[g]],p=w[h].x-v.position.x,y=w[h].y-v.position.y;if(0!==p&&0!==y){var m=p*p+y*y,b=Math.sqrt(m),x=s/m;5!==r.rings[h].members.length&&6!==r.rings[h].members.length||(x*=10);var A=x*p/b,C=x*y/b;v.positioned||(u[v.id].x-=A,u[v.id].y-=C)}}}for(var g=0;g<t.length-1;g++)for(var v=this.vertices[t[g]],d=g+1;d<t.length;d++){var f=this.vertices[t[d]];if(v.isNeighbour(f.id)){var p=f.position.x-v.position.x,y=f.position.y-v.position.y;if(0!==p&&0!==y){var b=Math.sqrt(p*p+y*y),x=o*(b-n);b<n&&(x*=.5),b>n&&(x*=2);var A=x*p/b,C=x*y/b;v.positioned||(u[v.id].x+=A,u[v.id].y+=C),f.positioned||(u[f.id].x-=A,u[f.id].y-=C)}}}for(var g=0;g<t.length;g++){var l=this.vertices[t[g]],p=e.x-l.position.x,y=e.y-l.position.y;if(0!==p&&0!==y){var b=Math.sqrt(p*p+y*y),x=a*(1/b),A=x*p/b,C=x*y/b;v.positioned||(u[l.id].x+=A,u[l.id].y+=C)}}for(var g=0;g<t.length;g++){var l=this.vertices[t[g]];if(!l.positioned){var p=.1*u[l.id].x,y=.1*u[l.id].y,m=p*p+y*y;if(m>500){var k=Math.sqrt(500/m);p*=k,y*=k}l.position.x+=p,l.position.y+=y}}}for(var g=0;g<t.length;g++)this.vertices[t[g]].positioned=!0;for(var g=0;g<t.length;g++)for(var l=this.vertices[t[g]],S=l.getNeighbours(),h=0;h<S.length;h++)l.value.isBridge?this.createBonds(this.vertices[S[h]],l,MathHelper.toRad(60)):0===this.vertices[S[h]].value.rings.length&&this.createBonds(this.vertices[S[h]],l,e)},SmilesDrawer.prototype.drawEdges=function(t){for(var e=this,i=0;i<this.edges.length;i++){var r=this.edges[i],n=this.vertices[r.source],s=this.vertices[r.target],o=n.value.element,a=s.value.element,h=n.position,l=s.position,u=this.getEdgeNormals(r),c=("gradient"+n.value.element.toUpperCase()+s.value.element.toUpperCase(),ArrayHelper.clone(u));if(ArrayHelper.each(c,function(t){t.multiply(10),t.add(h)}),"="==r.bond||"="==this.matchRingBonds(n,s)){var g=this.areVerticesInSameRing(n,s),v=this.chooseSide(n,s,c);if(g){var d=this.getLargestCommonRing(n,s),f=d.center;ArrayHelper.each(u,function(t){t.multiply(e.settings.bondSpacing)});var p=null;p=f.sameSideAs(n.position,s.position,Vector2.add(h,u[0]))?new Line(Vector2.add(h,u[0]),Vector2.add(l,u[0])):new Line(Vector2.add(h,u[1]),Vector2.add(l,u[1])),p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.a.x,p.a.y,p.b.x,p.b.y,o,a),this.line(h.x,h.y,l.x,l.y,o,a)}else if(0==v.anCount&&v.bnCount>1||0==v.bnCount&&v.anCount>1){ArrayHelper.each(u,function(t){t.multiply(e.settings.bondSpacing/2)});var y=new Line(Vector2.add(h,u[0]),Vector2.add(l,u[0])),m=new Line(Vector2.add(h,u[1]),Vector2.add(l,u[1]));this.line(y.a.x,y.a.y,y.b.x,y.b.y,o,a),this.line(m.a.x,m.a.y,m.b.x,m.b.y,o,a)}else if(v.sideCount[0]>v.sideCount[1]){ArrayHelper.each(u,function(t){t.multiply(e.settings.bondSpacing)});var p=new Line(Vector2.add(h,u[0]),Vector2.add(l,u[0]));p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.a.x,p.a.y,p.b.x,p.b.y,o,a),this.line(h.x,h.y,l.x,l.y,o,a)}else if(v.sideCount[0]<v.sideCount[1]){ArrayHelper.each(u,function(t){t.multiply(e.settings.bondSpacing)});var p=new Line(Vector2.add(h,u[1]),Vector2.add(l,u[1]));p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.a.x,p.a.y,p.b.x,p.b.y,o,a),this.line(h.x,h.y,l.x,l.y,o,a)}else if(v.totalSideCount[0]>v.totalSideCount[1]){ArrayHelper.each(u,function(t){t.multiply(e.settings.bondSpacing)});var p=new Line(Vector2.add(h,u[0]),Vector2.add(l,u[0]));p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.a.x,p.a.y,p.b.x,p.b.y,o,a),this.line(h.x,h.y,l.x,l.y,o,a)}else if(v.totalSideCount[0]<=v.totalSideCount[1]){ArrayHelper.each(u,function(t){t.multiply(e.settings.bondSpacing)});var p=new Line(Vector2.add(h,u[1]),Vector2.add(l,u[1]));p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.a.x,p.a.y,p.b.x,p.b.y,o,a),this.line(h.x,h.y,l.x,l.y,o,a)}}else if("#"===r.bond){ArrayHelper.each(u,function(t){t.multiply(e.settings.bondSpacing/1.5)});var b=new Line(Vector2.add(h,u[0]),Vector2.add(l,u[0])),x=new Line(Vector2.add(h,u[1]),Vector2.add(l,u[1]));b.shorten(this.settings.bondLength-this.settings.shortBondLength),x.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(b.a.x,b.a.y,b.b.x,b.b.y,o,a),this.line(x.a.x,x.a.y,x.b.x,x.b.y,o,a),this.line(h.x,h.y,l.x,l.y,o,a)}else this.line(h.x,h.y,l.x,l.y,o,a);if(t){var A=Vector2.midpoint(h,l);this.debugText(A.x,A.y,"id: "+i)}}},SmilesDrawer.maxBonds={c:4,C:4,n:3,N:3,o:2,O:2},SmilesDrawer.prototype.drawVertices=function(t){for(var e=0;e<this.vertices.length;e++){var i=this.vertices[e],r=i.value,n=this.getBondCount(i),s=1==r.element.length?r.element.toUpperCase():r.element;if(t){var o=i.id+" "+ArrayHelper.print(r.ringbonds);this.debugText(i.position.x,i.position.y,"id: "+o)}var a=SmilesDrawer.maxBonds[s]-n;r.bracket&&(a=r.bracket.hcount);var h=0;if(r.bracket&&(h=r.bracket.charge),i.isTerminal()){var l=i.getTextDirection(this.vertices);this.text(i.position.x,i.position.y,s,"element "+r.element.toLowerCase(),!0,a,l,!0,h)}else if("c"!==r.element.toLowerCase()){var l=i.getTextDirection(this.vertices);this.text(i.position.x,i.position.y,s,"element "+r.element.toLowerCase(),!0,a,l,!1,h)}}if(this.settings.debug)for(var e=0;e<this.rings.length;e++)this.drawPoint(this.rings[e].center,"id: "+this.rings[e].id);for(var e=0;e<this.rings.length;e++){var u=this.rings[e];u.isBenzene(this.vertices)&&(this.ctx.save(),this.ctx.strokeStyle=this.colors.C,this.ctx.lineWidth=1.5,this.ctx.beginPath(),this.ctx.arc(u.center.x+this.offsetX,u.center.y+this.offsetY,u.radius-10,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore())}},SmilesDrawer.prototype.position=function(){for(var t=0,e=0;e<this.rings.length;e++)this.rings[e].isBridged&&(t=this.rings[e].members[e]);this.createBonds(this.vertices[t]),this.resolvePrimaryOverlaps()},SmilesDrawer.prototype.clearPositions=function(){this.backupVertices=[],this.backupRings=[];for(var t=0;t<this.vertices.length;t++){var e=this.vertices[t];this.backupVertices.push(e.clone()),e.positioned=!1,e.position=new Vector2}for(var t=0;t<this.rings.length;t++){var i=this.rings[t];this.backupRings.push(i.clone()),i.positioned=!1,i.center=new Vector2}},SmilesDrawer.prototype.restorePositions=function(){for(var t=0;t<this.backupVertices.length;t++)this.vertices[t]=this.backupVertices[t];for(var t=0;t<this.backupRings.length;t++)this.rings[t]=this.backupRings[t]},SmilesDrawer.prototype.createRing=function(t,e,i,r){if(!t.positioned){var n=t.getOrderedNeighbours(this.ringConnections);e=e?e:new Vector2(0,0);var s=i?Vector2.subtract(i.position,e).angle():0,o=this,a=MathHelper.polyCircumradius(o.settings.bondLength,t.size());t.radius=a;var h=MathHelper.centralAngle(t.size());t.centralAngle=h;var l=s;if(t.eachMember(this.vertices,function(i){var r=o.vertices[i];r.positioned||(r.position.x=e.x+Math.cos(l)*a,r.position.y=e.y+Math.sin(l)*a),l+=h,(!t.isBridged||t.rings.length<3)&&(r.positioned=!0)},i?i.id:null,r?r.id:null),t.isBridged){var u=ArrayHelper.merge(t.members,t.insiders);this.forceLayout(u,e,i.id,t)}this.vertices[t.members[0]].value.addAnchoredRing(t),t.positioned=!0,t.center=e;for(var c=0;c<n.length;c++){var g=this.getRing(n[c].neighbour);if(!g.positioned){var v=RingConnection.getVertices(this.ringConnections,t.id,g.id);if(2==v.length){t.isFused=!0,g.isFused=!0;var d=this.vertices[v[0]],f=this.vertices[v[1]],p=Vector2.midpoint(d.position,f.position),y=Vector2.normals(d.position,f.position);ArrayHelper.each(y,function(t){t.normalize()});var m=MathHelper.polyCircumradius(o.settings.bondLength,g.size()),b=MathHelper.apothem(m,g.size());ArrayHelper.each(y,function(t){t.multiply(b)}),ArrayHelper.each(y,function(t){t.add(p)});var x=y[0];this.isPointInRing(x)&&(x=y[1]);var A=Vector2.subtract(d.position,x),C=Vector2.subtract(f.position,x);A.clockwise(C)===-1?this.createRing(g,x,d,f):this.createRing(g,x,f,d)}else if(1==v.length){t.isSpiro=!0,g.isSpiro=!0;var d=this.vertices[v[0]],x=Vector2.subtract(e,d.position);x.invert(),x.normalize();var m=MathHelper.polyCircumradius(o.settings.bondLength,g.size());x.multiply(m),x.add(d.position),this.createRing(g,x,d)}}}for(var c=0;c<t.members.length;c++)for(var w=this.vertices[t.members[c]],R=w.getNeighbours(),k=0;k<R.length;k++)if(!t.thisOrNeighboursContain(this.rings,R[k])){var S=this.vertices[R[k]];this.createBonds(S,w,t.center)}}},SmilesDrawer.prototype.rotateSubtree=function(t,e,i,r){var n=this;this.traverseTree(e,t,function(t){t.position.rotateAround(i,r);for(var e=0;e<t.value.anchoredRings.length;e++)n.rings[t.value.anchoredRings[e]].center.rotateAround(i,r)})},SmilesDrawer.prototype.resolvePrimaryOverlaps=function(){for(var t=[],e=[],i=new Array(this.vertices.length),r=0;r<this.rings.length;r++)for(var n=this.rings[r],s=0;s<n.members.length;s++){var o=this.vertices[n.members[s]];if(!i[o.id]){if(i[o.id]=!0,o.getNeighbours().length>2){for(var a=[],h=0;h<o.value.rings.length;h++)a.push(o.value.rings[h]);t.push({common:o,rings:a,vertices:this.getNonRingNeighbours(o.id)})}if(2==o.value.rings.length&&4==o.getNeighbours().length){var l=this.getNonRingNeighbours(o.id)[0];if(l&&l.getNeighbours().length>1){var u=this.getCommonRingbondNeighbour(o);e.push({common:o,other:u,vertex:l})}}}}for(var r=0;r<e.length;r++){var c=e[r],g=-c.vertex.position.getRotateToAngle(c.other.position,c.common.position);this.rotateSubtree(c.vertex.id,c.common.id,g+Math.PI,c.common.position)}for(var r=0;r<t.length;r++){var v=t[r];if(1==v.vertices.length){var d=v.vertices[0];if(1==d.getNeighbours().length){d.flippable=!0,d.flipCenter=v.common.id;for(var s=0;s<v.rings.length;s++)d.flipRings.push(v.rings[s])}}else if(2==v.vertices.length){var g=(2*Math.PI-this.getRing(v.rings[0]).getAngle())/6,d=v.vertices[0],f=v.vertices[1];if(d.backAngle-=g,f.backAngle+=g,this.rotateSubtree(d.id,v.common.id,g,v.common.position),this.rotateSubtree(f.id,v.common.id,-g,v.common.position),1==d.getNeighbours().length){
d.flippable=!0,d.flipCenter=v.common.id,d.flipNeighbour=f.id;for(var s=0;s<v.rings.length;s++)d.flipRings.push(v.rings[s])}if(1==f.getNeighbours().length){f.flippable=!0,f.flipCenter=v.common.id,f.flipNeighbour=d.id;for(var s=0;s<v.rings.length;s++)f.flipRings.push(v.rings[s])}}}},SmilesDrawer.prototype.resolveSecondaryOverlaps=function(t){for(var e=0;e<t.length;e++)if(t[e].score>this.settings.bondLength/5){var i=this.vertices[t[e].id];if(i.flippable){var r=i.flipRings[0]?this.rings[i.flipRings[0]]:null,n=i.flipRings[1]?this.rings[i.flipRings[1]]:null,s=this.vertices[i.flipCenter].position;if(r&&n){var o=r.members.length>n.members.length?r:n;n=r.members.length<n.members.length?r:n,r=o}r&&r.allowsFlip()?(i.position.rotateTo(r.center,s),r.flipped(),null!==i.flipNeighbour):n&&n.allowsFlip()&&(i.position.rotateTo(n.center,s),n.flipped(),null!==i.flipNeighbour)}}},SmilesDrawer.prototype.createBonds=function(t,e,i,r){if(!t.positioned){if(e)if(0!=e.value.rings.length||t.value.isBridge){if(e.value.isBridgeNode&&t.value.isBridge){var n=(this.getTargets(t.id,e.id,t.value.bridgedRing),Vector2.subtract(i,e.position));n.normalize(),n.multiply(this.settings.bondLength),t.position.add(e.position),t.position.add(n),t.previousPosition=e.position,t.positioned=!0}else if(t.value.isBridge){var s=(this.getTargets(t.id,e.id,t.value.bridgedRing),new Vector2(this.settings.bondLength,0));s.rotate(i),s.add(e.position),t.position=s,t.previousPosition=e.position,t.positioned=!0}else if(1==e.value.rings.length){var n=Vector2.subtract(i,e.position);n.invert(),n.normalize(),n.multiply(this.settings.bondLength),t.position.add(e.position),t.position.add(n),t.previousPosition=e.position,t.positioned=!0}else if(2==e.value.rings.length){var o=this.getRing(e.value.rings[0]),a=this.getRing(e.value.rings[1]),h=Vector2.subtract(a.center,o.center),l=Vector2.subtract(e.position,o.center),u=Vector2.scalarProjection(l,h);h.normalize(),h.multiply(u),h.add(o.center);var n=Vector2.subtract(h,e.position);n.invert(),n.normalize(),n.multiply(this.settings.bondLength),t.position.add(e.position),t.position.add(n),t.previousPosition=e.position,t.positioned=!0}}else{var s=new Vector2(this.settings.bondLength,0);s.rotate(i),s.add(e.position),t.position=s,t.previousPosition=e.position,t.positioned=!0}else{var c=new Vector2(this.settings.bondLength,0);c.rotate(MathHelper.toRad(-120)),t.previousPosition=c,t.position=new Vector2(this.settings.bondLength,0),t.angle=MathHelper.toRad(-120),t.positioned=!0}if(Ring.contains(this.rings,t.id)){var g=this.getRing(t.value.rings[0]),v=Vector2.subtract(t.previousPosition,t.position);v.invert(),v.normalize();var d=MathHelper.polyCircumradius(this.settings.bondLength,g.size());v.multiply(d),v.add(t.position),this.createRing(g,v,t)}else{var f=t.getNeighbours();e&&(f=ArrayHelper.remove(f,e.id));var p=t.getAngle();if(1==f.length){var y=this.vertices[f[0]];if("#"===t.value.bond||e&&"#"===e.value.bond)y.angle=p,this.createBonds(y,t,y.angle,-r);else{var m=Math.random()<.5?-1:1;r||(r=m),y.angle=MathHelper.toRad(60)*r,this.createBonds(y,t,p+y.angle,-r)}}else if(2==f.length){var b=this.getTreeDepth(t.id,f[0]),x=this.getTreeDepth(t.id,f[1]),A=0,C=1;if(b>x&&(A=1,C=0),1===t.position.clockwise(t.previousPosition)){var w=this.vertices[f[A]],R=this.vertices[f[C]];R.angle=MathHelper.toRad(60),w.angle=-MathHelper.toRad(60),this.createBonds(R,t,p+R.angle),this.createBonds(w,t,p+w.angle)}else{var w=this.vertices[f[A]],R=this.vertices[f[C]];R.angle=-MathHelper.toRad(60),w.angle=MathHelper.toRad(60),this.createBonds(w,t,p+w.angle),this.createBonds(R,t,p+R.angle)}}else if(3==f.length){var k=this.getTreeDepth(t.id,f[0]),S=this.getTreeDepth(t.id,f[1]),V=this.getTreeDepth(t.id,f[2]),u=this.vertices[f[0]],B=this.vertices[f[1]],d=this.vertices[f[2]];S>k&&S>V?(u=this.vertices[f[1]],B=this.vertices[f[0]],d=this.vertices[f[2]]):V>k&&V>S&&(u=this.vertices[f[2]],B=this.vertices[f[0]],d=this.vertices[f[1]]),this.createBonds(u,t,p),this.createBonds(B,t,p+MathHelper.toRad(90)),this.createBonds(d,t,p-MathHelper.toRad(90))}else if(4==f.length){var k=this.getTreeDepth(t.id,f[0]),S=this.getTreeDepth(t.id,f[1]),V=this.getTreeDepth(t.id,f[2]),D=this.getTreeDepth(t.id,f[3]),N=this.vertices[f[0]],H=this.vertices[f[1]],M=this.vertices[f[2]],L=this.vertices[f[3]];S>k&&S>V&&S>D?(N=this.vertices[f[1]],H=this.vertices[f[0]],M=this.vertices[f[2]],L=this.vertices[f[3]]):V>k&&V>S&&V>D?(N=this.vertices[f[2]],H=this.vertices[f[0]],M=this.vertices[f[1]],L=this.vertices[f[3]]):D>k&&D>S&&D>V&&(N=this.vertices[f[3]],H=this.vertices[f[0]],M=this.vertices[f[1]],L=this.vertices[f[2]]),this.createBonds(N,t,p-MathHelper.toRad(36)),this.createBonds(H,t,p+MathHelper.toRad(36)),this.createBonds(M,t,p-MathHelper.toRad(108)),this.createBonds(L,t,p+MathHelper.toRad(108))}}}},SmilesDrawer.prototype.getTargets=function(t,e,i){var r=this,n=new Array,s=function t(e,s){for(var o=r.vertices[e].getNeighbours(),a=0;a<o.length;a++){var h=r.vertices[o[a]];h.id!==s&&(h.value.isBridge?t(h.id,e):h.value.hasRing(i)&&n.push(h.id))}};return s(t,e),n},SmilesDrawer.prototype.getCommonRingbondNeighbour=function(t){for(var e=t.getNeighbours(),i=0;i<e.length;i++){var r=this.vertices[e[i]];if(ArrayHelper.containsAll(r.value.rings,t.value.rings))return r}},SmilesDrawer.prototype.isPointInRing=function(t){for(var e=0;e<this.rings.length;e++){var i=this.rings[e].getPolygon(this.vertices);if(t.isInPolygon(i))return!0}return!1},SmilesDrawer.prototype.isEdgeInRing=function(t){var e=this.vertices[t.source],i=this.vertices[t.target];return this.areVerticesInSameRing(e,i)},SmilesDrawer.prototype.isRingAromatic=function(t){for(var e=0;e<t.members.length;e++)if(!this.isVertexInAromaticRing(t.members[e]))return!1;return!0},SmilesDrawer.prototype.isEdgeInAromaticRing=function(t){return this.isVertexInAromaticRing(t.source)&&this.isVertexInAromaticRing(t.target)},SmilesDrawer.prototype.isVertexInAromaticRing=function(t){var e=this.vertices[t].value.element;return e==e.toLowerCase()},SmilesDrawer.prototype.getEdgeNormals=function(t){var e=this.vertices[t.source].position,i=this.vertices[t.target].position,r=Vector2.normals(e,i);return ArrayHelper.each(r,function(t){t.normalize()}),r},SmilesDrawer.prototype.getNormals=function(t,e){var t=t.position,e=e.position,i=Vector2.normals(t,e);return ArrayHelper.each(i,function(t){t.normalize()}),i},SmilesDrawer.prototype.getTreeDepth=function(t,e){for(var i=this.vertices[e].getSpanningTreeNeighbours(t),r=0,n=0;n<i.length;n++){var s=i[n],o=this.getTreeDepth(e,s);o>r&&(r=o)}return r+1},SmilesDrawer.prototype.traverseTree=function(t,e,i){var r=this.vertices[e],n=r.getSpanningTreeNeighbours(t);i(r);for(var s=0;s<n.length;s++)this.traverseTree(e,n[s],i)},SmilesDrawer.prototype.getMaxDepth=function(t,e,i){i=i?i:0;for(var r=t.getNeighbours(),n=0,s=0;s<r.length;s++)if(r[s]!=e.id){var o=this.vertices[r[s]],a=0;a=o.value.getRingbondCount()>0?100:this.getMaxDepth(this.vertices[r[s]],t,i+1),a>n&&(n=a)}return n},SmilesDrawer.prototype.getBondCount=function(t){for(var e=0,i=0;i<t.edges.length;i++)e+=this.edges[t.edges[i]].getBondCount();return e},SmilesDrawer.prototype.getNonRingNeighbours=function(t){for(var e=[],i=this.vertices[t],r=i.getNeighbours(),n=0;n<r.length;n++){var s=this.vertices[r[n]];0==ArrayHelper.intersection(i.value.rings,s.value.rings).length&&0==s.value.isBridge&&e.push(s)}return e};var Edge=function(){function t(e,i,r){_classCallCheck(this,t),this.id=null,this.source=e,this.target=i,this.weight=r,this.bond="-",this.isInAromaticRing=!1}return _createClass(t,[{key:"getBondCount",value:function(){return t.bonds[this.bond]}}],[{key:"bonds",get:function(){return{"-":1,"/":1,"\\":1,"=":2,"#":3,$:4}}}]),t}(),Line=function(){function t(e,i,r,n){_classCallCheck(this,t),this.a=e?e:new Vector2(0,0),this.b=i?i:new Vector2(0,0),this.elementA=r,this.elementB=n}return _createClass(t,[{key:"clone",value:function(){return new t(this.a.clone(),this.b.clone(),this.elementA,this.elementB)}},{key:"getLength",value:function(){return Math.sqrt(Math.pow(this.b.x-this.a.x,2)+Math.pow(this.b.y-this.a.y,2))}},{key:"getAngle",value:function(){var t=Vector2.subtract(this.getRightVector(),this.getLeftVector());return t.angle()}},{key:"getRightVector",value:function(){return this.a.x<this.b.x?this.b:this.a}},{key:"getLeftVector",value:function(){return this.a.x<this.b.x?this.a:this.b}},{key:"getRightElement",value:function(){return this.a.x<this.b.x?this.elementB:this.elementA}},{key:"getLeftElement",value:function(){return this.a.x<this.b.x?this.elementA:this.elementB}},{key:"setRightVector",value:function(t,e){this.a.x<this.b.x?this.b.set(t,e):this.a.set(t,e)}},{key:"rotateToXAxis",value:function(){var t=this.getLeftVector();this.setRightVector(t.x+this.getLength(),t.y)}},{key:"rotate",value:function(t){var e=this.getLeftVector(),i=this.getRightVector(),r=Math.cos(t)*(i.x-e.x)-Math.sin(t)*(i.y-e.y)+e.x,n=Math.sin(t)*(i.x-e.x)-Math.cos(t)*(i.y-e.y)+e.y;return this.setRightVector(r,n),this}},{key:"shortenA",value:function(t){var e=Vector2.subtract(this.b,this.a);return e.normalize(),e.multiply(t),this.a.add(e),this}},{key:"shortenB",value:function(t){var e=Vector2.subtract(this.a,this.b);return e.normalize(),e.multiply(t),this.b.add(e),this}},{key:"shorten",value:function(t){var e=Vector2.subtract(this.a,this.b);return e.normalize(),e.multiply(t/2),this.b.add(e),this.a.subtract(e),this}}]),t}(),MathHelper=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"round",value:function(t,e){return e=e?e:1,Number(Math.round(t+"e"+e)+"e-"+e)}},{key:"meanAngle",value:function(t){for(var e=0,i=0,r=0;r<t.length;r++)e+=Math.sin(t[r]),i+=Math.cos(t[r]);return Math.atan2(e/t.length,i/t.length)}},{key:"innerAngle",value:function(e){return t.toRad(180*(e-2)/e)}},{key:"polyCircumradius",value:function(t,e){return t/(2*Math.sin(Math.PI/e))}},{key:"apothem",value:function(t,e){return t*Math.cos(Math.PI/e)}},{key:"centralAngle",value:function(e){return t.toRad(360/e)}},{key:"toDeg",value:function(t){return 180*t/Math.PI}},{key:"toRad",value:function(t){return t*Math.PI/180}}]),t}(),Pair=function(){function t(e,i){_classCallCheck(this,t),this.first=e,this.second=i}return _createClass(t,[{key:"getHash",value:function(){return.5*(this.first+this.second)*(this.first+this.second+1)+(this.first+this.second)}},{key:"contains",value:function(t){return this.first===t||this.second===t}}],[{key:"createUniquePairs",value:function(e){for(var i=[],r=0;r<e.length;r++)for(var n=e[r],s=r+1;s<e.length;s++){var o=e[s];i.push(new t(n,o))}return i}}]),t}(),Ring=function(){function t(e,i,r){_classCallCheck(this,t),this.id=null,this.ringbond=e,this.source=i,this.target=r,this.members=new Array,this.insiders=new Array,this.neighbours=new Array,this.positioned=!1,this.center=new Vector2,this.rings=new Array,this.isBridged=!1,this.template=null,this.isSpiro=!1,this.isFused=!1,this.radius=0,this.centralAngle=0,this.flip=!0}return _createClass(t,[{key:"clone",value:function e(){var e=new t(this.ringbond,this.source,this.target);return e.id=this.id,e.members=ArrayHelper.clone(this.members),e.insiders=ArrayHelper.clone(this.insiders),e.neighbours=ArrayHelper.clone(this.neighbours),e.positioned=this.positioned,e.center=ArrayHelper.clone(this.center),e.rings=ArrayHelper.clone(this.rings),e.isBridged=this.isBridged,e.template=this.template,e.isSpiro=this.isSpiro,e.isFused=this.isFused,e.radius=this.radius,e.centralAngle=this.centralAngle,e.flip=this.flip,e}},{key:"allowsFlip",value:function(){return this.flip&&this.members.length>4}},{key:"flipped",value:function(){this.members.length<8&&(this.flip=!1)}},{key:"size",value:function(){return this.members.length}},{key:"getPolygon",value:function(t){for(var e=[],i=0;i<this.members.length;i++)e.push(t[this.members[i]].position);return e}},{key:"getAngle",value:function(){return Math.PI-this.centralAngle}},{key:"eachMember",value:function(t,e,i,r){for(var i=i||0===i?i:this.members[0],n=i,s=0;null!=n&&s<100;){var o=n;e(o),n=t[n].getNextInRing(t,this.id,r),r=o,n==i&&(n=null),99==s&&console.log("crap"),s++}}},{key:"getOrderedNeighbours",value:function(t){for(var e=[],i=0;i<this.neighbours.length;i++){var r=RingConnection.getVertices(t,this.id,this.neighbours[i]);e.push({n:r.length,neighbour:this.neighbours[i]})}return e.sort(function(t,e){return e.n-t.n}),e}},{key:"isBenzene",value:function(t){for(var e=0;e<this.members.length;e++){var i=t[this.members[e]].value.element.charAt(0);if(i==i.toUpperCase())return!1}return!0}},{key:"contains",value:function(t){for(var e=0;e<this.members.length;e++)if(this.members[e]==t)return!0;return!1}},{key:"thisOrNeighboursContain",value:function(e,i){for(var r=0;r<this.neighbours.length;r++)if(t.getRing(e,this.neighbours[r]).contains(i))return!0;return!!this.contains(i)}},{key:"hasSource",value:function(){return!(void 0===this.source||null===this.source)}},{key:"hasTarget",value:function(){return!(void 0===this.target||null===this.target)}},{key:"hasSourceAndTarget",value:function(){return this.hasSource()&&this.hasTarget()}},{key:"getRing",value:function(t,e){for(var i=0;i<t.length;i++)if(t[i].id==e)return t[i]}}],[{key:"contains",value:function(t,e){for(var i=0;i<t.length;i++)if(t[i].contains(e))return!0;return!1}}]),t}(),RingConnection=function(){function t(e,i){_classCallCheck(this,t),this.id=null,this.rings=new Pair(e,i),this.vertices=[]}return _createClass(t,[{key:"addVertex",value:function(t){ArrayHelper.contains(this.vertices,{value:t})||this.vertices.push(t)}},{key:"isBridge",value:function(t){if(this.vertices.length>2)return!0;for(var e=0;e<this.vertices.length;e++){var i=this.vertices[e];if(t[i].value.rings.length>2)return!0}return!1}},{key:"updateOther",value:function(t,e){this.rings.first===e?this.rings.second=t:this.rings.first=t}}],[{key:"isBridge",value:function(t,e,i,r){for(var n=null,s=0;s<t.length;s++){n=t[s];var o=n.rings;if(o.first===i&&o.second===r||o.first===r&&o.second===i)return n.isBridge(e)}}},{key:"getNeighbours",value:function(t,e){for(var i=[],r=0;r<t.length;r++){var n=t[r].rings;n.first==e?i.push(n.second):n.second==e&&i.push(n.first)}return i}},{key:"getVertices",value:function(t,e,i){for(var r=0;r<t.length;r++){var n=t[r];if(n.rings.first==e&&n.rings.second==i||n.rings.first==i&&n.rings.second==e)return n.vertices}}}]),t}(),smiles=function(){function t(t,e){function i(){this.constructor=t}i.prototype=e.prototype,t.prototype=new i}function e(t,i,r,n){this.message=t,this.expected=i,this.found=r,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function i(t){function i(e){var i,r,n=ie[e];if(n)return n;for(i=e-1;!ie[i];)i--;for(n=ie[i],n={line:n.line,column:n.column,seenCR:n.seenCR};i<e;)r=t.charAt(i),"\n"===r?(n.seenCR||n.line++,n.column=1,n.seenCR=!1):"\r"===r||"\u2028"===r||"\u2029"===r?(n.line++,n.column=1,n.seenCR=!0):(n.column++,n.seenCR=!1),i++;return ie[e]=n,n}function r(t,e){var r=i(t),n=i(e);return{start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function n(t){te<re||(te>re&&(re=te,ne=[]),ne.push(t))}function s(t,i,r,n){function s(t){var e=1;for(t.sort(function(t,e){return t.description<e.description?-1:t.description>e.description?1:0});e<t.length;)t[e-1]===t[e]?t.splice(e,1):e++}function o(t,e){function i(t){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+e(t)}).replace(/[\u0100-\u0FFF]/g,function(t){return"\\u0"+e(t)}).replace(/[\u1000-\uFFFF]/g,function(t){return"\\u"+e(t)})}var r,n,s,o=new Array(t.length);for(s=0;s<t.length;s++)o[s]=t[s].description;return r=t.length>1?o.slice(0,-1).join(", ")+" or "+o[t.length-1]:o[0],n=e?'"'+i(e)+'"':"end of input","Expected "+r+" but "+n+" found."}return null!==i&&s(i),new e(null!==t?t:o(i,r),i,r,n)}function o(){var t,e,i,r,n,s,u,c,g,v;if(t=te,e=te,i=h(),i!==k){for(r=[],n=a();n!==k;)r.push(n),n=a();if(r!==k){for(n=[],s=te,u=l(),u===k&&(u=null),u!==k?(c=f(),c!==k?(u=[u,c],s=u):(te=s,s=k)):(te=s,s=k);s!==k;)n.push(s),s=te,u=l(),u===k&&(u=null),u!==k?(c=f(),c!==k?(u=[u,c],s=u):(te=s,s=k)):(te=s,s=k);if(n!==k){for(s=[],u=a();u!==k;)s.push(u),u=a();if(s!==k)if(u=l(),u===k&&(u=null),u!==k)if(c=o(),c===k&&(c=null),c!==k){for(g=[],v=a();v!==k;)g.push(v),v=a();g!==k?(i=[i,r,n,s,u,c,g],e=i):(te=e,e=k)}else te=e,e=k;else te=e,e=k;else te=e,e=k}else te=e,e=k}else te=e,e=k}else te=e,e=k;return e!==k&&(ee=t,e=B(e)),t=e}function a(){var e,i,r,s,a,h;return e=te,i=te,40===t.charCodeAt(te)?(r=D,te++):(r=k,0===se&&n(N)),r!==k?(s=l(),s===k&&(s=null),s!==k?(a=o(),a!==k?(41===t.charCodeAt(te)?(h=H,te++):(h=k,0===se&&n(M)),h!==k?(r=[r,s,a,h],i=r):(te=i,i=k)):(te=i,i=k)):(te=i,i=k)):(te=i,i=k),i!==k&&(ee=e,i=L(i)),e=i}function h(){var t,e;return t=te,e=c(),e===k&&(e=g(),e===k&&(e=u(),e===k&&(e=v()))),e!==k&&(ee=t,e=T(e)),t=e}function l(){var e,i;return e=te,P.test(t.charAt(te))?(i=t.charAt(te),te++):(i=k,0===se&&n(I)),i!==k&&(ee=e,i=E(i)),e=i}function u(){var e,i,r,s,o,a,h,l,u,c;return e=te,i=te,91===t.charCodeAt(te)?(r=O,te++):(r=k,0===se&&n(_)),r!==k?(s=C(),s===k&&(s=null),s!==k?(t.substr(te,2)===z?(o=z,te+=2):(o=k,0===se&&n(F)),o===k&&(t.substr(te,2)===W?(o=W,te+=2):(o=k,0===se&&n(X)),o===k&&(o=g(),o===k&&(o=d(),o===k&&(o=v())))),o!==k?(a=p(),a===k&&(a=null),a!==k?(h=x(),h===k&&(h=null),h!==k?(l=y(),l===k&&(l=null),l!==k?(u=A(),u===k&&(u=null),u!==k?(93===t.charCodeAt(te)?(c=U,te++):(c=k,0===se&&n(q)),c!==k?(r=[r,s,o,a,h,l,u,c],i=r):(te=i,i=k)):(te=i,i=k)):(te=i,i=k)):(te=i,i=k)):(te=i,i=k)):(te=i,i=k)):(te=i,i=k)):(te=i,i=k),i!==k&&(ee=e,i=j(i)),e=i}function c(){var e,i,r,s;return e=te,i=te,66===t.charCodeAt(te)?(r=Y,te++):(r=k,0===se&&n(G)),r!==k?(114===t.charCodeAt(te)?(s=$,te++):(s=k,0===se&&n(K)),s===k&&(s=null),s!==k?(r=[r,s],i=r):(te=i,i=k)):(te=i,i=k),i===k&&(i=te,67===t.charCodeAt(te)?(r=Z,te++):(r=k,0===se&&n(J)),r!==k?(108===t.charCodeAt(te)?(s=Q,te++):(s=k,0===se&&n(tt)),s===k&&(s=null),s!==k?(r=[r,s],i=r):(te=i,i=k)):(te=i,i=k),i===k&&(et.test(t.charAt(te))?(i=t.charAt(te),te++):(i=k,0===se&&n(it)))),i!==k&&(ee=e,i=rt(i)),e=i}function g(){var e,i;return e=te,nt.test(t.charAt(te))?(i=t.charAt(te),te++):(i=k,0===se&&n(st)),i!==k&&(ee=e,i=T(i)),e=i}function v(){var e,i;return e=te,42===t.charCodeAt(te)?(i=ot,te++):(i=k,0===se&&n(at)),i!==k&&(ee=e,i=ht(i)),e=i}function d(){var e,i,r,s;return e=te,i=te,lt.test(t.charAt(te))?(r=t.charAt(te),te++):(r=k,0===se&&n(ut)),r!==k?(ct.test(t.charAt(te))?(s=t.charAt(te),te++):(s=k,0===se&&n(gt)),s===k&&(s=null),s!==k?(r=[r,s],i=r):(te=i,i=k)):(te=i,i=k),i!==k&&(ee=e,i=vt(i)),e=i}function f(){var e,i,r,s,o;return e=te,i=te,37===t.charCodeAt(te)?(r=dt,te++):(r=k,0===se&&n(ft)),r!==k?(pt.test(t.charAt(te))?(s=t.charAt(te),te++):(s=k,0===se&&n(yt)),s!==k?(mt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=k,0===se&&n(bt)),o!==k?(r=[r,s,o],i=r):(te=i,i=k)):(te=i,i=k)):(te=i,i=k),i===k&&(mt.test(t.charAt(te))?(i=t.charAt(te),te++):(i=k,0===se&&n(bt))),i!==k&&(ee=e,i=xt(i)),e=i}function p(){var e,i,r,s,o,a,h;return e=te,i=te,64===t.charCodeAt(te)?(r=At,te++):(r=k,0===se&&n(Ct)),r!==k?(64===t.charCodeAt(te)?(s=At,te++):(s=k,0===se&&n(Ct)),s===k&&(s=te,t.substr(te,2)===wt?(o=wt,te+=2):(o=k,0===se&&n(Rt)),o!==k?(kt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=k,0===se&&n(St)),a!==k?(o=[o,a],s=o):(te=s,s=k)):(te=s,s=k),s===k&&(s=te,t.substr(te,2)===Vt?(o=Vt,te+=2):(o=k,0===se&&n(Bt)),o!==k?(kt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=k,0===se&&n(St)),a!==k?(o=[o,a],s=o):(te=s,s=k)):(te=s,s=k),s===k&&(s=te,t.substr(te,2)===Dt?(o=Dt,te+=2):(o=k,0===se&&n(Nt)),o!==k?(Ht.test(t.charAt(te))?(a=t.charAt(te),te++):(a=k,0===se&&n(Mt)),a!==k?(o=[o,a],s=o):(te=s,s=k)):(te=s,s=k),s===k&&(s=te,t.substr(te,2)===Lt?(o=Lt,te+=2):(o=k,0===se&&n(Tt)),o!==k?(pt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=k,0===se&&n(yt)),a!==k?(mt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=k,0===se&&n(bt)),h===k&&(h=null),h!==k?(o=[o,a,h],s=o):(te=s,s=k)):(te=s,s=k)):(te=s,s=k),s===k&&(s=te,t.substr(te,2)===Pt?(o=Pt,te+=2):(o=k,0===se&&n(It)),o!==k?(pt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=k,0===se&&n(yt)),a!==k?(mt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=k,0===se&&n(bt)),h===k&&(h=null),h!==k?(o=[o,a,h],s=o):(te=s,s=k)):(te=s,s=k)):(te=s,s=k)))))),s===k&&(s=null),s!==k?(r=[r,s],i=r):(te=i,i=k)):(te=i,i=k),i!==k&&(ee=e,i=Et(i)),e=i}function y(){var t,e;return t=te,e=m(),e===k&&(e=b()),e!==k&&(ee=t,e=Ot(e)),t=e}function m(){var e,i,r,s,o,a;return e=te,i=te,43===t.charCodeAt(te)?(r=_t,te++):(r=k,0===se&&n(zt)),r!==k?(43===t.charCodeAt(te)?(s=_t,te++):(s=k,0===se&&n(zt)),s===k&&(s=te,pt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=k,0===se&&n(yt)),o!==k?(mt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=k,0===se&&n(bt)),a===k&&(a=null),a!==k?(o=[o,a],s=o):(te=s,s=k)):(te=s,s=k)),s===k&&(s=null),s!==k?(r=[r,s],i=r):(te=i,i=k)):(te=i,i=k),i!==k&&(ee=e,i=Ft(i)),e=i}function b(){var e,i,r,s,o,a;return e=te,i=te,45===t.charCodeAt(te)?(r=Wt,te++):(r=k,0===se&&n(Xt)),r!==k?(45===t.charCodeAt(te)?(s=Wt,te++):(s=k,0===se&&n(Xt)),s===k&&(s=te,pt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=k,0===se&&n(yt)),o!==k?(mt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=k,0===se&&n(bt)),a===k&&(a=null),a!==k?(o=[o,a],s=o):(te=s,s=k)):(te=s,s=k)),s===k&&(s=null),s!==k?(r=[r,s],i=r):(te=i,i=k)):(te=i,i=k),i!==k&&(ee=e,i=Ut(i)),e=i}function x(){var e,i,r,s;return e=te,i=te,72===t.charCodeAt(te)?(r=qt,te++):(r=k,0===se&&n(jt)),r!==k?(mt.test(t.charAt(te))?(s=t.charAt(te),te++):(s=k,0===se&&n(bt)),s===k&&(s=null),s!==k?(r=[r,s],i=r):(te=i,i=k)):(te=i,i=k),i!==k&&(ee=e,i=Yt(i)),e=i}function A(){var e,i,r,s,o,a,h;if(e=te,i=te,58===t.charCodeAt(te)?(r=Gt,te++):(r=k,0===se&&n($t)),r!==k){if(s=te,pt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=k,0===se&&n(yt)),o!==k){for(a=[],mt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=k,0===se&&n(bt));h!==k;)a.push(h),mt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=k,0===se&&n(bt));a!==k?(o=[o,a],s=o):(te=s,s=k)}else te=s,s=k;s===k&&(Kt.test(t.charAt(te))?(s=t.charAt(te),te++):(s=k,0===se&&n(Zt))),s!==k?(r=[r,s],i=r):(te=i,i=k)}else te=i,i=k;return i!==k&&(ee=e,i=Jt(i)),e=i}function C(){var e,i,r,s,o;return e=te,i=te,pt.test(t.charAt(te))?(r=t.charAt(te),te++):(r=k,0===se&&n(yt)),r!==k?(mt.test(t.charAt(te))?(s=t.charAt(te),te++):(s=k,0===se&&n(bt)),s===k&&(s=null),s!==k?(mt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=k,0===se&&n(bt)),o===k&&(o=null),o!==k?(r=[r,s,o],i=r):(te=i,i=k)):(te=i,i=k)):(te=i,i=k),i!==k&&(ee=e,i=Qt(i)),e=i}var w,R=arguments.length>1?arguments[1]:{},k={},S={chain:o},V=o,B=function(t){for(var e=[],i=[],r=0;r<t[1].length;r++)e.push(t[1][r]);for(var r=0;r<t[2].length;r++){var n=t[2][r][0]?t[2][r][0]:"-";i.push({bond:n,id:t[2][r][1]})}for(var r=0;r<t[3].length;r++)e.push(t[3][r]);for(var r=0;r<t[6].length;r++)e.push(t[6][r]);return{atom:t[0],isBracket:!!t[0].element,branches:e,branchCount:e.length,ringbonds:i,ringbondCount:i.length,bond:t[4]?t[4]:"-",next:t[5],hasNext:!!t[5]}},D="(",N={type:"literal",value:"(",description:'"("'},H=")",M={type:"literal",value:")",description:'")"'},L=function(t){var e=t[1]?t[1]:"-";return t[2].branchBond=e,t[2]},T=function(t){return t},P=/^[\-=#$:\/\\.]/,I={type:"class",value:"[-=#$:/\\\\.]",description:"[-=#$:/\\\\.]"},E=function(t){return t},O="[",_={type:"literal",value:"[",description:'"["'},z="se",F={type:"literal",value:"se",description:'"se"'},W="as",X={type:"literal",value:"as",description:'"as"'},U="]",q={type:"literal",value:"]",description:'"]"'},j=function(t){return{isotope:t[1],element:t[2],chirality:t[3],hcount:t[4],charge:t[5],class:t[6]}},Y="B",G={type:"literal",value:"B",description:'"B"'},$="r",K={type:"literal",value:"r",description:'"r"'},Z="C",J={type:"literal",value:"C",description:'"C"'},Q="l",tt={type:"literal",value:"l",description:'"l"'},et=/^[NOPSFI]/,it={type:"class",value:"[NOPSFI]",description:"[NOPSFI]"},rt=function(t){return t.length>1?t.join(""):t},nt=/^[bcnops]/,st={type:"class",value:"[bcnops]",description:"[bcnops]"},ot="*",at={type:"literal",value:"*",description:'"*"'},ht=function(t){return t},lt=/^[A-Z]/,ut={type:"class",value:"[A-Z]",description:"[A-Z]"},ct=/^[a-z]/,gt={type:"class",value:"[a-z]",description:"[a-z]"},vt=function(t){return t.join("")},dt="%",ft={type:"literal",value:"%",description:'"%"'},pt=/^[1-9]/,yt={type:"class",value:"[1-9]",description:"[1-9]"},mt=/^[0-9]/,bt={type:"class",value:"[0-9]",description:"[0-9]"},xt=function(t){return 1==t.length?Number(t):Number(t.join("").replace("%",""))},At="@",Ct={type:"literal",value:"@",description:'"@"'},wt="TH",Rt={type:"literal",value:"TH",description:'"TH"'},kt=/^[12]/,St={type:"class",value:"[12]",description:"[12]"},Vt="AL",Bt={type:"literal",value:"AL",description:'"AL"'},Dt="SP",Nt={type:"literal",value:"SP",description:'"SP"'},Ht=/^[1-3]/,Mt={type:"class",value:"[1-3]",description:"[1-3]"},Lt="TB",Tt={type:"literal",value:"TB",description:'"TB"'},Pt="OH",It={type:"literal",value:"OH",description:'"OH"'},Et=function(t){return t[1]?"@"==t[1]?"@@":t[1].join("").replace(",",""):"@"},Ot=function(t){return t},_t="+",zt={type:"literal",value:"+",description:'"+"'},Ft=function(t){return t[1]?"+"!=t[1]?Number(t[1].join("")):2:1},Wt="-",Xt={type:"literal",value:"-",description:'"-"'},Ut=function(t){return t[1]?"-"!=t[1]?-Number(t[1].join("")):-2:-1},qt="H",jt={type:"literal",value:"H",description:'"H"'},Yt=function(t){return t[1]?Number(t[1]):1},Gt=":",$t={type:"literal",value:":",description:'":"'},Kt=/^[0]/,Zt={type:"class",value:"[0]",description:"[0]"},Jt=function(t){return Number(t[1][0]+t[1][1].join(""))},Qt=function(t){return Number(t.join(""))},te=0,ee=0,ie=[{line:1,column:1,seenCR:!1}],re=0,ne=[],se=0;if("startRule"in R){if(!(R.startRule in S))throw new Error("Can't start parsing from rule \""+R.startRule+'".');V=S[R.startRule]}if(w=V(),w!==k&&te===t.length)return w;throw w!==k&&te<t.length&&n({type:"end",description:"end of input"}),s(null,ne,re<t.length?t.charAt(re):null,re<t.length?r(re,re+1):r(re,re))}return t(e,Error),{SyntaxError:e,parse:i}}(),Vector2=function(){function t(e,i){_classCallCheck(this,t),0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i)}return _createClass(t,[{key:"set",value:function(t,e){this.x=t,this.y=e}},{key:"clone",value:function(){return new t(this.x,this.y)}},{key:"toString",value:function(){return"("+this.x+","+this.y+")"}},{key:"add",value:function(t){this.x+=t.x,this.y+=t.y}},{key:"subtract",value:function(t){this.x-=t.x,this.y-=t.y}},{key:"multiply",value:function(t){this.x*=t,this.y*=t}},{key:"divide",value:function(t){this.x/=t,this.y/=t}},{key:"invert",value:function(){this.x=-this.x,this.y=-this.y}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(t){return Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y))}},{key:"distanceSq",value:function(t){return(t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y)}},{key:"clockwise",value:function(t){var e=this.y*t.x,i=this.x*t.y;return e>i?-1:e===i?0:1}},{key:"rotate",value:function(e){var i=new t;i.x=this.x*Math.cos(e)-this.y*Math.sin(e),i.y=this.x*Math.sin(e)+this.y*Math.cos(e),this.x=i.x,this.y=i.y}},{key:"rotateAround",value:function(t,e){var i=Math.sin(t),r=Math.cos(t);this.x-=e.x,this.y-=e.y;var n=this.x*r-this.y*i,s=this.x*i+this.y*r;this.x=n+e.x,this.y=s+e.y}},{key:"rotateTo",value:function(e,i,r){r=r?r:0;var n=t.subtract(this,i),s=t.subtract(e,i),o=t.angle(s,n);this.rotateAround(o+r,i)}},{key:"getRotateToAngle",value:function(e,i){var r=t.subtract(this,i),n=t.subtract(e,i),s=t.angle(n,r);return s}},{key:"isInPolygon",value:function(t){for(var e=!1,i=0,r=t.length-1;i<t.length;r=i++)t[i].y>this.y!=t[r].y>this.y&&this.x<(t[r].x-t[i].x)*(this.y-t[i].y)/(t[r].y-t[i].y)+t[i].x&&(e=!e);return e}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"normalize",value:function(){this.divide(this.length())}},{key:"normalized",value:function(){return t.divide(this,this.length())}},{key:"whichSide",value:function(t,e){return(this.x-t.x)*(e.y-t.y)-(this.y-t.y)*(e.x-t.x)}},{key:"sameSideAs",value:function(t,e,i){var r=this.whichSide(t,e),n=i.whichSide(t,e);return r<0&&n<0||0==r&&0==n||r>0&&n>0}}],[{key:"add",value:function(e,i){return new t(e.x+i.x,e.y+i.y)}},{key:"subtract",value:function(e,i){return new t(e.x-i.x,e.y-i.y)}},{key:"multiply",value:function(e,i){return i.x&&i.y?new t(e.x*i.x,e.y*i.y):new t(e.x*i,e.y*i)}},{key:"midpoint",value:function(e,i){return new t((e.x+i.x)/2,(e.y+i.y)/2)}},{key:"normals",value:function(e,i){var r=t.subtract(i,e);return[new t(-r.y,r.x),new t(r.y,-r.x)]}},{key:"divide",value:function(e,i){return i.x&&i.y?new t(e.x/i.x,e.y/i.y):new t(e.x/i,e.y/i)}},{key:"dot",value:function(t,e){return t.x*e.x+t.y*e.y}},{key:"angle",value:function(e,i){var r=t.dot(e,i);return Math.acos(r/(e.length()*i.length()))}},{key:"scalarProjection",value:function(e,i){var r=i.normalized();return t.dot(e,r)}}]),t}(),Vertex=function(){function t(e,i,r){_classCallCheck(this,t),this.id=null,this.value=e,this.position=new Vector2(i?i:0,r?r:0),this.previousPosition=new Vector2(0,0),this.parent=null,this.children=[],this.spanningTreeChildren=[],this.edges=[],this.positioned=!1,this.angle=0,this.backAngle=0,this.flippable=!1,this.flipCenter=null,this.flipNeighbour=null,this.flipRings=new Array}return _createClass(t,[{key:"isTerminal",value:function(){return null===this.parent&&this.children<2||0===this.children.length}},{key:"clone",value:function e(){var e=new t(this.value,this.position.x,this.position.y);return e.id=this.id,e.previousPosition=new Vector2(this.previousPosition.x,this.previousPosition.y),e.parent=this.parent,e.children=ArrayHelper.clone(this.children),e.spanningTreeChildren=ArrayHelper.clone(this.spanningTreeChildren),e.edges=ArrayHelper.clone(this.edges),e.positioned=this.positioned,e.angle=this.angle,e.backAngle=this.backAngle,e.flippable=this.flippable,e.flipCenter=this.flipCenter,e.flipRings=ArrayHelper.clone(this.flipRings),e}},{key:"equals",value:function(t){return this.id==t.id}},{key:"getAngle",value:function(t,e){var i=null;return i=t?Vector2.subtract(this.position,t):Vector2.subtract(this.position,this.previousPosition),e?MathHelper.toDeg(i.angle()):i.angle()}},{key:"getTextDirection",value:function(t){for(var e=this.getNeighbours(),i=[],r=0;r<e.length;r++)i.push(this.getAngle(t[e[r]].position));var n=MathHelper.meanAngle(i),s=Math.PI/2;return n=Math.round(Math.round(n/s)*s,3),2==n?"down":n==-2?"up":0===n||n===-0?"right":3==n||n==-3?"left":void 0}},{key:"getNeighbours",value:function(t){for(var e=[],i=0;i<this.children.length;i++)void 0!==t&&t==this.children[i]||e.push(this.children[i]);return null!=this.parent&&(void 0!==t&&t==this.parent||e.push(this.parent)),e}},{key:"getCommonNeighbours",value:function(t){for(var e=new Array,i=this.getNeighbours(),r=t.getNeighbours(),n=0;n<i.length;n++)for(var s=0;s<r.length;s++)i[n]===r[s]&&e.push(i[n]);return e}},{key:"isNeighbour",value:function(t){for(var e=0;e<this.children.length;e++)if(this.children[e]===t)return!0;return this.parent===t}},{key:"getSpanningTreeNeighbours",value:function(t){for(var e=[],i=0;i<this.spanningTreeChildren.length;i++)void 0!==t&&t==this.spanningTreeChildren[i]||e.push(this.spanningTreeChildren[i]);return null!=this.parent&&(void 0!==t&&t==this.parent||e.push(this.parent)),e}},{key:"getNextInRing",value:function(t,e,i){for(var r=this.getNeighbours(),n=0;n<r.length;n++)if(ArrayHelper.contains(t[r[n]].value.rings,{value:e})&&r[n]!=i)return r[n];return null}}]),t}();