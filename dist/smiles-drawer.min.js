"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ArrayHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"clone",value:function(t){var i=Array.isArray(t)?[]:{};for(var n in t){var r=t[n];"function"==typeof r.clone?i[n]=r.clone():i[n]="object"===("undefined"==typeof r?"undefined":_typeof(r))?e.clone(r):r}return i}},{key:"print",value:function(e){if(0==e.length)return"";for(var t="(",i=0;i<e.length;i++)t+=e[i].id+", ";return t=t.substring(0,t.length-2),t+")"}},{key:"each",value:function(e,t){for(var i=0;i<e.length;i++)t(e[i])}},{key:"get",value:function(e,t,i){for(var n=0;n<e.length;n++)if(e[n][t]==i)return e[n]}},{key:"contains",value:function(e,t){if(t.property||t.func){if(t.func){for(var i=0;i<e.length;i++)if(t.func(e[i]))return!0}else for(var i=0;i<e.length;i++)if(e[i][t.property]==t.value)return!0}else for(var i=0;i<e.length;i++)if(e[i]==t.value)return!0;return!1}},{key:"intersection",value:function e(t,i){for(var e=new Array,n=0;n<t.length;n++)for(var r=0;r<i.length;r++)t[n]==i[r]&&e.push(t[n]);return e}},{key:"unique",value:function(e){var t={};return e.filter(function(e){return void 0===t[e]&&(t[e]=!0)})}},{key:"count",value:function e(t,i){for(var e=0,n=0;n<t.length;n++)t[n]==i&&e++;return e}},{key:"toggle",value:function(e,t){for(var i=[],n=!1,r=0;r<e.length;r++)e[r]!=t?i.push(e[r]):n=!0;return n||i.push(t),i}},{key:"remove",value:function(e,t){for(var i=[],n=0;n<e.length;n++)e[n]!=t&&i.push(e[n]);return i}},{key:"removeAll",value:function(e,t){return e.filter(function(e){return t.indexOf(e)===-1})}},{key:"merge",value:function(e,t){for(var i=new Array(e.length+t.length),n=0;n<e.length;n++)i[n]=e[n];for(var n=0;n<t.length;n++)i[e.length+n]=t[n];return i}},{key:"containsAll",value:function(e,t){for(var i=0,n=0;n<e.length;n++)for(var r=0;r<t.length;r++)e[n]===t[r]&&i++;return i==t.length}}]),e}(),Atom=function(){function e(t,i){_classCallCheck(this,e),this.element=t,this.ringbonds=new Array,this.rings=new Array,this.bond="-",this.isTerminal=!1,this.isBridge=!1,this.isBridgeNode=!1,this.bridgedRing=null,this.anchoredRings=new Array,this.bracket=null}return _createClass(e,[{key:"addAnchoredRing",value:function(e){ArrayHelper.contains(this.anchoredRings,{value:e.id})||this.anchoredRings.push(e.id)}},{key:"getRingbondCount",value:function(){return this.ringbonds.length}},{key:"canRotate",value:function(){return"-"==this.bond&&0==this.rings.length}},{key:"hasRingbonds",value:function(){return this.ringbonds.length>0}},{key:"getMaxRingbond",value:function(){for(var e=0,t=0;t<this.ringbonds.length;t++)this.ringbonds[t].id>e&&(e=this.ringbonds[t].id);return e}},{key:"hasRing",value:function(e){for(var t=0;t<this.rings;t++)if(e===this.rings[t])return!0;return!1}},{key:"haveCommonRingbond",value:function(e,t){for(var i=0;i<e.ringbonds.length;i++)for(var n=0;n<t.ringbonds.length;n++)if(e.ringbonds[i].id==t.ringbonds[n].id)return!0;return!1}},{key:"maxCommonRingbond",value:function(e,t){for(var i=0,n=0,r=0,s=0;s<e.ringbonds.length;s++){e.ringbonds[s].id>n&&(n=e.ringbonds[s].id);for(var o=0;o<t.ringbonds.length;o++)t.ringbonds[o].id>r&&(r=t.ringbonds[o].id),n==r&&(i=n)}return i}}]),e}(),SmilesDrawer=function(){function e(){_classCallCheck(this,e),this.width=800,this.height=500,this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.canvas,this.ctx,this.drawingWidth=0,this.drawingHeight=0,this.offsetX=0,this.offsetY=0,this.colors={C:"#fff",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#141414"},this.colorsLight={C:"#222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#fff"},this.maxBonds={c:4,C:4,n:3,N:3,o:2,O:2},this.settings={shortBondLength:20,bondLength:25,bondSpacing:4,defaultDir:-1,debug:!1}}return _createClass(e,[{key:"draw",value:function(e,t,i,n){if(this.data=e,this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.vertices=[],this.edges=[],this.rings=[],this.ringConnections=[],this.backupVertices=[],this.backupRings=[],n&&(this.colors=this.colorsLight),this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight),this.createVertices(e,null),this.discoverRings(),!i){this.position();for(var r=this.getOverlapScore(),s=0;r.total>this.settings.bondLength/2&&s<10;){this.clearPositions(),this.position();var o=this.getOverlapScore();o.total<r.total?r=o:this.restorePositions(),s++}this.resolveSecondaryOverlaps(r.scores);for(var h={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},a={x:Number.MAX_VALUE,y:Number.MAX_VALUE},l=0;l<this.vertices.length;l++){var u=this.vertices[l].position;h.x<u.x&&(h.x=u.x),h.y<u.y&&(h.y=u.y),a.x>u.x&&(a.x=u.x),a.y>u.y&&(a.y=u.y)}var c=20;h.x+=c,h.y+=c,a.x-=c,a.y-=c,this.drawingWidth=h.x-a.x,this.drawingHeight=h.y-a.y;var g=this.canvas.offsetWidth/this.drawingWidth,v=this.canvas.offsetHeight/this.drawingHeight,d=g<v?g:v;this.ctx.scale(d,d),this.offsetX=-a.x,this.offsetY=-a.y,g<v?this.offsetY+=this.canvas.offsetHeight/(2*d)-this.drawingHeight/2:this.offsetX+=this.canvas.offsetWidth/(2*d)-this.drawingWidth/2,this.drawEdges(),this.drawVertices(this.settings.debug),this.ctx.setTransform(1,0,0,1,0,0)}}},{key:"edgeRingCount",value:function(e){var t=this.edges[e],i=this.vertices[t.source],n=this.vertices[t.target];return Math.min(i.value.rings.length,n.value.rings.length)}},{key:"getBridgedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isBridged&&e.push(this.rings[t]);return e}},{key:"getFusedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isFused&&e.push(this.rings[t]);return e}},{key:"getSpiros",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isSpiro&&e.push(this.rings[t]);return e}},{key:"printRingInfo",value:function(e){for(var t="",i=0;i<this.rings.length;i++){var n=this.rings[i];t+=e?e+";":"",t+=n.members.length+";",t+=n.neighbours.length+";",t+=n.isSpiro?"true;":"false;",t+=n.isFused?"true;":"false;",t+=n.isBridged?"true;":"false;",t+=n.rings.length+";",t+=n.insiders.length+";",t+="\n"}return t}},{key:"createVertices",value:function(e,t,i){var n=new Atom(e.atom.element?e.atom.element:e.atom);n.bond=e.bond,n.branchBond=e.branchBond,n.ringbonds=e.ringbonds,n.bracket=e.atom.element?e.atom:null;var r=new Vertex(n),s=this.vertices[t];if(r.parentVertexId=t,this.addVertex(r),null!=t){this.vertices[t].children.push(r.id),this.vertices[t].spanningTreeChildren.push(r.id);var o=new Edge(t,r.id,1);i?o.bond=r.value.branchBond:o.bond=this.vertices[t].value.bond;var h=this.addEdge(o);r.edges.push(h),s.edges.push(h)}for(var a=0;a<e.branchCount;a++)this.createVertices(e.branches[a],r.id,!0);e.hasNext&&this.createVertices(e.next,r.id)}},{key:"matchRingBonds",value:function(e,t){if(e.value.getRingbondCount()<1||t.value.getRingbondCount()<1)return null;for(var i=0;i<e.value.ringbonds.length;i++)for(var n=0;n<t.value.ringbonds.length;n++)if(e.value.ringbonds[i].id==t.value.ringbonds[n].id)return"-"==e.value.ringbonds[i].bond?t.value.ringbonds[n].bond:e.value.ringbonds[i].bond;return null}},{key:"hasRingWithoutTarget",value:function(e){for(var t=0;t<this.rings.length;t++){var i=this.rings[t];if(i.ringbond==e&&!i.hasTarget())return!0}return!1}},{key:"getRingWithoutTarget",value:function(e){for(var t=0;t<this.rings.length;t++){var i=this.rings[t];if(i.ringbond==e&&!i.hasTarget())return i}}},{key:"discoverRings",value:function(){for(var e={},t=this,i=this.vertices.length-1;i>=0;i--){var n=this.vertices[i];if(0!==n.value.ringbonds.length)for(var r=0;r<n.value.ringbonds.length;r++){var s=n.value.ringbonds[r].id;if(void 0===e[s])e[s]=n.id;else{var o=e[s],h=n.id,a=t.addEdge(new Edge(h,o,1));t.vertices[h].children.push(o),t.vertices[o].children.push(h),t.vertices[h].edges.push(a),t.vertices[o].edges.push(a);var l=new Ring(s,h,o);t.addRing(l);for(var u=t.annotateRing(l.id,l.source,l.target),c=0;c<u.length;c++)l.members.push(u[c]),t.vertices[u[c]].value.rings.push(l.id);e[s]=void 0}}}for(var i=0;i<this.rings.length-1;i++)for(var c=i+1;c<this.rings.length;c++){for(var g=this.rings[i],v=this.rings[c],d=new RingConnection(g.id,v.id),f=0;f<g.members.length;f++)for(var p=0;p<v.members.length;p++){var y=g.members[f],m=v.members[p];y===m&&d.addVertex(y)}d.vertices.length>0&&this.addRingConnection(d)}for(var i=0;i<this.rings.length;i++){var l=this.rings[i];l.neighbours=RingConnection.getNeighbours(this.ringConnections,l.id)}for(;this.rings.length>0;){for(var b=-1,i=0;i<this.rings.length;i++){var l=this.rings[i];this.isPartOfBridgedRing(l.id)&&(b=l.id)}if(b===-1)break;var l=this.getRing(b),x=this.getBridgedRingRings(l.id);this.createBridgedRing(x,l.source);for(var i=0;i<x.length;i++)this.removeRing(x[i])}}},{key:"getBridgedRingRings",value:function(e){var t=new Array,i=this,n=function e(n){var r=i.getRing(n);t.push(n);for(var s=0;s<r.neighbours.length;s++){var o=r.neighbours[s];t.indexOf(o)===-1&&o!==n&&RingConnection.isBridge(i.ringConnections,i.vertices,n,o)&&e(o)}};return n(e),ArrayHelper.unique(t)}},{key:"isPartOfBridgedRing",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].rings.contains(e)&&this.ringConnections[t].isBridge(this.vertices))return!0;return!1}},{key:"createBridgedRing",value:function(e,t){for(var i=new Array,n=new Array,r=new Array,s=(new Array,0);s<e.length;s++){for(var o=this.getRing(e[s]),h=0;h<o.members.length;h++)n.push(o.members[h]);for(var h=0;h<o.neighbours.length;h++)r.push(o.neighbours[h])}n=ArrayHelper.unique(n);for(var a=new Array,s=0;s<n.length;s++){var l=this.vertices[n[s]],u=ArrayHelper.intersection(e,l.value.rings);1==l.value.rings.length||1==u.length?i.push(l.id):a.push(l.id)}for(var c=new Array,g=new Array,s=0;s<a.length;s++){for(var l=this.vertices[a[s]],v=!1,h=0;h<l.edges.length;h++)1==this.edgeRingCount(l.edges[h])&&(v=!0);v?(l.value.isBridgeNode=!0,c.push(l.id)):(l.value.isBridge=!0,g.push(l.id))}var d=ArrayHelper.merge(i,c);r=ArrayHelper.unique(r),r=ArrayHelper.removeAll(r,e);for(var f=this.vertices[t],p=f.getNeighbours(),y=null,s=0;s<p.length;s++){var m=p[s];d.indexOf(m)!==-1&&(y=m)}var o=new Ring(-1,t,y);o.isBridged=!0,o.members=d,o.neighbours=r,o.insiders=g;for(var s=0;s<e.length;s++)o.rings.push(this.getRing(e[s]).clone());this.addRing(o);for(var s=0;s<g.length;s++){var l=this.vertices[g[s]];l.value.rings=new Array,l.value.bridgedRing=o.id}for(var s=0;s<d.length;s++){var l=this.vertices[d[s]];l.value.rings=ArrayHelper.removeAll(l.value.rings,e),l.value.rings.push(o.id)}for(var s=0;s<e.length;s++)for(var h=s+1;h<e.length;h++)this.removeRingConnectionBetween(e[s],e[h]);for(var s=0;s<r.length;s++)for(var b=this.getRingConnections(r[s],e),h=0;h<b.length;h++)this.getRingConnection(b[h]).updateOther(o.id,r[s]);return o}},{key:"ringCounter",value:function(e,t){for(var i=0;i<e.getRingbondCount();i++){var n=e.ringbonds[i].id;this.arrayContains(t,{value:n})||t.push(n)}for(var i=0;i<e.branchCount;i++)this.ringCounter(e.branches[i],t);return e.hasNext&&this.ringCounter(e.next,t),t}},{key:"annotateRing",value:function(e,t,i){for(var n=this.dijkstra(t,i),r=[],s=[],o=i;null!=o;)r.push(o),o=n[o];for(var h=r.length-1;h>=0;h--)s.push(r[h]);return s}},{key:"dijkstra",value:function(e,t){for(var i=new Array(this.vertices.length),n=new Array(this.vertices.length),r=new Array(this.vertices.length),s=new Array(this.vertices.length),o=0;o<this.vertices.length;o++)n[o]=o==e?0:Number.MAX_VALUE,i[o]=null,r[o]=!1,s[o]=this.vertices[o].getNeighbours();for(;ArrayHelper.count(r,!1)>0;){var h=this.getMinDist(n,r);if(h==t)return i;r[h]=!0;for(var o=0;o<s[h].length;o++){var a=s[h][o],l=n[h]+this.getEdgeWeight(h,a);h==e&&a==t||h==t&&a==e||l<n[a]&&(n[a]=l,i[a]=h)}}}},{key:"areVerticesInSameRing",value:function(e,t){for(var i=0;i<e.value.rings.length;i++)for(var n=0;n<t.value.rings.length;n++)if(e.value.rings[i]==t.value.rings[n])return!0;return!1}},{key:"getCommonRings",value:function(e,t){for(var i=[],n=0;n<e.value.rings.length;n++)for(var r=0;r<t.value.rings.length;r++)e.value.rings[n]==t.value.rings[r]&&i.push(e.value.rings[n]);return i}},{key:"getSmallestCommonRing",value:function(e,t){for(var i=this.getCommonRings(e,t),n=Number.MAX_VALUE,r=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).size();o<n&&(n=o,r=this.getRing(i[s]))}return r}},{key:"getLargestCommonRing",value:function(e,t){for(var i=this.getCommonRings(e,t),n=0,r=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).size();o>n&&(n=o,r=this.getRing(i[s]))}return r}},{key:"getMinDist",value:function(e,t){for(var i=Number.MAX_VALUE,n=null,r=0;r<e.length;r++)t[r]||e[r]<i&&(n=r,i=e[n]);return n}},{key:"getEdgeWeight",value:function(e,t){for(var i=0;i<this.edges.length;i++){var n=this.edges[i];if(n.source==e&&n.target==t||n.target==e&&n.source==t)return n.weight}}},{key:"addVertex",value:function(e){return e.id=this.vertices.length,this.vertices.push(e),e.id}},{key:"getVerticesAt",value:function(e,t,i){for(var n=new Array,r=0;r<this.vertices.length;r++){var s=this.vertices[r];if(s.id!==i&&s.positioned){var o=e.distance(s.position);o<=t&&n.push(s.id)}}return n}},{key:"getBranch",value:function(e,t){var i=new Array,n=new Array,r=this,s=function e(t,s){for(var o=r.vertices[t],h=0;h<o.value.rings.length;h++)n.push(o.value.rings[h]);for(var h=0;h<o.children.length;h++){var a=o.children[h];a===s||ArrayHelper.contains(i,{value:a})||(i.push(a),e(a,t))}var l=o.parentVertexId;l===s||null===l||ArrayHelper.contains(i,{value:l})||(i.push(l),e(l,t))};return i.push(e),s(e,t),{vertices:i,rings:ArrayHelper.unique(n)}}},{key:"addEdge",value:function(e){return e.id=this.edges.length,this.edges.push(e),e.id}},{key:"addRing",value:function(e){return e.id=this.ringIdCounter++,this.rings.push(e),e.id}},{key:"removeRing",value:function(e){this.rings=this.rings.filter(function(t){return t.id!==e}),this.ringConnections=this.ringConnections.filter(function(t){return t.rings.first!==e&&t.rings.second!==e});for(var t=0;t<this.rings.length;t++){var i=this.rings[t];i.neighbours=i.neighbours.filter(function(t){return t!==e})}}},{key:"getRing",value:function(e){for(var t=0;t<this.rings.length;t++)if(this.rings[t].id==e)return this.rings[t]}},{key:"addRingConnection",value:function(e){return e.id=this.ringConnectionIdCounter++,this.ringConnections.push(e),e.id}},{key:"removeRingConnection",value:function(e){this.ringConnections=this.ringConnections.filter(function(t){return t.id!==e})}},{key:"removeRingConnectionBetween",value:function(e,t){for(var i=new Array,n=0;n<this.ringConnections.length;n++){var r=this.ringConnections[n];(r.rings.first===e&&r.rings.second===t||r.rings.first===t&&r.rings.second===e)&&i.push(r.id)}for(var n=0;n<i.length;n++)this.removeRingConnection(i[n])}},{key:"getRingConnection",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].id==e)return this.ringConnections[t]}},{key:"getRingConnections",value:function(e,t){var i=new Array;if(1===arguments.length)for(var n=0;n<this.ringConnections.length;n++){var r=this.ringConnections[n];r.rings.first!==e&&r.rings.second!==e||i.push(r.id)}else if(t.constructor!==Array)for(var n=0;n<this.ringConnections.length;n++){var r=this.ringConnections[n];(r.rings.first===e&&r.rings.second===t||r.rings.first===t&&r.rings.second===e)&&i.push(r.id)}else for(var n=0;n<this.ringConnections.length;n++)for(var s=0;s<t.length;s++){var o=t[s],r=this.ringConnections[n];(r.rings.first===e&&r.rings.second===o||r.rings.first===o&&r.rings.second===e)&&i.push(r.id)}return i}},{key:"getOverlapScore",value:function(){for(var e=0,t=new Float32Array(this.vertices.length),i=0;i<this.vertices.length;i++)t[i]=0;for(var i=0;i<this.vertices.length;i++)for(var n=i+1;n<this.vertices.length;n++){var r=this.vertices[i],s=this.vertices[n],o=Vector2.subtract(r.position,s.position).length();if(o<this.settings.bondLength){var h=this.settings.bondLength-o;e+=h,t[i]+=h,t[n]+=h}}for(var a=[],i=0;i<this.vertices.length;i++)a.push({id:i,score:t[i]});return a.sort(function(e,t){return t.score-e.score}),{total:e,scores:a}}},{key:"getColor",value:function(e){return e in this.colors?this.colors[e]:this.colors.C}},{key:"circle",value:function(e,t,i,n,r,s){isNaN(t)||isNaN(i)||(this.ctx.save(),this.ctx.lineWidth=1.5,this.ctx.beginPath(),this.ctx.arc(t+this.offsetX,i+this.offsetY,e,0,2*Math.PI,!0),this.ctx.closePath(),s?r?(this.ctx.fillStyle="#ff0000",this.ctx.fill()):(this.ctx.strokeStyle="#ff0000",this.ctx.stroke()):r?(this.ctx.fillStyle=this.colors.C,this.ctx.fill()):(this.ctx.strokeStyle=this.colors.C,this.ctx.stroke()),this.ctx.restore())}},{key:"line",value:function e(t,i,n,r,s,o,h){if(!(isNaN(t)||isNaN(i)||isNaN(n)||isNaN(r))){var e=new Line(new Vector2(t,i),new Vector2(n,r),s,o),a=e.getLeftVector().clone(),l=e.getRightVector().clone();a.x+=this.offsetX,a.y+=this.offsetY,l.x+=this.offsetX,l.y+=this.offsetY,this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(a.x,a.y),this.ctx.lineTo(l.x,l.y),this.ctx.lineCap="round",this.ctx.lineWidth=1.5;var u=this.ctx.createLinearGradient(a.x,a.y,l.x,l.y);u.addColorStop(.4,this.colors[e.getLeftElement().toUpperCase()]||this.colors.C),u.addColorStop(.6,this.colors[e.getRightElement().toUpperCase()]||this.colors.C),this.ctx.strokeStyle=u,this.ctx.stroke(),this.ctx.restore()}}},{key:"debugText",value:function(e,t,i){this.ctx.save();var n="5px Arial";this.ctx.font=n,this.ctx.textAlign="start",this.ctx.textBaseline="top",this.ctx.fillStyle="#ff0000",this.ctx.fillText(i,e+this.offsetX,t+this.offsetY),this.ctx.restore()}},{key:"text",value:function(e,t,i,n,r,s,o,h,a){if(!isNaN(e)&&!isNaN(t)){this.ctx.save();var l="10px Arial",u="6px Arial";this.ctx.textAlign="start",this.ctx.textBaseline="top";var c=0;if(a){var g="+";2===a?g="2+":a===-1?g="-":a===-2&&(g="2-"),this.ctx.font=u,c=this.ctx.measureText(g).width}this.ctx.font=l,this.ctx.fillStyle=this.colors.BACKGROUND;var v=this.ctx.measureText(i);v.totalWidth=v.width+c,v.height=parseInt(l,10);var d=v.totalWidth>v.height?v.totalWidth:v.height;d/=2,this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(e+this.offsetX,t+this.offsetY+v.height/20,d+1,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalCompositeOperation="source-over",t-=2,this.ctx.fillStyle=this.getColor(i.toUpperCase()),this.ctx.fillText(i,e-v.totalWidth/2+this.offsetX,t-v.height/2+this.offsetY),a&&(this.ctx.font=u,this.ctx.fillText(g,e-v.totalWidth/2+v.width+this.offsetX,t-v.height/2+this.offsetY)),this.ctx.font=l;var f=this.ctx.measureText("H");if(f.height=parseInt(l,10),1===s){var p=e-v.totalWidth/2+this.offsetX,y=t-v.height/2+this.offsetY;"left"===o?p-=v.totalWidth:"right"===o?p+=v.totalWidth:"up"===o&&h?p+=v.totalWidth:"down"===o&&h?p+=v.totalWidth:"up"!==o||h?"down"!==o||h||(y+=v.height):y-=v.height,this.ctx.fillText("H",p,y)}else if(s>1){var p=e-v.totalWidth/2+this.offsetX,y=t-v.height/2+this.offsetY;this.ctx.font=u;var m=this.ctx.measureText(s);m.height=parseInt(u,10),"left"===o?p-=f.width+m.width:"right"===o?p+=v.totalWidth:"up"===o&&h?p+=v.totalWidth:"down"===o&&h?p+=v.totalWidth:"up"!==o||h?"down"!==o||h||(y+=v.height):y-=v.height,this.ctx.font=l,this.ctx.fillText("H",p,y),this.ctx.font=u,this.ctx.fillText(s,p+f.width,y+f.height/2)}this.ctx.restore()}}},{key:"drawPoint",value:function(e,t){this.circle(2,e.x,e.y,"helper",!0,!0),t&&this.debugText(e.x,e.y,t,"id",!0)}},{key:"chooseSide",value:function(e,t,i){for(var n=e.getNeighbours(t.id),r=t.getNeighbours(e.id),s=n.length,o=r.length,h=ArrayHelper.merge(n,r),a=[0,0],l=0;l<h.length;l++){var u=this.vertices[h[l]].position;u.sameSideAs(e.position,t.position,i[0])?a[0]++:a[1]++}for(var c=[0,0],l=0;l<this.vertices.length;l++){var u=this.vertices[l].position;u.sameSideAs(e.position,t.position,i[0])?c[0]++:c[1]++}return{totalSideCount:c,totalPosition:c[0]>c[1]?0:1,sideCount:a,position:a[0]>a[1]?0:1,anCount:s,bnCount:o}}},{key:"connected",value:function(e,t){for(var i=0;i<this.edges.length;i++){var n=this.edges[i];if(n.source===e&&n.target===t||n.source===t&&n.target===e)return!0}return!1}},{key:"forceLayout",value:function(e,t,i,n){var r=this.settings.bondLength,s=6e3,o=5,h=.5;n.rings.length>2&&(s=1e3,o=1.5,h=0),this.vertices[i].positioned=!1;for(var a=0;a<e.length;a++){var l=this.vertices[e[a]];l.positioned||(l.position.x=t.x+Math.random(),l.position.y=t.y+Math.random())}for(var u={},a=0;a<e.length;a++)u[e[a]]=new Vector2;for(var c=0;c<1e3;c++){for(var a=0;a<e.length;a++)u[e[a]].set(0,0);for(var g=0;g<e.length-1;g++)for(var v=this.vertices[e[g]],d=g+1;d<e.length;d++){var f=this.vertices[e[d]],p=f.position.x-v.position.x,y=f.position.y-v.position.y;if(0!==p&&0!==y){var m=p*p+y*y,b=Math.sqrt(m),x=s/m,A=x*p/b,k=x*y/b;v.positioned||(u[v.id].x-=A,u[v.id].y-=k),f.positioned||(u[f.id].x+=A,u[f.id].y+=k)}}if(n.rings.length>2)for(var C=new Array(n.rings.length),a=0;a<n.rings.length;a++){C[a]=new Vector2;for(var R=0;R<n.rings[a].members.length;R++)C[a].x+=this.vertices[n.rings[a].members[R]].position.x,C[a].y+=this.vertices[n.rings[a].members[R]].position.y;C[a].x/=n.rings[a].members.length,C[a].y/=n.rings[a].members.length;for(var g=0;g<n.rings[a].members.length;g++){var v=this.vertices[n.rings[a].members[g]],p=C[a].x-v.position.x,y=C[a].y-v.position.y;if(0!==p&&0!==y){var m=p*p+y*y,b=Math.sqrt(m),x=s/m;5!==n.rings[a].members.length&&6!==n.rings[a].members.length||(x*=10);var A=x*p/b,k=x*y/b;v.positioned||(u[v.id].x-=A,u[v.id].y-=k)}}}for(var g=0;g<e.length-1;g++)for(var v=this.vertices[e[g]],d=g+1;d<e.length;d++){var f=this.vertices[e[d]];if(v.isNeighbour(f.id)){var p=f.position.x-v.position.x,y=f.position.y-v.position.y;if(0!==p&&0!==y){var b=Math.sqrt(p*p+y*y),x=o*(b-r);x*=b<r?.5:2;var A=x*p/b,k=x*y/b;v.positioned||(u[v.id].x+=A,u[v.id].y+=k),f.positioned||(u[f.id].x-=A,u[f.id].y-=k)}}}for(var g=0;g<e.length;g++){var l=this.vertices[e[g]],p=t.x-l.position.x,y=t.y-l.position.y;if(0!==p&&0!==y){var b=Math.sqrt(p*p+y*y),x=h*(1/b),A=x*p/b,k=x*y/b;v.positioned||(u[l.id].x+=A,u[l.id].y+=k)}}for(var g=0;g<e.length;g++){var l=this.vertices[e[g]];if(!l.positioned){var p=.1*u[l.id].x,y=.1*u[l.id].y,m=p*p+y*y;if(m>500){var w=Math.sqrt(500/m);p*=w,y*=w}l.position.x+=p,l.position.y+=y}}}for(var g=0;g<e.length;g++)this.vertices[e[g]].positioned=!0;for(var g=0;g<e.length;g++)for(var l=this.vertices[e[g]],V=l.getNeighbours(),a=0;a<V.length;a++)l.value.isBridge?this.createBonds(this.vertices[V[a]],l,MathHelper.toRad(60)):0===this.vertices[V[a]].value.rings.length&&this.createBonds(this.vertices[V[a]],l,t)}},{key:"drawEdges",value:function(e){for(var t=this,i=0;i<this.edges.length;i++){var n=this.edges[i],r=this.vertices[n.source],s=this.vertices[n.target],o=r.value.element,h=s.value.element,a=r.position,l=s.position,u=this.getEdgeNormals(n),c=("gradient"+r.value.element.toUpperCase()+s.value.element.toUpperCase(),ArrayHelper.clone(u));if(ArrayHelper.each(c,function(e){e.multiply(10),e.add(a)}),"="==n.bond||"="==this.matchRingBonds(r,s)){var g=this.areVerticesInSameRing(r,s),v=this.chooseSide(r,s,c);if(g){var d=this.getLargestCommonRing(r,s),f=d.center;ArrayHelper.each(u,function(e){e.multiply(t.settings.bondSpacing)});var p=null;p=f.sameSideAs(r.position,s.position,Vector2.add(a,u[0]))?new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0])):new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1])),p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.from.x,p.to.y,p.to.x,p.from.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else if(0==v.anCount&&v.bnCount>1||0==v.bnCount&&v.anCount>1){ArrayHelper.each(u,function(e){e.multiply(t.settings.bondSpacing/2)});var y=new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0])),m=new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1]));this.line(y.a.x,y.a.y,y.b.x,y.b.y,o,h),this.line(m.a.x,m.a.y,m.b.x,m.b.y,o,h)}else if(v.sideCount[0]>v.sideCount[1]){ArrayHelper.each(u,function(e){e.multiply(t.settings.bondSpacing)});var p=new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0]));p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else if(v.sideCount[0]<v.sideCount[1]){ArrayHelper.each(u,function(e){e.multiply(t.settings.bondSpacing)});var p=new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1]));p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else if(v.totalSideCount[0]>v.totalSideCount[1]){ArrayHelper.each(u,function(e){e.multiply(t.settings.bondSpacing)});var p=new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0]));p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else if(v.totalSideCount[0]<=v.totalSideCount[1]){ArrayHelper.each(u,function(e){e.multiply(t.settings.bondSpacing)});var p=new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1]));p.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}}else if("#"===n.bond){ArrayHelper.each(u,function(e){e.multiply(t.settings.bondSpacing/1.5)});var b=new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0])),x=new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1]));b.shorten(this.settings.bondLength-this.settings.shortBondLength),x.shorten(this.settings.bondLength-this.settings.shortBondLength),this.line(b.a.x,b.a.y,b.b.x,b.b.y,o,h),this.line(x.a.x,x.a.y,x.b.x,x.b.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else this.line(a.x,a.y,l.x,l.y,o,h);if(e){var A=Vector2.midpoint(a,l);this.debugText(A.x,A.y,"id: "+i)}}}},{key:"drawVertices",value:function(e){for(var t=0;t<this.vertices.length;t++){var i=this.vertices[t],n=i.value,r=this.getBondCount(i),s=1==n.element.length?n.element.toUpperCase():n.element;if(e){var o=i.id+" "+ArrayHelper.print(n.ringbonds);this.debugText(i.position.x,i.position.y,"id: "+o)}var h=this.maxBonds[s]-r;n.bracket&&(h=n.bracket.hcount);var a=0;if(n.bracket&&(a=n.bracket.charge),i.isTerminal()){var l=i.getTextDirection(this.vertices);this.text(i.position.x,i.position.y,s,"element "+n.element.toLowerCase(),!0,h,l,!0,a)}else if("c"!==n.element.toLowerCase()){var l=i.getTextDirection(this.vertices);this.text(i.position.x,i.position.y,s,"element "+n.element.toLowerCase(),!0,h,l,!1,a)}}if(this.settings.debug)for(var t=0;t<this.rings.length;t++)this.drawPoint(this.rings[t].center,"id: "+this.rings[t].id);for(var t=0;t<this.rings.length;t++){var u=this.rings[t];u.isBenzene(this.vertices)&&(this.ctx.save(),this.ctx.strokeStyle=this.colors.C,this.ctx.lineWidth=1.5,this.ctx.beginPath(),this.ctx.arc(u.center.x+this.offsetX,u.center.y+this.offsetY,u.radius-10,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore())}}},{key:"position",value:function(){for(var e=0,t=0;t<this.rings.length;t++)this.rings[t].isBridged&&(e=this.rings[t].members[t]);this.createBonds(this.vertices[e]),this.resolvePrimaryOverlaps()}},{key:"clearPositions",value:function(){this.backupVertices=[],this.backupRings=[];for(var e=0;e<this.vertices.length;e++){var t=this.vertices[e];this.backupVertices.push(t.clone()),t.positioned=!1,t.position=new Vector2}for(var e=0;e<this.rings.length;e++){var i=this.rings[e];this.backupRings.push(i.clone()),i.positioned=!1,i.center=new Vector2}}},{key:"restorePositions",value:function(){for(var e=0;e<this.backupVertices.length;e++)this.vertices[e]=this.backupVertices[e];for(var e=0;e<this.backupRings.length;e++)this.rings[e]=this.backupRings[e]}},{key:"createRing",value:function(e,t,i,n){var r=this;if(!e.positioned){var s=e.getOrderedNeighbours(this.ringConnections);t=t?t:new Vector2(0,0);var o=i?Vector2.subtract(i.position,t).angle():0,h=MathHelper.polyCircumradius(r.settings.bondLength,e.size());e.radius=h;var a=MathHelper.centralAngle(e.size());e.centralAngle=a;var l=o;if(e.eachMember(this.vertices,function(i){var n=r.vertices[i];n.positioned||(n.position.x=t.x+Math.cos(l)*h,n.position.y=t.y+Math.sin(l)*h),l+=a,(!e.isBridged||e.rings.length<3)&&(n.positioned=!0)},i?i.id:null,n?n.id:null),e.isBridged){var u=ArrayHelper.merge(e.members,e.insiders);this.forceLayout(u,t,i.id,e)}this.vertices[e.members[0]].value.addAnchoredRing(e),e.positioned=!0,e.center=t;for(var c=0;c<s.length;c++){var g=this.getRing(s[c].neighbour);if(!g.positioned){var v=RingConnection.getVertices(this.ringConnections,e.id,g.id);if(2==v.length){e.isFused=!0,g.isFused=!0;var d=this.vertices[v[0]],f=this.vertices[v[1]],p=Vector2.midpoint(d.position,f.position),y=Vector2.normals(d.position,f.position);ArrayHelper.each(y,function(e){e.normalize()});var m=MathHelper.polyCircumradius(r.settings.bondLength,g.size()),b=MathHelper.apothem(m,g.size());ArrayHelper.each(y,function(e){e.multiply(b)}),ArrayHelper.each(y,function(e){e.add(p)});var x=y[0];this.isPointInRing(x)&&(x=y[1]);var A=Vector2.subtract(d.position,x),k=Vector2.subtract(f.position,x);A.clockwise(k)===-1?this.createRing(g,x,d,f):this.createRing(g,x,f,d)}else if(1==v.length){e.isSpiro=!0,g.isSpiro=!0;var d=this.vertices[v[0]],x=Vector2.subtract(t,d.position);x.invert(),x.normalize();var m=MathHelper.polyCircumradius(r.settings.bondLength,g.size());x.multiply(m),x.add(d.position),this.createRing(g,x,d)}}}for(var c=0;c<e.members.length;c++)for(var C=this.vertices[e.members[c]],R=C.getNeighbours(),w=0;w<R.length;w++)if(!e.thisOrNeighboursContain(this.rings,R[w])){var V=this.vertices[R[w]];this.createBonds(V,C,e.center)}}}},{key:"rotateSubtree",value:function(e,t,i,n){var r=this;this.traverseTree(t,e,function(e){e.position.rotateAround(i,n);for(var t=0;t<e.value.anchoredRings.length;t++)r.rings[e.value.anchoredRings[t]].center.rotateAround(i,n)})}},{key:"resolvePrimaryOverlaps",value:function(){for(var e=[],t=[],i=new Array(this.vertices.length),n=0;n<this.rings.length;n++)for(var r=this.rings[n],s=0;s<r.members.length;s++){var o=this.vertices[r.members[s]];if(!i[o.id]){if(i[o.id]=!0,o.getNeighbours().length>2){for(var h=[],a=0;a<o.value.rings.length;a++)h.push(o.value.rings[a]);e.push({common:o,rings:h,vertices:this.getNonRingNeighbours(o.id)})}if(2==o.value.rings.length&&4==o.getNeighbours().length){var l=this.getNonRingNeighbours(o.id)[0];if(l&&l.getNeighbours().length>1){var u=this.getCommonRingbondNeighbour(o);t.push({common:o,other:u,vertex:l})}}}}for(var n=0;n<t.length;n++){var c=t[n],g=-c.vertex.position.getRotateToAngle(c.other.position,c.common.position);this.rotateSubtree(c.vertex.id,c.common.id,g+Math.PI,c.common.position)}for(var n=0;n<e.length;n++){var v=e[n];if(1==v.vertices.length){var d=v.vertices[0];if(1==d.getNeighbours().length){d.flippable=!0,d.flipCenter=v.common.id;for(var s=0;s<v.rings.length;s++)d.flipRings.push(v.rings[s])}}else if(2==v.vertices.length){var g=(2*Math.PI-this.getRing(v.rings[0]).getAngle())/6,d=v.vertices[0],f=v.vertices[1];if(d.backAngle-=g,f.backAngle+=g,this.rotateSubtree(d.id,v.common.id,g,v.common.position),this.rotateSubtree(f.id,v.common.id,-g,v.common.position),1==d.getNeighbours().length){d.flippable=!0,d.flipCenter=v.common.id,d.flipNeighbour=f.id;for(var s=0;s<v.rings.length;s++)d.flipRings.push(v.rings[s])}if(1==f.getNeighbours().length){f.flippable=!0,f.flipCenter=v.common.id,f.flipNeighbour=d.id;for(var s=0;s<v.rings.length;s++)f.flipRings.push(v.rings[s])}}}}},{key:"resolveSecondaryOverlaps",value:function(e){for(var t=0;t<e.length;t++)if(e[t].score>this.settings.bondLength/5){var i=this.vertices[e[t].id];if(i.flippable){var n=i.flipRings[0]?this.rings[i.flipRings[0]]:null,r=i.flipRings[1]?this.rings[i.flipRings[1]]:null,s=this.vertices[i.flipCenter].position;
if(n&&r){var o=n.members.length>r.members.length?n:r;r=n.members.length<r.members.length?n:r,n=o}n&&n.allowsFlip()?(i.position.rotateTo(n.center,s),n.flipped(),null!==i.flipNeighbour):r&&r.allowsFlip()&&(i.position.rotateTo(r.center,s),r.flipped(),null!==i.flipNeighbour)}}}},{key:"createBonds",value:function(e,t,i,n){if(!e.positioned){if(t)if(0!=t.value.rings.length||e.value.isBridge){if(t.value.isBridgeNode&&e.value.isBridge){var r=(this.getTargets(e.id,t.id,e.value.bridgedRing),Vector2.subtract(i,t.position));r.normalize(),r.multiply(this.settings.bondLength),e.position.add(t.position),e.position.add(r),e.previousPosition=t.position,e.positioned=!0}else if(e.value.isBridge){var s=(this.getTargets(e.id,t.id,e.value.bridgedRing),new Vector2(this.settings.bondLength,0));s.rotate(i),s.add(t.position),e.position=s,e.previousPosition=t.position,e.positioned=!0}else if(1==t.value.rings.length){var r=Vector2.subtract(i,t.position);r.invert(),r.normalize(),r.multiply(this.settings.bondLength),e.position.add(t.position),e.position.add(r),e.previousPosition=t.position,e.positioned=!0}else if(2==t.value.rings.length){var o=this.getRing(t.value.rings[0]),h=this.getRing(t.value.rings[1]),a=Vector2.subtract(h.center,o.center),l=Vector2.subtract(t.position,o.center),u=Vector2.scalarProjection(l,a);a.normalize(),a.multiply(u),a.add(o.center);var r=Vector2.subtract(a,t.position);r.invert(),r.normalize(),r.multiply(this.settings.bondLength),e.position.add(t.position),e.position.add(r),e.previousPosition=t.position,e.positioned=!0}}else{var s=new Vector2(this.settings.bondLength,0);s.rotate(i),s.add(t.position),e.position=s,e.previousPosition=t.position,e.positioned=!0}else{var c=new Vector2(this.settings.bondLength,0);c.rotate(MathHelper.toRad(-120)),e.previousPosition=c,e.position=new Vector2(this.settings.bondLength,0),e.angle=MathHelper.toRad(-120),e.positioned=!0}if(Ring.contains(this.rings,e.id)){var g=this.getRing(e.value.rings[0]),v=Vector2.subtract(e.previousPosition,e.position);v.invert(),v.normalize();var d=MathHelper.polyCircumradius(this.settings.bondLength,g.size());v.multiply(d),v.add(e.position),this.createRing(g,v,e)}else{var f=e.getNeighbours();t&&(f=ArrayHelper.remove(f,t.id));var p=e.getAngle();if(1==f.length){var y=this.vertices[f[0]];if("#"===e.value.bond||t&&"#"===t.value.bond)y.angle=p,this.createBonds(y,e,y.angle,-n);else{var m=Math.random()<.5?-1:1;n||(n=m),y.angle=MathHelper.toRad(60)*n,this.createBonds(y,e,p+y.angle,-n)}}else if(2==f.length){var b=this.getTreeDepth(e.id,f[0]),x=this.getTreeDepth(e.id,f[1]),A=0,k=1;if(b>x&&(A=1,k=0),1===e.position.clockwise(e.previousPosition)){var C=this.vertices[f[A]],R=this.vertices[f[k]];R.angle=MathHelper.toRad(60),C.angle=-MathHelper.toRad(60),this.createBonds(R,e,p+R.angle),this.createBonds(C,e,p+C.angle)}else{var C=this.vertices[f[A]],R=this.vertices[f[k]];R.angle=-MathHelper.toRad(60),C.angle=MathHelper.toRad(60),this.createBonds(C,e,p+C.angle),this.createBonds(R,e,p+R.angle)}}else if(3==f.length){var w=this.getTreeDepth(e.id,f[0]),V=this.getTreeDepth(e.id,f[1]),N=this.getTreeDepth(e.id,f[2]),u=this.vertices[f[0]],B=this.vertices[f[1]],d=this.vertices[f[2]];V>w&&V>N?(u=this.vertices[f[1]],B=this.vertices[f[0]],d=this.vertices[f[2]]):N>w&&N>V&&(u=this.vertices[f[2]],B=this.vertices[f[0]],d=this.vertices[f[1]]),this.createBonds(u,e,p),this.createBonds(B,e,p+MathHelper.toRad(90)),this.createBonds(d,e,p-MathHelper.toRad(90))}else if(4==f.length){var w=this.getTreeDepth(e.id,f[0]),V=this.getTreeDepth(e.id,f[1]),N=this.getTreeDepth(e.id,f[2]),H=this.getTreeDepth(e.id,f[3]),M=this.vertices[f[0]],S=this.vertices[f[1]],T=this.vertices[f[2]],L=this.vertices[f[3]];V>w&&V>N&&V>H?(M=this.vertices[f[1]],S=this.vertices[f[0]],T=this.vertices[f[2]],L=this.vertices[f[3]]):N>w&&N>V&&N>H?(M=this.vertices[f[2]],S=this.vertices[f[0]],T=this.vertices[f[1]],L=this.vertices[f[3]]):H>w&&H>V&&H>N&&(M=this.vertices[f[3]],S=this.vertices[f[0]],T=this.vertices[f[1]],L=this.vertices[f[2]]),this.createBonds(M,e,p-MathHelper.toRad(36)),this.createBonds(S,e,p+MathHelper.toRad(36)),this.createBonds(T,e,p-MathHelper.toRad(108)),this.createBonds(L,e,p+MathHelper.toRad(108))}}}}},{key:"getTargets",value:function(e,t,i){var n=this,r=new Array,s=function e(t,s){for(var o=n.vertices[t].getNeighbours(),h=0;h<o.length;h++){var a=n.vertices[o[h]];a.id!==s&&(a.value.isBridge?e(a.id,t):a.value.hasRing(i)&&r.push(a.id))}};return s(e,t),r}},{key:"getCommonRingbondNeighbour",value:function(e){for(var t=e.getNeighbours(),i=0;i<t.length;i++){var n=this.vertices[t[i]];if(ArrayHelper.containsAll(n.value.rings,e.value.rings))return n}}},{key:"isPointInRing",value:function(e){for(var t=0;t<this.rings.length;t++){var i=this.rings[t].getPolygon(this.vertices);if(e.isInPolygon(i))return!0}return!1}},{key:"isEdgeInRing",value:function(e){var t=this.vertices[e.source],i=this.vertices[e.target];return this.areVerticesInSameRing(t,i)}},{key:"isRingAromatic",value:function(e){for(var t=0;t<e.members.length;t++)if(!this.isVertexInAromaticRing(e.members[t]))return!1;return!0}},{key:"isEdgeInAromaticRing",value:function(e){return this.isVertexInAromaticRing(e.source)&&this.isVertexInAromaticRing(e.target)}},{key:"isVertexInAromaticRing",value:function(e){var t=this.vertices[e].value.element;return t==t.toLowerCase()}},{key:"getEdgeNormals",value:function(e){var t=this.vertices[e.source].position,i=this.vertices[e.target].position,n=Vector2.normals(t,i);return ArrayHelper.each(n,function(e){e.normalize()}),n}},{key:"getNormals",value:function(e,t){var e=e.position,t=t.position,i=Vector2.normals(e,t);return ArrayHelper.each(i,function(e){e.normalize()}),i}},{key:"getTreeDepth",value:function(e,t){for(var i=this.vertices[t].getSpanningTreeNeighbours(e),n=0,r=0;r<i.length;r++){var s=i[r],o=this.getTreeDepth(t,s);o>n&&(n=o)}return n+1}},{key:"traverseTree",value:function(e,t,i){var n=this.vertices[t],r=n.getSpanningTreeNeighbours(e);i(n);for(var s=0;s<r.length;s++)this.traverseTree(t,r[s],i)}},{key:"getMaxDepth",value:function(e,t,i){i=i?i:0;for(var n=e.getNeighbours(),r=0,s=0;s<n.length;s++)if(n[s]!=t.id){var o=this.vertices[n[s]],h=0;h=o.value.getRingbondCount()>0?100:this.getMaxDepth(this.vertices[n[s]],e,i+1),h>r&&(r=h)}return r}},{key:"getBondCount",value:function(e){for(var t=0,i=0;i<e.edges.length;i++)t+=this.edges[e.edges[i]].getBondCount();return t}},{key:"getNonRingNeighbours",value:function(e){for(var t=[],i=this.vertices[e],n=i.getNeighbours(),r=0;r<n.length;r++){var s=this.vertices[n[r]],o=ArrayHelper.intersection(i.value.rings,s.value.rings).length;0===o&&0==s.value.isBridge&&t.push(s)}return t}}]),e}(),Edge=function(){function e(t,i,n){_classCallCheck(this,e),this.id=null,this.source=t,this.target=i,this.weight=n,this.bond="-",this.isInAromaticRing=!1}return _createClass(e,[{key:"getBondCount",value:function(){return e.bonds[this.bond]}}],[{key:"bonds",get:function(){return{"-":1,"/":1,"\\":1,"=":2,"#":3,$:4}}}]),e}(),Line=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Vector2(0,0),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Vector(0,0),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,e),this.from=t,this.to=i,this.elementFrom=n,this.elementTo=r}return _createClass(e,[{key:"clone",value:function(){return new e(this.elementFrom,this.elementTo,this.from.clone(),this.to.clone())}},{key:"getLength",value:function(){return Math.sqrt(Math.pow(this.to.x-this.from.x,2)+Math.pow(this.to.y-this.from.y,2))}},{key:"getAngle",value:function(){var e=Vector2.subtract(this.getRightVector(),this.getLeftVector());return e.angle()}},{key:"getRightVector",value:function(){return this.from.x<this.to.x?this.to:this.from}},{key:"getLeftVector",value:function(){return this.from.x<this.to.x?this.from:this.to}},{key:"getRightElement",value:function(){return this.from.x<this.to.x?this.elementTo:this.elementFrom}},{key:"getLeftElement",value:function(){return this.from.x<this.to.x?this.elementFrom:this.elementTo}},{key:"setRightVector",value:function(e,t){this.from.x<this.to.x?this.to.set(e,t):this.from.set(e,t)}},{key:"rotateToXAxis",value:function(){var e=this.getLeftVector();this.setRightVector(e.x+this.getLength(),e.y)}},{key:"rotate",value:function(e){var t=this.getLeftVector(),i=this.getRightVector(),n=Math.cos(e)*(i.x-t.x)-Math.sin(e)*(i.y-t.y)+t.x,r=Math.sin(e)*(i.x-t.x)-Math.cos(e)*(i.y-t.y)+t.y;return this.setRightVector(n,r),this}},{key:"shortenFrom",value:function(e){var t=Vector2.subtract(this.to,this.from);return t.normalize(),t.multiply(e),this.from.add(t),this}},{key:"shortenTo",value:function(e){var t=Vector2.subtract(this.from,this.to);return t.normalize(),t.multiply(e),this.to.add(t),this}},{key:"shorten",value:function(e){var t=Vector2.subtract(this.from,this.to);return t.normalize(),t.multiply(e/2),this.to.add(t),this.from.subtract(t),this}}]),e}(),MathHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"round",value:function(e,t){return t=t?t:1,Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"meanAngle",value:function(e){for(var t=0,i=0,n=0;n<e.length;n++)t+=Math.sin(e[n]),i+=Math.cos(e[n]);return Math.atan2(t/e.length,i/e.length)}},{key:"innerAngle",value:function(t){return e.toRad(180*(t-2)/t)}},{key:"polyCircumradius",value:function(e,t){return e/(2*Math.sin(Math.PI/t))}},{key:"apothem",value:function(e,t){return e*Math.cos(Math.PI/t)}},{key:"centralAngle",value:function(t){return e.toRad(360/t)}},{key:"toDeg",value:function(e){return 180*e/Math.PI}},{key:"toRad",value:function(e){return e*Math.PI/180}}]),e}(),Pair=function(){function e(t,i){_classCallCheck(this,e),this.first=t,this.second=i}return _createClass(e,[{key:"getHash",value:function(){return.5*(this.first+this.second)*(this.first+this.second+1)+(this.first+this.second)}},{key:"contains",value:function(e){return this.first===e||this.second===e}}],[{key:"createUniquePairs",value:function(t){for(var i=[],n=0;n<t.length;n++)for(var r=t[n],s=n+1;s<t.length;s++){var o=t[s];i.push(new e(r,o))}return i}}]),e}(),Ring=function(){function e(t,i,n){_classCallCheck(this,e),this.id=null,this.ringbond=t,this.source=i,this.target=n,this.members=new Array,this.insiders=new Array,this.neighbours=new Array,this.positioned=!1,this.center=new Vector2,this.rings=new Array,this.isBridged=!1,this.template=null,this.isSpiro=!1,this.isFused=!1,this.radius=0,this.centralAngle=0,this.flip=!0}return _createClass(e,[{key:"clone",value:function t(){var t=new e(this.ringbond,this.source,this.target);return t.id=this.id,t.members=ArrayHelper.clone(this.members),t.insiders=ArrayHelper.clone(this.insiders),t.neighbours=ArrayHelper.clone(this.neighbours),t.positioned=this.positioned,t.center=ArrayHelper.clone(this.center),t.rings=ArrayHelper.clone(this.rings),t.isBridged=this.isBridged,t.template=this.template,t.isSpiro=this.isSpiro,t.isFused=this.isFused,t.radius=this.radius,t.centralAngle=this.centralAngle,t.flip=this.flip,t}},{key:"allowsFlip",value:function(){return this.flip&&this.members.length>4}},{key:"flipped",value:function(){this.members.length<8&&(this.flip=!1)}},{key:"size",value:function(){return this.members.length}},{key:"getPolygon",value:function(e){for(var t=[],i=0;i<this.members.length;i++)t.push(e[this.members[i]].position);return t}},{key:"getAngle",value:function(){return Math.PI-this.centralAngle}},{key:"eachMember",value:function(e,t,i,n){for(var i=i||0===i?i:this.members[0],r=i,s=0;null!=r&&s<100;){var o=r;t(o),r=e[r].getNextInRing(e,this.id,n),n=o,r==i&&(r=null),99==s&&console.log("crap"),s++}}},{key:"getOrderedNeighbours",value:function(e){for(var t=[],i=0;i<this.neighbours.length;i++){var n=RingConnection.getVertices(e,this.id,this.neighbours[i]);t.push({n:n.length,neighbour:this.neighbours[i]})}return t.sort(function(e,t){return t.n-e.n}),t}},{key:"isBenzene",value:function(e){for(var t=0;t<this.members.length;t++){var i=e[this.members[t]].value.element.charAt(0);if(i==i.toUpperCase())return!1}return!0}},{key:"contains",value:function(e){for(var t=0;t<this.members.length;t++)if(this.members[t]==e)return!0;return!1}},{key:"thisOrNeighboursContain",value:function(t,i){for(var n=0;n<this.neighbours.length;n++)if(e.getRing(t,this.neighbours[n]).contains(i))return!0;return!!this.contains(i)}},{key:"hasSource",value:function(){return!(void 0===this.source||null===this.source)}},{key:"hasTarget",value:function(){return!(void 0===this.target||null===this.target)}},{key:"hasSourceAndTarget",value:function(){return this.hasSource()&&this.hasTarget()}},{key:"getRing",value:function(e,t){for(var i=0;i<e.length;i++)if(e[i].id==t)return e[i]}}],[{key:"contains",value:function(e,t){for(var i=0;i<e.length;i++)if(e[i].contains(t))return!0;return!1}}]),e}(),RingConnection=function(){function e(t,i){_classCallCheck(this,e),this.id=null,this.rings=new Pair(t,i),this.vertices=[]}return _createClass(e,[{key:"addVertex",value:function(e){ArrayHelper.contains(this.vertices,{value:e})||this.vertices.push(e)}},{key:"isBridge",value:function(e){if(this.vertices.length>2)return!0;for(var t=0;t<this.vertices.length;t++){var i=this.vertices[t];if(e[i].value.rings.length>2)return!0}return!1}},{key:"updateOther",value:function(e,t){this.rings.first===t?this.rings.second=e:this.rings.first=e}}],[{key:"isBridge",value:function(e,t,i,n){for(var r=null,s=0;s<e.length;s++){r=e[s];var o=r.rings;if(o.first===i&&o.second===n||o.first===n&&o.second===i)return r.isBridge(t)}}},{key:"getNeighbours",value:function(e,t){for(var i=[],n=0;n<e.length;n++){var r=e[n].rings;r.first==t?i.push(r.second):r.second==t&&i.push(r.first)}return i}},{key:"getVertices",value:function(e,t,i){for(var n=0;n<e.length;n++){var r=e[n];if(r.rings.first==t&&r.rings.second==i||r.rings.first==i&&r.rings.second==t)return r.vertices}}}]),e}(),smiles=function(){function e(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}function t(e,i,n,r){this.message=e,this.expected=i,this.found=n,this.location=r,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,t)}function i(e){function i(t){var i,n,r=it[t];if(r)return r;for(i=t-1;!it[i];)i--;for(r=it[i],r={line:r.line,column:r.column,seenCR:r.seenCR};i<t;)n=e.charAt(i),"\n"===n?(r.seenCR||r.line++,r.column=1,r.seenCR=!1):"\r"===n||"\u2028"===n||"\u2029"===n?(r.line++,r.column=1,r.seenCR=!0):(r.column++,r.seenCR=!1),i++;return it[t]=r,r}function n(e,t){var n=i(e),r=i(t);return{start:{offset:e,line:n.line,column:n.column},end:{offset:t,line:r.line,column:r.column}}}function r(e){et<nt||(et>nt&&(nt=et,rt=[]),rt.push(e))}function s(e,i,n,r){function s(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}function o(e,t){function i(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0100-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1000-\uFFFF]/g,function(e){return"\\u"+t(e)})}var n,r,s,o=new Array(e.length);for(s=0;s<e.length;s++)o[s]=e[s].description;return n=e.length>1?o.slice(0,-1).join(", ")+" or "+o[e.length-1]:o[0],r=t?'"'+i(t)+'"':"end of input","Expected "+n+" but "+r+" found."}return null!==i&&s(i),new t(null!==e?e:o(i,n),i,n,r)}function o(){var e,t,i,n,r,s,u,c,g,v;if(e=et,t=et,i=a(),i!==w){for(n=[],r=h();r!==w;)n.push(r),r=h();if(n!==w){for(r=[],s=et,u=l(),u===w&&(u=null),u!==w?(c=f(),c!==w?(u=[u,c],s=u):(et=s,s=w)):(et=s,s=w);s!==w;)r.push(s),s=et,u=l(),u===w&&(u=null),u!==w?(c=f(),c!==w?(u=[u,c],s=u):(et=s,s=w)):(et=s,s=w);if(r!==w){for(s=[],u=h();u!==w;)s.push(u),u=h();if(s!==w)if(u=l(),u===w&&(u=null),u!==w)if(c=o(),c===w&&(c=null),c!==w){for(g=[],v=h();v!==w;)g.push(v),v=h();g!==w?(i=[i,n,r,s,u,c,g],t=i):(et=t,t=w)}else et=t,t=w;else et=t,t=w;else et=t,t=w}else et=t,t=w}else et=t,t=w}else et=t,t=w;return t!==w&&(tt=e,t=B(t)),e=t}function h(){var t,i,n,s,h,a;return t=et,i=et,40===e.charCodeAt(et)?(n=H,et++):(n=w,0===st&&r(M)),n!==w?(s=l(),s===w&&(s=null),s!==w?(h=o(),h!==w?(41===e.charCodeAt(et)?(a=S,et++):(a=w,0===st&&r(T)),a!==w?(n=[n,s,h,a],i=n):(et=i,i=w)):(et=i,i=w)):(et=i,i=w)):(et=i,i=w),i!==w&&(tt=t,i=L(i)),t=i}function a(){var e,t;return e=et,t=c(),t===w&&(t=g(),t===w&&(t=u(),t===w&&(t=v()))),t!==w&&(tt=e,t=P(t)),e=t}function l(){var t,i;return t=et,I.test(e.charAt(et))?(i=e.charAt(et),et++):(i=w,0===st&&r(E)),i!==w&&(tt=t,i=F(i)),t=i}function u(){var t,i,n,s,o,h,a,l,u,c;return t=et,i=et,91===e.charCodeAt(et)?(n=O,et++):(n=w,0===st&&r(_)),n!==w?(s=k(),s===w&&(s=null),s!==w?(e.substr(et,2)===z?(o=z,et+=2):(o=w,0===st&&r(W)),o===w&&(e.substr(et,2)===D?(o=D,et+=2):(o=w,0===st&&r(X)),o===w&&(o=g(),o===w&&(o=d(),o===w&&(o=v())))),o!==w?(h=p(),h===w&&(h=null),h!==w?(a=x(),a===w&&(a=null),a!==w?(l=y(),l===w&&(l=null),l!==w?(u=A(),u===w&&(u=null),u!==w?(93===e.charCodeAt(et)?(c=U,et++):(c=w,0===st&&r(q)),c!==w?(n=[n,s,o,h,a,l,u,c],i=n):(et=i,i=w)):(et=i,i=w)):(et=i,i=w)):(et=i,i=w)):(et=i,i=w)):(et=i,i=w)):(et=i,i=w)):(et=i,i=w),i!==w&&(tt=t,i=j(i)),t=i}function c(){var t,i,n,s;return t=et,i=et,66===e.charCodeAt(et)?(n=Y,et++):(n=w,0===st&&r(G)),n!==w?(114===e.charCodeAt(et)?(s=$,et++):(s=w,0===st&&r(K)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(et=i,i=w)):(et=i,i=w),i===w&&(i=et,67===e.charCodeAt(et)?(n=Z,et++):(n=w,0===st&&r(J)),n!==w?(108===e.charCodeAt(et)?(s=Q,et++):(s=w,0===st&&r(ee)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(et=i,i=w)):(et=i,i=w),i===w&&(te.test(e.charAt(et))?(i=e.charAt(et),et++):(i=w,0===st&&r(ie)))),i!==w&&(tt=t,i=ne(i)),t=i}function g(){var t,i;return t=et,re.test(e.charAt(et))?(i=e.charAt(et),et++):(i=w,0===st&&r(se)),i!==w&&(tt=t,i=P(i)),t=i}function v(){var t,i;return t=et,42===e.charCodeAt(et)?(i=oe,et++):(i=w,0===st&&r(he)),i!==w&&(tt=t,i=ae(i)),t=i}function d(){var t,i,n,s;return t=et,i=et,le.test(e.charAt(et))?(n=e.charAt(et),et++):(n=w,0===st&&r(ue)),n!==w?(ce.test(e.charAt(et))?(s=e.charAt(et),et++):(s=w,0===st&&r(ge)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(et=i,i=w)):(et=i,i=w),i!==w&&(tt=t,i=ve(i)),t=i}function f(){var t,i,n,s,o;return t=et,i=et,37===e.charCodeAt(et)?(n=de,et++):(n=w,0===st&&r(fe)),n!==w?(pe.test(e.charAt(et))?(s=e.charAt(et),et++):(s=w,0===st&&r(ye)),s!==w?(me.test(e.charAt(et))?(o=e.charAt(et),et++):(o=w,0===st&&r(be)),o!==w?(n=[n,s,o],i=n):(et=i,i=w)):(et=i,i=w)):(et=i,i=w),i===w&&(me.test(e.charAt(et))?(i=e.charAt(et),et++):(i=w,0===st&&r(be))),i!==w&&(tt=t,i=xe(i)),t=i}function p(){var t,i,n,s,o,h,a;return t=et,i=et,64===e.charCodeAt(et)?(n=Ae,et++):(n=w,0===st&&r(ke)),n!==w?(64===e.charCodeAt(et)?(s=Ae,et++):(s=w,0===st&&r(ke)),s===w&&(s=et,e.substr(et,2)===Ce?(o=Ce,et+=2):(o=w,0===st&&r(Re)),o!==w?(we.test(e.charAt(et))?(h=e.charAt(et),et++):(h=w,0===st&&r(Ve)),h!==w?(o=[o,h],s=o):(et=s,s=w)):(et=s,s=w),s===w&&(s=et,e.substr(et,2)===Ne?(o=Ne,et+=2):(o=w,0===st&&r(Be)),o!==w?(we.test(e.charAt(et))?(h=e.charAt(et),et++):(h=w,0===st&&r(Ve)),h!==w?(o=[o,h],s=o):(et=s,s=w)):(et=s,s=w),s===w&&(s=et,e.substr(et,2)===He?(o=He,et+=2):(o=w,0===st&&r(Me)),o!==w?(Se.test(e.charAt(et))?(h=e.charAt(et),et++):(h=w,0===st&&r(Te)),h!==w?(o=[o,h],s=o):(et=s,s=w)):(et=s,s=w),s===w&&(s=et,e.substr(et,2)===Le?(o=Le,et+=2):(o=w,0===st&&r(Pe)),o!==w?(pe.test(e.charAt(et))?(h=e.charAt(et),et++):(h=w,0===st&&r(ye)),h!==w?(me.test(e.charAt(et))?(a=e.charAt(et),et++):(a=w,0===st&&r(be)),a===w&&(a=null),a!==w?(o=[o,h,a],s=o):(et=s,s=w)):(et=s,s=w)):(et=s,s=w),s===w&&(s=et,e.substr(et,2)===Ie?(o=Ie,et+=2):(o=w,0===st&&r(Ee)),o!==w?(pe.test(e.charAt(et))?(h=e.charAt(et),et++):(h=w,0===st&&r(ye)),h!==w?(me.test(e.charAt(et))?(a=e.charAt(et),et++):(a=w,0===st&&r(be)),a===w&&(a=null),a!==w?(o=[o,h,a],s=o):(et=s,s=w)):(et=s,s=w)):(et=s,s=w)))))),s===w&&(s=null),s!==w?(n=[n,s],i=n):(et=i,i=w)):(et=i,i=w),i!==w&&(tt=t,i=Fe(i)),t=i}function y(){var e,t;return e=et,t=m(),t===w&&(t=b()),t!==w&&(tt=e,t=Oe(t)),e=t}function m(){var t,i,n,s,o,h;return t=et,i=et,43===e.charCodeAt(et)?(n=_e,et++):(n=w,0===st&&r(ze)),n!==w?(43===e.charCodeAt(et)?(s=_e,et++):(s=w,0===st&&r(ze)),s===w&&(s=et,pe.test(e.charAt(et))?(o=e.charAt(et),et++):(o=w,0===st&&r(ye)),o!==w?(me.test(e.charAt(et))?(h=e.charAt(et),et++):(h=w,0===st&&r(be)),h===w&&(h=null),h!==w?(o=[o,h],s=o):(et=s,s=w)):(et=s,s=w)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(et=i,i=w)):(et=i,i=w),i!==w&&(tt=t,i=We(i)),t=i}function b(){var t,i,n,s,o,h;return t=et,i=et,45===e.charCodeAt(et)?(n=De,et++):(n=w,0===st&&r(Xe)),n!==w?(45===e.charCodeAt(et)?(s=De,et++):(s=w,0===st&&r(Xe)),s===w&&(s=et,pe.test(e.charAt(et))?(o=e.charAt(et),et++):(o=w,0===st&&r(ye)),o!==w?(me.test(e.charAt(et))?(h=e.charAt(et),et++):(h=w,0===st&&r(be)),h===w&&(h=null),h!==w?(o=[o,h],s=o):(et=s,s=w)):(et=s,s=w)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(et=i,i=w)):(et=i,i=w),i!==w&&(tt=t,i=Ue(i)),t=i}function x(){var t,i,n,s;return t=et,i=et,72===e.charCodeAt(et)?(n=qe,et++):(n=w,0===st&&r(je)),n!==w?(me.test(e.charAt(et))?(s=e.charAt(et),et++):(s=w,0===st&&r(be)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(et=i,i=w)):(et=i,i=w),i!==w&&(tt=t,i=Ye(i)),t=i}function A(){var t,i,n,s,o,h,a;if(t=et,i=et,58===e.charCodeAt(et)?(n=Ge,et++):(n=w,0===st&&r($e)),n!==w){if(s=et,pe.test(e.charAt(et))?(o=e.charAt(et),et++):(o=w,0===st&&r(ye)),o!==w){for(h=[],me.test(e.charAt(et))?(a=e.charAt(et),et++):(a=w,0===st&&r(be));a!==w;)h.push(a),me.test(e.charAt(et))?(a=e.charAt(et),et++):(a=w,0===st&&r(be));h!==w?(o=[o,h],s=o):(et=s,s=w)}else et=s,s=w;s===w&&(Ke.test(e.charAt(et))?(s=e.charAt(et),et++):(s=w,0===st&&r(Ze))),s!==w?(n=[n,s],i=n):(et=i,i=w)}else et=i,i=w;return i!==w&&(tt=t,i=Je(i)),t=i}function k(){var t,i,n,s,o;return t=et,i=et,pe.test(e.charAt(et))?(n=e.charAt(et),et++):(n=w,0===st&&r(ye)),n!==w?(me.test(e.charAt(et))?(s=e.charAt(et),et++):(s=w,0===st&&r(be)),s===w&&(s=null),s!==w?(me.test(e.charAt(et))?(o=e.charAt(et),et++):(o=w,0===st&&r(be)),o===w&&(o=null),o!==w?(n=[n,s,o],i=n):(et=i,i=w)):(et=i,i=w)):(et=i,i=w),i!==w&&(tt=t,i=Qe(i)),t=i}var C,R=arguments.length>1?arguments[1]:{},w={},V={chain:o},N=o,B=function(e){for(var t=[],i=[],n=0;n<e[1].length;n++)t.push(e[1][n]);for(var n=0;n<e[2].length;n++){var r=e[2][n][0]?e[2][n][0]:"-";i.push({bond:r,id:e[2][n][1]})}for(var n=0;n<e[3].length;n++)t.push(e[3][n]);for(var n=0;n<e[6].length;n++)t.push(e[6][n]);return{atom:e[0],isBracket:!!e[0].element,branches:t,branchCount:t.length,ringbonds:i,ringbondCount:i.length,bond:e[4]?e[4]:"-",next:e[5],hasNext:!!e[5]}},H="(",M={type:"literal",value:"(",description:'"("'},S=")",T={type:"literal",value:")",description:'")"'},L=function(e){var t=e[1]?e[1]:"-";return e[2].branchBond=t,e[2]},P=function(e){return e},I=/^[\-=#$:\/\\.]/,E={type:"class",value:"[-=#$:/\\\\.]",description:"[-=#$:/\\\\.]"},F=function(e){return e},O="[",_={type:"literal",value:"[",description:'"["'},z="se",W={type:"literal",value:"se",description:'"se"'},D="as",X={type:"literal",value:"as",description:'"as"'},U="]",q={type:"literal",value:"]",description:'"]"'},j=function(e){return{isotope:e[1],element:e[2],chirality:e[3],hcount:e[4],charge:e[5],class:e[6]}},Y="B",G={type:"literal",value:"B",description:'"B"'},$="r",K={type:"literal",value:"r",description:'"r"'},Z="C",J={type:"literal",value:"C",description:'"C"'},Q="l",ee={type:"literal",value:"l",description:'"l"'},te=/^[NOPSFI]/,ie={type:"class",value:"[NOPSFI]",description:"[NOPSFI]"},ne=function(e){return e.length>1?e.join(""):e},re=/^[bcnops]/,se={type:"class",value:"[bcnops]",description:"[bcnops]"},oe="*",he={type:"literal",value:"*",description:'"*"'},ae=function(e){return e},le=/^[A-Z]/,ue={type:"class",value:"[A-Z]",description:"[A-Z]"},ce=/^[a-z]/,ge={type:"class",value:"[a-z]",description:"[a-z]"},ve=function(e){return e.join("")},de="%",fe={type:"literal",value:"%",description:'"%"'},pe=/^[1-9]/,ye={type:"class",value:"[1-9]",description:"[1-9]"},me=/^[0-9]/,be={type:"class",value:"[0-9]",description:"[0-9]"},xe=function(e){return 1==e.length?Number(e):Number(e.join("").replace("%",""))},Ae="@",ke={type:"literal",value:"@",description:'"@"'},Ce="TH",Re={type:"literal",value:"TH",description:'"TH"'},we=/^[12]/,Ve={type:"class",value:"[12]",description:"[12]"},Ne="AL",Be={type:"literal",value:"AL",description:'"AL"'},He="SP",Me={type:"literal",value:"SP",description:'"SP"'},Se=/^[1-3]/,Te={type:"class",value:"[1-3]",description:"[1-3]"},Le="TB",Pe={type:"literal",value:"TB",description:'"TB"'},Ie="OH",Ee={type:"literal",value:"OH",description:'"OH"'},Fe=function(e){return e[1]?"@"==e[1]?"@@":e[1].join("").replace(",",""):"@"},Oe=function(e){return e},_e="+",ze={type:"literal",value:"+",description:'"+"'},We=function(e){return e[1]?"+"!=e[1]?Number(e[1].join("")):2:1},De="-",Xe={type:"literal",value:"-",description:'"-"'},Ue=function(e){return e[1]?"-"!=e[1]?-Number(e[1].join("")):-2:-1},qe="H",je={type:"literal",value:"H",description:'"H"'},Ye=function(e){return e[1]?Number(e[1]):1},Ge=":",$e={type:"literal",value:":",description:'":"'},Ke=/^[0]/,Ze={type:"class",value:"[0]",description:"[0]"},Je=function(e){return Number(e[1][0]+e[1][1].join(""))},Qe=function(e){return Number(e.join(""))},et=0,tt=0,it=[{line:1,column:1,seenCR:!1}],nt=0,rt=[],st=0;if("startRule"in R){if(!(R.startRule in V))throw new Error("Can't start parsing from rule \""+R.startRule+'".');N=V[R.startRule]}if(C=N(),C!==w&&et===e.length)return C;throw C!==w&&et<e.length&&r({type:"end",description:"end of input"}),s(null,rt,nt<e.length?e.charAt(nt):null,nt<e.length?n(nt,nt+1):n(nt,nt))}return e(t,Error),{SyntaxError:t,parse:i}}(),Vector2=function(){function e(t,i){_classCallCheck(this,e),0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=t.x,this.y=t.y):(this.x=t,this.y=i)}return _createClass(e,[{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e,this.y=t}},{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"toString",value:function(){return"("+this.x+","+this.y+")"}},{key:"add",value:function(e){this.x+=e.x,this.y+=e.y}},{key:"subtract",value:function(e){this.x-=e.x,this.y-=e.y}},{key:"divide",value:function(e){this.x/=e,this.y/=e}},{key:"multiply",value:function(e){this.x*=e,this.y*=e}},{key:"invert",value:function(){this.x=-this.x,this.y=-this.y}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(e){return Math.sqrt((e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y))}},{key:"distanceSq",value:function(e){return(e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y)}},{key:"clockwise",value:function(e){var t=this.y*e.x,i=this.x*e.y;return t>i?-1:t===i?0:1}},{key:"rotate",value:function(t){var i=new e;i.x=this.x*Math.cos(t)-this.y*Math.sin(t),i.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=i.x,this.y=i.y}},{key:"rotateAround",value:function(e,t){var i=Math.sin(e),n=Math.cos(e);this.x-=t.x,this.y-=t.y;var r=this.x*n-this.y*i,s=this.x*i+this.y*n;this.x=r+t.x,this.y=s+t.y}},{key:"rotateTo",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=e.subtract(this,i),s=e.subtract(t,i),o=e.angle(s,r);this.rotateAround(o+n,i)}},{key:"getRotateToAngle",value:function(t,i){var n=e.subtract(this,i),r=e.subtract(t,i),s=e.angle(r,n);return s}},{key:"isInPolygon",value:function(e){for(var t=!1,i=0,n=e.length-1;i<e.length;n=i++)e[i].y>this.y!=e[n].y>this.y&&this.x<(e[n].x-e[i].x)*(this.y-e[i].y)/(e[n].y-e[i].y)+e[i].x&&(t=!t);return t}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"normalize",value:function(){this.divide(this.length())}},{key:"normalized",value:function(){return e.divide(this,this.length())}},{key:"whichSide",value:function(e,t){return(this.x-e.x)*(t.y-e.y)-(this.y-e.y)*(t.x-e.x)}},{key:"sameSideAs",value:function(e,t,i){var n=this.whichSide(e,t),r=i.whichSide(e,t);return n<0&&r<0||0==n&&0==r||n>0&&r>0}}],[{key:"add",value:function(t,i){return new e(t.x+i.x,t.y+i.y)}},{key:"subtract",value:function(t,i){return new e(t.x-i.x,t.y-i.y)}},{key:"multiply",value:function(t,i){return i.x&&i.y?new e(t.x*i.x,t.y*i.y):new e(t.x*i,t.y*i)}},{key:"midpoint",value:function(t,i){return new e((t.x+i.x)/2,(t.y+i.y)/2)}},{key:"normals",value:function(t,i){var n=e.subtract(i,t);return[new e(-n.y,n.x),new e(n.y,-n.x)]}},{key:"divide",value:function(t,i){return i.x&&i.y?new e(t.x/i.x,t.y/i.y):new e(t.x/i,t.y/i)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"angle",value:function(t,i){var n=e.dot(t,i);return Math.acos(n/(t.length()*i.length()))}},{key:"scalarProjection",value:function(t,i){var n=i.normalized();return e.dot(t,n)}}]),e}(),Vertex=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,e),this.id=null,this.value=t,this.position=new Vector2(i?i:0,n?n:0),this.previousPosition=new Vector2(0,0),this.parentVertexId=null,this.children=[],this.spanningTreeChildren=[],this.edges=[],this.positioned=!1,this.angle=0,this.backAngle=0,this.flippable=!1,this.flipCenter=null,this.flipNeighbour=null,this.flipRings=new Array}return _createClass(e,[{key:"isTerminal",value:function(){return null===this.parent&&this.children.length<2||0===this.children.length}},{key:"clone",value:function t(){var t=new e(this.value,this.position.x,this.position.y);return t.id=this.id,t.previousPosition=new Vector2(this.previousPosition.x,this.previousPosition.y),t.parentVertexId=this.parentVertexId,t.children=ArrayHelper.clone(this.children),t.spanningTreeChildren=ArrayHelper.clone(this.spanningTreeChildren),t.edges=ArrayHelper.clone(this.edges),t.positioned=this.positioned,t.angle=this.angle,t.backAngle=this.backAngle,t.flippable=this.flippable,t.flipCenter=this.flipCenter,t.flipRings=ArrayHelper.clone(this.flipRings),t}},{key:"equals",value:function(e){return this.id===e.id}},{key:"getAngle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=null;return i=e?Vector2.subtract(this.position,e):Vector2.subtract(this.position,this.previousPosition),t?MathHelper.toDeg(i.angle()):i.angle()}},{key:"getTextDirection",value:function(e){for(var t=this.getNeighbours(),i=[],n=0;n<t.length;n++)i.push(this.getAngle(e[t[n]].position));var r=MathHelper.meanAngle(i),s=Math.PI/2;return r=Math.round(Math.round(r/s)*s,3),2==r?"down":r==-2?"up":0===r||r===-0?"right":3==r||r==-3?"left":"down"}},{key:"getNeighbours",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=[],i=0;i<this.children.length;i++)void 0!==e&&e==this.children[i]||t.push(this.children[i]);return null!=this.parentVertexId&&(void 0!==e&&e==this.parentVertexId||t.push(this.parentVertexId)),t}},{key:"getCommonNeighbours",value:function(e){for(var t=new Array,i=this.getNeighbours(),n=e.getNeighbours(),r=0;r<i.length;r++)for(var s=0;s<n.length;s++)i[r]===n[s]&&t.push(i[r]);return t}},{key:"isNeighbour",value:function(e){if(this.parentVertexId===e)return!0;for(var t=0;t<this.children.length;t++)if(this.children[t]===e)return!0}},{key:"getSpanningTreeNeighbours",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=[],i=0;i<this.spanningTreeChildren.length;i++)void 0!==e&&e==this.spanningTreeChildren[i]||t.push(this.spanningTreeChildren[i]);return null!=this.parentVertexId&&(void 0!==e&&e==this.parentVertexId||t.push(this.parentVertexId)),t}},{key:"getNextInRing",value:function(e,t,i){for(var n=this.getNeighbours(),r=0;r<n.length;r++)if(ArrayHelper.contains(e[n[r]].value.rings,{value:t})&&n[r]!=i)return n[r];return null}}]),e}();