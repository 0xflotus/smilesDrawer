"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),ArrayHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"clone",value:function(t){var i=Array.isArray(t)?[]:{};for(var r in t){var n=t[r];"function"==typeof n.clone?i[r]=n.clone():i[r]="object"===(void 0===n?"undefined":_typeof(n))?e.clone(n):n}return i}},{key:"print",value:function(e){if(0==e.length)return"";for(var t="(",i=0;i<e.length;i++)t+=e[i].id?e[i].id+", ":e[i]+", ";return(t=t.substring(0,t.length-2))+")"}},{key:"each",value:function(e,t){for(var i=0;i<e.length;i++)t(e[i])}},{key:"get",value:function(e,t,i){for(var r=0;r<e.length;r++)if(e[r][t]==i)return e[r]}},{key:"contains",value:function(e,t){if(t.property||t.func){if(t.func){for(var i=0;i<e.length;i++)if(t.func(e[i]))return!0}else for(var r=0;r<e.length;r++)if(e[r][t.property]==t.value)return!0}else for(var n=0;n<e.length;n++)if(e[n]==t.value)return!0;return!1}},{key:"intersection",value:function(e,t){for(var i=new Array,r=0;r<e.length;r++)for(var n=0;n<t.length;n++)e[r]===t[n]&&i.push(e[r]);return i}},{key:"unique",value:function(e){var t={};return e.filter(function(e){return void 0===t[e]&&(t[e]=!0)})}},{key:"count",value:function(e,t){for(var i=0,r=0;r<e.length;r++)e[r]===t&&i++;return i}},{key:"toggle",value:function(e,t){for(var i=[],r=!1,n=0;n<e.length;n++)e[n]!==t?i.push(e[n]):r=!0;return r||i.push(t),i}},{key:"remove",value:function(e,t){for(var i=[],r=0;r<e.length;r++)e[r]!==t&&i.push(e[r]);return i}},{key:"removeUnique",value:function(e,t){var i=array.indexOf(t);return i>-1&&e.splice(i,1),e}},{key:"removeAll",value:function(e,t){return e.filter(function(e){return-1===t.indexOf(e)})}},{key:"merge",value:function(e,t){for(var i=new Array(e.length+t.length),r=0;r<e.length;r++)i[r]=e[r];for(var n=0;n<t.length;n++)i[e.length+n]=t[n];return i}},{key:"containsAll",value:function(e,t){for(var i=0,r=0;r<e.length;r++)for(var n=0;n<t.length;n++)e[r]===t[n]&&i++;return i===t.length}},{key:"sortByAtomicNumberDesc",value:function(e){var t=e.map(function(e,t){return{index:t,value:e.atomicNumber.split(".").map(Number)}});return t.sort(function(e,t){for(var i=Math.min(t.value.length,e.value.length),r=0;r<i&&t.value[r]===e.value[r];)r++;return r===i?t.value.length-e.value.length:t.value[r]-e.value[r]}),t.map(function(t){return e[t.index]})}},{key:"deepCopy",value:function(t){for(var i=[],r=0;r<t.length;r++){var n=t[r];n instanceof Array?i[r]=e.deepCopy(n):i[r]=n}return i}}]),e}(),Atom=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-";_classCallCheck(this,e),this.element=1===t.length?t.toUpperCase():t,this.explicit=!1,this.ringbonds=[],this.rings=[],this.bondType=i,this.isTerminal=!1,this.isBridge=!1,this.isBridgeNode=!1,this.originalRings=[],this.bridgedRing=null,this.anchoredRings=[],this.bracket=null,this.chiral=0,this.order={},this.attachedPseudoElements={},this.hasAttachedPseudoElements=!1,this.isDrawn=!0,this.isConnectedToRing=!1,this.neighbouringElements=[],this.isPartOfAromaticRing=t!==this.element}return _createClass(e,[{key:"addNeighbouringElement",value:function(e){this.neighbouringElements.push(e)}},{key:"attachPseudoElement",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=i+e;this.attachedPseudoElements[r]?this.attachedPseudoElements[r].count+=1:this.attachedPseudoElements[r]={element:e,count:1,hydrogenCount:i,previousElement:t},this.hasAttachedPseudoElements=!0}},{key:"getAttachedPseudoElements",value:function(){var e={},t=this;return Object.keys(this.attachedPseudoElements).sort().forEach(function(i){e[i]=t.attachedPseudoElements[i]}),e}},{key:"getAttachedPseudoElementsCount",value:function(){return Object.keys(this.attachedPseudoElements).length}},{key:"addAnchoredRing",value:function(e){ArrayHelper.contains(this.anchoredRings,{value:e})||this.anchoredRings.push(e)}},{key:"getRingbondCount",value:function(){return this.ringbonds.length}},{key:"canRotate",value:function(){return"-"===this.bondType&&0==this.rings.length}},{key:"hasRingbonds",value:function(){return this.ringbonds.length>0}},{key:"getMaxRingbond",value:function(){for(var e=0,t=0;t<this.ringbonds.length;t++)this.ringbonds[t].id>e&&(e=this.ringbonds[t].id);return e}},{key:"isInRing",value:function(){return this.rings.length>0}},{key:"hasRing",value:function(e){for(var t=0;t<this.rings;t++)if(e===this.rings[t])return!0;return!1}},{key:"backupRings",value:function(){this.originalRings=[];for(var e=0;e<this.rings.length;e++)this.originalRings.push(this.rings[e])}},{key:"restoreRings",value:function(){this.rings=[];for(var e=0;e<this.originalRings.length;e++)this.rings.push(this.originalRings[e])}},{key:"haveCommonRingbond",value:function(e,t){for(var i=0;i<e.ringbonds.length;i++)for(var r=0;r<t.ringbonds.length;r++)if(e.ringbonds[i].id==t.ringbonds[r].id)return!0;return!1}},{key:"maxCommonRingbond",value:function(e,t){for(var i=0,r=0,n=0,s=0;s<e.ringbonds.length;s++){e.ringbonds[s].id>r&&(r=e.ringbonds[s].id);for(var o=0;o<t.ringbonds.length;o++)t.ringbonds[o].id>n?n=t.ringbonds[o].id:r==n&&(i=r)}return i}},{key:"getOrder",value:function(e){return this.order[e]}},{key:"setOrder",value:function(e,t){this.order[e]=t}},{key:"neighbouringElementsEqual",value:function(e){if(e.length!==this.neighbouringElements.length)return!1;e.sort(),this.neighbouringElements.sort();for(var t=0;t<this.neighbouringElements.length;t++)if(e[t]!==this.neighbouringElements[t])return!1;return!0}},{key:"getAtomicNumber",value:function(){return e.atomicNumbers[this.element]}}],[{key:"sortByAtomicNumber",value:function(t,i){for(var r=new Array(t.length),n=0;n<t.length;n++){var s=i[t[n]],o=e.atomicNumbers[s.value.element];r[n]={atomicNumber:o.toString(),vertexId:s.id}}return ArrayHelper.sortByAtomicNumberDesc(r)}},{key:"hasDuplicateAtomicNumbers",value:function(e){for(var t={},i=0;i<e.length;i++){var r=e[i];if(void 0!==t[r.atomicNumber])return!0;t[r.atomicNumber]=!0}return!1}},{key:"getDuplicateAtomicNumbers",value:function(e){for(var t={},i=[],r=0;r<e.length;r++){var n=e[r];void 0===t[n.atomicNumber]&&(t[n.atomicNumber]=[]),t[n.atomicNumber].push(r)}for(var s in t){var o=t[s];o.length>1&&i.push(o)}return i}}]),e}();Atom.atomicNumbers={H:1,He:2,Li:3,Be:4,B:5,b:5,C:6,c:6,N:7,n:7,O:8,o:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,p:15,S:16,s:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103,Rf:104,Db:105,Sg:106,Bh:107,Hs:108,Mt:109,Ds:110,Rg:111,Cn:112,Uut:113,Uuq:114,Uup:115,Uuh:116,Uus:117,Uuo:118},Atom.mass={H:1,He:2,Li:3,Be:4,B:5,b:5,C:6,c:6,N:7,n:7,O:8,o:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,p:15,S:16,s:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103,Rf:104,Db:105,Sg:106,Bh:107,Hs:108,Mt:109,Ds:110,Rg:111,Cn:112,Uut:113,Uuq:114,Uup:115,Uuh:116,Uus:117,Uuo:118};var CanvasWrapper=function(){function e(t,i,r){_classCallCheck(this,e),"string"==typeof t||t instanceof String?this.canvas=document.getElementById(t):this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.colors=i,this.opts=r,this.drawingWidth=0,this.drawingHeight=0,this.offsetX=0,this.offsetY=0,this.fontLarge=this.opts.fontSizeLarge+"pt Droid Sans, sans-serif",this.fontSmall=this.opts.fontSizeSmall+"pt Droid Sans, sans-serif",this.updateSize(this.opts.width,this.opts.height),this.clear()}return _createClass(e,[{key:"updateSize",value:function(e,t){this.devicePixelRatio=window.devicePixelRatio||1,this.backingStoreRatio=this.ctx.webkitBackingStorePixelRatio||this.ctx.mozBackingStorePixelRatio||this.ctx.msBackingStorePixelRatio||this.ctx.oBackingStorePixelRatio||this.ctx.backingStorePixelRatio||1,this.ratio=this.devicePixelRatio/this.backingStoreRatio,1!==this.ratio?(this.canvas.width=e*this.ratio,this.canvas.height=t*this.ratio,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.ctx.setTransform(this.ratio,0,0,this.ratio,0,0)):(this.canvas.width=e*this.ratio,this.canvas.height=t*this.ratio)}},{key:"setTheme",value:function(e){this.colors=e}},{key:"scale",value:function(e){for(var t=-Number.MAX_VALUE,i=-Number.MAX_VALUE,r=Number.MAX_VALUE,n=Number.MAX_VALUE,s=0;s<e.length;s++){var o=e[s].position;t<o.x&&(t=o.x),i<o.y&&(i=o.y),r>o.x&&(r=o.x),n>o.y&&(n=o.y)}t+=20,i+=20,r-=20,n-=20,this.drawingWidth=t-r,this.drawingHeight=i-n;var a=this.canvas.offsetWidth/this.drawingWidth,h=this.canvas.offsetHeight/this.drawingHeight,l=a<h?a:h;this.ctx.scale(l,l),this.offsetX=-r,this.offsetY=-n,a<h?this.offsetY+=this.canvas.offsetHeight/(2*l)-this.drawingHeight/2:this.offsetX+=this.canvas.offsetWidth/(2*l)-this.drawingWidth/2}},{key:"reset",value:function(){this.ctx.setTransform(1,0,0,1,0,0)}},{key:"getColor",value:function(e){return e=e.toUpperCase(),e in this.colors?this.colors[e]:this.colors.C}},{key:"drawCircle",value:function(e,t,i,r){var n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",a=this.ctx,h=this.offsetX,l=this.offsetY;a.save(),a.lineWidth=1.5,a.beginPath(),a.arc(e+h,t+l,i,0,MathHelper.twoPI,!0),a.closePath(),s?(n?(a.fillStyle="#f00",a.fill()):(a.strokeStyle="#f00",a.stroke()),this.drawDebugText(e,t,o)):n?(a.fillStyle=r,a.fill()):(a.strokeStyle=r,a.stroke()),a.restore()}},{key:"drawLine",value:function(e){if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var t=this.ctx,i=this.offsetX,r=this.offsetY,n=e.clone().shorten(8),s=n.getLeftVector().clone(),o=n.getRightVector().clone();s.x+=i,s.y+=r,o.x+=i,o.y+=r,s=e.getLeftVector().clone(),o=e.getRightVector().clone(),s.x+=i,s.y+=r,o.x+=i,o.y+=r,t.save(),t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(o.x,o.y),t.lineCap="round",t.lineWidth=1.5;var a=this.ctx.createLinearGradient(s.x,s.y,o.x,o.y);a.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),a.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),t.strokeStyle=a,t.stroke(),t.restore()}}},{key:"drawWedge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var i=this.ctx,r=this.offsetX,n=this.offsetY,s=e.clone().shorten(8),o=s.getLeftVector().clone(),a=s.getRightVector().clone();o.x+=r,o.y+=n,a.x+=r,a.y+=n,o=e.getLeftVector().clone(),a=e.getRightVector().clone(),o.x+=r,o.y+=n,a.x+=r,a.y+=n,i.save();var h=Vector2.normals(o,a);h[0].normalize(),h[1].normalize();var l=e.getRightChiral(),g=o,u=a;l&&(g=a,u=o);var c=Vector2.add(g,Vector2.multiplyScalar(h[0],.75)),d=Vector2.add(u,Vector2.multiplyScalar(h[0],t)),v=Vector2.add(u,Vector2.multiplyScalar(h[1],t)),f=Vector2.add(g,Vector2.multiplyScalar(h[1],.75));i.beginPath(),i.moveTo(c.x,c.y),i.lineTo(d.x,d.y),i.lineTo(v.x,v.y),i.lineTo(f.x,f.y);var p=this.ctx.createRadialGradient(a.x,a.y,this.opts.bondLength,a.x,a.y,0);p.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),p.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),i.fillStyle=p,i.fill(),i.restore()}}},{key:"drawDashedWedge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var i=this.ctx,r=this.offsetX,n=this.offsetY,s=e.getLeftVector().clone(),o=e.getRightVector().clone();s.x+=r,s.y+=n,o.x+=r,o.y+=n,i.save();var a=Vector2.normals(s,o);a[0].normalize(),a[1].normalize();var h=e.getRightChiral(),l=void 0,g=void 0,u=void 0,c=void 0,d=e.clone();h?(l=o,g=s,d.shortenRight(3),u=d.getRightVector().clone(),c=d.getLeftVector().clone()):(l=s,g=o,d.shortenLeft(3),u=d.getLeftVector().clone(),c=d.getRightVector().clone()),u.x+=r,u.y+=n,c.x+=r,c.y+=n;var v=Vector2.add(l,Vector2.multiplyScalar(a[0],.75)),f=Vector2.add(g,Vector2.multiplyScalar(a[0],t/2)),p=Vector2.add(g,Vector2.multiplyScalar(a[1],t/2)),y=Vector2.add(l,Vector2.multiplyScalar(a[1],.75));i.beginPath(),i.moveTo(v.x,v.y),i.lineTo(f.x,f.y),i.lineTo(p.x,p.y),i.lineTo(y.x,y.y);var m=this.ctx.createRadialGradient(o.x,o.y,this.bondLength,o.x,o.y,0);m.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),m.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),i.fillStyle=m,i.fill(),i.globalCompositeOperation="destination-out",i.beginPath(),i.moveTo(u.x,u.y),i.lineTo(c.x,c.y),i.lineCap="butt",i.lineWidth=t,i.setLineDash([1,1]),i.strokeStyle=this.getColor("BACKGROUND"),i.stroke(),i.globalCompositeOperation="source-over",i.restore()}}},{key:"drawDebugText",value:function(e,t,i){var r=this.ctx;r.save(),r.font="5px Droid Sans, sans-serif",r.textAlign="start",r.textBaseline="top",r.fillStyle="#ff0000",r.fillText(i,e+this.offsetX,t+this.offsetY),r.restore()}},{key:"drawBall",value:function(e,t,i){var r=this.ctx;r.save(),r.beginPath(),r.arc(e+this.offsetX,t+this.offsetY,this.opts.bondLength/4.5,0,MathHelper.twoPI,!1),r.fillStyle=this.getColor(i),r.fill()}},{key:"drawText",value:function(e,t,i,r,n,s,o,a){var h=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{},l=this.ctx,g=this.offsetX,u=this.offsetY;l.save();var c=this.opts.fontSizeLarge;this.opts.fontSizeSmall;l.textAlign="start",l.textBaseline="alphabetic";var d="+",v=0;o&&(2===o?d="2+":-1===o?d="-":-2===o&&(d="2-"),l.font=this.fontSmall,v=l.measureText(d).width);var f="0",p=0;a>0&&(f=a,l.font=this.fontSmall,p=l.measureText(f).width),l.font=this.fontLarge,l.fillStyle=this.getColor(i);var y=l.measureText(i);y.totalWidth=y.width+v,y.height=parseInt(this.fontLarge,10);var m=y.width>c?y.width:this.opts.fontSizeLarge;m/=1.25,l.globalCompositeOperation="destination-out",l.beginPath(),l.arc(e+g,t+u,m,0,2*MathHelper.twoPI,!0),l.closePath(),l.fill(),l.globalCompositeOperation="source-over";var b=-y.width/2,C=-y.width/2;l.fillStyle=this.getColor(i),l.fillText(i,e+g+b,t+this.opts.fontSizeLarge/2+u),b+=y.width,o&&(l.font=this.fontSmall,l.fillText(d,e+g+b,t-this.opts.fontSizeSmall/5+u),b+=v),a>0&&(l.font=this.fontSmall,l.fillText(f,e+g+C-p,t-this.opts.fontSizeSmall/5+u),C-=p),l.font=this.fontLarge;var x=0,A=0;if(1===r){var k=e+g,R=t+u+c/2;x=l.measureText("H").width,C-=x,"left"===n?k+=C:"right"===n?k+=b:"up"===n&&s?k+=b:"down"===n&&s?k+=b:"up"!==n||s?"down"!==n||s||(R+=this.opts.fontSizeLarge+this.opts.fontSizeLarge/4,k-=x/2):(R-=this.opts.fontSizeLarge+this.opts.fontSizeLarge/4,k-=x/2),l.fillText("H",k,R),b+=x}else if(r>1){var S=e+g,w=t+u+c/2;x=l.measureText("H").width,l.font=this.fontSmall,A=l.measureText(r).width,C-=x+A,"left"===n?S+=C:"right"===n?S+=b:"up"===n&&s?S+=b:"down"===n&&s?S+=b:"up"!==n||s?"down"!==n||s||(w+=this.opts.fontSizeLarge+this.opts.fontSizeLarge/4,S-=x/2):(w-=this.opts.fontSizeLarge+this.opts.fontSizeLarge/4,S-=x/2),l.font=this.fontLarge,l.fillText("H",S,w),l.font=this.fontSmall,l.fillText(r,S+x/2+A,w+this.opts.fontSizeSmall/5),b+=x+x/2+A}for(var N in h)if(h.hasOwnProperty(N)){var I=0,L=0,V=h[N].element,T=h[N].count,P=h[N].hydrogenCount;l.font=this.fontLarge,T>1&&P>0&&(I=l.measureText("(").width,L=l.measureText(")").width);var B=l.measureText(V).width,H=0;x=0,P>0&&(x=l.measureText("H").width),l.font=this.fontSmall,T>1&&(H=l.measureText(T).width),A=0,P>1&&(A=l.measureText(P).width),l.font=this.fontLarge;var M=e+g,E=t+u+c/2;l.fillStyle=this.getColor(V),T>0&&(C-=H),T>1&&P>0&&("left"===n?(C-=L,l.fillText(")",M+C,E)):(l.fillText("(",M+b,E),b+=I)),"left"===n?(C-=B,l.fillText(V,M+C,E)):(l.fillText(V,M+b,E),b+=B),P>0&&("left"===n?(C-=x+A,l.fillText("H",M+C,E),P>1&&(l.font=this.fontSmall,l.fillText(P,M+C+x,E+this.opts.fontSizeSmall/5))):(l.fillText("H",M+b,E),b+=x,P>1&&(l.font=this.fontSmall,l.fillText(P,M+b,E+this.opts.fontSizeSmall/5),b+=A))),l.font=this.fontLarge,T>1&&P>0&&("left"===n?(C-=I,l.fillText("(",M+C,E)):(l.fillText(")",M+b,E),b+=L)),l.font=this.fontSmall,T>1&&("left"===n?l.fillText(T,M-C+H+I+L+x+A+B,E+this.opts.fontSizeSmall/5):(l.fillText(T,M+b,E+this.opts.fontSizeSmall/5),b+=H))}l.restore()}},{key:"drawDebugPoint",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#f00";this.drawCircle(e,t,2,r,!0,!0,i)}},{key:"drawAromaticityRing",value:function(e){var t=this.ctx,i=MathHelper.polyCircumradius(this.opts.bondLength,e.getSize());t.save(),t.strokeStyle=this.getColor("C"),t.lineWidth=1.5,t.beginPath(),t.arc(e.center.x+this.offsetX,e.center.y+this.offsetY,i-this.opts.bondLength/3-this.opts.bondSpacing,0,2*Math.PI,!0),t.closePath(),t.stroke(),t.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight)}}]),e}(),Edge=function(){function e(t,i,r){_classCallCheck(this,e),this.id=null,this.sourceId=t,this.targetId=i,this.weight=r,this.bondType="-",this.isInAromaticRing=!1,this.center=!1,this.chiral=""}return _createClass(e,[{key:"getBondCount",value:function(){return e.bonds[this.bondType]}}],[{key:"bonds",get:function(){return{"-":1,"/":1,"\\":1,"=":2,"#":3,$:4}}}]),e}(),Graph=function(){function e(){_classCallCheck(this,e),this.vertices=[],this.edges=[],this.vertexIdsToEdgeId={},this._time=0}return _createClass(e,[{key:"clear",value:function(){this.vertices=[],this.edges=[],this.vertexIdsToEdgeId={}}},{key:"addVertex",value:function(e){return e.id=this.vertices.length,this.vertices.push(e),e.id}},{key:"addEdge",value:function(e){return e.id=this.edges.length,this.edges.push(e),this.vertexIdsToEdgeId[e.sourceId+"_"+e.targetId]=e.id,this.vertexIdsToEdgeId[e.targetId+"_"+e.sourceId]=e.id,e.id}},{key:"getEdge",value:function(e,t){var i=this.vertexIdsToEdgeId[e+"_"+t];return void 0===i?null:this.edges[i]}},{key:"hasEdge",value:function(e,t){return void 0!==this.vertexIdsToEdgeId[e+"_"+t]}},{key:"getVertexList",value:function(){for(var e=[this.vertices.length],t=0;t<this.vertices.length;t++)e[t]=this.vertices[t].id;return e}},{key:"getEdgeList",value:function(){for(var e=[this.edges.length],t=0;t<this.edges.length;t++)e[t]=[this.edges[t].sourceId,this.edges[t].targetId];return e}},{key:"getAdjacencyMatrix",value:function(){for(var e=this.vertices.length,t=Array(e),i=0;i<e;i++)t[i]=new Array(e),t[i].fill(0);for(var i=0;i<this.edges.length;i++){var r=this.edges[i];t[r.sourceId][r.targetId]=1,t[r.targetId][r.sourceId]=1}return t}},{key:"getComponentsAdjacencyMatrix",value:function(){for(var e=this.vertices.length,t=Array(e),i=this.getBridges(),r=0;r<e;r++)t[r]=new Array(e),t[r].fill(0);for(var r=0;r<this.edges.length;r++){var n=this.edges[r];t[n.sourceId][n.targetId]=1,t[n.targetId][n.sourceId]=1}for(var r=0;r<i.length;r++)t[i[r][0]][i[r][1]]=0,t[i[r][1]][i[r][0]]=0;return t}},{key:"getSubgraphAdjacencyMatrix",value:function(e){for(var t=e.length,i=Array(t),r=0;r<t;r++){i[r]=new Array(t),i[r].fill(0);for(var n=0;n<t;n++)r!==n&&this.hasEdge(e[r],e[n])&&(i[r][n]=1)}return i}},{key:"getAdjacencyList",value:function(){for(var e=this.vertices.length,t=Array(e),i=0;i<e;i++){t[i]=[];for(var r=0;r<e;r++)i!==r&&this.hasEdge(this.vertices[i].id,this.vertices[r].id)&&t[i].push(r)}return t}},{key:"getSubgraphAdjacencyList",value:function(e){for(var t=e.length,i=Array(t),r=0;r<t;r++){i[r]=[];for(var n=0;n<t;n++)r!==n&&this.hasEdge(e[r],e[n])&&i[r].push(n)}return i}},{key:"getLargestCycleInSubgraph",value:function(e,t){var i=[];this.getSubgraphAdjacencyList(t);return i}},{key:"getBridges",value:function(){var e=this.vertices.length,t=new Array(e),i=new Array(e),r=new Array(e),n=new Array(e),s=this.getAdjacencyList(),o=[];t.fill(!1),n.fill(null),this._time=0;for(var a=0;a<e;a++)t[a]||this._bridgeDfs(a,t,i,r,n,s,o);return o}},{key:"_bridgeDfs",value:function(e,t,i,r,n,s,o){t[e]=!0,i[e]=r[e]=++this._time;for(var a=0;a<s[e].length;a++){var h=s[e][a];t[h]?h!==n[e]&&(r[e]=Math.min(r[e],i[h])):(n[h]=e,this._bridgeDfs(h,t,i,r,n,s,o),r[e]=Math.min(r[e],r[h]),r[h]>i[e]&&o.push([e,h]))}}}],[{key:"getConnectedComponentCount",value:function(t){var i=t.length,r=new Array(i),n=0;r.fill(!1);for(var s=0;s<i;s++)r[s]||(r[s]=!0,n++,e._ccCountDfs(s,r,t));return n}},{key:"_ccCountDfs",value:function(t,i,r){for(var n=0;n<r[t].length;n++){r[t][n]&&!i[n]&&t!==n&&(i[n]=!0,e._ccCountDfs(n,i,r))}}}]),e}(),Hanser=function(){function e(t,i){_classCallCheck(this,e),this.vertices=t,this.edges=i,this.cycles=[],this.paths={},this.pathIdCounter=0,this.getRings(),this.removeBridgedRings()}return _createClass(e,[{key:"getRings",value:function(e,t){for(var i=this.edges.length-1;i>=0;i--)this.paths[this.pathIdCounter]={id:this.pathIdCounter++,nodes:[this.edges[i][0],this.edges[i][1]],source:this.edges[i][0],target:this.edges[i][1],isConnected:!1},this.pathIdCounter++;for(var i=this.vertices.length-1;i>=0;i--)this.remove(i)}},{key:"remove",value:function(e){for(var t=this.getPaths(e),i=0;i<t.length;i++){for(var r=i+1;r<t.length;r++){var n=this.splice(t[i],t[r]);n&&(n.isConnected?(n.nodes.pop(),this.cycles.push(new Set(n.nodes)),delete this.paths[n.id]):this.paths[n.id]=n)}delete this.paths[t[i].id]}}},{key:"getPaths",value:function(e){var t=[];for(var i in this.paths){var r=this.paths[i];r.source!==e&&r.target!==e||t.push(r)}return t}},{key:"splice",value:function(e,t){var i=null,r=e.nodes.concat();if(i=e.source===t.source||e.source===t.target?e.source:e.target,i===e.source&&(r=r.reverse()),i===t.source)for(var n=1;n<t.nodes.length;n++)r.push(t.nodes[n]);else for(var n=t.nodes.length-2;n>=0;n--)r.push(t.nodes[n]);if(this.valid(r))return{id:this.pathIdCounter++,nodes:r,source:r[0],target:r[r.length-1],isConnected:r.length>2&&r[0]===r[r.length-1]}}},{key:"valid",value:function(e){for(var t=1;t<e.length;t++)for(var i=1;i<e.length;i++)if(t!==i&&e[t]===e[i])return!1;return!0}},{key:"removeBridgedRings",value:function(){if(!(this.cycles.length<2)){for(var e=new Array(this.vertices.length),t=0;t<this.vertices.length;t++){e[t]=new Set;for(var i=0;i<this.cycles.length;i++)this.cycles[i].has(t)&&e[t].add(i)}for(var t=0;t<e.length;t++)if(e[t].size>2)return;console.log("vertexRings",e)}}}]),e}(),Line=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Vector2(0,0),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Vector(0,0),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];_classCallCheck(this,e),this.from=t,this.to=i,this.elementFrom=r,this.elementTo=n,this.chiralFrom=s,this.chiralTo=o}return _createClass(e,[{key:"clone",value:function(){return new e(this.from.clone(),this.to.clone(),this.elementFrom,this.elementTo)}},{key:"getLength",value:function(){return Math.sqrt(Math.pow(this.to.x-this.from.x,2)+Math.pow(this.to.y-this.from.y,2))}},{key:"getAngle",value:function(){return Vector2.subtract(this.getRightVector(),this.getLeftVector()).angle()}},{key:"getRightVector",value:function(){return this.from.x<this.to.x?this.to:this.from}},{key:"getLeftVector",value:function(){return this.from.x<this.to.x?this.from:this.to}},{key:"getRightElement",value:function(){return this.from.x<this.to.x?this.elementTo:this.elementFrom}},{key:"getLeftElement",value:function(){return this.from.x<this.to.x?this.elementFrom:this.elementTo}},{key:"getRightChiral",value:function(){return this.from.x<this.to.x?this.chiralTo:this.chiralFrom}},{key:"getLeftChiral",value:function(){return this.from.x<this.to.x?this.chiralFrom:this.chiralTo}},{key:"setRightVector",value:function(e,t){return this.from.x<this.to.x?(this.to.x=e,this.to.y=t):(this.from.x=e,this.from.y=t),this}},{key:"setLeftVector",value:function(e,t){return this.from.x<this.to.x?(this.from.x=e,this.from.y=t):(this.to.x=e,this.to.y=t),this}},{key:"rotateToXAxis",value:function(){var e=this.getLeftVector();return this.setRightVector(e.x+this.getLength(),e.y),this}},{key:"rotate",value:function(e){var t=this.getLeftVector(),i=this.getRightVector(),r=Math.sin(e),n=Math.cos(e),s=n*(i.x-t.x)-r*(i.y-t.y)+t.x,o=r*(i.x-t.x)-n*(i.y-t.y)+t.y;return this.setRightVector(s,o),this}},{key:"shortenFrom",value:function(e){var t=Vector2.subtract(this.to,this.from);return t.normalize(),t.multiplyScalar(e),this.from.add(t),this}},{key:"shortenTo",value:function(e){var t=Vector2.subtract(this.from,this.to);return t.normalize(),t.multiplyScalar(e),this.to.add(t),this}},{key:"shortenRight",value:function(e){return this.from.x<this.to.x?this.shortenTo(e):this.shortenFrom(e),this}},{key:"shortenLeft",value:function(e){return this.from.x<this.to.x?this.shortenFrom(e):this.shortenTo(e),this}},{key:"shorten",value:function(e){var t=Vector2.subtract(this.from,this.to);return t.normalize(),t.multiplyScalar(e/2),this.to.add(t),this.from.subtract(t),this}},{key:"getNormals",value:function(){var e=Vector2.subtract(from,to);return[new Vector2(-e.y,e.x),new Vector2(e.y,-e.x)]}}]),e}(),MathHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"round",value:function(e,t){return t=t||1,Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"meanAngle",value:function(e){for(var t=0,i=0,r=0;r<e.length;r++)t+=Math.sin(e[r]),i+=Math.cos(e[r]);return Math.atan2(t/e.length,i/e.length)}},{key:"innerAngle",value:function(t){return e.toRad(180*(t-2)/t)}},{key:"polyCircumradius",value:function(e,t){return e/(2*Math.sin(Math.PI/t))}},{key:"apothem",value:function(e,t){return e*Math.cos(Math.PI/t)}},{key:"apothemFromSideLength",value:function(t,i){var r=e.polyCircumradius(t,i);return e.apothem(r,i)}},{key:"centralAngle",value:function(t){return e.toRad(360/t)}},{key:"toDeg",value:function(t){return t*e.degFactor}},{key:"toRad",value:function(t){return t*e.radFactor}}]),e}();MathHelper.radFactor=Math.PI/180,MathHelper.degFactor=180/Math.PI,MathHelper.twoPI=2*Math.PI;var Ring=function(){function e(t){_classCallCheck(this,e),this.id=null,this.members=t,this.edges=[],this.insiders=[],this.neighbours=[],this.positioned=!1,this.center=new Vector2,this.rings=[],this.isBridged=!1,this.template=null,this.isSpiro=!1,this.isFused=!1,this.centralAngle=0,this.canFlip=!0}return _createClass(e,[{key:"clone",value:function(){var t=new e(this.members);return t.id=this.id,t.insiders=ArrayHelper.clone(this.insiders),t.neighbours=ArrayHelper.clone(this.neighbours),t.positioned=this.positioned,t.center=this.center.clone(),t.rings=ArrayHelper.clone(this.rings),t.isBridged=this.isBridged,t.template=this.template,t.isSpiro=this.isSpiro,t.isFused=this.isFused,t.centralAngle=this.centralAngle,t.canFlip=this.canFlip,t}},{key:"allowsFlip",value:function(){return this.canFlip&&this.members.length>4}},{key:"setFlipped",value:function(){this.members.length<8&&(this.canFlip=!1)}},{key:"getSize",value:function(){return this.members.length}},{key:"getPolygon",value:function(e){for(var t=[],i=0;i<this.members.length;i++)t.push(e[this.members[i]].position);return t}},{key:"getAngle",value:function(){return Math.PI-this.centralAngle}},{key:"eachMember",value:function(e,t,i,r){i=i||0===i?i:this.members[0];for(var n=i,s=0;null!=n&&s<100;){var o=n;if(t(o),n=e[n].getNextInRing(e,this.id,r),r=o,n==i&&(n=null),99==s)throw console.log("Smiles-drawer was not able to loop over the members of this ring.",this),"Smiles-drawer was not able to loop over the members of this ring.";s++}}},{key:"getOrderedNeighbours",value:function(e){for(var t=[],i=0;i<this.neighbours.length;i++){var r=RingConnection.getVertices(e,this.id,this.neighbours[i]);t.push({n:r.size,neighbour:this.neighbours[i]})}return t.sort(function(e,t){return t.n-e.n}),t}},{key:"isBenzeneLike",value:function(e){var t=this.getDoubleBondCount(e),i=this.members.length;return 3===t&&6===i||2===t&&5===i}},{key:"getDoubleBondCount",value:function(e){for(var t=0,i=0;i<this.members.length;i++){var r=e[this.members[i]].value;"="!==r.bondType&&"="!==r.branchBond||t++}return t}},{key:"contains",value:function(e){for(var t=0;t<this.members.length;t++)if(this.members[t]==e)return!0;return!1}},{key:"thisOrNeighboursContain",value:function(t,i){for(var r=0;r<this.neighbours.length;r++)if(e.getRing(t,this.neighbours[r]).contains(i))return!0;return!!this.contains(i)}}],[{key:"getRing",value:function(e,t){for(var i=0;i<e.length;i++)if(e[i].id==t)return e[i]}}]),e}(),RingConnection=function(){function e(t,i){_classCallCheck(this,e),this.id=null,this.firstRingId=t.id,this.secondRingId=i.id,this.vertices=new Set;for(var r=0;r<t.members.length;r++)for(var n=t.members[r],s=0;s<i.members.length;s++){var o=i.members[s];n===o&&this.addVertex(n)}}return _createClass(e,[{key:"addVertex",value:function(e){this.vertices.add(e)}},{key:"isBridge",value:function(e){if(this.vertices.size>2)return!0;var t=!0,i=!1,r=void 0;try{for(var n,s=this.vertices[Symbol.iterator]();!(t=(n=s.next()).done);t=!0){if(e[n.value].value.rings.length>2)return!0}}catch(e){i=!0,r=e}finally{try{!t&&s.return&&s.return()}finally{if(i)throw r}}return!1}},{key:"updateOther",value:function(e,t){this.firstRingId===t?this.secondRingId=e:this.firstRingId=e}},{key:"containsRing",value:function(e){return this.firstRingId===e||this.secondRingId===e}}],[{key:"isBridge",value:function(e,t,i,r){for(var n=null,s=0;s<e.length;s++)if(n=e[s],n.firstRingId===i&&n.secondRingId===r||n.firstRingId===r&&n.secondRingId===i)return n.isBridge(t);return!1}},{key:"getNeighbours",value:function(e,t){for(var i=[],r=0;r<e.length;r++){var n=e[r];n.firstRingId===t?i.push(n.secondRingId):n.secondRingId===t&&i.push(n.firstRingId)}return i}},{key:"getVertices",value:function(e,t,i){for(var r=0;r<e.length;r++){var n=e[r];if(n.firstRingId===t&&n.secondRingId===i||n.firstRingId===i&&n.secondRingId===t)return[].concat(_toConsumableArray(n.vertices))}}}]),e}(),SMILESPARSER=function(){function e(t,i,r,n){this.message=t,this.expected=i,this.found=r,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function t(t){function i(e){var i,r,n=it[e];if(n)return n;for(i=e-1;!it[i];)i--;for(n=it[i],n={line:n.line,column:n.column,seenCR:n.seenCR};i<e;)r=t.charAt(i),"\n"===r?(n.seenCR||n.line++,n.column=1,n.seenCR=!1):"\r"===r||"\u2028"===r||"\u2029"===r?(n.line++,n.column=1,n.seenCR=!0):(n.column++,n.seenCR=!1),i++;return it[e]=n,n}function r(e,t){var r=i(e),n=i(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:n.line,column:n.column}}}function n(e){et<rt||(et>rt&&(rt=et,nt=[]),nt.push(e))}function s(t,i,r,n){return null!==i&&function(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}(i),
new e(null!==t?t:function(e,t){var i,r,n,s=new Array(e.length);for(n=0;n<e.length;n++)s[n]=e[n].description;return i=e.length>1?s.slice(0,-1).join(", ")+" or "+s[e.length-1]:s[0],r=t?'"'+function(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0100-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1000-\uFFFF]/g,function(e){return"\\u"+t(e)})}(t)+'"':"end of input","Expected "+i+" but "+r+" found."}(i,r),i,r,n)}function o(){var e,t,i,r,n,s,g,u,c,d;if(e=et,t=et,(i=h())!==S){for(r=[],n=a();n!==S;)r.push(n),n=a();if(r!==S){for(n=[],s=et,g=l(),g===S&&(g=null),g!==S?(u=f(),u!==S?(g=[g,u],s=g):(et=s,s=S)):(et=s,s=S);s!==S;)n.push(s),s=et,g=l(),g===S&&(g=null),g!==S?(u=f(),u!==S?(g=[g,u],s=g):(et=s,s=S)):(et=s,s=S);if(n!==S){for(s=[],g=a();g!==S;)s.push(g),g=a();if(s!==S)if(g=l(),g===S&&(g=null),g!==S)if(u=o(),u===S&&(u=null),u!==S){for(c=[],d=a();d!==S;)c.push(d),d=a();c!==S?(i=[i,r,n,s,g,u,c],t=i):(et=t,t=S)}else et=t,t=S;else et=t,t=S;else et=t,t=S}else et=t,t=S}else et=t,t=S}else et=t,t=S;return t!==S&&(tt=e,t=I(t)),e=t}function a(){var e,i,r,s,a,h;return e=et,i=et,40===t.charCodeAt(et)?(r=L,et++):(r=S,0===st&&n(V)),r!==S?(s=l(),s===S&&(s=null),s!==S?(a=o(),a!==S?(41===t.charCodeAt(et)?(h=T,et++):(h=S,0===st&&n(P)),h!==S?(r=[r,s,a,h],i=r):(et=i,i=S)):(et=i,i=S)):(et=i,i=S)):(et=i,i=S),i!==S&&(tt=e,i=B(i)),e=i}function h(){var e,t;return e=et,t=u(),t===S&&(t=c())===S&&(t=g())===S&&(t=d()),t!==S&&(tt=e,t=H(t)),e=t}function l(){var e,i;return e=et,M.test(t.charAt(et))?(i=t.charAt(et),et++):(i=S,0===st&&n(E)),i!==S&&(tt=e,i=z(i)),e=i}function g(){var e,i,r,s,o,a,h,l,g,u;return e=et,i=et,91===t.charCodeAt(et)?(r=O,et++):(r=S,0===st&&n(F)),r!==S?(s=A(),s===S&&(s=null),s!==S?(t.substr(et,2)===D?(o=D,et+=2):(o=S,0===st&&n(_)),o===S&&(t.substr(et,2)===W?(o=W,et+=2):(o=S,0===st&&n(j)),o===S&&(o=c())===S&&(o=v())===S&&(o=d())),o!==S?(a=p(),a===S&&(a=null),a!==S?(h=C(),h===S&&(h=null),h!==S?(l=y(),l===S&&(l=null),l!==S?(g=x(),g===S&&(g=null),g!==S?(93===t.charCodeAt(et)?(u=q,et++):(u=S,0===st&&n(U)),u!==S?(r=[r,s,o,a,h,l,g,u],i=r):(et=i,i=S)):(et=i,i=S)):(et=i,i=S)):(et=i,i=S)):(et=i,i=S)):(et=i,i=S)):(et=i,i=S)):(et=i,i=S),i!==S&&(tt=e,i=G(i)),e=i}function u(){var e,i,r,s;return e=et,i=et,66===t.charCodeAt(et)?(r=X,et++):(r=S,0===st&&n(Y)),r!==S?(114===t.charCodeAt(et)?(s=Z,et++):(s=S,0===st&&n(K)),s===S&&(s=null),s!==S?(r=[r,s],i=r):(et=i,i=S)):(et=i,i=S),i===S&&(i=et,67===t.charCodeAt(et)?(r=$,et++):(r=S,0===st&&n(J)),r!==S?(108===t.charCodeAt(et)?(s=Q,et++):(s=S,0===st&&n(ee)),s===S&&(s=null),s!==S?(r=[r,s],i=r):(et=i,i=S)):(et=i,i=S),i===S&&(te.test(t.charAt(et))?(i=t.charAt(et),et++):(i=S,0===st&&n(ie)))),i!==S&&(tt=e,i=re(i)),e=i}function c(){var e,i;return e=et,ne.test(t.charAt(et))?(i=t.charAt(et),et++):(i=S,0===st&&n(se)),i!==S&&(tt=e,i=H(i)),e=i}function d(){var e,i;return e=et,42===t.charCodeAt(et)?(i=oe,et++):(i=S,0===st&&n(ae)),i!==S&&(tt=e,i=he(i)),e=i}function v(){var e,i,r,s;return e=et,i=et,le.test(t.charAt(et))?(r=t.charAt(et),et++):(r=S,0===st&&n(ge)),r!==S?(ue.test(t.charAt(et))?(s=t.charAt(et),et++):(s=S,0===st&&n(ce)),s===S&&(s=null),s!==S?(r=[r,s],i=r):(et=i,i=S)):(et=i,i=S),i!==S&&(tt=e,i=de(i)),e=i}function f(){var e,i,r,s,o;return e=et,i=et,37===t.charCodeAt(et)?(r=ve,et++):(r=S,0===st&&n(fe)),r!==S?(pe.test(t.charAt(et))?(s=t.charAt(et),et++):(s=S,0===st&&n(ye)),s!==S?(me.test(t.charAt(et))?(o=t.charAt(et),et++):(o=S,0===st&&n(be)),o!==S?(r=[r,s,o],i=r):(et=i,i=S)):(et=i,i=S)):(et=i,i=S),i===S&&(me.test(t.charAt(et))?(i=t.charAt(et),et++):(i=S,0===st&&n(be))),i!==S&&(tt=e,i=Ce(i)),e=i}function p(){var e,i,r,s,o,a,h;return e=et,i=et,64===t.charCodeAt(et)?(r=xe,et++):(r=S,0===st&&n(Ae)),r!==S?(64===t.charCodeAt(et)?(s=xe,et++):(s=S,0===st&&n(Ae)),s===S&&(s=et,t.substr(et,2)===ke?(o=ke,et+=2):(o=S,0===st&&n(Re)),o!==S?(Se.test(t.charAt(et))?(a=t.charAt(et),et++):(a=S,0===st&&n(we)),a!==S?(o=[o,a],s=o):(et=s,s=S)):(et=s,s=S),s===S&&(s=et,t.substr(et,2)===Ne?(o=Ne,et+=2):(o=S,0===st&&n(Ie)),o!==S?(Se.test(t.charAt(et))?(a=t.charAt(et),et++):(a=S,0===st&&n(we)),a!==S?(o=[o,a],s=o):(et=s,s=S)):(et=s,s=S),s===S&&(s=et,t.substr(et,2)===Le?(o=Le,et+=2):(o=S,0===st&&n(Ve)),o!==S?(Te.test(t.charAt(et))?(a=t.charAt(et),et++):(a=S,0===st&&n(Pe)),a!==S?(o=[o,a],s=o):(et=s,s=S)):(et=s,s=S),s===S&&(s=et,t.substr(et,2)===Be?(o=Be,et+=2):(o=S,0===st&&n(He)),o!==S?(pe.test(t.charAt(et))?(a=t.charAt(et),et++):(a=S,0===st&&n(ye)),a!==S?(me.test(t.charAt(et))?(h=t.charAt(et),et++):(h=S,0===st&&n(be)),h===S&&(h=null),h!==S?(o=[o,a,h],s=o):(et=s,s=S)):(et=s,s=S)):(et=s,s=S),s===S&&(s=et,t.substr(et,2)===Me?(o=Me,et+=2):(o=S,0===st&&n(Ee)),o!==S?(pe.test(t.charAt(et))?(a=t.charAt(et),et++):(a=S,0===st&&n(ye)),a!==S?(me.test(t.charAt(et))?(h=t.charAt(et),et++):(h=S,0===st&&n(be)),h===S&&(h=null),h!==S?(o=[o,a,h],s=o):(et=s,s=S)):(et=s,s=S)):(et=s,s=S)))))),s===S&&(s=null),s!==S?(r=[r,s],i=r):(et=i,i=S)):(et=i,i=S),i!==S&&(tt=e,i=ze(i)),e=i}function y(){var e,t;return e=et,t=m(),t===S&&(t=b()),t!==S&&(tt=e,t=Oe(t)),e=t}function m(){var e,i,r,s,o,a;return e=et,i=et,43===t.charCodeAt(et)?(r=Fe,et++):(r=S,0===st&&n(De)),r!==S?(43===t.charCodeAt(et)?(s=Fe,et++):(s=S,0===st&&n(De)),s===S&&(s=et,pe.test(t.charAt(et))?(o=t.charAt(et),et++):(o=S,0===st&&n(ye)),o!==S?(me.test(t.charAt(et))?(a=t.charAt(et),et++):(a=S,0===st&&n(be)),a===S&&(a=null),a!==S?(o=[o,a],s=o):(et=s,s=S)):(et=s,s=S)),s===S&&(s=null),s!==S?(r=[r,s],i=r):(et=i,i=S)):(et=i,i=S),i!==S&&(tt=e,i=_e(i)),e=i}function b(){var e,i,r,s,o,a;return e=et,i=et,45===t.charCodeAt(et)?(r=We,et++):(r=S,0===st&&n(je)),r!==S?(45===t.charCodeAt(et)?(s=We,et++):(s=S,0===st&&n(je)),s===S&&(s=et,pe.test(t.charAt(et))?(o=t.charAt(et),et++):(o=S,0===st&&n(ye)),o!==S?(me.test(t.charAt(et))?(a=t.charAt(et),et++):(a=S,0===st&&n(be)),a===S&&(a=null),a!==S?(o=[o,a],s=o):(et=s,s=S)):(et=s,s=S)),s===S&&(s=null),s!==S?(r=[r,s],i=r):(et=i,i=S)):(et=i,i=S),i!==S&&(tt=e,i=qe(i)),e=i}function C(){var e,i,r,s;return e=et,i=et,72===t.charCodeAt(et)?(r=Ue,et++):(r=S,0===st&&n(Ge)),r!==S?(me.test(t.charAt(et))?(s=t.charAt(et),et++):(s=S,0===st&&n(be)),s===S&&(s=null),s!==S?(r=[r,s],i=r):(et=i,i=S)):(et=i,i=S),i!==S&&(tt=e,i=Xe(i)),e=i}function x(){var e,i,r,s,o,a,h;if(e=et,i=et,58===t.charCodeAt(et)?(r=Ye,et++):(r=S,0===st&&n(Ze)),r!==S){if(s=et,pe.test(t.charAt(et))?(o=t.charAt(et),et++):(o=S,0===st&&n(ye)),o!==S){for(a=[],me.test(t.charAt(et))?(h=t.charAt(et),et++):(h=S,0===st&&n(be));h!==S;)a.push(h),me.test(t.charAt(et))?(h=t.charAt(et),et++):(h=S,0===st&&n(be));a!==S?(o=[o,a],s=o):(et=s,s=S)}else et=s,s=S;s===S&&(Ke.test(t.charAt(et))?(s=t.charAt(et),et++):(s=S,0===st&&n($e))),s!==S?(r=[r,s],i=r):(et=i,i=S)}else et=i,i=S;return i!==S&&(tt=e,i=Je(i)),e=i}function A(){var e,i,r,s,o;return e=et,i=et,pe.test(t.charAt(et))?(r=t.charAt(et),et++):(r=S,0===st&&n(ye)),r!==S?(me.test(t.charAt(et))?(s=t.charAt(et),et++):(s=S,0===st&&n(be)),s===S&&(s=null),s!==S?(me.test(t.charAt(et))?(o=t.charAt(et),et++):(o=S,0===st&&n(be)),o===S&&(o=null),o!==S?(r=[r,s,o],i=r):(et=i,i=S)):(et=i,i=S)):(et=i,i=S),i!==S&&(tt=e,i=Qe(i)),e=i}var k,R=arguments.length>1?arguments[1]:{},S={},w={chain:o},N=o,I=function(e){for(var t=[],i=[],r=0;r<e[1].length;r++)t.push(e[1][r]);for(var r=0;r<e[2].length;r++){var n=e[2][r][0]?e[2][r][0]:"-";i.push({bond:n,id:e[2][r][1]})}for(var r=0;r<e[3].length;r++)t.push(e[3][r]);for(var r=0;r<e[6].length;r++)t.push(e[6][r]);return{atom:e[0],isBracket:!!e[0].element,branches:t,branchCount:t.length,ringbonds:i,ringbondCount:i.length,bond:e[4]?e[4]:"-",next:e[5],hasNext:!!e[5]}},L="(",V={type:"literal",value:"(",description:'"("'},T=")",P={type:"literal",value:")",description:'")"'},B=function(e){var t=e[1]?e[1]:"-";return e[2].branchBond=t,e[2]},H=function(e){return e},M=/^[\-=#$:\/\\.]/,E={type:"class",value:"[-=#$:/\\\\.]",description:"[-=#$:/\\\\.]"},z=function(e){return e},O="[",F={type:"literal",value:"[",description:'"["'},D="se",_={type:"literal",value:"se",description:'"se"'},W="as",j={type:"literal",value:"as",description:'"as"'},q="]",U={type:"literal",value:"]",description:'"]"'},G=function(e){return{isotope:e[1],element:e[2],chirality:e[3],hcount:e[4],charge:e[5],class:e[6]}},X="B",Y={type:"literal",value:"B",description:'"B"'},Z="r",K={type:"literal",value:"r",description:'"r"'},$="C",J={type:"literal",value:"C",description:'"C"'},Q="l",ee={type:"literal",value:"l",description:'"l"'},te=/^[NOPSFI]/,ie={type:"class",value:"[NOPSFI]",description:"[NOPSFI]"},re=function(e){return e.length>1?e.join(""):e},ne=/^[bcnops]/,se={type:"class",value:"[bcnops]",description:"[bcnops]"},oe="*",ae={type:"literal",value:"*",description:'"*"'},he=function(e){return e},le=/^[A-Z]/,ge={type:"class",value:"[A-Z]",description:"[A-Z]"},ue=/^[a-z]/,ce={type:"class",value:"[a-z]",description:"[a-z]"},de=function(e){return e.join("")},ve="%",fe={type:"literal",value:"%",description:'"%"'},pe=/^[1-9]/,ye={type:"class",value:"[1-9]",description:"[1-9]"},me=/^[0-9]/,be={type:"class",value:"[0-9]",description:"[0-9]"},Ce=function(e){return 1==e.length?Number(e):Number(e.join("").replace("%",""))},xe="@",Ae={type:"literal",value:"@",description:'"@"'},ke="TH",Re={type:"literal",value:"TH",description:'"TH"'},Se=/^[12]/,we={type:"class",value:"[12]",description:"[12]"},Ne="AL",Ie={type:"literal",value:"AL",description:'"AL"'},Le="SP",Ve={type:"literal",value:"SP",description:'"SP"'},Te=/^[1-3]/,Pe={type:"class",value:"[1-3]",description:"[1-3]"},Be="TB",He={type:"literal",value:"TB",description:'"TB"'},Me="OH",Ee={type:"literal",value:"OH",description:'"OH"'},ze=function(e){return e[1]?"@"==e[1]?"@@":e[1].join("").replace(",",""):"@"},Oe=function(e){return e},Fe="+",De={type:"literal",value:"+",description:'"+"'},_e=function(e){return e[1]?"+"!=e[1]?Number(e[1].join("")):2:1},We="-",je={type:"literal",value:"-",description:'"-"'},qe=function(e){return e[1]?"-"!=e[1]?-Number(e[1].join("")):-2:-1},Ue="H",Ge={type:"literal",value:"H",description:'"H"'},Xe=function(e){return e[1]?Number(e[1]):1},Ye=":",Ze={type:"literal",value:":",description:'":"'},Ke=/^[0]/,$e={type:"class",value:"[0]",description:"[0]"},Je=function(e){return Number(e[1][0]+e[1][1].join(""))},Qe=function(e){return Number(e.join(""))},et=0,tt=0,it=[{line:1,column:1,seenCR:!1}],rt=0,nt=[],st=0;if("startRule"in R){if(!(R.startRule in w))throw new Error("Can't start parsing from rule \""+R.startRule+'".');N=w[R.startRule]}if((k=N())!==S&&et===t.length)return k;throw k!==S&&et<t.length&&n({type:"end",description:"end of input"}),s(null,nt,rt<t.length?t.charAt(rt):null,rt<t.length?r(rt,rt+1):r(rt,rt))}return function(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}(e,Error),{SyntaxError:e,parse:t}}(),SmilesDrawer=function(){function e(t){_classCallCheck(this,e),this.graph=new Graph,this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.canvasWrapper=null,this.direction=1,this.totalOverlapScore=0,this.maxBonds={c:4,C:4,n:3,N:3,o:2,O:2,p:3,P:3,s:2,S:2,b:3,B:3,F:1,I:1,Cl:1,Br:1},this.defaultOptions={width:500,height:500,bondLength:16,shortBondLength:9,bondSpacing:4,atomVisualization:"default",allowFlips:!1,isomeric:!1,debug:!1,terminalCarbons:!1,compactDrawing:!0,fontSizeLarge:6,fontSizeSmall:4,themes:{dark:{C:"#fff",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",H:"#fff",BACKGROUND:"#141414"},light:{C:"#222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",H:"#222",BACKGROUND:"#fff"}}},this.opts=this.extend(!0,this.defaultOptions,t),this.theme=this.opts.themes.dark}return _createClass(e,[{key:"extend",value:function(){var e=this,t={},i=!1,r=0,n=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(i=arguments[0],r++);for(;r<n;r++){var s=arguments[r];!function(r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(i&&"[object Object]"===Object.prototype.toString.call(r[n])?t[n]=e.extend(!0,t[n],r[n]):t[n]=r[n])}(s)}return t}},{key:"draw",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"light",r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.data=e,this.canvasWrapper=new CanvasWrapper(t,this.opts.themes[i],this.opts),this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.graph.clear(),this.rings=[],this.ringConnections=[],this.originalRings=[],this.originalRingConnections=[],this.bridgedRing=!1,this.initGraph(e),this.initRings(),this.opts.isomeric&&this.annotateChirality(),!r){this.position(),this.restoreRingInformation();var n=this.getOverlapScore();this.totalOverlapScore=this.getOverlapScore().total;for(var s=0;s<this.graph.edges.length;s++){var o=this.graph.edges[s];if(this.isEdgeRotatable(o)){var a=this.getTreeDepth(o.sourceId,o.targetId),h=this.getTreeDepth(o.targetId,o.sourceId),l=o.targetId,g=o.sourceId;a>h&&(l=o.sourceId,g=o.targetId);if(this.getSubtreeOverlapScore(g,l,n.vertexScores).value>1){var u=this.graph.vertices[l],c=this.graph.vertices[g],d=c.getNeighbours(l);if(1===d.length){var v=this.graph.vertices[d[0]],f=v.position.getRotateAwayFromAngle(u.position,c.position,MathHelper.toRad(120));this.rotateSubtree(v.id,c.id,f,c.position);var p=this.getOverlapScore().total;p>this.totalOverlapScore?this.rotateSubtree(v.id,c.id,-f,c.position):this.totalOverlapScore=p}else if(2==d.length){if(c.value.rings.length+u.value.rings.length>0)continue;var y=this.graph.vertices[d[0]],m=this.graph.vertices[d[1]],b=y.position.getRotateAwayFromAngle(u.position,c.position,MathHelper.toRad(120)),C=m.position.getRotateAwayFromAngle(u.position,c.position,MathHelper.toRad(120));this.rotateSubtree(y.id,c.id,b,c.position),this.rotateSubtree(m.id,c.id,C,c.position);var x=this.getOverlapScore().total;x>this.totalOverlapScore?(this.rotateSubtree(y.id,c.id,-b,c.position),this.rotateSubtree(m.id,c.id,-C,c.position)):this.totalOverlapScore=x}n=this.getOverlapScore()}}}this.resolveSecondaryOverlaps(n.scores),this.canvasWrapper.scale(this.graph.vertices),this.opts.compactDrawing&&this.initPseudoElements(),this.drawEdges(this.opts.debug),this.drawVertices(this.opts.debug),this.canvasWrapper.reset()}}},{key:"edgeRingCount",value:function(e){var t=this.graph.edges[e],i=this.graph.vertices[t.sourceId],r=this.graph.vertices[t.targetId];return Math.min(i.value.rings.length,r.value.rings.length)}},{key:"getBridgedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isBridged&&e.push(this.rings[t]);return e}},{key:"getFusedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isFused&&e.push(this.rings[t]);return e}},{key:"getSpiros",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isSpiro&&e.push(this.rings[t]);return e}},{key:"printRingInfo",value:function(){for(var e="",t=0;t<this.rings.length;t++){var i=this.rings[t];e+=i.id+";",e+=i.members.length+";",e+=i.neighbours.length+";",e+=i.isSpiro?"true;":"false;",e+=i.isFused?"true;":"false;",e+=i.isBridged?"true;":"false;",e+=i.rings.length+";",e+=i.insiders.length,e+="\n"}return e}},{key:"getTotalOverlapScore",value:function(){return this.totalOverlapScore}},{key:"getRingCount",value:function(){return this.rings.length}},{key:"hasBridgedRing",value:function(){return this.bridgedRing}},{key:"getHeavyAtomCount",value:function(){for(var e=0,t=0;t<this.graph.vertices.length;t++)"H"!==this.graph.vertices[t].value.element&&e++;return e}},{key:"initGraph",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=new Atom(e.atom.element?e.atom.element:e.atom,e.bond);n.branchBond=e.branchBond,n.ringbonds=e.ringbonds,n.bracket=e.atom.element?e.atom:null,n.setOrder(i,t);var s=new Vertex(n),o=this.graph.vertices[i];if(this.graph.addVertex(s),null!==i){s.setParentVertexId(i),s.value.addNeighbouringElement(o.value.element),o.addChild(s.id),o.value.addNeighbouringElement(n.element),o.spanningTreeChildren.push(s.id);var a=new Edge(i,s.id,1);a.bondType=r?s.value.branchBond:o.value.bondType;var h=this.graph.addEdge(a);s.edges.push(h),o.edges.push(h)}if(n.bracket&&this.opts.isomeric)for(var l=0;l<n.bracket.hcount;l++)this.opts.isomeric&&this.initGraph({atom:{element:"H",bond:"-"},ringbonds:[]},l+1,s.id);var g=e.ringbondCount+1;n.bracket&&(g+=n.bracket.hcount);for(var l=0;l<e.branchCount;l++)this.initGraph(e.branches[l],l+g,s.id,!0);e.hasNext&&this.initGraph(e.next,e.branchCount+g,s.id)}},{key:"getRingbondType",value:function(e,t){if(e.value.getRingbondCount()<1||t.value.getRingbondCount()<1)return null;for(var i=0;i<e.value.ringbonds.length;i++)for(var r=0;r<t.value.ringbonds.length;r++)if(e.value.ringbonds[i].id===t.value.ringbonds[r].id)return"-"===e.value.ringbonds[i].bondType?t.value.ringbonds[r].bond:e.value.ringbonds[i].bond;return null}},{key:"initRings",value:function(){for(var e=new Map,t=this.graph.vertices.length-1;t>=0;t--){var i=this.graph.vertices[t];if(0!==i.value.ringbonds.length)for(var r=0;r<i.value.ringbonds.length;r++){var n=i.value.ringbonds[r].id;if(e.has(n)){var s=i.id,o=e.get(n),a=this.graph.addEdge(new Edge(s,o,1)),h=this.graph.vertices[o];i.addChild(o),i.value.addNeighbouringElement(h.value.element),h.addChild(s),h.value.addNeighbouringElement(i.value.element),i.edges.push(a),h.edges.push(a),e.delete(n)}else e.set(n,i.id)}}var l=SSSR.getRings(this.graph.getComponentsAdjacencyMatrix());if(null!==l){for(var t=0;t<l.length;t++)for(var g=[].concat(_toConsumableArray(l[t])),u=this.addRing(new Ring(g)),r=0;r<g.length;r++)this.graph.vertices[g[r]].value.rings.push(u);for(var t=0;t<this.rings.length-1;t++)for(var r=t+1;r<this.rings.length;r++){var c=this.rings[t],d=this.rings[r],v=new RingConnection(c,d);v.vertices.size>0&&this.addRingConnection(v)}for(var t=0;t<this.rings.length;t++){var f=this.rings[t];f.neighbours=RingConnection.getNeighbours(this.ringConnections,f.id)}for(this.backupRingInformation();this.rings.length>0;){for(var p=-1,t=0;t<this.rings.length;t++){var y=this.rings[t];this.isPartOfBridgedRing(y.id)&&!y.isBridged&&(p=y.id)}if(-1===p)break;var m=this.getRing(p),b=this.getBridgedRingRings(m.id);this.bridgedRing=!0,this.createBridgedRing(b,m.members[0]);for(var t=0;t<b.length;t++)this.removeRing(b[t])}}}},{key:"getBridgedRingRings",value:function(e){var t=[],i=this;return function e(r){var n=i.getRing(r);t.push(r);for(var s=0;s<n.neighbours.length;s++){var o=n.neighbours[s];-1===t.indexOf(o)&&o!==r&&RingConnection.isBridge(i.ringConnections,i.graph.vertices,r,o)&&e(o)}}(e),ArrayHelper.unique(t)}},{key:"isPartOfBridgedRing",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].containsRing(e)&&this.ringConnections[t].isBridge(this.graph.vertices))return!0;return!1}},{key:"createBridgedRing",value:function(e,t){for(var i=[],r=[],n=[],s=0;s<e.length;s++){for(var o=this.getRing(e[s]),a=0;a<o.members.length;a++)r.push(o.members[a]);for(var a=0;a<o.neighbours.length;a++)n.push(o.neighbours[a])}r=ArrayHelper.unique(r);for(var h=[],s=0;s<r.length;s++){var l=this.graph.vertices[r[s]],g=ArrayHelper.intersection(e,l.value.rings);1===l.value.rings.length||1===g.length?i.push(l.id):h.push(l.id)}for(var u=[],c=[],s=0;s<h.length;s++){for(var d=this.graph.vertices[h[s]],v=!1,f=0;f<d.edges.length;f++)1===this.edgeRingCount(d.edges[f])&&(v=!0);v?(d.value.isBridgeNode=!0,u.push(d.id)):(d.value.isBridge=!0,c.push(d.id))}var p=ArrayHelper.merge(i,u);n=ArrayHelper.unique(n),n=ArrayHelper.removeAll(n,e);for(var y=this.graph.vertices[t],m=y.getNeighbours(),s=0;s<m.length;s++){var b=m[s];-1!==p.indexOf(b)&&b}var C=new Ring(p);C.isBridged=!0,C.neighbours=n,C.insiders=c;for(var s=0;s<e.length;s++)C.rings.push(this.getRing(e[s]).clone());this.addRing(C),this.graph.vertices[t].value.anchoredRings.push(C.id);for(var s=0;s<c.length;s++){var x=this.graph.vertices[c[s]];x.value.rings=[],x.value.anchoredRings=[],x.value.bridgedRing=C.id}for(var s=0;s<p.length;s++){var A=this.graph.vertices[p[s]];A.value.rings=ArrayHelper.removeAll(A.value.rings,e),A.value.rings.push(C.id)}for(var s=0;s<e.length;s++)for(var a=s+1;a<e.length;a++)this.removeRingConnectionsBetween(e[s],e[a]);for(var s=0;s<n.length;s++){for(var k=this.getRingConnections(n[s],e),a=0;a<k.length;a++)this.getRingConnection(k[a]).updateOther(C.id,n[s]);this.getRing(n[s]).neighbours.push(C.id)}return C}},{key:"areVerticesInSameRing",value:function(e,t){for(var i=0;i<e.value.rings.length;i++)for(var r=0;r<t.value.rings.length;r++)if(e.value.rings[i]===t.value.rings[r])return!0;return!1}},{key:"getCommonRings",value:function(e,t){for(var i=[],r=0;r<e.value.rings.length;r++)for(var n=0;n<t.value.rings.length;n++)e.value.rings[r]==t.value.rings[n]&&i.push(e.value.rings[r]);return i}},{key:"getSmallestCommonRing",value:function(e,t){for(var i=this.getCommonRings(e,t),r=Number.MAX_VALUE,n=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).getSize();o<r&&(r=o,n=this.getRing(i[s]))}return n}},{key:"getLargestOrAromaticCommonRing",value:function(e,t){for(var i=this.getCommonRings(e,t),r=0,n=null,s=0;s<i.length;s++){var o=this.getRing(i[s]),a=o.getSize();if(o.isBenzeneLike(this.graph.vertices))return o;a>r&&(r=a,n=o)}return n}},{key:"getVerticesAt",value:function(e,t,i){for(var r=[],n=0;n<this.graph.vertices.length;n++){var s=this.graph.vertices[n];if(s.id!==i&&s.positioned){e.distance(s.position)<=t&&r.push(s.id)}}return r}},{key:"getClosestVertex",value:function(e){for(var t=99999,i=null,r=0;r<this.graph.vertices.length;r++){var n=this.graph.vertices[r];if(n.id!==e.id){var s=e.position.distanceSq(n.position);s<t&&(t=s,i=n)}}return i}},{key:"getClosestEndpointVertex",value:function(e){for(var t=99999,i=null,r=0;r<this.graph.vertices.length;r++){var n=this.graph.vertices[r];if(!(n.id===e.id||n.getNeighbourCount()>1)){var s=e.position.distanceSq(n.position);s<t&&(t=s,i=n)}}return i}},{key:"addRing",value:function(e){return e.id=this.ringIdCounter++,this.rings.push(e),e.id}},{key:"removeRing",value:function(e){this.rings=this.rings.filter(function(t){return t.id!==e}),this.ringConnections=this.ringConnections.filter(function(t){return t.firstRingId!==e&&t.secondRingId!==e});for(var t=0;t<this.rings.length;t++){var i=this.rings[t];i.neighbours=i.neighbours.filter(function(t){return t!==e})}}},{key:"getRing",value:function(e){for(var t=0;t<this.rings.length;t++)if(this.rings[t].id==e)return this.rings[t]}},{key:"addRingConnection",value:function(e){return e.id=this.ringConnectionIdCounter++,this.ringConnections.push(e),e.id}},{key:"removeRingConnection",value:function(e){this.ringConnections=this.ringConnections.filter(function(t){return t.id!==e})}},{key:"removeRingConnectionsBetween",value:function(e,t){for(var i=[],r=0;r<this.ringConnections.length;r++){var n=this.ringConnections[r];(n.firstRingId===e&&n.secondRingId===t||n.firstRingId===t&&n.secondRingId===e)&&i.push(n.id)}for(var r=0;r<i.length;r++)this.removeRingConnection(i[r])}},{key:"getRingConnection",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].id==e)return this.ringConnections[t]}},{key:"getRingConnections",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=[];if(null===t)for(var r=0;r<this.ringConnections.length;r++){var n=this.ringConnections[r];n.firstRingId!==e&&n.secondRingId!==e||i.push(n.id)}else if(t.constructor!==Array)for(var r=0;r<this.ringConnections.length;r++){var s=this.ringConnections[r];(s.firstRingId===e&&s.secondRingId===t||s.firstRingId===t&&s.secondRingId===e)&&i.push(s.id)}else for(var r=0;r<this.ringConnections.length;r++)for(var o=0;o<t.length;o++){var a=t[o],h=this.ringConnections[r];(h.firstRingId===e&&h.secondRingId===a||h.firstRingId===a&&h.secondRingId===e)&&i.push(h.id)}return i}},{key:"isRingConnection",value:function(e,t){for(var i=0;i<this.ringConnections.length;i++){var r=this.ringConnections[i];if(2===r.vertices.size&&(r.vertices.has(e)&&r.vertices.has(t)))return!0}return!1}},{key:"getOverlapScore",value:function(){for(var e=0,t=new Float32Array(this.graph.vertices.length),i=0;i<this.graph.vertices.length;i++)t[i]=0;for(var i=0;i<this.graph.vertices.length;i++)for(var r=i+1;r<this.graph.vertices.length;r++){var n=this.graph.vertices[i],s=this.graph.vertices[r],o=Vector2.subtract(n.position,s.position).length();if(o<this.opts.bondLength){var a=(this.opts.bondLength-o)/this.opts.bondLength;e+=a,t[i]+=a,t[r]+=a}}for(var h=[],i=0;i<this.graph.vertices.length;i++)h.push({id:i,score:t[i]});return h.sort(function(e,t){return t.score-e.score}),{total:e,scores:h,vertexScores:t}}},{key:"chooseSide",value:function(e,t,i){for(var r=e.getNeighbours(t.id),n=t.getNeighbours(e.id),s=r.length,o=n.length,a=ArrayHelper.merge(r,n),h=[0,0],l=0;l<a.length;l++){this.graph.vertices[a[l]].position.sameSideAs(e.position,t.position,i[0])?h[0]++:h[1]++}for(var g=[0,0],l=0;l<this.graph.vertices.length;l++){this.graph.vertices[l].position.sameSideAs(e.position,t.position,i[0])?g[0]++:g[1]++}return{totalSideCount:g,totalPosition:g[0]>g[1]?0:1,sideCount:h,position:h[0]>h[1]?0:1,anCount:s,bnCount:o}}},{key:"areConnected",value:function(e,t){for(var i=0;i<this.graph.edges.length;i++){var r=this.graph.edges[i];if(r.sourceId===e&&r.targetId===t||r.sourceId===t&&r.targetId===e)return!0}return!1}},{key:"getEdgeWeight",value:function(e,t){for(var i=0;i<this.graph.edges.length;i++){var r=this.graph.edges[i];if(r.sourceId==e&&r.targetId==t||r.targetId==e&&r.sourceId==t)return r.weight}return null}},{key:"forceLayout",value:function(e,t,i,r){for(var n=this.opts.bondLength,s=this.graph.vertices[i],o=s.getNeighbours(),a=0;a<o.length;a++)this.graph.vertices[o[a]].positioned&&e.push(o[a]);for(var h=e.length+r.rings.length,l=[e.length],g=new Map,u=[h],c=[],a=0;a<h;a++){u[a]=[h];for(var d=0;d<h;d++)u[a][d]=0}for(var a=0;a<e.length;a++)l[a]=this.graph.vertices[e[a]].id,g.set(l[a],a);for(var a=0;a<e.length-1;a++)for(var d=a;d<e.length;d++){var v=this.graph.getEdge(l[a],this.graph.vertices[e[d]].id);null!==v&&(u[a][d]=n,u[d][a]=n,c.push([a,d]))}for(var a=0;a<r.rings.length;a++)for(var f=r.rings[a],p=e.length+a,d=0;d<f.members.length;d++){var y=g.get(f.members[d]),m=MathHelper.polyCircumradius(n,f.getSize());u[y][p]=m,u[p][y]=m}for(var a=0;a<c.length;a++){for(var d=0;d<h;d++)u[d].push(0);u.push([]);for(var d=0;d<h+c.length;d++)u[h+a].push(0)}for(var a=0;a<r.rings.length;a++){for(var b=r.rings[a],C=e.length+a,x=b.getSize(),d=0;d<c.length;d++){var A=c[d][0];if(0!==u[C][A]){var k=MathHelper.apothem(u[C][A],x);u[C][h+d]=k,u[h+d][C]=k}}for(var d=a;d<r.rings.length;d++){var R=r.rings[d];if(R.id!==b.id){if(0!==ArrayHelper.intersection(b.members,R.members).length){var S=e.length+d,w=R.getSize(),N=MathHelper.apothemFromSideLength(n,x)+MathHelper.apothemFromSideLength(n,w);u[C][S]=N,u[S][C]=N}}}}h+=c.length;for(var I=h-c.length,L=[h],V=[h],T=[h],P=[h],B=[h],H=[h],a=0;a<h;a++)P[a]=a>=e.length&&a<I,H[a]=a<e.length?this.graph.vertices[l[a]].value.originalRings.length:1,P[a]?B[a]=r.rings[a-e.length].members.length:B[a]=1;for(var a=0;a<h;a++)if(L[a]=new Vector2,V[a]=new Vector2(t.x+Math.random()*n,t.y+Math.random()*n),T[a]=!1,!(a>=e.length)){var M=this.graph.vertices[l[a]];V[a]=M.position.clone(),M.positioned&&2===r.rings.length&&(T[a]=!0)}for(var E=n/1.4,z=E*E,O=n/2,F=2*n,D=F*F,_=0;_<600;_++){for(var a=0;a<h;a++)L[a].x=0,L[a].y=0;for(var a=0;a<c.length;a++){var W=I+a,j=V[c[a][0]],q=V[c[a][1]];V[W]=Vector2.midpoint(j,q)}for(var U=0;U<h-1;U++)for(var G=U+1;G<h;G++)if((!(_<=250)||P[U]&&P[G])&&!(_>250&&P[U]&&P[G]||r.rings.length<3&&(P[U]||P[G]))){var X=V[G].x-V[U].x,Y=V[G].y-V[U].y;if(0!==X&&0!==Y){var Z=X*X+Y*Y;Z<.01&&(X=.1*Math.random()+.1,Y=.1*Math.random()+.1,Z=X*X+Y*Y);var K=Math.sqrt(Z);if(!(K>u[U][G]&&_>200)){var $=z/K;_<=200&&($*=B[U]*B[G]),_>250&&(P[U]||P[G])&&($*=B[U]*B[G]);var J=$/K,Q=J*X,ee=J*Y;T[U]||(L[U].x-=Q,L[U].y-=ee),T[G]||(L[G].x+=Q,L[G].y+=ee)}}}for(var U=0;U<h-1;U++)for(var G=U+1;G<h;G++){var te=P[U]&&P[G];if(!(u[U][G]<1)&&((!(_<=250)||te)&&!(_>250&&te))){var ie=V[G].x-V[U].x,re=V[G].y-V[U].y;if(0!==ie&&0!==re){var ne=ie*ie+re*re;ne<.01&&(ie=.1*Math.random()+.1,re=.1*Math.random()+.1,ne=ie*ie+re*re);var se=Math.sqrt(ne);se>F&&(se=F,ne=D);var oe=(ne-z)/E,ae=u[U][G];oe*=se/ae;var he=oe/se,le=he*ie,ge=he*re;T[U]||(L[U].x+=le,L[U].y+=ge),T[G]||(L[G].x-=le,L[G].y-=ge)}}}for(var a=0;a<c.length;a++){var ue=I+a,ce=L[ue],de=c[a][0],ve=c[a][1];L[de].x+=ce.x,L[de].y+=ce.y,L[ve].x+=ce.x,L[ve].y+=ce.y}for(var U=0;U<h;U++)if(!T[U]){var fe=.005*L[U].x,pe=.005*L[U].y;fe>O&&(fe=O),fe<-O&&(fe=-O),pe>O&&(pe=O),pe<-O&&(pe=-O),V[U].x+=fe,V[U].y+=pe}if(_>200&&r.rings.length>2)for(var a=0;a<r.rings.length;a++){for(var ye=r.rings[a],me=new Vector2,d=0;d<ye.members.length;d++){var be=V[g.get(ye.members[d])];me.x+=be.x,me.y+=be.y}me.x/=ye.members.length,me.y/=ye.members.length,V[e.length+a]=me}}for(var a=0;a<h;a++)if(a<e.length)T[a]||(this.graph.vertices[l[a]].setPositionFromVector(V[a]),this.graph.vertices[l[a]].positioned=!0);else if(a<e.length+r.rings.length){var Ce=a-e.length;r.rings[Ce].center=V[a]}for(var U=0;U<e.length;U++)for(var xe=this.graph.vertices[e[U]],Ae=xe.getNeighbours(),a=0;a<Ae.length;a++){var ke=this.graph.vertices[Ae[a]];ke.positioned||(t=this.getSubringCenter(r,xe),0===ke.value.rings.length&&(ke.value.isConnectedToRing=!0),this.createNextBond(ke,xe,t))}this.createRing(r,null,null,null,!0)}},{key:"getSubringCenter",value:function(e,t){for(var i=Number.MAX_VALUE,r=e.center,n=0;n<e.rings.length;n++)for(var s=e.rings[n],o=0;o<s.members.length;o++)s.members[o]===t.id&&i>s.members.length&&(r=s.center,i=s.members.length);return r}},{key:"drawEdges",value:function(e){for(var t=this,i=0;i<this.graph.edges.length;i++){var r=this.graph.edges[i],n=this.graph.vertices[r.sourceId],s=this.graph.vertices[r.targetId],o=n.value.element,a=s.value.element;if(n.value.isDrawn&&s.value.isDrawn||"default"!==this.opts.atomVisualization){var h=n.position,l=s.position,g=this.getEdgeNormals(r),u=ArrayHelper.clone(g);if(u[0].multiplyScalar(10).add(h),u[1].multiplyScalar(10).add(h),"="===r.bondType||"="===this.getRingbondType(n,s)){var c=this.areVerticesInSameRing(n,s),d=this.chooseSide(n,s,u);if(c){var v=this.getLargestOrAromaticCommonRing(n,s),f=v.center;ArrayHelper.each(g,function(e){e.multiplyScalar(t.opts.bondSpacing)});var p=null;p=f.sameSideAs(n.position,s.position,Vector2.add(h,g[0]))?new Line(Vector2.add(h,g[0]),Vector2.add(l,g[0]),o,a):new Line(Vector2.add(h,g[1]),Vector2.add(l,g[1]),o,a),p.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(p),this.canvasWrapper.drawLine(new Line(h,l,o,a))}else if(r.center){ArrayHelper.each(g,function(e){e.multiplyScalar(t.opts.bondSpacing/2)});var y=new Line(Vector2.add(h,g[0]),Vector2.add(l,g[0]),o,a),m=new Line(Vector2.add(h,g[1]),Vector2.add(l,g[1]),o,a);y.shorten(this.opts.bondLength-this.opts.shortBondLength),m.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(y),this.canvasWrapper.drawLine(m)}else if(0==d.anCount&&d.bnCount>1||0==d.bnCount&&d.anCount>1){ArrayHelper.each(g,function(e){e.multiplyScalar(t.opts.bondSpacing/2)});var b=new Line(Vector2.add(h,g[0]),Vector2.add(l,g[0]),o,a),C=new Line(Vector2.add(h,g[1]),Vector2.add(l,g[1]),o,a);this.canvasWrapper.drawLine(b),this.canvasWrapper.drawLine(C)}else if(d.sideCount[0]>d.sideCount[1]){ArrayHelper.each(g,function(e){e.multiplyScalar(t.opts.bondSpacing)});var x=new Line(Vector2.add(h,g[0]),Vector2.add(l,g[0]),o,a);x.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(x),this.canvasWrapper.drawLine(new Line(h,l,o,a))}else if(d.sideCount[0]<d.sideCount[1]){
ArrayHelper.each(g,function(e){e.multiplyScalar(t.opts.bondSpacing)});var A=new Line(Vector2.add(h,g[1]),Vector2.add(l,g[1]),o,a);A.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(A),this.canvasWrapper.drawLine(new Line(h,l,o,a))}else if(d.totalSideCount[0]>d.totalSideCount[1]){ArrayHelper.each(g,function(e){e.multiplyScalar(t.opts.bondSpacing)});var k=new Line(Vector2.add(h,g[0]),Vector2.add(l,g[0]),o,a);k.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(k),this.canvasWrapper.drawLine(new Line(h,l,o,a))}else if(d.totalSideCount[0]<=d.totalSideCount[1]){ArrayHelper.each(g,function(e){e.multiplyScalar(t.opts.bondSpacing)});var R=new Line(Vector2.add(h,g[1]),Vector2.add(l,g[1]),o,a);R.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(R),this.canvasWrapper.drawLine(new Line(h,l,o,a))}}else if("#"===r.bondType){ArrayHelper.each(g,function(e){e.multiplyScalar(t.opts.bondSpacing/1.5)});var S=new Line(Vector2.add(h,g[0]),Vector2.add(l,g[0]),o,a),w=new Line(Vector2.add(h,g[1]),Vector2.add(l,g[1]),o,a);this.canvasWrapper.drawLine(S),this.canvasWrapper.drawLine(w),this.canvasWrapper.drawLine(new Line(h,l,o,a))}else if("."===r.bondType);else{var N=n.value.bracket&&n.value.bracket.chirality,I=s.value.bracket&&s.value.bracket.chirality;"up"===r.chiral?this.canvasWrapper.drawWedge(new Line(h,l,o,a,N,I)):"down"===r.chiral?this.canvasWrapper.drawDashedWedge(new Line(h,l,o,a,N,I)):this.canvasWrapper.drawLine(new Line(h,l,o,a,N,I))}if(e){var L=Vector2.midpoint(h,l);this.canvasWrapper.drawDebugText(L.x,L.y,"e: "+i)}}}for(var i=0;i<this.rings.length;i++){var V=this.rings[i];this.isRingAromatic(V)&&this.canvasWrapper.drawAromaticityRing(V)}}},{key:"drawVertices",value:function(e){for(var t=0;t<this.graph.vertices.length;t++){var i=this.graph.vertices[t],r=i.value,n=0,s=0,o=this.getBondCount(i),a=r.element,h=this.maxBonds[a]-o,l=i.getTextDirection(this.graph.vertices),g=!(!this.opts.terminalCarbons&&"C"===a&&!r.hasAttachedPseudoElements)&&i.isTerminal(),u="C"===r.element;if(r.bracket&&(h=r.bracket.hcount,n=r.bracket.charge,s=r.bracket.isotope),r.isDrawn&&(!u||r.explicit||g||r.hasAttachedPseudoElements)&&("default"===this.opts.atomVisualization?this.canvasWrapper.drawText(i.position.x,i.position.y,a,h,l,g,n,s,r.getAttachedPseudoElements()):"balls"===this.opts.atomVisualization&&this.canvasWrapper.drawBall(i.position.x,i.position.y,a)),e){var c="v: "+i.id+" "+ArrayHelper.print(r.ringbonds);this.canvasWrapper.drawDebugText(i.position.x,i.position.y,c)}}if(this.opts.debug)for(var t=0;t<this.rings.length;t++){var d=this.rings[t].center;this.canvasWrapper.drawDebugPoint(d.x,d.y,"r: "+this.rings[t].id)}}},{key:"position",value:function(){var e=this.graph.vertices[0];this.createNextBond(e),this.resolvePrimaryOverlaps()}},{key:"clearPositions",value:function(){this.vertexPositionsBackup=[],this.ringPositionsBackup=[];for(var e=0;e<this.graph.vertices.length;e++){var t=this.graph.vertices[e];this.vertexPositionsBackup.push(t.position.clone()),t.positioned=!1,t.setPositionFromVector(new Vector2)}for(var e=0;e<this.rings.length;e++){var i=this.rings[e];this.ringPositionsBackup.push(i.center.clone()),i.positioned=!1,i.center=new Vector2}}},{key:"restorePositions",value:function(){for(var e=0;e<this.vertexPositionsBackup.length;e++)this.graph.vertices[e].setPositionFromVector(this.vertexPositionsBackup[e]),this.graph.vertices[e].positioned=!0;for(var e=0;e<this.ringPositionsBackup.length;e++)this.rings[e].center=this.ringPositionsBackup[e],this.rings[e].positioned=!0}},{key:"backupRingInformation",value:function(){this.originalRings=[],this.originalRingConnections=[];for(var e=0;e<this.rings.length;e++)this.originalRings.push(this.rings[e]);for(var e=0;e<this.ringConnections.length;e++)this.originalRingConnections.push(this.ringConnections[e]);for(var e=0;e<this.graph.vertices.length;e++)this.graph.vertices[e].value.backupRings()}},{key:"restoreRingInformation",value:function(){var e=this.getBridgedRings();this.rings=[],this.ringConnections=[];for(var t=0;t<e.length;t++)for(var i=e[t],r=0;r<i.rings.length;r++){var n=i.rings[r];this.originalRings[n.id].center=n.center}for(var t=0;t<this.originalRings.length;t++)this.rings.push(this.originalRings[t]);for(var t=0;t<this.originalRingConnections.length;t++)this.ringConnections.push(this.originalRingConnections[t]);for(var t=0;t<this.graph.vertices.length;t++)this.graph.vertices[t].value.restoreRings()}},{key:"createRing",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=this,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(!e.positioned||s){t=t||new Vector2(0,0);var o=e.getOrderedNeighbours(this.ringConnections),a=i?Vector2.subtract(i.position,t).angle():0,h=MathHelper.polyCircumradius(this.opts.bondLength,e.getSize()),l=MathHelper.centralAngle(e.getSize());e.centralAngle=l;var g=a,u=this,c=i?i.id:null;if(-1===e.members.indexOf(c)&&(c=e.members[0]),!s){if(e.eachMember(this.graph.vertices,function(i){var r=u.graph.vertices[i];r.positioned||r.setPosition(t.x+Math.cos(g)*h,t.y+Math.sin(g)*h),g+=l,(!e.isBridged||e.rings.length<3)&&(r.positioned=!0)},c,n?n.id:null),e.isBridged){var d=ArrayHelper.merge(e.members,e.insiders);this.forceLayout(d,t,i.id,e)}this.graph.vertices[e.members[0]].value.addAnchoredRing(e.id),e.positioned=!0,e.center=t}for(var v=0;v<o.length;v++){var f=this.getRing(o[v].neighbour);if(!f.positioned){var p=RingConnection.getVertices(this.ringConnections,e.id,f.id);if(2===p.length)!function(){e.isFused=!0,f.isFused=!0;var t=r.graph.vertices[p[0]],i=r.graph.vertices[p[1]],n=Vector2.midpoint(t.position,i.position),s=Vector2.normals(t.position,i.position);ArrayHelper.each(s,function(e){e.normalize()});var o=MathHelper.polyCircumradius(r.opts.bondLength,f.getSize()),a=MathHelper.apothem(o,f.getSize());ArrayHelper.each(s,function(e){e.multiplyScalar(a)}),ArrayHelper.each(s,function(e){e.add(n)});var h=s[0];r.isPointInRing(h)&&(h=s[1]);var l=Vector2.subtract(t.position,h),g=Vector2.subtract(i.position,h);-1===l.clockwise(g)?r.createRing(f,h,t,i):r.createRing(f,h,i,t)}();else if(1===p.length){e.isSpiro=!0,f.isSpiro=!0;var y=this.graph.vertices[p[0]],m=Vector2.subtract(t,y.position);m.invert(),m.normalize();var b=MathHelper.polyCircumradius(this.opts.bondLength,f.getSize());m.multiplyScalar(b),m.add(y.position),this.createRing(f,m,y)}}}for(var v=0;v<e.members.length;v++)for(var C=this.graph.vertices[e.members[v]],x=C.getNeighbours(),A=0;A<x.length;A++){var k=this.graph.vertices[x[A]];k.positioned||(k.value.isConnectedToRing=!0,this.createNextBond(k,C,e.center))}}}},{key:"rotateSubtree",value:function(e,t,i,r){var n=this;this.traverseTree(e,t,function(e){e.position.rotateAround(i,r);for(var t=0;t<e.value.anchoredRings.length;t++){var s=n.rings[e.value.anchoredRings[t]];s&&s.center.rotateAround(i,r)}})}},{key:"getSubtreeOverlapScore",value:function(e,t,i){var r=this,n=0,s=new Vector2;return this.traverseTree(e,t,function(e){var t=i[e.id];n+=t;var o=r.graph.vertices[e.id].position.clone();o.multiplyScalar(t),s.add(o)}),s.divide(n),{value:n,center:s}}},{key:"getCurrentCenterOfMass",value:function(){for(var e=new Vector2,t=0,i=0;i<this.graph.vertices.length;i++){var r=this.graph.vertices[i];r.positioned&&(e.add(r.position),t++)}return e.divide(t)}},{key:"getCurrentCenterOfMassInNeigbourhood",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2*this.opts.bondLength,i=new Vector2,r=0,n=t*t,s=0;s<this.graph.vertices.length;s++){var o=this.graph.vertices[s];o.positioned&&e.distanceSq(o.position)<n&&(i.add(o.position),r++)}return i.divide(r)}},{key:"resolvePrimaryOverlaps",value:function(){for(var e=[],t=[],i=[this.graph.vertices.length],r=0;r<this.rings.length;r++)for(var n=this.rings[r],s=0;s<n.members.length;s++){var o=this.graph.vertices[n.members[s]];if(!i[o.id]&&(i[o.id]=!0,o.getNeighbourCount()>2)){for(var a=[],h=0;h<o.value.rings.length;h++)a.push(o.value.rings[h]);e.push({common:o,rings:a,vertices:this.getNonRingNeighbours(o.id)})}}for(var r=0;r<t.length;r++){var l=t[r],g=-l.vertex.position.getRotateToAngle(l.other.position,l.common.position);this.rotateSubtree(l.vertex.id,l.common.id,g+Math.PI,l.common.position)}for(var r=0;r<e.length;r++){var u=e[r];if(1===u.vertices.length){var c=u.vertices[0];if(1===c.getNeighbourCount()){c.flippable=!0,c.flipCenter=u.common.id;for(var s=0;s<u.rings.length;s++)c.flipRings.push(u.rings[s])}if(2===u.rings.length){for(var d=u.common.getNeighbours(),v=[],s=0;s<d.length;s++){var f=this.graph.vertices[d[s]];this.isRingConnection(f.id,u.common.id)||f.id===c.id||v.push(f.position)}var p=Vector2.midpoint(v[0],v[1]),y=c.position.getRotateToAngle(p,u.common.position);y*=c.position.clockwise(p),this.rotateSubtree(c.id,u.common.id,y,u.common.position)}}else if(2===u.vertices.length){var m=(2*Math.PI-this.getRing(u.rings[0]).getAngle())/6,b=u.vertices[0],C=u.vertices[1];if(b.backAngle-=m,C.backAngle+=m,this.rotateSubtree(b.id,u.common.id,m,u.common.position),this.rotateSubtree(C.id,u.common.id,-m,u.common.position),1===b.getNeighbourCount()){b.flippable=!0,b.flipCenter=u.common.id,b.flipNeighbour=C.id;for(var s=0;s<u.rings.length;s++)b.flipRings.push(u.rings[s])}if(1===C.getNeighbourCount()){C.flippable=!0,C.flipCenter=u.common.id,C.flipNeighbour=b.id;for(var s=0;s<u.rings.length;s++)C.flipRings.push(u.rings[s])}}}}},{key:"resolveSecondaryOverlaps",value:function(e){for(var t=0;t<e.length;t++)if(e[t].score>this.opts.bondLength/(4*this.opts.bondLength)){var i=this.graph.vertices[e[t].id];if(i.isTerminal()){var r=this.getClosestVertex(i);if(r){var n=null;n=r.isTerminal()?0===r.id?this.graph.vertices[1].position:r.previousPosition:0===r.id?this.graph.vertices[1].position:r.position;var s=0===i.id?this.graph.vertices[1].position:i.previousPosition;i.position.rotateAwayFrom(n,s,MathHelper.toRad(20))}}if(i.flippable){var o=i.flipRings[0]?this.rings[i.flipRings[0]]:null,a=i.flipRings[1]?this.rings[i.flipRings[1]]:null,h=this.graph.vertices[i.flipCenter].position;if(o&&a){var l=o.members.length>a.members.length?o:a;a=o.members.length<a.members.length?o:a,o=l}this.opts.allowFlips&&(o&&o.allowsFlip()?(i.position.rotateTo(o.center,h),o.setFlipped(),i.flipNeighbour):a&&a.allowsFlip()&&(i.position.rotateTo(a.center,h),a.setFlipped(),i.flipNeighbour))}}}},{key:"createNextBond",value:function(e,t,i,r){if(!e.positioned){if(t)if(0!==t.value.rings.length||e.value.isBridge||t.value.isBridge){if(t.value.isBridgeNode&&e.value.isBridge){var n=Vector2.subtract(i,t.position);n.normalize(),n.multiplyScalar(this.opts.bondLength),e.position.add(t.position),e.position.add(n),e.previousPosition=t.position,e.positioned=!0}else if(e.value.isBridge){var s=new Vector2(this.opts.bondLength,0);s.rotate(i),s.add(t.position),e.globalAngle=i,e.setPositionFromVector(s),e.previousPosition=t.position,e.positioned=!0}else if(1===t.value.rings.length||t.value.isBridge){var o=Vector2.subtract(i,t.position);o.invert(),o.normalize(),o.multiplyScalar(this.opts.bondLength),e.position.add(t.position),e.position.add(o),e.previousPosition=t.position,e.positioned=!0}else if(2==t.value.rings.length){var a=this.getRing(t.value.rings[0]),h=this.getRing(t.value.rings[1]),l=Vector2.subtract(h.center,a.center),g=Vector2.subtract(t.position,a.center),u=Vector2.scalarProjection(g,l);l.normalize(),l.multiply(u),l.add(a.center);var c=Vector2.subtract(l,t.position);c.invert(),c.normalize(),c.multiplyScalar(this.opts.bondLength),e.position.add(t.position),e.position.add(c),e.previousPosition=t.position,e.positioned=!0}}else{var d=new Vector2(this.opts.bondLength,0);d.rotate(i),d.add(t.position),e.globalAngle=i,e.setPositionFromVector(d),e.previousPosition=t.position,e.positioned=!0}else{var v=new Vector2(this.opts.bondLength,0);v.rotate(MathHelper.toRad(-120)),e.previousPosition=v,e.setPosition(this.opts.bondLength,0),e.angle=MathHelper.toRad(-120),e.globalAngle=e.angle,e.positioned=!0}if(e.value.rings.length>0){var f=this.getRing(e.value.rings[0]),p=Vector2.subtract(e.previousPosition,e.position);p.invert(),p.normalize();var y=MathHelper.polyCircumradius(this.opts.bondLength,f.getSize());p.multiplyScalar(y),p.add(e.position),this.createRing(f,p,e)}else if(null!==e.value.bridgedRing){var m=this.getRing(e.value.bridgedRing),b=Vector2.subtract(e.previousPosition,e.position);b.invert(),b.normalize();var C=MathHelper.polyCircumradius(this.opts.bondLength,m.members.length);b.multiplyScalar(C),b.add(e.position),this.createRing(m,b,e)}else{var x=e.getNeighbours();t&&(x=ArrayHelper.remove(x,t.id));var A=e.getAngle();if(1===x.length){var k=this.graph.vertices[x[0]];if("#"===e.value.bondType||t&&"#"===t.value.bondType||"="===e.value.bondType&&t&&"="===t.value.bondType){if(e.value.explicit=!0,t){var R=this.graph.getEdge(e.id,t.id);R.center=!0}var S=this.graph.getEdge(e.id,k.id);S.center=!0,k.globalAngle=A,k.angle=0,this.createNextBond(k,e,k.globalAngle,-r)}else if(t&&t.value.rings.length>0){var w=MathHelper.toRad(60),N=-w,I=new Vector2(this.opts.bondLength,0),L=new Vector2(this.opts.bondLength,0);I.rotate(w).add(e.position),L.rotate(N).add(e.position);var V=this.getCurrentCenterOfMass(),T=I.distance(V),P=L.distance(V);k.angle=T<P?N:w,r=k.angle>0?-1:1,k.globalAngle=A+k.angle,this.createNextBond(k,e,k.globalAngle,r)}else{if(r)k.angle=MathHelper.toRad(60)*r,r=-r;else{var B=MathHelper.toRad(60),H=-B,M=new Vector2(this.opts.bondLength,0),E=new Vector2(this.opts.bondLength,0);M.rotate(B).add(e.position),E.rotate(H).add(e.position);var z=this.getCurrentCenterOfMass(),O=M.distance(z),F=E.distance(z);k.angle=O<F?H:B,r=k.angle>0?-1:1}k.globalAngle=A+k.angle,this.createNextBond(k,e,k.globalAngle,r)}}else if(2===x.length){var D=this.getTreeDepth(x[0],e.id),_=this.getTreeDepth(x[1],e.id),W=this.getTreeDepth(t?t.id:null,e.id),j=0,q=1;D>_&&(j=1,q=0);var U=this.graph.vertices[x[j]],G=this.graph.vertices[x[q]];W<D&&W<_?1===e.position.clockwise(e.previousPosition)?(G.angle=MathHelper.toRad(60),U.angle=-MathHelper.toRad(60),G.globalAngle=A+G.angle,U.globalAngle=A+U.angle,this.createNextBond(G,e,G.globalAngle,-r),this.createNextBond(U,e,U.globalAngle,r)):(G.angle=-MathHelper.toRad(60),U.angle=MathHelper.toRad(60),G.globalAngle=A+G.angle,U.globalAngle=A+U.angle,this.createNextBond(U,e,U.globalAngle,r),this.createNextBond(G,e,G.globalAngle,-r)):1===e.position.clockwise(e.previousPosition)?(G.angle=MathHelper.toRad(60),U.angle=-MathHelper.toRad(60),G.globalAngle=A+G.angle,U.globalAngle=A+U.angle,this.createNextBond(G,e,G.globalAngle,-r),this.createNextBond(U,e,U.globalAngle,-r)):(G.angle=-MathHelper.toRad(60),U.angle=MathHelper.toRad(60),G.globalAngle=A+G.angle,U.globalAngle=A+U.angle,this.createNextBond(U,e,U.globalAngle,-r),this.createNextBond(G,e,G.globalAngle,-r))}else if(3===x.length){var X=this.getTreeDepth(x[0],e.id),Y=this.getTreeDepth(x[1],e.id),Z=this.getTreeDepth(x[2],e.id),K=this.graph.vertices[x[0]],$=this.graph.vertices[x[1]],J=this.graph.vertices[x[2]];if(Y>X&&Y>Z?(K=this.graph.vertices[x[1]],$=this.graph.vertices[x[0]],J=this.graph.vertices[x[2]]):Z>X&&Z>Y&&(K=this.graph.vertices[x[2]],$=this.graph.vertices[x[0]],J=this.graph.vertices[x[1]]),1===this.getTreeDepth($.id,e.id)&&1===this.getTreeDepth(J.id,e.id)&&this.getTreeDepth(K.id,e.id)>1){if(r)K.angle=MathHelper.toRad(60)*r,r=-r;else{var Q=MathHelper.toRad(60),ee=-Q,te=new Vector2(this.opts.bondLength,0),ie=new Vector2(this.opts.bondLength,0);te.rotate(Q).add(e.position),ie.rotate(ee).add(e.position);var re=this.getCurrentCenterOfMass(),ne=te.distance(re),se=ie.distance(re);K.angle=ne<se?ee:Q,r=K.angle>0?-1:1}K.globalAngle=A+K.angle,this.createNextBond(K,e,K.globalAngle,-r),e.value.bracket&&"@@"===e.value.bracket.chirality?(J.angle=MathHelper.toRad(30)*r,$.angle=MathHelper.toRad(90)*r,J.globalAngle=A+J.angle,$.globalAngle=A+$.angle,this.createNextBond(J,e,J.globalAngle),this.createNextBond($,e,$.globalAngle)):($.angle=MathHelper.toRad(30)*r,J.angle=MathHelper.toRad(90)*r,$.globalAngle=A+$.angle,J.globalAngle=A+J.angle,this.createNextBond($,e,$.globalAngle),this.createNextBond(J,e,J.globalAngle))}else K.angle=0,$.angle=MathHelper.toRad(90),J.angle=-MathHelper.toRad(90),K.globalAngle=A+K.angle,$.globalAngle=A+$.angle,J.globalAngle=A+J.angle,this.createNextBond(K,e,K.globalAngle),this.createNextBond($,e,$.globalAngle),this.createNextBond(J,e,J.globalAngle)}else if(4===x.length){var oe=this.getTreeDepth(x[0],e.id),ae=this.getTreeDepth(x[1],e.id),he=this.getTreeDepth(x[2],e.id),le=this.getTreeDepth(x[3],e.id),ge=this.graph.vertices[x[0]],ue=this.graph.vertices[x[1]],ce=this.graph.vertices[x[2]],de=this.graph.vertices[x[3]];ae>oe&&ae>he&&ae>le?(ge=this.graph.vertices[x[1]],ue=this.graph.vertices[x[0]],ce=this.graph.vertices[x[2]],de=this.graph.vertices[x[3]]):he>oe&&he>ae&&he>le?(ge=this.graph.vertices[x[2]],ue=this.graph.vertices[x[0]],ce=this.graph.vertices[x[1]],de=this.graph.vertices[x[3]]):le>oe&&le>ae&&le>he&&(ge=this.graph.vertices[x[3]],ue=this.graph.vertices[x[0]],ce=this.graph.vertices[x[1]],de=this.graph.vertices[x[2]]),ge.angle=-MathHelper.toRad(36),ue.angle=MathHelper.toRad(36),ce.angle=-MathHelper.toRad(108),de.angle=MathHelper.toRad(108),ge.globalAngle=A+ge.angle,ue.globalAngle=A+ue.angle,ce.globalAngle=A+ce.angle,de.globalAngle=A+de.angle,this.createNextBond(ge,e,ge.globalAngle),this.createNextBond(ue,e,ue.globalAngle),this.createNextBond(ce,e,ce.globalAngle),this.createNextBond(de,e,de.globalAngle)}}}}},{key:"getCommonRingbondNeighbour",value:function(e){for(var t=e.getNeighbours(),i=0;i<t.length;i++){var r=this.graph.vertices[t[i]];if(ArrayHelper.All(r.value.rings,e.value.rings))return r}return null}},{key:"isPointInRing",value:function(e){for(var t=0;t<this.rings.length;t++){var i=this.rings[t];if(i.positioned){var r=(i.getPolygon(this.graph.vertices),MathHelper.polyCircumradius(this.opts.bondLength,i.getSize())),n=r*r;if(e.distanceSq(i.center)<n)return!0}}return!1}},{key:"isEdgeInRing",value:function(e){var t=this.graph.vertices[e.sourceId],i=this.graph.vertices[e.targetId];return this.areVerticesInSameRing(t,i)}},{key:"isEdgeRotatable",value:function(e){var t=this.graph.vertices[e.sourceId],i=this.graph.vertices[e.targetId];return"-"===e.bondType&&(!(t.getNeighbourCount()+i.getNeighbourCount()<5)&&!(t.value.rings.length>0&&i.value.rings.length>0&&this.areVerticesInSameRing(t,i)))}},{key:"isRingAromatic",value:function(e){for(var t=0;t<e.members.length;t++){if(!this.graph.vertices[e.members[t]].value.isPartOfAromaticRing)return!1}return!0}},{key:"isEdgeInAromaticRing",value:function(e){var t=this.graph.vertices[e.sourceId].value,i=this.graph.vertices[e.targetId].value;return t.isPartOfAromaticRing&&i.isPartOfAromaticRing}},{key:"getEdgeNormals",value:function(e){var t=this.graph.vertices[e.sourceId].position,i=this.graph.vertices[e.targetId].position;return Vector2.units(t,i)}},{key:"getTreeDepth",value:function(e,t){if(null===e||null===t)return 0;for(var i=this.graph.vertices[e].getSpanningTreeNeighbours(t),r=0,n=0;n<i.length;n++){var s=i[n],o=this.getTreeDepth(s,e);o>r&&(r=o)}return r+1}},{key:"traverseTree",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];if(!(null!==r&&s>r+1)){for(var a=0;a<o.length;a++)if(o[a]===e)return;o.push(e);var h=this.graph.vertices[e],l=h.getNeighbours(t);(!n||s>1)&&i(h);for(var g=0;g<l.length;g++)this.traverseTree(l[g],e,i,r,n,s+1,o)}}},{key:"getBondCount",value:function(e){for(var t=0,i=0;i<e.edges.length;i++)t+=this.graph.edges[e.edges[i]].getBondCount();return t}},{key:"getNonRingNeighbours",value:function(e){for(var t=[],i=this.graph.vertices[e],r=i.getNeighbours(),n=0;n<r.length;n++){var s=this.graph.vertices[r[n]];0===ArrayHelper.intersection(i.value.rings,s.value.rings).length&&0==s.value.isBridge&&t.push(s)}return t}},{key:"annotateChirality",value:function(){}},{key:"initPseudoElements",value:function(){for(var e=0;e<this.graph.vertices.length;e++){for(var t=this.graph.vertices[e],i=(t.value.element,t.getNeighbours()),r=[],n=0;n<i.length;n++)r.push(this.graph.vertices[i[n]]);if(!(t.getNeighbourCount()<3||t.value.rings.length>0)){for(var s=0,o=0,n=0;n<r.length;n++){var a=r[n],h=a.value.element,l=a.getNeighbourCount();"C"!==h&&"H"!==h&&1===l&&s++,l>1&&o++}if(!(o>1||s<2)){for(var g=null,n=0;n<r.length;n++){var u=r[n];u.getNeighbourCount()>1&&(g=u)}for(var n=0;n<r.length;n++){var c=r[n];if(!(c.getNeighbourCount()>1)){c.value.isDrawn=!1;var d=this.maxBonds[c.value.element]-this.getBondCount(c);c.value.bracket&&(d=c.value.bracket.hcount),t.value.attachPseudoElement(c.value.element,g?g.value.element:null,d)}}}}}for(var e=0;e<this.graph.vertices.length;e++){var v=this.graph.vertices[e],f=v.value,p=f.element;if("C"!==p&&"H"!==p&&f.isDrawn){for(var y=v.getNeighbours(),m=[],n=0;n<y.length;n++)m.push(this.graph.vertices[y[n]]);for(var n=0;n<m.length;n++){var b=m[n].value;if(b.hasAttachedPseudoElements&&2===b.getAttachedPseudoElementsCount()){var C=b.getAttachedPseudoElements();C.hasOwnProperty("0O")&&C.hasOwnProperty("3C")&&(b.isDrawn=!1,v.value.attachPseudoElement("Ac","",0))}}}}}}],[{key:"clean",value:function(e){return e.replace(/[^A-Za-z0-9@\.\+\-\?!\(\)\[\]\{\}\/\\=#\$:\*]/g,"")}},{key:"apply",value:function(t){for(var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"light",r=new e(t),n=document.querySelectorAll("canvas[data-smiles]"),s=0;s<n.length;s++){var o=n[s],a=e.parse(e.clean(o.getAttribute("data-smiles")));r.draw(a,o,i,!1)}}},{key:"parse",value:function(e,t,i){try{t&&t(SMILESPARSER.parse(e))}catch(e){i&&i(e)}}}]),e}(),SSSR=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getRings",value:function(t){if(0===t.length)return null;var i=e.getEdgeList(t).length-t.length+Graph.getConnectedComponentCount(t);if(0===i)return null;for(var r=e.getPathIncludedDistanceMatrices(t),n=r.d,s=r.pe1,o=r.pe2,a=e.getRingCandidates(n,s,o),h=e.getSSSR(a,n,s,o,i),l=new Array(h.length),g=0;g<h.length;g++){l[g]=new Array(h[g].length);var u=0,c=!0,d=!1,v=void 0;try{for(var f,p=h[g][Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var y=f.value;l[g][u++]=y}}catch(e){d=!0,v=e}finally{try{!c&&p.return&&p.return()}finally{if(d)throw v}}}return l}},{key:"matrixToString",value:function(e){for(var t="",i=0;i<e.length;i++){for(var r=0;r<e[i].length;r++)t+=e[i][r]+" ";t+="\n"}return t}},{key:"getPathIncludedDistanceMatrices",value:function(e){for(var t=e.length,i=Array(t),r=Array(t),n=Array(t),s=0,o=0,a=0,h=0;h<t;h++){i[h]=Array(t),r[h]=Array(t),n[h]=Array(t);for(var l=0;l<t;l++)i[h][l]=h===l||1===e[h][l]?e[h][l]:Number.POSITIVE_INFINITY,1===i[h][l]?r[h][l]=[[[h,l]]]:r[h][l]=[],n[h][l]=[]}for(var g=0;g<t;g++)for(var u=0;u<t;u++)for(var c=0;c<t;c++){var d=i[u][c],v=i[u][g]+i[g][c];if(d>v){if(d===v+1)for(n[u][c]=[r[u][c].length],s=0;s<r[u][c].length;s++)for(n[u][c][s]=[r[u][c][s].length],o=0;o<r[u][c][s].length;o++)for(n[u][c][s][o]=[r[u][c][s][o].length],a=0;a<r[u][c][s][o].length;a++)n[u][c][s][o][a]=[r[u][c][s][o][0],r[u][c][s][o][1]];else n[u][c]=[];for(i[u][c]=v,r[u][c]=[[]],s=0;s<r[u][g][0].length;s++)r[u][c][0].push(r[u][g][0][s]);for(s=0;s<r[g][c][0].length;s++)r[u][c][0].push(r[g][c][0][s])}else if(d===v){if(r[u][g].length&&r[g][c].length)if(r[u][c].length){var f=[];for(s=0;s<r[u][g][0].length;s++)f.push(r[u][g][0][s]);for(s=0;s<r[g][c][0].length;s++)f.push(r[g][c][0][s]);r[u][c].push(f)}else{var p=[];for(s=0;s<r[u][g][0].length;s++)p.push(r[u][g][0][s]);for(s=0;s<r[g][c][0].length;s++)p.push(r[g][c][0][s]);r[u][c][0]=p}}else if(d===v-1)if(n[u][c].length){for(var y=[],s=0;s<r[u][g][0].length;s++)y.push(r[u][g][0][s]);for(var s=0;s<r[g][c][0].length;s++)y.push(r[g][c][0][s]);n[u][c].push(y)}else{for(var m=[],s=0;s<r[u][g][0].length;s++)m.push(r[u][g][0][s]);for(var s=0;s<r[g][c][0].length;s++)m.push(r[g][c][0][s]);n[u][c][0]=m}}return{d:i,pe1:r,pe2:n}}},{key:"getRingCandidates",value:function(e,t,i){for(var r=e.length,n=[],s=0,o=0;o<r;o++)for(var a=0;a<r;a++)0===e[o][a]||1===t[o][a].length&&0===i[o][a]||(s=0!==i[o][a].length?2*(e[o][a]+.5):2*e[o][a],n.push([s,t[o][a],i[o][a]]));return n.sort(function(e,t){return e[0]-t[0]}),n}},{key:"getSSSR",value:function(t,i,r,n,s){for(var o=[],a=0;a<t.length;a++)if(t[a][0]%2!=0)for(var h=0;h<t[a][2].length;h++){var l=t[a][1][0].concat(t[a][2][h]),g=e.bondsToAtoms(l);if(l.length!==g.size||e.pathSetsContain(o,g)||o.push(g),o.length===s)return o}else for(var u=0;u<t[a][1].length-1;u++){var c=t[a][1][u].concat(t[a][1][u+1]),d=e.bondsToAtoms(c);if(c.length!==d.size||e.pathSetsContain(o,d)||o.push(d),o.length===s)return o}return o}},{key:"getEdgeCount",value:function(e){for(var t=0,i=e.length,r=0;r<i-1;r++)for(var n=r+1;n<i;n++)1===e[r][n]&&t++;return t}},{key:"getEdgeList",value:function(e){for(var t=e.length,i=[],r=0;r<t-1;r++)for(var n=r+1;n<t;n++)1===e[r][n]&&i.push([r,n]);return i}},{key:"bondsToAtoms",value:function(e){for(var t=new Set,i=0;i<e.length;i++)t.add(e[i][0]),t.add(e[i][1]);return t}},{key:"pathSetsContain",value:function(t,i){for(var r=0;r<t.length;r++)if(t[r].size===i.size&&e.areSetsEqual(t[r],i))return!0;return!1}},{key:"areSetsEqual",value:function(e,t){if(e.size!==t.size)return!1;var i=!0,r=!1,n=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done);i=!0){var a=s.value;if(!t.has(a))return!1}}catch(e){r=!0,n=e}finally{try{!i&&o.return&&o.return()}finally{if(r)throw n}}return!0}}]),e}(),Vector2=function(){function e(t,i){_classCallCheck(this,e),0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=t.x,this.y=t.y):(this.x=t,this.y=i)}return _createClass(e,[{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"toString",value:function(){return"("+this.x+","+this.y+")"}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"divide",value:function(e){return this.x/=e,this.y/=e,this}},{key:"multiply",value:function(e){return this.x*=e.x,this.y*=e.y,this}},{key:"multiplyScalar",value:function(e){return this.x*=e,this.y*=e,this}},{key:"invert",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(e){return Math.sqrt((e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y))}},{key:"distanceSq",value:function(e){return(e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y)}},{key:"clockwise",value:function(e){var t=this.y*e.x,i=this.x*e.y;return t>i?-1:t===i?0:1}},{key:"rotate",value:function(t){var i=new e,r=Math.cos(t),n=Math.sin(t);return i.x=this.x*r-this.y*n,i.y=this.x*n+this.y*r,this.x=i.x,this.y=i.y,this}},{key:"rotateAround",value:function(e,t){var i=Math.sin(e),r=Math.cos(e);this.x-=t.x,this.y-=t.y;var n=this.x*r-this.y*i,s=this.x*i+this.y*r;return this.x=n+t.x,this.y=s+t.y,this}},{key:"rotateTo",value:function(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.x+=.001,this.y-=.001;var n=e.subtract(this,i),s=e.subtract(t,i),o=e.angle(s,n);return this.rotateAround(o+r,i),this}},{key:"rotateAwayFrom",value:function(e,t,i){this.rotateAround(i,t);var r=this.distanceSq(e);this.rotateAround(-2*i,t),this.distanceSq(e)<r&&this.rotateAround(2*i,t)}},{key:"getRotateAwayFromAngle",value:function(e,t,i){var r=this.clone();r.rotateAround(i,t);var n=r.distanceSq(e);return r.rotateAround(-2*i,t),r.distanceSq(e)<n?i:-i}},{key:"getRotateTowardsAngle",value:function(e,t,i){var r=this.clone();r.rotateAround(i,t);var n=r.distanceSq(e);return r.rotateAround(-2*i,t),r.distanceSq(e)>n?i:-i}},{key:"getRotateToAngle",value:function(t,i){var r=e.subtract(this,i),n=e.subtract(t,i),s=e.angle(n,r);return Number.isNaN(s)?0:s}},{key:"isInPolygon",value:function(e){for(var t=!1,i=0,r=e.length-1;i<e.length;r=i++)e[i].y>this.y!=e[r].y>this.y&&this.x<(e[r].x-e[i].x)*(this.y-e[i].y)/(e[r].y-e[i].y)+e[i].x&&(t=!t);return t}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"normalize",value:function(){return this.divide(this.length()),this}},{key:"normalized",value:function(){return e.divide(this,this.length())}},{key:"whichSide",value:function(e,t){return(this.x-e.x)*(t.y-e.y)-(this.y-e.y)*(t.x-e.x)}},{key:"sameSideAs",value:function(e,t,i){var r=this.whichSide(e,t),n=i.whichSide(e,t);return r<0&&n<0||0==r&&0==n||r>0&&n>0}}],[{key:"add",value:function(t,i){return new e(t.x+i.x,t.y+i.y)}},{key:"subtract",value:function(t,i){return new e(t.x-i.x,t.y-i.y)}},{key:"multiply",value:function(t,i){return new e(t.x*i.x,t.y*i.y)}},{key:"multiplyScalar",value:function(t,i){return new e(t).multiply(i)}},{key:"midpoint",value:function(t,i){return new e((t.x+i.x)/2,(t.y+i.y)/2)}},{key:"normals",value:function(t,i){var r=e.subtract(i,t);return[new e(-r.y,r.x),new e(r.y,-r.x)]}},{key:"units",value:function(t,i){var r=e.subtract(i,t);return[new e(-r.y,r.x).normalize(),new e(r.y,-r.x).normalize()]}},{key:"divide",value:function(t,i){return i.x&&i.y?new e(t.x/i.x,t.y/i.y):new e(t.x/i,t.y/i)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"angle",value:function(t,i){var r=e.dot(t,i);return Math.acos(r/(t.length()*i.length()))}},{key:"threePointangle",value:function(t,i,r){var n=e.subtract(i-t),s=e.subtract(r,i),o=(t.distance(i),i.distance(r));return Math.acos(e.dot(n,s)/(abLenght*o))}},{key:"scalarProjection",value:function(t,i){var r=i.normalized();return e.dot(t,r)}}]),e}(),Vertex=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,e),this.id=null,this.value=t,this.position=new Vector2(i||0,r||0),this.previousPosition=new Vector2(0,0),this.parentVertexId=null,this.children=[],this.spanningTreeChildren=[],this.edges=[],this.positioned=!1,this.angle=0,this.globalAngle=0,this.dir=1,this.backAngle=0,this.flippable=!1,this.flipCenter=null,this.flipNeighbour=null,this.flipRings=new Array,this.neighbourCount=0,this.neighbours=[],this.neighbouringElements=[]}return _createClass(e,[{key:"setPosition",value:function(e,t){this.position.x=e,this.position.y=t}},{key:"setPositionFromVector",value:function(e){this.position.x=e.x,this.position.y=e.y}},{key:"addChild",value:function(e){this.neighbourCount++,this.children.push(e),this.neighbours.push(e)}},{key:"setParentVertexId",value:function(e,t){this.neighbourCount++,this.parentVertexId=e,this.neighbours.push(e)}},{key:"isTerminal",value:function(){return!!this.value.hasAttachedPseudoElements||(null===this.parentVertexId&&this.children.length<2||0===this.children.length)}},{key:"clone",value:function(){var t=new e(this.value,this.position.x,this.position.y);return t.id=this.id,t.previousPosition=new Vector2(this.previousPosition.x,this.previousPosition.y),t.parentVertexId=this.parentVertexId,t.children=ArrayHelper.clone(this.children),t.spanningTreeChildren=ArrayHelper.clone(this.spanningTreeChildren),t.edges=ArrayHelper.clone(this.edges),t.positioned=this.positioned,t.angle=this.angle,t.backAngle=this.backAngle,t.flippable=this.flippable,t.flipCenter=this.flipCenter,t.flipRings=ArrayHelper.clone(this.flipRings),t}},{key:"equals",value:function(e){return this.id===e.id}},{key:"getAngle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=null;return i=e?Vector2.subtract(this.position,e):Vector2.subtract(this.position,this.previousPosition),t?MathHelper.toDeg(i.angle()):i.angle()}},{key:"getTextDirection",value:function(e){for(var t=this.getDrawnNeighbours(e),i=[],r=0;r<t.length;r++)i.push(this.getAngle(e[t[r]].position));var n=MathHelper.meanAngle(i),s=Math.PI/2;return n=Math.round(Math.round(n/s)*s,3),
2==n?"down":-2==n?"up":0===n||-0===n?"right":3==n||-3==n?"left":"down"}},{key:"getNeighbours",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null===e)return this.neighbours;for(var t=[],i=0;i<this.neighbours.length;i++)this.neighbours[i]!==e&&t.push(this.neighbours[i]);return t}},{key:"getDrawnNeighbours",value:function(e){for(var t=[],i=0;i<this.neighbours.length;i++)e[this.neighbours[i]].value.isDrawn&&t.push(this.neighbours[i]);return t}},{key:"getNeighbourCount",value:function(){return this.neighbourCount}},{key:"getCommonNeighbours",value:function(e){for(var t=new Array,i=this.getNeighbours(),r=e.getNeighbours(),n=0;n<i.length;n++)for(var s=0;s<r.length;s++)i[n]===r[s]&&t.push(i[n]);return t}},{key:"isNeighbour",value:function(e){if(this.parentVertexId===e)return!0;for(var t=0;t<this.children.length;t++)if(this.children[t]===e)return!0}},{key:"getSpanningTreeNeighbours",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=[],i=0;i<this.spanningTreeChildren.length;i++)void 0!==e&&e==this.spanningTreeChildren[i]||t.push(this.spanningTreeChildren[i]);return null!=this.parentVertexId&&(void 0!==e&&e==this.parentVertexId||t.push(this.parentVertexId)),t}},{key:"getNextInRing",value:function(e,t,i){for(var r=this.getNeighbours(),n=0;n<r.length;n++)if(ArrayHelper.contains(e[r[n]].value.rings,{value:t})&&r[n]!=i)return r[n];return null}}]),e}();