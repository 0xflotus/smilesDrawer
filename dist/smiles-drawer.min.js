"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ArrayHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"clone",value:function(t){var i=Array.isArray(t)?[]:{};for(var n in t){var r=t[n];"function"==typeof r.clone?i[n]=r.clone():i[n]="object"===("undefined"==typeof r?"undefined":_typeof(r))?e.clone(r):r}return i}},{key:"print",value:function(e){if(0==e.length)return"";for(var t="(",i=0;i<e.length;i++)t+=e[i].id?e[i].id+", ":e[i]+", ";return t=t.substring(0,t.length-2),t+")"}},{key:"each",value:function(e,t){for(var i=0;i<e.length;i++)t(e[i])}},{key:"get",value:function(e,t,i){for(var n=0;n<e.length;n++)if(e[n][t]==i)return e[n]}},{key:"contains",value:function(e,t){if(t.property||t.func){if(t.func){for(var i=0;i<e.length;i++)if(t.func(e[i]))return!0}else for(var n=0;n<e.length;n++)if(e[n][t.property]==t.value)return!0}else for(var r=0;r<e.length;r++)if(e[r]==t.value)return!0;return!1}},{key:"intersection",value:function e(t,i){for(var e=new Array,n=0;n<t.length;n++)for(var r=0;r<i.length;r++)t[n]===i[r]&&e.push(t[n]);return e}},{key:"unique",value:function(e){var t={};return e.filter(function(e){return void 0===t[e]&&(t[e]=!0)})}},{key:"count",value:function e(t,i){for(var e=0,n=0;n<t.length;n++)t[n]===i&&e++;return e}},{key:"toggle",value:function(e,t){for(var i=[],n=!1,r=0;r<e.length;r++)e[r]!==t?i.push(e[r]):n=!0;return n||i.push(t),i}},{key:"remove",value:function(e,t){for(var i=[],n=0;n<e.length;n++)e[n]!==t&&i.push(e[n]);return i}},{key:"removeAll",value:function(e,t){return e.filter(function(e){return t.indexOf(e)===-1})}},{key:"merge",value:function(e,t){for(var i=new Array(e.length+t.length),n=0;n<e.length;n++)i[n]=e[n];for(var r=0;r<t.length;r++)i[e.length+r]=t[r];return i}},{key:"containsAll",value:function(e,t){for(var i=0,n=0;n<e.length;n++)for(var r=0;r<t.length;r++)e[n]===t[r]&&i++;return i===t.length}}]),e}(),Atom=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-";_classCallCheck(this,e),this.element=t,this.explicit=!1,this.ringbonds=new Array,this.rings=new Array,this.bondType=i,this.isTerminal=!1,this.isBridge=!1,this.isBridgeNode=!1,this.bridgedRing=null,this.anchoredRings=new Array,this.bracket=null}return _createClass(e,[{key:"addAnchoredRing",value:function(e){ArrayHelper.contains(this.anchoredRings,{value:e})||this.anchoredRings.push(e)}},{key:"getRingbondCount",value:function(){return this.ringbonds.length}},{key:"canRotate",value:function(){return"-"===this.bondType&&0==this.rings.length}},{key:"hasRingbonds",value:function(){return this.ringbonds.length>0}},{key:"getMaxRingbond",value:function(){for(var e=0,t=0;t<this.ringbonds.length;t++)this.ringbonds[t].id>e&&(e=this.ringbonds[t].id);return e}},{key:"hasRing",value:function(e){for(var t=0;t<this.rings;t++)if(e===this.rings[t])return!0;return!1}},{key:"haveCommonRingbond",value:function(e,t){for(var i=0;i<e.ringbonds.length;i++)for(var n=0;n<t.ringbonds.length;n++)if(e.ringbonds[i].id==t.ringbonds[n].id)return!0;return!1}},{key:"maxCommonRingbond",value:function(e,t){for(var i=0,n=0,r=0,s=0;s<e.ringbonds.length;s++){e.ringbonds[s].id>n&&(n=e.ringbonds[s].id);for(var o=0;o<t.ringbonds.length;o++)t.ringbonds[o].id>r?r=t.ringbonds[o].id:n==r&&(i=n)}return i}}]),e}(),CanvasWrapper=function(){function e(t,i){_classCallCheck(this,e),this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.colors=i,this.drawingWidth=0,this.drawingHeight=0,this.offsetX=0,this.offsetY=0,this.clear()}return _createClass(e,[{key:"setTheme",value:function(e){this.colors=e}},{key:"scale",value:function e(t){for(var i={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},n={x:Number.MAX_VALUE,y:Number.MAX_VALUE},r=0;r<t.length;r++){var s=t[r].position;i.x<s.x&&(i.x=s.x),i.y<s.y&&(i.y=s.y),n.x>s.x&&(n.x=s.x),n.y>s.y&&(n.y=s.y)}var o=20;i.x+=o,i.y+=o,n.x-=o,n.y-=o,this.drawingWidth=i.x-n.x,this.drawingHeight=i.y-n.y;var a=this.canvas.offsetWidth/this.drawingWidth,h=this.canvas.offsetHeight/this.drawingHeight,e=a<h?a:h;this.ctx.scale(e,e),this.offsetX=-n.x,this.offsetY=-n.y,a<h?this.offsetY+=this.canvas.offsetHeight/(2*e)-this.drawingHeight/2:this.offsetX+=this.canvas.offsetWidth/(2*e)-this.drawingWidth/2}},{key:"reset",value:function(){this.ctx.setTransform(1,0,0,1,0,0)}},{key:"getColor",value:function(e){return e=e.toUpperCase(),e in this.colors?this.colors[e]:this.colors.C}},{key:"drawCircle",value:function(e,t,i,n){var r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";if(!isNaN(e)&&!isNaN(t)){var a=this.ctx,h=this.offsetX,l=this.offsetY;a.save(),a.lineWidth=1.5,a.beginPath(),a.arc(e+h,t+l,i,0,2*Math.PI,!0),a.closePath(),s?(r?(a.fillStyle="#f00",a.fill()):(a.strokeStyle="#f00",a.stroke()),this.drawDebugText(e,t,o)):r?(a.fillStyle=n,a.fill()):(a.strokeStyle=n,a.stroke()),a.restore()}}},{key:"drawLine",value:function(e){if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var t=this.ctx,i=this.offsetX,n=this.offsetY,r=e.clone().shorten(8),s=r.getLeftVector().clone(),o=r.getRightVector().clone();s.x+=i,s.y+=n,o.x+=i,o.y+=n,t.save(),t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(o.x,o.y),t.lineCap="round",t.lineWidth=3.5,t.shadowColor=this.getColor("BACKGROUND"),t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,t.strokeStyle=this.getColor("BACKGROUND"),t.stroke(),t.restore(),s=e.getLeftVector().clone(),o=e.getRightVector().clone(),s.x+=i,s.y+=n,o.x+=i,o.y+=n,t.save(),t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(o.x,o.y),t.lineCap="round",t.lineWidth=1.5;var a=this.ctx.createLinearGradient(s.x,s.y,o.x,o.y);a.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),a.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),t.strokeStyle=a,t.stroke(),t.restore()}}},{key:"drawDebugText",value:function(e,t,i){var n=this.ctx;n.save(),n.font="5px Droid Sans, sans-serif",n.textAlign="start",n.textBaseline="top",n.fillStyle="#ff0000",n.fillText(i,e+this.offsetX,t+this.offsetY),n.restore()}},{key:"drawText",value:function(e,t,i,n,r,s,o){if(!isNaN(e)&&!isNaN(t)){var a=this.ctx,h=this.offsetX,l=this.offsetY;a.save();var u="10px Droid Sans, sans-serif",c="6px Droid Sans, sans-serif";a.textAlign="start",a.textBaseline="top";var g="+",d=0;o&&(2===o?g="2+":o===-1?g="-":o===-2&&(g="2-"),a.font=c,d=a.measureText(g).width),a.font=u,a.fillStyle=this.getColor(i);var v=a.measureText(i);v.totalWidth=v.width+d,v.height=parseInt(u,10);var f=v.totalWidth>v.height?v.totalWidth:v.height;f/=2,a.globalCompositeOperation="destination-out",a.beginPath(),a.arc(e+h,t+l+v.height/20,f+1,0,2*Math.PI,!0),a.closePath(),a.fill(),a.globalCompositeOperation="source-over",a.fillStyle=this.getColor(i),a.fillText(i,e-v.totalWidth/2+h,t-v.height/2+l),o&&(a.font=c,a.fillText(g,e-v.totalWidth/2+v.width+h,t-v.height/2+l)),a.font=u;var p=a.measureText("H");if(p.height=parseInt(u,10),1===n){var y=e-v.totalWidth/2+h,m=t-v.height/2+l;"left"===r?y-=v.totalWidth:"right"===r?y+=v.totalWidth:"up"===r&&s?y+=v.totalWidth:"down"===r&&s?y+=v.totalWidth:"up"!==r||s?"down"!==r||s||(m+=v.height):m-=v.height,a.fillText("H",y,m)}else if(n>1){var b=e-v.totalWidth/2+h,k=t-v.height/2+l;a.font=c;var x=a.measureText(n);x.height=parseInt(c,10),"left"===r?b-=p.width+x.width:"right"===r?b+=v.totalWidth:"up"===r&&s?b+=v.totalWidth:"down"===r&&s?b+=v.totalWidth:"up"!==r||s?"down"!==r||s||(k+=v.height):k-=v.height,a.font=u,a.fillText("H",b,k),a.font=c,a.fillText(n,b+p.width,k+p.height/2)}a.restore()}}},{key:"drawDebugPoint",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#f00";this.drawCircle(e,t,2,n,!0,!0,i)}},{key:"drawAromaticityRing",value:function(e){var t=this.ctx;t.save(),t.strokeStyle=this.getColor("C"),t.lineWidth=1.5,t.beginPath(),t.arc(e.center.x+this.offsetX,e.center.y+this.offsetY,e.radius-10,0,2*Math.PI,!0),t.closePath(),t.stroke(),t.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight)}}]),e}(),Edge=function(){function e(t,i,n){_classCallCheck(this,e),this.id=null,this.sourceId=t,this.targetId=i,this.weight=n,this.bondType="-",this.isInAromaticRing=!1,this.center=!1}return _createClass(e,[{key:"getBondCount",value:function(){return e.bonds[this.bondType]}}],[{key:"bonds",get:function(){return{"-":1,"/":1,"\\":1,"=":2,"#":3,$:4}}}]),e}(),Line=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Vector2(0,0),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Vector(0,0),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,e),this.from=t,this.to=i,this.elementFrom=n,this.elementTo=r}return _createClass(e,[{key:"clone",value:function(){return new e(this.from.clone(),this.to.clone(),this.elementFrom,this.elementTo)}},{key:"getLength",value:function(){return Math.sqrt(Math.pow(this.to.x-this.from.x,2)+Math.pow(this.to.y-this.from.y,2))}},{key:"getAngle",value:function(){var e=Vector2.subtract(this.getRightVector(),this.getLeftVector());return e.angle()}},{key:"getRightVector",value:function(){return this.from.x<this.to.x?this.to:this.from}},{key:"getLeftVector",value:function(){return this.from.x<this.to.x?this.from:this.to}},{key:"getRightElement",value:function(){return this.from.x<this.to.x?this.elementTo:this.elementFrom}},{key:"getLeftElement",value:function(){return this.from.x<this.to.x?this.elementFrom:this.elementTo}},{key:"setRightVector",value:function(e,t){return this.from.x<this.to.x?this.to.set(e,t):this.from.set(e,t),this}},{key:"setLeftVector",value:function(e,t){return this.from.x<this.to.x?this.from.set(e,t):this.to.set(e,t),this}},{key:"rotateToXAxis",value:function(){var e=this.getLeftVector();return this.setRightVector(e.x+this.getLength(),e.y),this}},{key:"rotate",value:function(e){var t=this.getLeftVector(),i=this.getRightVector(),n=Math.cos(e)*(i.x-t.x)-Math.sin(e)*(i.y-t.y)+t.x,r=Math.sin(e)*(i.x-t.x)-Math.cos(e)*(i.y-t.y)+t.y;return this.setRightVector(n,r),this}},{key:"shortenFrom",value:function(e){var t=Vector2.subtract(this.to,this.from);return t.normalize(),t.multiply(e),this.from.add(t),this}},{key:"shortenTo",value:function(e){var t=Vector2.subtract(this.from,this.to);return t.normalize(),t.multiply(e),this.to.add(t),this}},{key:"shorten",value:function(e){var t=Vector2.subtract(this.from,this.to);return t.normalize(),t.multiply(e/2),this.to.add(t),this.from.subtract(t),this}}]),e}(),MathHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"round",value:function(e,t){return t=t?t:1,Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"meanAngle",value:function(e){for(var t=0,i=0,n=0;n<e.length;n++)t+=Math.sin(e[n]),i+=Math.cos(e[n]);return Math.atan2(t/e.length,i/e.length)}},{key:"innerAngle",value:function(t){return e.toRad(180*(t-2)/t)}},{key:"polyCircumradius",value:function(e,t){return e/(2*Math.sin(Math.PI/t))}},{key:"apothem",value:function(e,t){return e*Math.cos(Math.PI/t)}},{key:"apothemFromSideLength",value:function(t,i){var n=e.polyCircumradius(t,i);return e.apothem(n,i)}},{key:"centralAngle",value:function(t){return e.toRad(360/t)}},{key:"toDeg",value:function(e){return 180*e/Math.PI}},{key:"toRad",value:function(e){return e*Math.PI/180}}]),e}(),Pair=function(){function e(t,i){_classCallCheck(this,e),this.first=t,this.second=i}return _createClass(e,[{key:"getHash",value:function(){return.5*(this.first+this.second)*(this.first+this.second+1)+(this.first+this.second)}},{key:"contains",value:function(e){return this.first===e||this.second===e}}],[{key:"createUniquePairs",value:function(t){for(var i=[],n=0;n<t.length;n++)for(var r=t[n],s=n+1;s<t.length;s++){var o=t[s];i.push(new e(r,o))}return i}}]),e}(),Ring=function(){function e(t,i,n){_classCallCheck(this,e),this.id=null,this.ringbond=t,this.sourceId=i,this.targetId=n,this.members=new Array,this.insiders=new Array,this.neighbours=new Array,this.positioned=!1,this.center=new Vector2,this.rings=new Array,this.isBridged=!1,this.template=null,this.isSpiro=!1,this.isFused=!1,this.radius=0,this.centralAngle=0,this.canFlip=!0}return _createClass(e,[{key:"clone",value:function t(){var t=new e(this.ringbond,this.sourceId,this.target);return t.id=this.id,t.members=ArrayHelper.clone(this.members),t.insiders=ArrayHelper.clone(this.insiders),t.neighbours=ArrayHelper.clone(this.neighbours),t.positioned=this.positioned,t.center=this.center.clone(),t.rings=ArrayHelper.clone(this.rings),t.isBridged=this.isBridged,t.template=this.template,t.isSpiro=this.isSpiro,t.isFused=this.isFused,t.radius=this.radius,t.centralAngle=this.centralAngle,t.canFlip=this.canFlip,t}},{key:"allowsFlip",value:function(){return this.canFlip&&this.members.length>4}},{key:"setFlipped",value:function(){this.members.length<8&&(this.canFlip=!1)}},{key:"getSize",value:function(){return this.members.length}},{key:"getPolygon",value:function(e){for(var t=[],i=0;i<this.members.length;i++)t.push(e[this.members[i]].position);return t}},{key:"getAngle",value:function(){return Math.PI-this.centralAngle}},{key:"eachMember",value:function(e,t,i,n){i=i||0===i?i:this.members[0];for(var r=i,s=0;null!=r&&s<100;){var o=r;if(t(o),r=e[r].getNextInRing(e,this.id,n),n=o,r==i&&(r=null),99==s)throw console.log("Smiles-drawer was not able to loop over the members of this ring.",this),"Smiles-drawer was not able to loop over the members of this ring.";s++}}},{key:"getOrderedNeighbours",value:function(e){for(var t=[],i=0;i<this.neighbours.length;i++){var n=RingConnection.getVertices(e,this.id,this.neighbours[i]);t.push({n:n.length,neighbour:this.neighbours[i]})}return t.sort(function(e,t){return t.n-e.n}),t}},{key:"isAromatic",value:function(e){for(var t=0;t<this.members.length;t++){var i=e[this.members[t]].value.element.charAt(0);if(i==i.toUpperCase())return!1}return!0}},{key:"contains",value:function(e){for(var t=0;t<this.members.length;t++)if(this.members[t]==e)return!0;return!1}},{key:"thisOrNeighboursContain",value:function(t,i){for(var n=0;n<this.neighbours.length;n++)if(e.getRing(t,this.neighbours[n]).contains(i))return!0;return!!this.contains(i)}},{key:"hasSource",value:function(){return!(void 0===this.sourceId||null===this.sourceId)}},{key:"hasTarget",value:function(){return!(void 0===this.targetId||null===this.targetId)}},{key:"hasSourceAndTarget",value:function(){return this.hasSource()&&this.hasTarget()}}],[{key:"getRing",value:function(e,t){for(var i=0;i<e.length;i++)if(e[i].id==t)return e[i]}}]),e}(),RingConnection=function(){function e(t,i){_classCallCheck(this,e),this.id=null,this.rings=new Pair(t.id,i.id),this.vertices=[];for(var n=0;n<t.members.length;n++)for(var r=t.members[n],s=0;s<i.members.length;s++){var o=i.members[s];r===o&&this.addVertex(r)}}return _createClass(e,[{key:"addVertex",value:function(e){ArrayHelper.contains(this.vertices,{value:e})||this.vertices.push(e)}},{key:"isBridge",value:function(e){if(this.vertices.length>2)return!0;for(var t=0;t<this.vertices.length;t++){var i=this.vertices[t];if(e[i].value.rings.length>2)return!0}return!1}},{key:"updateOther",value:function(e,t){this.rings.first===t?this.rings.second=e:this.rings.first=e}}],[{key:"isBridge",value:function(e,t,i,n){for(var r=null,s=0;s<e.length;s++){r=e[s];var o=r.rings;if(o.first===i&&o.second===n||o.first===n&&o.second===i)return r.isBridge(t)}return!1}},{key:"getNeighbours",value:function(e,t){for(var i=[],n=0;n<e.length;n++){var r=e[n].rings;r.first===t?i.push(r.second):r.second===t&&i.push(r.first)}return i}},{key:"getVertices",value:function(e,t,i){for(var n=0;n<e.length;n++){var r=e[n];if(r.rings.first==t&&r.rings.second==i||r.rings.first==i&&r.rings.second==t)return r.vertices}}}]),e}(),smiles=function(){function e(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}function t(e,i,n,r){this.message=e,this.expected=i,this.found=n,this.location=r,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,t)}function i(e){function i(t){var i,n,r=it[t];if(r)return r;for(i=t-1;!it[i];)i--;for(r=it[i],r={line:r.line,column:r.column,seenCR:r.seenCR};i<t;)n=e.charAt(i),"\n"===n?(r.seenCR||r.line++,r.column=1,r.seenCR=!1):"\r"===n||"\u2028"===n||"\u2029"===n?(r.line++,r.column=1,r.seenCR=!0):(r.column++,r.seenCR=!1),i++;return it[t]=r,r}function n(e,t){var n=i(e),r=i(t);return{start:{offset:e,line:n.line,column:n.column},end:{offset:t,line:r.line,column:r.column}}}function r(e){et<nt||(et>nt&&(nt=et,rt=[]),rt.push(e))}function s(e,i,n,r){function s(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}function o(e,t){function i(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0100-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1000-\uFFFF]/g,function(e){return"\\u"+t(e)})}var n,r,s,o=new Array(e.length);for(s=0;s<e.length;s++)o[s]=e[s].description;return n=e.length>1?o.slice(0,-1).join(", ")+" or "+o[e.length-1]:o[0],r=t?'"'+i(t)+'"':"end of input","Expected "+n+" but "+r+" found."}return null!==i&&s(i),new t(null!==e?e:o(i,n),i,n,r)}function o(){var e,t,i,n,r,s,u,c,g,d;if(e=et,t=et,i=h(),i!==R){for(n=[],r=a();r!==R;)n.push(r),r=a();if(n!==R){for(r=[],s=et,u=l(),u===R&&(u=null),u!==R?(c=f(),c!==R?(u=[u,c],s=u):(et=s,s=R)):(et=s,s=R);s!==R;)r.push(s),s=et,u=l(),u===R&&(u=null),u!==R?(c=f(),c!==R?(u=[u,c],s=u):(et=s,s=R)):(et=s,s=R);if(r!==R){for(s=[],u=a();u!==R;)s.push(u),u=a();if(s!==R)if(u=l(),u===R&&(u=null),u!==R)if(c=o(),c===R&&(c=null),c!==R){for(g=[],d=a();d!==R;)g.push(d),d=a();g!==R?(i=[i,n,r,s,u,c,g],t=i):(et=t,t=R)}else et=t,t=R;else et=t,t=R;else et=t,t=R}else et=t,t=R}else et=t,t=R}else et=t,t=R;return t!==R&&(tt=e,t=S(t)),e=t}function a(){var t,i,n,s,a,h;return t=et,i=et,40===e.charCodeAt(et)?(n=L,et++):(n=R,0===st&&r(I)),n!==R?(s=l(),s===R&&(s=null),s!==R?(a=o(),a!==R?(41===e.charCodeAt(et)?(h=B,et++):(h=R,0===st&&r(T)),h!==R?(n=[n,s,a,h],i=n):(et=i,i=R)):(et=i,i=R)):(et=i,i=R)):(et=i,i=R),i!==R&&(tt=t,i=H(i)),t=i}function h(){var e,t;return e=et,t=c(),t===R&&(t=g(),t===R&&(t=u(),t===R&&(t=d()))),t!==R&&(tt=e,t=M(t)),e=t}function l(){var t,i;return t=et,P.test(e.charAt(et))?(i=e.charAt(et),et++):(i=R,0===st&&r(W)),i!==R&&(tt=t,i=O(i)),t=i}function u(){var t,i,n,s,o,a,h,l,u,c;return t=et,i=et,91===e.charCodeAt(et)?(n=F,et++):(n=R,0===st&&r(E)),n!==R?(s=A(),s===R&&(s=null),s!==R?(e.substr(et,2)===_?(o=_,et+=2):(o=R,0===st&&r(D)),o===R&&(e.substr(et,2)===z?(o=z,et+=2):(o=R,0===st&&r(j)),o===R&&(o=g(),o===R&&(o=v(),o===R&&(o=d())))),o!==R?(a=p(),a===R&&(a=null),a!==R?(h=k(),h===R&&(h=null),h!==R?(l=y(),l===R&&(l=null),l!==R?(u=x(),u===R&&(u=null),u!==R?(93===e.charCodeAt(et)?(c=U,et++):(c=R,0===st&&r(X)),c!==R?(n=[n,s,o,a,h,l,u,c],i=n):(et=i,i=R)):(et=i,i=R)):(et=i,i=R)):(et=i,i=R)):(et=i,i=R)):(et=i,i=R)):(et=i,i=R)):(et=i,i=R),i!==R&&(tt=t,i=q(i)),t=i}function c(){var t,i,n,s;return t=et,i=et,66===e.charCodeAt(et)?(n=G,et++):(n=R,0===st&&r(Y)),n!==R?(114===e.charCodeAt(et)?(s=K,et++):(s=R,0===st&&r($)),s===R&&(s=null),s!==R?(n=[n,s],i=n):(et=i,i=R)):(et=i,i=R),i===R&&(i=et,67===e.charCodeAt(et)?(n=Z,et++):(n=R,0===st&&r(J)),n!==R?(108===e.charCodeAt(et)?(s=Q,et++):(s=R,0===st&&r(ee)),s===R&&(s=null),s!==R?(n=[n,s],i=n):(et=i,i=R)):(et=i,i=R),i===R&&(te.test(e.charAt(et))?(i=e.charAt(et),et++):(i=R,0===st&&r(ie)))),i!==R&&(tt=t,i=ne(i)),t=i}function g(){var t,i;return t=et,re.test(e.charAt(et))?(i=e.charAt(et),et++):(i=R,0===st&&r(se)),i!==R&&(tt=t,i=M(i)),t=i}function d(){var t,i;return t=et,42===e.charCodeAt(et)?(i=oe,et++):(i=R,0===st&&r(ae)),i!==R&&(tt=t,i=he(i)),t=i}function v(){var t,i,n,s;return t=et,i=et,le.test(e.charAt(et))?(n=e.charAt(et),et++):(n=R,0===st&&r(ue)),n!==R?(ce.test(e.charAt(et))?(s=e.charAt(et),et++):(s=R,0===st&&r(ge)),s===R&&(s=null),s!==R?(n=[n,s],i=n):(et=i,i=R)):(et=i,i=R),i!==R&&(tt=t,i=de(i)),t=i}function f(){var t,i,n,s,o;return t=et,i=et,37===e.charCodeAt(et)?(n=ve,et++):(n=R,0===st&&r(fe)),n!==R?(pe.test(e.charAt(et))?(s=e.charAt(et),et++):(s=R,0===st&&r(ye)),s!==R?(me.test(e.charAt(et))?(o=e.charAt(et),et++):(o=R,0===st&&r(be)),o!==R?(n=[n,s,o],i=n):(et=i,i=R)):(et=i,i=R)):(et=i,i=R),i===R&&(me.test(e.charAt(et))?(i=e.charAt(et),et++):(i=R,0===st&&r(be))),i!==R&&(tt=t,i=ke(i)),t=i}function p(){var t,i,n,s,o,a,h;return t=et,i=et,64===e.charCodeAt(et)?(n=xe,et++):(n=R,0===st&&r(Ae)),n!==R?(64===e.charCodeAt(et)?(s=xe,et++):(s=R,0===st&&r(Ae)),s===R&&(s=et,e.substr(et,2)===Ce?(o=Ce,et+=2):(o=R,0===st&&r(we)),o!==R?(Re.test(e.charAt(et))?(a=e.charAt(et),et++):(a=R,0===st&&r(Ve)),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R),s===R&&(s=et,e.substr(et,2)===Ne?(o=Ne,et+=2):(o=R,0===st&&r(Se)),o!==R?(Re.test(e.charAt(et))?(a=e.charAt(et),et++):(a=R,0===st&&r(Ve)),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R),s===R&&(s=et,e.substr(et,2)===Le?(o=Le,et+=2):(o=R,0===st&&r(Ie)),o!==R?(Be.test(e.charAt(et))?(a=e.charAt(et),et++):(a=R,0===st&&r(Te)),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R),s===R&&(s=et,e.substr(et,2)===He?(o=He,et+=2):(o=R,0===st&&r(Me)),o!==R?(pe.test(e.charAt(et))?(a=e.charAt(et),et++):(a=R,0===st&&r(ye)),a!==R?(me.test(e.charAt(et))?(h=e.charAt(et),et++):(h=R,0===st&&r(be)),h===R&&(h=null),h!==R?(o=[o,a,h],s=o):(et=s,s=R)):(et=s,s=R)):(et=s,s=R),s===R&&(s=et,e.substr(et,2)===Pe?(o=Pe,et+=2):(o=R,0===st&&r(We)),o!==R?(pe.test(e.charAt(et))?(a=e.charAt(et),et++):(a=R,0===st&&r(ye)),a!==R?(me.test(e.charAt(et))?(h=e.charAt(et),et++):(h=R,0===st&&r(be)),h===R&&(h=null),h!==R?(o=[o,a,h],s=o):(et=s,s=R)):(et=s,s=R)):(et=s,s=R)))))),s===R&&(s=null),s!==R?(n=[n,s],i=n):(et=i,i=R)):(et=i,i=R),i!==R&&(tt=t,i=Oe(i)),t=i}function y(){var e,t;return e=et,t=m(),t===R&&(t=b()),t!==R&&(tt=e,t=Fe(t)),e=t}function m(){var t,i,n,s,o,a;return t=et,i=et,43===e.charCodeAt(et)?(n=Ee,et++):(n=R,0===st&&r(_e)),n!==R?(43===e.charCodeAt(et)?(s=Ee,et++):(s=R,0===st&&r(_e)),s===R&&(s=et,pe.test(e.charAt(et))?(o=e.charAt(et),et++):(o=R,0===st&&r(ye)),o!==R?(me.test(e.charAt(et))?(a=e.charAt(et),et++):(a=R,0===st&&r(be)),a===R&&(a=null),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R)),s===R&&(s=null),s!==R?(n=[n,s],i=n):(et=i,i=R)):(et=i,i=R),i!==R&&(tt=t,i=De(i)),t=i}function b(){var t,i,n,s,o,a;return t=et,i=et,45===e.charCodeAt(et)?(n=ze,et++):(n=R,0===st&&r(je)),n!==R?(45===e.charCodeAt(et)?(s=ze,et++):(s=R,0===st&&r(je)),s===R&&(s=et,pe.test(e.charAt(et))?(o=e.charAt(et),et++):(o=R,0===st&&r(ye)),o!==R?(me.test(e.charAt(et))?(a=e.charAt(et),et++):(a=R,0===st&&r(be)),a===R&&(a=null),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R)),s===R&&(s=null),s!==R?(n=[n,s],i=n):(et=i,i=R)):(et=i,i=R),i!==R&&(tt=t,i=Ue(i)),t=i}function k(){var t,i,n,s;return t=et,i=et,72===e.charCodeAt(et)?(n=Xe,et++):(n=R,0===st&&r(qe)),n!==R?(me.test(e.charAt(et))?(s=e.charAt(et),et++):(s=R,0===st&&r(be)),s===R&&(s=null),s!==R?(n=[n,s],i=n):(et=i,i=R)):(et=i,i=R),i!==R&&(tt=t,i=Ge(i)),t=i}function x(){var t,i,n,s,o,a,h;if(t=et,i=et,58===e.charCodeAt(et)?(n=Ye,et++):(n=R,0===st&&r(Ke)),n!==R){if(s=et,pe.test(e.charAt(et))?(o=e.charAt(et),et++):(o=R,0===st&&r(ye)),o!==R){for(a=[],me.test(e.charAt(et))?(h=e.charAt(et),et++):(h=R,0===st&&r(be));h!==R;)a.push(h),me.test(e.charAt(et))?(h=e.charAt(et),et++):(h=R,0===st&&r(be));a!==R?(o=[o,a],s=o):(et=s,s=R)}else et=s,s=R;s===R&&($e.test(e.charAt(et))?(s=e.charAt(et),et++):(s=R,0===st&&r(Ze))),s!==R?(n=[n,s],i=n):(et=i,i=R)}else et=i,i=R;return i!==R&&(tt=t,i=Je(i)),t=i}function A(){var t,i,n,s,o;return t=et,i=et,pe.test(e.charAt(et))?(n=e.charAt(et),et++):(n=R,0===st&&r(ye)),n!==R?(me.test(e.charAt(et))?(s=e.charAt(et),et++):(s=R,0===st&&r(be)),s===R&&(s=null),s!==R?(me.test(e.charAt(et))?(o=e.charAt(et),et++):(o=R,0===st&&r(be)),o===R&&(o=null),o!==R?(n=[n,s,o],i=n):(et=i,i=R)):(et=i,i=R)):(et=i,i=R),i!==R&&(tt=t,i=Qe(i)),t=i}var C,w=arguments.length>1?arguments[1]:{},R={},V={chain:o},N=o,S=function(e){for(var t=[],i=[],n=0;n<e[1].length;n++)t.push(e[1][n]);for(var n=0;n<e[2].length;n++){var r=e[2][n][0]?e[2][n][0]:"-";i.push({bond:r,id:e[2][n][1]})}for(var n=0;n<e[3].length;n++)t.push(e[3][n]);for(var n=0;n<e[6].length;n++)t.push(e[6][n]);return{atom:e[0],isBracket:!!e[0].element,branches:t,branchCount:t.length,ringbonds:i,ringbondCount:i.length,bond:e[4]?e[4]:"-",next:e[5],hasNext:!!e[5]}},L="(",I={type:"literal",value:"(",description:'"("'},B=")",T={type:"literal",value:")",description:'")"'},H=function(e){var t=e[1]?e[1]:"-";return e[2].branchBond=t,e[2]},M=function(e){return e},P=/^[\-=#$:\/\\.]/,W={type:"class",value:"[-=#$:/\\\\.]",description:"[-=#$:/\\\\.]"},O=function(e){return e},F="[",E={type:"literal",value:"[",description:'"["'},_="se",D={type:"literal",value:"se",description:'"se"'},z="as",j={type:"literal",value:"as",description:'"as"'},U="]",X={type:"literal",value:"]",description:'"]"'},q=function(e){return{isotope:e[1],element:e[2],chirality:e[3],hcount:e[4],charge:e[5],class:e[6]}},G="B",Y={type:"literal",value:"B",description:'"B"'},K="r",$={type:"literal",value:"r",description:'"r"'},Z="C",J={type:"literal",value:"C",description:'"C"'},Q="l",ee={type:"literal",value:"l",description:'"l"'},te=/^[NOPSFI]/,ie={type:"class",value:"[NOPSFI]",description:"[NOPSFI]"},ne=function(e){return e.length>1?e.join(""):e},re=/^[bcnops]/,se={type:"class",value:"[bcnops]",description:"[bcnops]"},oe="*",ae={type:"literal",value:"*",description:'"*"'},he=function(e){return e},le=/^[A-Z]/,ue={type:"class",value:"[A-Z]",description:"[A-Z]"},ce=/^[a-z]/,ge={type:"class",value:"[a-z]",description:"[a-z]"},de=function(e){return e.join("")},ve="%",fe={type:"literal",value:"%",description:'"%"'},pe=/^[1-9]/,ye={type:"class",value:"[1-9]",description:"[1-9]"},me=/^[0-9]/,be={type:"class",value:"[0-9]",description:"[0-9]"},ke=function(e){return 1==e.length?Number(e):Number(e.join("").replace("%",""))},xe="@",Ae={type:"literal",value:"@",description:'"@"'},Ce="TH",we={type:"literal",value:"TH",description:'"TH"'},Re=/^[12]/,Ve={type:"class",value:"[12]",description:"[12]"},Ne="AL",Se={type:"literal",value:"AL",description:'"AL"'},Le="SP",Ie={type:"literal",value:"SP",description:'"SP"'},Be=/^[1-3]/,Te={type:"class",value:"[1-3]",description:"[1-3]"},He="TB",Me={type:"literal",value:"TB",description:'"TB"'},Pe="OH",We={type:"literal",value:"OH",description:'"OH"'},Oe=function(e){return e[1]?"@"==e[1]?"@@":e[1].join("").replace(",",""):"@"},Fe=function(e){return e},Ee="+",_e={type:"literal",value:"+",description:'"+"'},De=function(e){return e[1]?"+"!=e[1]?Number(e[1].join("")):2:1},ze="-",je={type:"literal",value:"-",description:'"-"'},Ue=function(e){return e[1]?"-"!=e[1]?-Number(e[1].join("")):-2:-1},Xe="H",qe={type:"literal",value:"H",description:'"H"'},Ge=function(e){return e[1]?Number(e[1]):1},Ye=":",Ke={type:"literal",value:":",description:'":"'},$e=/^[0]/,Ze={type:"class",value:"[0]",description:"[0]"},Je=function(e){return Number(e[1][0]+e[1][1].join(""))},Qe=function(e){return Number(e.join(""))},et=0,tt=0,it=[{line:1,column:1,seenCR:!1}],nt=0,rt=[],st=0;if("startRule"in w){if(!(w.startRule in V))throw new Error("Can't start parsing from rule \""+w.startRule+'".');N=V[w.startRule]}if(C=N(),C!==R&&et===e.length)return C;throw C!==R&&et<e.length&&r({type:"end",description:"end of input"}),s(null,rt,nt<e.length?e.charAt(nt):null,nt<e.length?n(nt,nt+1):n(nt,nt))}return e(t,Error),{SyntaxError:t,parse:i}}(),SmilesDrawer=function(){function e(t){_classCallCheck(this,e),this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.canvasWrapper=null,this.direction=1,this.totalOverlapScore=0,this.maxBonds={c:4,C:4,n:3,N:3,o:2,O:2},this.defaultOptions={shortBondLength:15,bondLength:22,bondSpacing:4,debug:!1,drawingIterations:10,themes:{dark:{C:"#fff",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#141414"},light:{C:"#222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#fff"}}},this.opts=this.extend(!0,this.defaultOptions,t),this.theme=this.opts.themes.dark}return _createClass(e,[{key:"extend",value:function(){var e=this,t={},i=!1,n=0,r=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(i=arguments[0],n++);for(var s=function(n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(i&&"[object Object]"===Object.prototype.toString.call(n[r])?t[r]=e.extend(!0,t[r],n[r]):t[r]=n[r])};n<r;n++){var o=arguments[n];s(o)}return t}},{key:"draw",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"dark",n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.data=e,this.canvasWrapper=new CanvasWrapper(t,this.opts.themes[i]),this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.vertices=[],this.edges=[],this.rings=[],this.ringConnections=[],this.backupVertices=[],this.backupRings=[],this.initGraph(e),this.initRings(),!n){this.position();var r=this.getOverlapScore(),s=0,o=this.getBridgedRings().length;if(0===o)for(;r.total>this.opts.bondLength/10&&s<this.opts.drawingIterations;){1===this.direction?this.direction=-1:this.direction===-1&&(this.direction=0),this.clearPositions(),this.position();var a=this.getOverlapScore();a.total<r.total?r=a:this.restorePositions(),s++}this.resolveSecondaryOverlaps(r.scores),this.totalOverlapScore=this.getOverlapScore().total,this.canvasWrapper.scale(this.vertices),this.drawEdges(this.opts.debug),this.drawVertices(this.opts.debug),this.canvasWrapper.reset()}}},{key:"edgeRingCount",value:function(e){var t=this.edges[e],i=this.vertices[t.sourceId],n=this.vertices[t.targetId];return Math.min(i.value.rings.length,n.value.rings.length)}},{key:"getBridgedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isBridged&&e.push(this.rings[t]);return e}},{key:"getFusedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isFused&&e.push(this.rings[t]);return e}},{key:"getSpiros",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isSpiro&&e.push(this.rings[t]);return e}},{key:"printRingInfo",value:function(){for(var e="",t=0;t<this.rings.length;t++){var i=this.rings[t];e+=i.id+";",e+=i.members.length+";",e+=i.neighbours.length+";",e+=i.isSpiro?"true;":"false;",e+=i.isFused?"true;":"false;",e+=i.isBridged?"true;":"false;",e+=i.rings.length+";",e+=i.insiders.length,e+="\n"}return e}},{key:"getTotalOverlapScore",value:function(){return this.totalOverlapScore}},{key:"getRingCount",value:function(){return this.rings.length}},{key:"hasBridgedRing",value:function(){for(var e=0;e<this.rings.length;e++)if(this.rings[e].isBridged)return!0;return!1}},{key:"getHeavyAtomCount",value:function(){for(var e=0,t=0;t<this.vertices.length;t++)"h"!==this.vertices[t].value.element.toLowerCase()&&e++;return e}},{key:"initGraph",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=new Atom(e.atom.element?e.atom.element:e.atom,e.bond);
n.branchBond=e.branchBond,n.ringbonds=e.ringbonds,n.bracket=e.atom.element?e.atom:null;var r=new Vertex(n),s=this.vertices[t];if(r.parentVertexId=t,this.addVertex(r),null!=t){this.vertices[t].children.push(r.id),this.vertices[t].spanningTreeChildren.push(r.id);var o=new Edge(t,r.id,1);i?o.bondType=r.value.branchBond:o.bondType=this.vertices[t].value.bondType;var a=this.addEdge(o);r.edges.push(a),s.edges.push(a)}for(var h=0;h<e.branchCount;h++)this.initGraph(e.branches[h],r.id,!0);e.hasNext&&this.initGraph(e.next,r.id)}},{key:"getRingbondType",value:function(e,t){if(e.value.getRingbondCount()<1||t.value.getRingbondCount()<1)return null;for(var i=0;i<e.value.ringbonds.length;i++)for(var n=0;n<t.value.ringbonds.length;n++)if(e.value.ringbonds[i].id==t.value.ringbonds[n].id)return"-"==e.value.ringbonds[i].bondType?t.value.ringbonds[n].bond:e.value.ringbonds[i].bond;return null}},{key:"initRings",value:function(){for(var e=this,t={},i=this.vertices.length-1;i>=0;i--){var n=this.vertices[i];if(0!==n.value.ringbonds.length)for(var r=0;r<n.value.ringbonds.length;r++){var s=n.value.ringbonds[r].id;if(void 0===t[s])t[s]=n.id;else{var o=t[s],a=n.id,h=e.addEdge(new Edge(a,o,1));e.vertices[a].children.push(o),e.vertices[o].children.push(a),e.vertices[a].edges.push(h),e.vertices[o].edges.push(h);var l=new Ring(s,a,o);e.addRing(l);for(var u=e.getRingVertices(l.sourceId,l.targetId),c=0;c<u.length;c++)l.members.push(u[c]),e.vertices[u[c]].value.rings.push(l.id);t[s]=void 0}}}for(var g=0;g<this.rings.length-1;g++)for(var d=g+1;d<this.rings.length;d++){var v=this.rings[g],f=this.rings[d],p=new RingConnection(v,f);p.vertices.length>0&&this.addRingConnection(p)}for(var y=0;y<this.rings.length;y++){var m=this.rings[y];m.neighbours=RingConnection.getNeighbours(this.ringConnections,m.id)}for(;this.rings.length>0;){for(var b=-1,k=0;k<this.rings.length;k++){var x=this.rings[k];this.isPartOfBridgedRing(x.id)&&(b=x.id)}if(b===-1)break;var A=this.getRing(b),C=this.getBridgedRingRings(A.id);this.createBridgedRing(C,A.sourceId);for(var w=0;w<C.length;w++)this.removeRing(C[w])}}},{key:"getBridgedRingRings",value:function(e){var t=new Array,i=this,n=function e(n){var r=i.getRing(n);t.push(n);for(var s=0;s<r.neighbours.length;s++){var o=r.neighbours[s];t.indexOf(o)===-1&&o!==n&&RingConnection.isBridge(i.ringConnections,i.vertices,n,o)&&e(o)}};return n(e),ArrayHelper.unique(t)}},{key:"isPartOfBridgedRing",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].rings.contains(e)&&this.ringConnections[t].isBridge(this.vertices))return!0;return!1}},{key:"createBridgedRing",value:function(e,t){for(var i=new Array,n=new Array,r=new Array,s=(new Array,0);s<e.length;s++){for(var o=this.getRing(e[s]),a=0;a<o.members.length;a++)n.push(o.members[a]);for(var h=0;h<o.neighbours.length;h++)r.push(o.neighbours[h])}n=ArrayHelper.unique(n);for(var l=new Array,u=0;u<n.length;u++){var c=this.vertices[n[u]],g=ArrayHelper.intersection(e,c.value.rings);1==c.value.rings.length||1==g.length?i.push(c.id):l.push(c.id)}for(var d=new Array,v=new Array,f=0;f<l.length;f++){for(var p=this.vertices[l[f]],y=!1,m=0;m<p.edges.length;m++)1==this.edgeRingCount(p.edges[m])&&(y=!0);y?(p.value.isBridgeNode=!0,d.push(p.id)):(p.value.isBridge=!0,v.push(p.id))}var b=ArrayHelper.merge(i,d);r=ArrayHelper.unique(r),r=ArrayHelper.removeAll(r,e);for(var k=this.vertices[t],x=k.getNeighbours(),A=null,C=0;C<x.length;C++){var w=x[C];b.indexOf(w)!==-1&&(A=w)}var R=new Ring(-1,t,A);R.isBridged=!0,R.members=b,R.neighbours=r,R.insiders=v;for(var V=0;V<e.length;V++)R.rings.push(this.getRing(e[V]).clone());this.addRing(R);for(var N=0;N<v.length;N++){var S=this.vertices[v[N]];S.value.rings=new Array,S.value.bridgedRing=R.id}for(var L=0;L<b.length;L++){var I=this.vertices[b[L]];I.value.rings=ArrayHelper.removeAll(I.value.rings,e),I.value.rings.push(R.id)}for(var B=0;B<e.length;B++)for(var T=B+1;T<e.length;T++)this.removeRingConnectionsBetween(e[B],e[T]);for(var H=0;H<r.length;H++)for(var M=this.getRingConnections(r[H],e),P=0;P<M.length;P++)this.getRingConnection(M[P]).updateOther(R.id,r[H]);return R}},{key:"getRingVertices",value:function(e,t){for(var i=this.dijkstra(e,t),n=[],r=[],s=t;null!=s;)n.push(s),s=i[s];for(var o=n.length-1;o>=0;o--)r.push(n[o]);return r}},{key:"dijkstra",value:function(e,t){for(var i=new Array(this.vertices.length),n=new Array(this.vertices.length),r=new Array(this.vertices.length),s=new Array(this.vertices.length),o=0;o<this.vertices.length;o++)n[o]=o==e?0:Number.MAX_VALUE,i[o]=null,r[o]=!1,s[o]=this.vertices[o].getNeighbours();for(;ArrayHelper.count(r,!1)>0;){var a=this.getMinDist(n,r);if(a==t)return i;r[a]=!0;for(var h=0;h<s[a].length;h++){var l=s[a][h],u=n[a]+this.getEdgeWeight(a,l);a==e&&l==t||a==t&&l==e||u<n[l]&&(n[l]=u,i[l]=a)}}}},{key:"getMinDist",value:function(e,t){for(var i=Number.MAX_VALUE,n=null,r=0;r<e.length;r++)t[r]||e[r]<i&&(n=r,i=e[n]);return n}},{key:"areVerticesInSameRing",value:function(e,t){for(var i=0;i<e.value.rings.length;i++)for(var n=0;n<t.value.rings.length;n++)if(e.value.rings[i]==t.value.rings[n])return!0;return!1}},{key:"getCommonRings",value:function(e,t){for(var i=[],n=0;n<e.value.rings.length;n++)for(var r=0;r<t.value.rings.length;r++)e.value.rings[n]==t.value.rings[r]&&i.push(e.value.rings[n]);return i}},{key:"getSmallestCommonRing",value:function(e,t){for(var i=this.getCommonRings(e,t),n=Number.MAX_VALUE,r=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).getSize();o<n&&(n=o,r=this.getRing(i[s]))}return r}},{key:"getLargestCommonRing",value:function(e,t){for(var i=this.getCommonRings(e,t),n=0,r=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).getSize();o>n&&(n=o,r=this.getRing(i[s]))}return r}},{key:"getVerticesAt",value:function(e,t,i){for(var n=new Array,r=0;r<this.vertices.length;r++){var s=this.vertices[r];if(s.id!==i&&s.positioned){var o=e.distance(s.position);o<=t&&n.push(s.id)}}return n}},{key:"getBranch",value:function(e,t){var i=new Array,n=new Array,r=this,s=function e(t,s){for(var o=r.vertices[t],a=0;a<o.value.rings.length;a++)n.push(o.value.rings[a]);for(var h=0;h<o.children.length;h++){var l=o.children[h];l===s||ArrayHelper.contains(i,{value:l})||(i.push(l),e(l,t))}var u=o.parentVertexId;u===s||null===u||ArrayHelper.contains(i,{value:u})||(i.push(u),e(u,t))};return i.push(e),s(e,t),{vertices:i,rings:ArrayHelper.unique(n)}}},{key:"addVertex",value:function(e){return e.id=this.vertices.length,this.vertices.push(e),e.id}},{key:"addEdge",value:function(e){return e.id=this.edges.length,this.edges.push(e),e.id}},{key:"addRing",value:function(e){return e.id=this.ringIdCounter++,this.rings.push(e),e.id}},{key:"removeRing",value:function(e){this.rings=this.rings.filter(function(t){return t.id!==e}),this.ringConnections=this.ringConnections.filter(function(t){return t.rings.first!==e&&t.rings.second!==e});for(var t=0;t<this.rings.length;t++){var i=this.rings[t];i.neighbours=i.neighbours.filter(function(t){return t!==e})}}},{key:"getRing",value:function(e){for(var t=0;t<this.rings.length;t++)if(this.rings[t].id==e)return this.rings[t]}},{key:"addRingConnection",value:function(e){return e.id=this.ringConnectionIdCounter++,this.ringConnections.push(e),e.id}},{key:"removeRingConnection",value:function(e){this.ringConnections=this.ringConnections.filter(function(t){return t.id!==e})}},{key:"removeRingConnectionsBetween",value:function(e,t){for(var i=new Array,n=0;n<this.ringConnections.length;n++){var r=this.ringConnections[n];(r.rings.first===e&&r.rings.second===t||r.rings.first===t&&r.rings.second===e)&&i.push(r.id)}for(var s=0;s<i.length;s++)this.removeRingConnection(i[s])}},{key:"getRingConnection",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].id==e)return this.ringConnections[t]}},{key:"getRingConnections",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=new Array;if(null===t)for(var n=0;n<this.ringConnections.length;n++){var r=this.ringConnections[n];r.rings.first!==e&&r.rings.second!==e||i.push(r.id)}else if(t.constructor!==Array)for(var s=0;s<this.ringConnections.length;s++){var o=this.ringConnections[s];(o.rings.first===e&&o.rings.second===t||o.rings.first===t&&o.rings.second===e)&&i.push(o.id)}else for(var a=0;a<this.ringConnections.length;a++)for(var h=0;h<t.length;h++){var l=t[h],u=this.ringConnections[a];(u.rings.first===e&&u.rings.second===l||u.rings.first===l&&u.rings.second===e)&&i.push(u.id)}return i}},{key:"getOverlapScore",value:function(){for(var e=0,t=new Float32Array(this.vertices.length),i=0;i<this.vertices.length;i++)t[i]=0;for(var n=0;n<this.vertices.length;n++)for(var r=n+1;r<this.vertices.length;r++){var s=this.vertices[n],o=this.vertices[r],a=Vector2.subtract(s.position,o.position).length();if(a<this.opts.bondLength){var h=this.opts.bondLength-a;e+=h,t[n]+=h,t[r]+=h}}for(var l=[],u=0;u<this.vertices.length;u++)l.push({id:u,score:t[u]});return l.sort(function(e,t){return t.score-e.score}),{total:e,scores:l}}},{key:"chooseSide",value:function(e,t,i){for(var n=e.getNeighbours(t.id),r=t.getNeighbours(e.id),s=n.length,o=r.length,a=ArrayHelper.merge(n,r),h=[0,0],l=0;l<a.length;l++){var u=this.vertices[a[l]].position;u.sameSideAs(e.position,t.position,i[0])?h[0]++:h[1]++}for(var c=[0,0],g=0;g<this.vertices.length;g++){var d=this.vertices[g].position;d.sameSideAs(e.position,t.position,i[0])?c[0]++:c[1]++}return{totalSideCount:c,totalPosition:c[0]>c[1]?0:1,sideCount:h,position:h[0]>h[1]?0:1,anCount:s,bnCount:o}}},{key:"areConnected",value:function(e,t){for(var i=0;i<this.edges.length;i++){var n=this.edges[i];if(n.sourceId===e&&n.targetId===t||n.sourceId===t&&n.targetId===e)return!0}return!1}},{key:"getEdgeWeight",value:function(e,t){for(var i=0;i<this.edges.length;i++){var n=this.edges[i];if(n.sourceId==e&&n.targetId==t||n.targetId==e&&n.sourceId==t)return n.weight}return null}},{key:"getEdge",value:function(e,t){for(var i=0;i<this.edges.length;i++){var n=this.edges[i];if(n.sourceId==e&&n.targetId==t||n.targetId==e&&n.sourceId==t)return n}return null}},{key:"forceLayout",value:function(e,t,i,n){return}},{key:"getSubringCenter",value:function(e,t){for(var i=0;i<e.rings.length;i++)for(var n=e.rings[i],r=0;r<n.members.length;r++)if(n.members[r]===t.id)return n.center;return e.center}},{key:"drawEdges",value:function(e){for(var t=this,i=this,n=function(n){var r=t.edges[n],s=t.vertices[r.sourceId],o=t.vertices[r.targetId],a=s.value.element,h=o.value.element,l=s.position,u=o.position,c=t.getEdgeNormals(r),g=("gradient"+s.value.element.toUpperCase()+o.value.element.toUpperCase(),ArrayHelper.clone(c));if(ArrayHelper.each(g,function(e){e.multiply(10),e.add(l)}),"="===r.bondType||"="===t.getRingbondType(s,o)){var d=t.areVerticesInSameRing(s,o),v=t.chooseSide(s,o,g);if(d){var f=t.getLargestCommonRing(s,o),p=f.center;ArrayHelper.each(c,function(e){e.multiply(i.opts.bondSpacing)});var y=null;y=p.sameSideAs(s.position,o.position,Vector2.add(l,c[0]))?new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h):new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h),y.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(y),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else if(r.center){ArrayHelper.each(c,function(e){e.multiply(i.opts.bondSpacing/2)});var m=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h),b=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);m.shorten(t.opts.bondLength-t.opts.shortBondLength),b.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(m),t.canvasWrapper.drawLine(b)}else if(0==v.anCount&&v.bnCount>1||0==v.bnCount&&v.anCount>1){ArrayHelper.each(c,function(e){e.multiply(i.opts.bondSpacing/2)});var k=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h),x=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);t.canvasWrapper.drawLine(k),t.canvasWrapper.drawLine(x)}else if(v.sideCount[0]>v.sideCount[1]){ArrayHelper.each(c,function(e){e.multiply(i.opts.bondSpacing)});var A=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h);A.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(A),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else if(v.sideCount[0]<v.sideCount[1]){ArrayHelper.each(c,function(e){e.multiply(i.opts.bondSpacing)});var C=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);C.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(C),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else if(v.totalSideCount[0]>v.totalSideCount[1]){ArrayHelper.each(c,function(e){e.multiply(i.opts.bondSpacing)});var w=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h);w.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(w),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else if(v.totalSideCount[0]<=v.totalSideCount[1]){ArrayHelper.each(c,function(e){e.multiply(i.opts.bondSpacing)});var R=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);R.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(R),t.canvasWrapper.drawLine(new Line(l,u,a,h))}}else if("#"===r.bondType){ArrayHelper.each(c,function(e){e.multiply(i.opts.bondSpacing/1.5)});var V=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h),N=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);V.shorten(t.opts.bondLength-t.opts.shortBondLength),N.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(V),t.canvasWrapper.drawLine(N),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else t.canvasWrapper.drawLine(new Line(l,u,a,h));if(e){var S=Vector2.midpoint(l,u);t.canvasWrapper.drawDebugText(S.x,S.y,"e: "+n)}},r=0;r<this.edges.length;r++)n(r);for(var r=0;r<this.rings.length;r++){var s=this.rings[r];s.isAromatic(this.vertices)&&this.canvasWrapper.drawAromaticityRing(s)}}},{key:"drawVertices",value:function(e){for(var t=0;t<this.vertices.length;t++){var i=this.vertices[t],n=i.value,r=0,s=this.getBondCount(i),o=1==n.element.length?n.element.toUpperCase():n.element,a=this.maxBonds[o]-s,h=i.getTextDirection(this.vertices),l=i.isTerminal(),u="c"===n.element.toLowerCase();if(n.bracket&&(a=n.bracket.hcount,r=n.bracket.charge),(!u||n.explicit||l)&&this.canvasWrapper.drawText(i.position.x,i.position.y,o,a,h,l,r),e){var c="v: "+i.id+" "+ArrayHelper.print(n.ringbonds);this.canvasWrapper.drawDebugText(i.position.x,i.position.y,c)}}if(this.opts.debug)for(var g=0;g<this.rings.length;g++){var d=this.rings[g].center;this.canvasWrapper.drawDebugPoint(d.x,d.y,"r: "+this.rings[g].id)}}},{key:"position",value:function(){for(var e=0,t=0;t<this.rings.length;t++)this.rings[t].isBridged&&(e=this.rings[t].members[t]);this.createNextBond(this.vertices[e]),this.resolvePrimaryOverlaps()}},{key:"clearPositions",value:function(){this.backupVertices=[],this.backupRings=[];for(var e=0;e<this.vertices.length;e++){var t=this.vertices[e];this.backupVertices.push(t.clone()),t.positioned=!1,t.position=new Vector2}for(var i=0;i<this.rings.length;i++){var n=this.rings[i];this.backupRings.push(n.clone()),n.positioned=!1,n.center=new Vector2}}},{key:"restorePositions",value:function(){for(var e=0;e<this.backupVertices.length;e++)this.vertices[e]=this.backupVertices[e];for(var t=0;t<this.backupRings.length;t++)this.rings[t]=this.backupRings[t]}},{key:"createRing",value:function(e,t){var i=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!e.positioned){console.log(e,t,n,r),t=t?t:new Vector2(0,0);var s=e.getOrderedNeighbours(this.ringConnections),o=n?Vector2.subtract(n.position,t).angle():0,a=MathHelper.polyCircumradius(this.opts.bondLength,e.getSize());e.radius=a;var h=MathHelper.centralAngle(e.getSize());e.centralAngle=h;var l=o,u=this;if(e.eachMember(this.vertices,function(i){var n=u.vertices[i];n.positioned||(n.position.x=t.x+Math.cos(l)*a,n.position.y=t.y+Math.sin(l)*a),l+=h,(!e.isBridged||e.rings.length<3)&&(n.positioned=!0,console.log(n.id+" positioned"))},n?n.id:null,r?r.id:null),e.isBridged){var c=ArrayHelper.merge(e.members,e.insiders);this.forceLayout(c,t,n.id,e)}this.vertices[e.members[0]].value.addAnchoredRing(e.id),e.positioned=!0,e.center=t;for(var g=0;g<s.length;g++){var d=this.getRing(s[g].neighbour);if(!d.positioned){var v=RingConnection.getVertices(this.ringConnections,e.id,d.id);if(console.log(this.ringConnections),console.log(v),2==v.length)!function(){e.isFused=!0,d.isFused=!0;var t=i.vertices[v[0]],n=i.vertices[v[1]],r=Vector2.midpoint(t.position,n.position),s=Vector2.normals(t.position,n.position);ArrayHelper.each(s,function(e){e.normalize()});var o=MathHelper.polyCircumradius(i.opts.bondLength,d.getSize()),a=MathHelper.apothem(o,d.getSize());ArrayHelper.each(s,function(e){e.multiply(a)}),ArrayHelper.each(s,function(e){e.add(r)});var h=s[0];i.isPointInRing(h)&&(h=s[1]);var l=Vector2.subtract(t.position,h),u=Vector2.subtract(n.position,h);l.clockwise(u)===-1?i.createRing(d,h,t,n):i.createRing(d,h,n,t)}();else if(1==v.length){e.isSpiro=!0,d.isSpiro=!0;var f=this.vertices[v[0]],p=Vector2.subtract(t,f.position);p.invert(),p.normalize();var y=MathHelper.polyCircumradius(this.opts.bondLength,d.getSize());p.multiply(y),p.add(f.position),this.createRing(d,p,f)}}}for(var m=0;m<e.members.length;m++)for(var b=this.vertices[e.members[m]],k=b.getNeighbours(),x=0;x<k.length;x++)if(!e.thisOrNeighboursContain(this.rings,k[x])){var A=this.vertices[k[x]];this.createNextBond(A,b,e.center)}}}},{key:"rotateSubtree",value:function(e,t,i,n){var r=this;this.traverseTree(e,t,function(e){e.position.rotateAround(i,n);for(var t=0;t<e.value.anchoredRings.length;t++)r.rings[e.value.anchoredRings[t]].center.rotateAround(i,n)})}},{key:"resolvePrimaryOverlaps",value:function(){for(var e=[],t=[],i=new Array(this.vertices.length),n=0;n<this.rings.length;n++)for(var r=this.rings[n],s=0;s<r.members.length;s++){var o=this.vertices[r.members[s]];if(!i[o.id]){if(i[o.id]=!0,o.getNeighbours().length>2){for(var a=[],h=0;h<o.value.rings.length;h++)a.push(o.value.rings[h]);e.push({common:o,rings:a,vertices:this.getNonRingNeighbours(o.id)})}if(2==o.value.rings.length&&4==o.getNeighbours().length){var l=this.getNonRingNeighbours(o.id)[0];if(l&&l.getNeighbours().length>1){var u=this.getCommonRingbondNeighbour(o);t.push({common:o,other:u,vertex:l})}}}}for(var c=0;c<t.length;c++){var g=t[c],d=-g.vertex.position.getRotateToAngle(g.other.position,g.common.position);this.rotateSubtree(g.vertex.id,g.common.id,d+Math.PI,g.common.position)}for(var v=0;v<e.length;v++){var f=e[v];if(1==f.vertices.length){var p=f.vertices[0];if(1==p.getNeighbours().length){p.flippable=!0,p.flipCenter=f.common.id;for(var y=0;y<f.rings.length;y++)p.flipRings.push(f.rings[y])}}else if(2==f.vertices.length){var m=(2*Math.PI-this.getRing(f.rings[0]).getAngle())/6,b=f.vertices[0],k=f.vertices[1];if(b.backAngle-=m,k.backAngle+=m,this.rotateSubtree(b.id,f.common.id,m,f.common.position),this.rotateSubtree(k.id,f.common.id,-m,f.common.position),1==b.getNeighbours().length){b.flippable=!0,b.flipCenter=f.common.id,b.flipNeighbour=k.id;for(var x=0;x<f.rings.length;x++)b.flipRings.push(f.rings[x])}if(1==k.getNeighbours().length){k.flippable=!0,k.flipCenter=f.common.id,k.flipNeighbour=b.id;for(var A=0;A<f.rings.length;A++)k.flipRings.push(f.rings[A])}}}}},{key:"resolveSecondaryOverlaps",value:function(e){for(var t=0;t<e.length;t++)if(e[t].score>this.opts.bondLength/5){var i=this.vertices[e[t].id];if(i.flippable){var n=i.flipRings[0]?this.rings[i.flipRings[0]]:null,r=i.flipRings[1]?this.rings[i.flipRings[1]]:null,s=this.vertices[i.flipCenter].position;if(n&&r){var o=n.members.length>r.members.length?n:r;r=n.members.length<r.members.length?n:r,n=o}n&&n.allowsFlip()?(i.position.rotateTo(n.center,s),n.setFlipped(),null!==i.flipNeighbour):r&&r.allowsFlip()&&(i.position.rotateTo(r.center,s),r.setFlipped(),null!==i.flipNeighbour)}}}},{key:"createNextBond",value:function(e,t,i,n){if(!e.positioned){if(console.log("Placing "+e.id),t)if(0!=t.value.rings.length||e.value.isBridge){if(t.value.isBridgeNode&&e.value.isBridge){var r=Vector2.subtract(i,t.position);r.normalize(),r.multiply(this.opts.bondLength),e.position.add(t.position),e.position.add(r),e.previousPosition=t.position,e.positioned=!0}else if(e.value.isBridge){var s=new Vector2(this.opts.bondLength,0);s.rotate(i),s.add(t.position),e.position=s,e.previousPosition=t.position,e.positioned=!0}else if(1==t.value.rings.length){var o=Vector2.subtract(i,t.position);o.invert(),o.normalize(),o.multiply(this.opts.bondLength),e.position.add(t.position),e.position.add(o),e.previousPosition=t.position,e.positioned=!0}else if(2==t.value.rings.length){var a=this.getRing(t.value.rings[0]),h=this.getRing(t.value.rings[1]),l=Vector2.subtract(h.center,a.center),u=Vector2.subtract(t.position,a.center),c=Vector2.scalarProjection(u,l);l.normalize(),l.multiply(c),l.add(a.center);var g=Vector2.subtract(l,t.position);g.invert(),g.normalize(),g.multiply(this.opts.bondLength),e.position.add(t.position),e.position.add(g),e.previousPosition=t.position,e.positioned=!0}}else{var d=new Vector2(this.opts.bondLength,0);d.rotate(i),d.add(t.position),e.position=d,e.previousPosition=t.position,e.positioned=!0}else{var v=new Vector2(this.opts.bondLength,0);v.rotate(MathHelper.toRad(-120)),e.previousPosition=v,e.position=new Vector2(this.opts.bondLength,0),e.angle=MathHelper.toRad(-120),e.positioned=!0}if(e.value.rings.length>0){var f=this.getRing(e.value.rings[0]),p=Vector2.subtract(e.previousPosition,e.position);p.invert(),p.normalize();var y=MathHelper.polyCircumradius(this.opts.bondLength,f.getSize());p.multiply(y),p.add(e.position),this.createRing(f,p,e)}else{var m=e.getNeighbours();t&&(m=ArrayHelper.remove(m,t.id));var b=e.getAngle();if(1==m.length){var k=this.vertices[m[0]];if("#"===e.value.bondType||t&&"#"===t.value.bondType||"="===e.value.bondType&&t&&"="===t.value.bondType){e.value.explicit=!0;var x=this.getEdge(e.id,t.id),A=this.getEdge(e.id,k.id);x.center=!0,A.center=!0,k.angle=b,this.createNextBond(k,e,k.angle,-n)}else{var C=Math.random()<.5?-1:1;0!==this.direction&&(C=this.direction),n||(n=C),k.angle=MathHelper.toRad(60)*n,this.createNextBond(k,e,b+k.angle,-n)}}else if(2==m.length){var w=this.getTreeDepth(m[0],e.id),R=this.getTreeDepth(m[1],e.id),V=0,N=1;if(w>R&&(V=1,N=0),1===e.position.clockwise(e.previousPosition)){var S=this.vertices[m[V]],L=this.vertices[m[N]];L.angle=MathHelper.toRad(60),S.angle=-MathHelper.toRad(60),this.createNextBond(L,e,b+L.angle),this.createNextBond(S,e,b+S.angle)}else{var I=this.vertices[m[V]],B=this.vertices[m[N]];B.angle=-MathHelper.toRad(60),I.angle=MathHelper.toRad(60),this.createNextBond(I,e,b+I.angle),this.createNextBond(B,e,b+B.angle)}}else if(3==m.length){var T=this.getTreeDepth(m[0],e.id),H=this.getTreeDepth(m[1],e.id),M=this.getTreeDepth(m[2],e.id),P=this.vertices[m[0]],W=this.vertices[m[1]],O=this.vertices[m[2]];H>T&&H>M?(P=this.vertices[m[1]],W=this.vertices[m[0]],O=this.vertices[m[2]]):M>T&&M>H&&(P=this.vertices[m[2]],W=this.vertices[m[0]],O=this.vertices[m[1]]),this.createNextBond(P,e,b),this.createNextBond(W,e,b+MathHelper.toRad(90)),this.createNextBond(O,e,b-MathHelper.toRad(90))}else if(4==m.length){var F=this.getTreeDepth(m[0],e.id),E=this.getTreeDepth(m[1],e.id),_=this.getTreeDepth(m[2],e.id),D=this.getTreeDepth(m[3],e.id),z=this.vertices[m[0]],j=this.vertices[m[1]],U=this.vertices[m[2]],X=this.vertices[m[3]];E>F&&E>_&&E>D?(z=this.vertices[m[1]],j=this.vertices[m[0]],U=this.vertices[m[2]],X=this.vertices[m[3]]):_>F&&_>E&&_>D?(z=this.vertices[m[2]],j=this.vertices[m[0]],U=this.vertices[m[1]],X=this.vertices[m[3]]):D>F&&D>E&&D>_&&(z=this.vertices[m[3]],j=this.vertices[m[0]],U=this.vertices[m[1]],X=this.vertices[m[2]]),this.createNextBond(z,e,b-MathHelper.toRad(36)),this.createNextBond(j,e,b+MathHelper.toRad(36)),this.createNextBond(U,e,b-MathHelper.toRad(108)),this.createNextBond(X,e,b+MathHelper.toRad(108))}}}}},{key:"getCommonRingbondNeighbour",value:function(e){for(var t=e.getNeighbours(),i=0;i<t.length;i++){var n=this.vertices[t[i]];if(ArrayHelper.containsAll(n.value.rings,e.value.rings))return n}return null}},{key:"isPointInRing",value:function(e){for(var t=0;t<this.rings.length;t++){var i=this.rings[t].getPolygon(this.vertices);if(e.isInPolygon(i))return!0}return!1}},{key:"isEdgeInRing",value:function(e){var t=this.vertices[e.sourceId],i=this.vertices[e.targetId];return this.areVerticesInSameRing(t,i)}},{key:"isRingAromatic",value:function(e){for(var t=0;t<e.members.length;t++)if(!this.isVertexInAromaticRing(e.members[t]))return!1;return!0}},{key:"isEdgeInAromaticRing",value:function(e){return this.isVertexInAromaticRing(e.sourceId)&&this.isVertexInAromaticRing(e.targetId)}},{key:"isVertexInAromaticRing",value:function(e){var t=this.vertices[e].value.element;return t==t.toLowerCase()}},{key:"getEdgeNormals",value:function(e){var t=this.vertices[e.sourceId].position,i=this.vertices[e.targetId].position,n=Vector2.normals(t,i);return ArrayHelper.each(n,function(e){e.normalize()}),n}},{key:"getTreeDepth",value:function(e,t){for(var i=this.vertices[e].getSpanningTreeNeighbours(t),n=0,r=0;r<i.length;r++){var s=i[r],o=this.getTreeDepth(s,e);o>n&&(n=o)}return n+1}},{key:"traverseTree",value:function(e,t,i){var n=this.vertices[e],r=n.getSpanningTreeNeighbours(t);i(n);for(var s=0;s<r.length;s++)this.traverseTree(r[s],e,i)}},{key:"getBondCount",value:function(e){for(var t=0,i=0;i<e.edges.length;i++)t+=this.edges[e.edges[i]].getBondCount();return t}},{key:"getNonRingNeighbours",value:function(e){for(var t=[],i=this.vertices[e],n=i.getNeighbours(),r=0;r<n.length;r++){var s=this.vertices[n[r]],o=ArrayHelper.intersection(i.value.rings,s.value.rings).length;0===o&&0==s.value.isBridge&&t.push(s)}return t}}]),e}(),Vector2=function(){function e(t,i){_classCallCheck(this,e),0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=t.x,this.y=t.y):(this.x=t,this.y=i)}return _createClass(e,[{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e,this.y=t}},{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"toString",value:function(){return"("+this.x+","+this.y+")"}},{key:"add",value:function(e){this.x+=e.x,this.y+=e.y}},{key:"subtract",value:function(e){this.x-=e.x,this.y-=e.y}},{key:"divide",value:function(e){this.x/=e,this.y/=e}},{key:"multiply",value:function(e){this.x*=e,this.y*=e}},{key:"invert",value:function(){this.x=-this.x,this.y=-this.y}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(e){return Math.sqrt((e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y))}},{key:"distanceSq",value:function(e){return(e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y)}},{key:"clockwise",value:function(e){var t=this.y*e.x,i=this.x*e.y;return t>i?-1:t===i?0:1}},{key:"rotate",value:function(t){var i=new e;i.x=this.x*Math.cos(t)-this.y*Math.sin(t),i.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=i.x,this.y=i.y}},{key:"rotateAround",value:function(e,t){var i=Math.sin(e),n=Math.cos(e);this.x-=t.x,this.y-=t.y;var r=this.x*n-this.y*i,s=this.x*i+this.y*n;this.x=r+t.x,this.y=s+t.y}},{key:"rotateTo",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=e.subtract(this,i),s=e.subtract(t,i),o=e.angle(s,r);this.rotateAround(o+n,i)}},{key:"getRotateToAngle",value:function(t,i){var n=e.subtract(this,i),r=e.subtract(t,i),s=e.angle(r,n);return s}},{key:"isInPolygon",value:function(e){for(var t=!1,i=0,n=e.length-1;i<e.length;n=i++)e[i].y>this.y!=e[n].y>this.y&&this.x<(e[n].x-e[i].x)*(this.y-e[i].y)/(e[n].y-e[i].y)+e[i].x&&(t=!t);return t}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"normalize",value:function(){this.divide(this.length())}},{key:"normalized",value:function(){return e.divide(this,this.length())}},{key:"whichSide",value:function(e,t){return(this.x-e.x)*(t.y-e.y)-(this.y-e.y)*(t.x-e.x)}},{key:"sameSideAs",value:function(e,t,i){var n=this.whichSide(e,t),r=i.whichSide(e,t);return n<0&&r<0||0==n&&0==r||n>0&&r>0}}],[{key:"add",value:function(t,i){return new e(t.x+i.x,t.y+i.y)}},{key:"subtract",value:function(t,i){return new e(t.x-i.x,t.y-i.y)}},{key:"multiply",value:function(t,i){return i.x&&i.y?new e(t.x*i.x,t.y*i.y):new e(t.x*i,t.y*i)}},{key:"midpoint",value:function(t,i){return new e((t.x+i.x)/2,(t.y+i.y)/2)}},{key:"normals",value:function(t,i){var n=e.subtract(i,t);return[new e(-n.y,n.x),new e(n.y,-n.x)]}},{key:"divide",value:function(t,i){return i.x&&i.y?new e(t.x/i.x,t.y/i.y):new e(t.x/i,t.y/i)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"angle",value:function(t,i){var n=e.dot(t,i);return Math.acos(n/(t.length()*i.length()))}},{key:"scalarProjection",value:function(t,i){var n=i.normalized();return e.dot(t,n)}}]),e}(),Vertex=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,e),this.id=null,this.value=t,this.position=new Vector2(i?i:0,n?n:0),this.previousPosition=new Vector2(0,0),this.parentVertexId=null,this.children=[],this.spanningTreeChildren=[],this.edges=[],this.positioned=!1,this.angle=0,this.backAngle=0,this.flippable=!1,this.flipCenter=null,this.flipNeighbour=null,this.flipRings=new Array}return _createClass(e,[{key:"isTerminal",value:function(){return null===this.parentVertexId&&this.children.length<2||0===this.children.length}},{key:"clone",value:function t(){var t=new e(this.value,this.position.x,this.position.y);return t.id=this.id,t.previousPosition=new Vector2(this.previousPosition.x,this.previousPosition.y),t.parentVertexId=this.parentVertexId,t.children=ArrayHelper.clone(this.children),t.spanningTreeChildren=ArrayHelper.clone(this.spanningTreeChildren),t.edges=ArrayHelper.clone(this.edges),t.positioned=this.positioned,t.angle=this.angle,t.backAngle=this.backAngle,t.flippable=this.flippable,t.flipCenter=this.flipCenter,t.flipRings=ArrayHelper.clone(this.flipRings),t}},{key:"equals",value:function(e){return this.id===e.id}},{key:"getAngle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=null;return i=e?Vector2.subtract(this.position,e):Vector2.subtract(this.position,this.previousPosition),t?MathHelper.toDeg(i.angle()):i.angle()}},{key:"getTextDirection",value:function(e){for(var t=this.getNeighbours(),i=[],n=0;n<t.length;n++)i.push(this.getAngle(e[t[n]].position));var r=MathHelper.meanAngle(i),s=Math.PI/2;return r=Math.round(Math.round(r/s)*s,3),2==r?"down":r==-2?"up":0===r||r===-0?"right":3==r||r==-3?"left":"down"}},{key:"getNeighbours",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=[],i=0;i<this.children.length;i++)void 0!==e&&e==this.children[i]||t.push(this.children[i]);return null!=this.parentVertexId&&(void 0!==e&&e==this.parentVertexId||t.push(this.parentVertexId)),t}},{key:"getCommonNeighbours",value:function(e){for(var t=new Array,i=this.getNeighbours(),n=e.getNeighbours(),r=0;r<i.length;r++)for(var s=0;s<n.length;s++)i[r]===n[s]&&t.push(i[r]);return t}},{key:"isNeighbour",value:function(e){if(this.parentVertexId===e)return!0;for(var t=0;t<this.children.length;t++)if(this.children[t]===e)return!0}},{key:"getSpanningTreeNeighbours",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=[],i=0;i<this.spanningTreeChildren.length;i++)void 0!==e&&e==this.spanningTreeChildren[i]||t.push(this.spanningTreeChildren[i]);return null!=this.parentVertexId&&(void 0!==e&&e==this.parentVertexId||t.push(this.parentVertexId)),t}},{key:"getNextInRing",value:function(e,t,i){for(var n=this.getNeighbours(),r=0;r<n.length;r++)if(ArrayHelper.contains(e[n[r]].value.rings,{value:t})&&n[r]!=i)return n[r];return null}}]),e}();