"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),ArrayHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"clone",value:function(t){var r=Array.isArray(t)?[]:{};for(var i in t){var n=t[i];"function"==typeof n.clone?r[i]=n.clone():r[i]="object"===(void 0===n?"undefined":_typeof(n))?e.clone(n):n}return r}},{key:"print",value:function(e){if(0==e.length)return"";for(var t="(",r=0;r<e.length;r++)t+=e[r].id?e[r].id+", ":e[r]+", ";return(t=t.substring(0,t.length-2))+")"}},{key:"each",value:function(e,t){for(var r=0;r<e.length;r++)t(e[r])}},{key:"get",value:function(e,t,r){for(var i=0;i<e.length;i++)if(e[i][t]==r)return e[i]}},{key:"contains",value:function(e,t){if(t.property||t.func){if(t.func){for(var r=0;r<e.length;r++)if(t.func(e[r]))return!0}else for(var i=0;i<e.length;i++)if(e[i][t.property]==t.value)return!0}else for(var n=0;n<e.length;n++)if(e[n]==t.value)return!0;return!1}},{key:"intersection",value:function e(t,r){for(var e=new Array,i=0;i<t.length;i++)for(var n=0;n<r.length;n++)t[i]===r[n]&&e.push(t[i]);return e}},{key:"unique",value:function(e){var t={};return e.filter(function(e){return void 0===t[e]&&(t[e]=!0)})}},{key:"count",value:function e(t,r){for(var e=0,i=0;i<t.length;i++)t[i]===r&&e++;return e}},{key:"toggle",value:function(e,t){for(var r=[],i=!1,n=0;n<e.length;n++)e[n]!==t?r.push(e[n]):i=!0;return i||r.push(t),r}},{key:"remove",value:function(e,t){for(var r=[],i=0;i<e.length;i++)e[i]!==t&&r.push(e[i]);return r}},{key:"removeAll",value:function(e,t){return e.filter(function(e){return t.indexOf(e)===-1})}},{key:"merge",value:function(e,t){for(var r=new Array(e.length+t.length),i=0;i<e.length;i++)r[i]=e[i];for(var n=0;n<t.length;n++)r[e.length+n]=t[n];return r}},{key:"containsAll",value:function(e,t){for(var r=0,i=0;i<e.length;i++)for(var n=0;n<t.length;n++)e[i]===t[n]&&r++;return r===t.length}},{key:"sortByAtomicNumberDesc",value:function(e){var t=e.map(function(e,t){return{index:t,value:e.atomicNumber.split(".").map(Number)}});return t.sort(function(e,t){for(var r=Math.min(t.value.length,e.value.length),i=0;i<r&&t.value[i]===e.value[i];)i++;return i===r?t.value.length-e.value.length:t.value[i]-e.value[i]}),t.map(function(t){return e[t.index]})}}]),e}(),Atom=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-";_classCallCheck(this,e),this.element=t,this.explicit=!1,this.ringbonds=new Array,this.rings=new Array,this.bondType=r,this.isTerminal=!1,this.isBridge=!1,this.isBridgeNode=!1,this.originalRings=new Array,this.bridgedRing=null,this.anchoredRings=new Array,this.bracket=null,this.chiral=0,this.order={}}return _createClass(e,[{key:"addAnchoredRing",value:function(e){ArrayHelper.contains(this.anchoredRings,{value:e})||this.anchoredRings.push(e)}},{key:"getRingbondCount",value:function(){return this.ringbonds.length}},{key:"canRotate",value:function(){return"-"===this.bondType&&0==this.rings.length}},{key:"hasRingbonds",value:function(){return this.ringbonds.length>0}},{key:"getMaxRingbond",value:function(){for(var e=0,t=0;t<this.ringbonds.length;t++)this.ringbonds[t].id>e&&(e=this.ringbonds[t].id);return e}},{key:"hasRing",value:function(e){for(var t=0;t<this.rings;t++)if(e===this.rings[t])return!0;return!1}},{key:"haveCommonRingbond",value:function(e,t){for(var r=0;r<e.ringbonds.length;r++)for(var i=0;i<t.ringbonds.length;i++)if(e.ringbonds[r].id==t.ringbonds[i].id)return!0;return!1}},{key:"maxCommonRingbond",value:function(e,t){for(var r=0,i=0,n=0,s=0;s<e.ringbonds.length;s++){e.ringbonds[s].id>i&&(i=e.ringbonds[s].id);for(var o=0;o<t.ringbonds.length;o++)t.ringbonds[o].id>n?n=t.ringbonds[o].id:i==n&&(r=i)}return r}},{key:"getOrder",value:function(e){return this.order[e]}},{key:"setOrder",value:function(e,t){this.order[e]=t}},{key:"getAtomicNumber",value:function(){return e.atomicNumbers[this.element]}}],[{key:"sortByAtomicNumber",value:function(t,r){for(var i=new Array(t.length),n=0;n<t.length;n++){var s=r[t[n]],o=e.atomicNumbers[s.value.element];i[n]={atomicNumber:o.toString(),vertexId:s.id}}return ArrayHelper.sortByAtomicNumberDesc(i)}},{key:"hasDuplicateAtomicNumbers",value:function(e){for(var t={},r=0;r<e.length;r++){var i=e[r];if(void 0!==t[i.atomicNumber])return!0;t[i.atomicNumber]=!0}return!1}},{key:"getDuplicateAtomicNumbers",value:function(e){for(var t={},r=[],i=0;i<e.length;i++){var n=e[i];void 0===t[n.atomicNumber]&&(t[n.atomicNumber]=[]),t[n.atomicNumber].push(i)}for(var s in t){var o=t[s];o.length>1&&r.push(o)}return r}}]),e}();Atom.atomicNumbers={H:1,He:2,Li:3,Be:4,B:5,b:5,C:6,c:6,N:7,n:7,O:8,o:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,p:15,S:16,s:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103,Rf:104,Db:105,Sg:106,Bh:107,Hs:108,Mt:109,Ds:110,Rg:111,Cn:112,Uut:113,Uuq:114,Uup:115,Uuh:116,Uus:117,Uuo:118};var CanvasWrapper=function(){function e(t,r,i,n){_classCallCheck(this,e),this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.colors=r,this.bondLength=i,this.bondSpacing=n,this.drawingWidth=0,this.drawingHeight=0,this.offsetX=0,this.offsetY=0,this.clear()}return _createClass(e,[{key:"setTheme",value:function(e){this.colors=e}},{key:"scale",value:function e(t){for(var r={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},i={x:Number.MAX_VALUE,y:Number.MAX_VALUE},n=0;n<t.length;n++){var s=t[n].position;r.x<s.x&&(r.x=s.x),r.y<s.y&&(r.y=s.y),i.x>s.x&&(i.x=s.x),i.y>s.y&&(i.y=s.y)}r.x+=20,r.y+=20,i.x-=20,i.y-=20,this.drawingWidth=r.x-i.x,this.drawingHeight=r.y-i.y;var o=this.canvas.offsetWidth/this.drawingWidth,a=this.canvas.offsetHeight/this.drawingHeight,e=o<a?o:a;this.ctx.scale(e,e),this.offsetX=-i.x,this.offsetY=-i.y,o<a?this.offsetY+=this.canvas.offsetHeight/(2*e)-this.drawingHeight/2:this.offsetX+=this.canvas.offsetWidth/(2*e)-this.drawingWidth/2}},{key:"reset",value:function(){this.ctx.setTransform(1,0,0,1,0,0)}},{key:"getColor",value:function(e){return e=e.toUpperCase(),e in this.colors?this.colors[e]:this.colors.C}},{key:"drawCircle",value:function(e,t,r,i){var n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";if(!isNaN(e)&&!isNaN(t)){var a=this.ctx,h=this.offsetX,l=this.offsetY;a.save(),a.lineWidth=1.5,a.beginPath(),a.arc(e+h,t+l,r,0,2*Math.PI,!0),a.closePath(),s?(n?(a.fillStyle="#f00",a.fill()):(a.strokeStyle="#f00",a.stroke()),this.drawDebugText(e,t,o)):n?(a.fillStyle=i,a.fill()):(a.strokeStyle=i,a.stroke()),a.restore()}}},{key:"drawLine",value:function(e){if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var t=this.ctx,r=this.offsetX,i=this.offsetY,n=e.clone().shorten(8),s=n.getLeftVector().clone(),o=n.getRightVector().clone();s.x+=r,s.y+=i,o.x+=r,o.y+=i,s=e.getLeftVector().clone(),o=e.getRightVector().clone(),s.x+=r,s.y+=i,o.x+=r,o.y+=i,t.save(),t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(o.x,o.y),t.lineCap="round",t.lineWidth=1.5;var a=this.ctx.createLinearGradient(s.x,s.y,o.x,o.y);a.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),a.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),t.strokeStyle=a,t.stroke(),t.restore()}}},{key:"drawWedge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var r=this.ctx,i=this.offsetX,n=this.offsetY,s=e.clone().shorten(8),o=s.getLeftVector().clone(),a=s.getRightVector().clone();o.x+=i,o.y+=n,a.x+=i,a.y+=n,o=e.getLeftVector().clone(),a=e.getRightVector().clone(),o.x+=i,o.y+=n,a.x+=i,a.y+=n,r.save();var h=Vector2.normals(o,a);h[0].normalize(),h[1].normalize();var l=e.getRightChiral(),u=o,c=a;l&&(u=a,c=o);var g=Vector2.add(u,Vector2.multiply(h[0],.75)),v=Vector2.add(c,Vector2.multiply(h[0],t)),d=Vector2.add(c,Vector2.multiply(h[1],t)),f=Vector2.add(u,Vector2.multiply(h[1],.75));r.beginPath(),r.moveTo(g.x,g.y),r.lineTo(v.x,v.y),r.lineTo(d.x,d.y),r.lineTo(f.x,f.y);var p=this.ctx.createRadialGradient(a.x,a.y,this.bondLength,a.x,a.y,0);p.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),p.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),r.fillStyle=p,r.fill(),r.restore()}}},{key:"drawDashedWedge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var r=this.ctx,i=this.offsetX,n=this.offsetY,s=e.getLeftVector().clone(),o=e.getRightVector().clone();s.x+=i,s.y+=n,o.x+=i,o.y+=n,r.save();var a=Vector2.normals(s,o);a[0].normalize(),a[1].normalize();var h=e.getRightChiral(),l=void 0,u=void 0,c=void 0,g=void 0,v=e.clone();h?(l=o,u=s,v.shortenRight(3),c=v.getRightVector().clone(),g=v.getLeftVector().clone()):(l=s,u=o,v.shortenLeft(3),c=v.getLeftVector().clone(),g=v.getRightVector().clone()),c.x+=i,c.y+=n,g.x+=i,g.y+=n;var d=Vector2.add(l,Vector2.multiply(a[0],.75)),f=Vector2.add(u,Vector2.multiply(a[0],t/2)),p=Vector2.add(u,Vector2.multiply(a[1],t/2)),y=Vector2.add(l,Vector2.multiply(a[1],.75));r.beginPath(),r.moveTo(d.x,d.y),r.lineTo(f.x,f.y),r.lineTo(p.x,p.y),r.lineTo(y.x,y.y);var m=this.ctx.createRadialGradient(o.x,o.y,this.bondLength,o.x,o.y,0);m.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),m.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),r.fillStyle=m,r.fill(),r.globalCompositeOperation="destination-out",r.beginPath(),r.moveTo(c.x,c.y),r.lineTo(g.x,g.y),r.lineCap="butt",r.lineWidth=t,r.setLineDash([1,1]),r.strokeStyle=this.getColor("BACKGROUND"),r.stroke(),r.globalCompositeOperation="source-over",r.restore()}}},{key:"drawDebugText",value:function(e,t,r){var i=this.ctx;i.save(),i.font="5px Droid Sans, sans-serif",i.textAlign="start",i.textBaseline="top",i.fillStyle="#ff0000",i.fillText(r,e+this.offsetX,t+this.offsetY),i.restore()}},{key:"drawText",value:function(e,t,r,i,n,s,o){if(!isNaN(e)&&!isNaN(t)){var a=this.ctx,h=this.offsetX,l=this.offsetY;a.save();var u="10px Droid Sans, sans-serif",c="6px Droid Sans, sans-serif";a.textAlign="start",a.textBaseline="top";var g="+",v=0;o&&(2===o?g="2+":o===-1?g="-":o===-2&&(g="2-"),a.font=c,v=a.measureText(g).width),a.font=u,a.fillStyle=this.getColor(r);var d=a.measureText(r);d.totalWidth=d.width+v,d.height=parseInt(u,10);var f=d.totalWidth>d.height?d.totalWidth:d.height;f/=2,a.globalCompositeOperation="destination-out",a.beginPath(),a.arc(e+h,t+l+d.height/20,f+1,0,2*Math.PI,!0),a.closePath(),a.fill(),a.globalCompositeOperation="source-over",a.fillStyle=this.getColor(r),a.fillText(r,e-d.totalWidth/2+h,t-d.height/2+l),o&&(a.font=c,a.fillText(g,e-d.totalWidth/2+d.width+h,t-d.height/2+l)),a.font=u;var p=a.measureText("H");if(p.height=parseInt(u,10),1===i){var y=e-d.totalWidth/2+h,m=t-d.height/2+l;"left"===n?y-=d.totalWidth:"right"===n?y+=d.totalWidth:"up"===n&&s?y+=d.totalWidth:"down"===n&&s?y+=d.totalWidth:"up"!==n||s?"down"!==n||s||(m+=d.height):m-=d.height,a.fillText("H",y,m)}else if(i>1){var b=e-d.totalWidth/2+h,x=t-d.height/2+l;a.font=c;var k=a.measureText(i);k.height=parseInt(c,10),"left"===n?b-=p.width+k.width:"right"===n?b+=d.totalWidth:"up"===n&&s?b+=d.totalWidth:"down"===n&&s?b+=d.totalWidth:"up"!==n||s?"down"!==n||s||(x+=d.height):x-=d.height,a.font=u,a.fillText("H",b,x),a.font=c,a.fillText(i,b+p.width,x+p.height/2)}a.restore()}}},{key:"drawDebugPoint",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#f00";this.drawCircle(e,t,2,i,!0,!0,r)}},{key:"drawAromaticityRing",value:function(e){var t=this.ctx;t.save(),t.strokeStyle=this.getColor("C"),t.lineWidth=1.5,t.beginPath(),t.arc(e.center.x+this.offsetX,e.center.y+this.offsetY,e.radius-this.bondLength/3,0,2*Math.PI,!0),t.closePath(),t.stroke(),t.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight)}}]),e}(),Edge=function(){function e(t,r,i){_classCallCheck(this,e),this.id=null,this.sourceId=t,this.targetId=r,this.weight=i,this.bondType="-",this.isInAromaticRing=!1,this.center=!1,this.chiral=""}return _createClass(e,[{key:"getBondCount",value:function(){return e.bonds[this.bondType]}}],[{key:"bonds",get:function(){return{"-":1,"/":1,"\\":1,"=":2,"#":3,$:4}}}]),e}(),Line=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Vector2(0,0),r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Vector(0,0),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];_classCallCheck(this,e),this.from=t,this.to=r,this.elementFrom=i,this.elementTo=n,this.chiralFrom=s,this.chiralTo=o}return _createClass(e,[{key:"clone",value:function(){return new e(this.from.clone(),this.to.clone(),this.elementFrom,this.elementTo)}},{key:"getLength",value:function(){return Math.sqrt(Math.pow(this.to.x-this.from.x,2)+Math.pow(this.to.y-this.from.y,2))}},{key:"getAngle",value:function(){return Vector2.subtract(this.getRightVector(),this.getLeftVector()).angle()}},{key:"getRightVector",value:function(){return this.from.x<this.to.x?this.to:this.from}},{key:"getLeftVector",value:function(){return this.from.x<this.to.x?this.from:this.to}},{key:"getRightElement",value:function(){return this.from.x<this.to.x?this.elementTo:this.elementFrom}},{key:"getLeftElement",value:function(){return this.from.x<this.to.x?this.elementFrom:this.elementTo}},{key:"getRightChiral",value:function(){return this.from.x<this.to.x?this.chiralTo:this.chiralFrom}},{key:"getLeftChiral",value:function(){return this.from.x<this.to.x?this.chiralFrom:this.chiralTo}},{key:"setRightVector",value:function(e,t){return this.from.x<this.to.x?this.to.set(e,t):this.from.set(e,t),this}},{key:"setLeftVector",value:function(e,t){return this.from.x<this.to.x?this.from.set(e,t):this.to.set(e,t),this}},{key:"rotateToXAxis",value:function(){var e=this.getLeftVector();return this.setRightVector(e.x+this.getLength(),e.y),this}},{key:"rotate",value:function(e){var t=this.getLeftVector(),r=this.getRightVector(),i=Math.cos(e)*(r.x-t.x)-Math.sin(e)*(r.y-t.y)+t.x,n=Math.sin(e)*(r.x-t.x)-Math.cos(e)*(r.y-t.y)+t.y;return this.setRightVector(i,n),this}},{key:"shortenFrom",value:function(e){var t=Vector2.subtract(this.to,this.from);return t.normalize(),t.multiply(e),this.from.add(t),this}},{key:"shortenTo",value:function(e){var t=Vector2.subtract(this.from,this.to);return t.normalize(),t.multiply(e),this.to.add(t),this}},{key:"shortenRight",value:function(e){return this.from.x<this.to.x?this.shortenTo(e):this.shortenFrom(e),this}},{key:"shortenLeft",value:function(e){return this.from.x<this.to.x?this.shortenFrom(e):this.shortenTo(e),this}},{key:"shorten",value:function(e){var t=Vector2.subtract(this.from,this.to);return t.normalize(),t.multiply(e/2),this.to.add(t),this.from.subtract(t),this}},{key:"getNormals",value:function(){var e=Vector2.subtract(from,to);return[new Vector2(-e.y,e.x),new Vector2(e.y,-e.x)]}}]),e}(),MathHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"round",value:function(e,t){return t=t?t:1,Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"meanAngle",value:function(e){for(var t=0,r=0,i=0;i<e.length;i++)t+=Math.sin(e[i]),r+=Math.cos(e[i]);return Math.atan2(t/e.length,r/e.length)}},{key:"innerAngle",value:function(t){return e.toRad(180*(t-2)/t)}},{key:"polyCircumradius",value:function(e,t){return e/(2*Math.sin(Math.PI/t))}},{key:"apothem",value:function(e,t){return e*Math.cos(Math.PI/t)}},{key:"apothemFromSideLength",value:function(t,r){var i=e.polyCircumradius(t,r);return e.apothem(i,r)}},{key:"centralAngle",value:function(t){return e.toRad(360/t)}},{key:"toDeg",value:function(e){return 180*e/Math.PI}},{key:"toRad",value:function(e){return e*Math.PI/180}}]),e}(),Pair=function(){function e(t,r){_classCallCheck(this,e),this.first=t,this.second=r}return _createClass(e,[{key:"getHash",value:function(){return.5*(this.first+this.second)*(this.first+this.second+1)+(this.first+this.second)}},{key:"contains",value:function(e){return this.first===e||this.second===e}}],[{key:"createUniquePairs",value:function(t){for(var r=[],i=0;i<t.length;i++)for(var n=t[i],s=i+1;s<t.length;s++){var o=t[s];r.push(new e(n,o))}return r}}]),e}(),Ring=function(){function e(t,r,i){_classCallCheck(this,e),this.id=null,this.ringbond=t,this.sourceId=r,this.targetId=i,this.members=new Array,this.insiders=new Array,this.neighbours=new Array,this.positioned=!1,this.center=new Vector2,this.rings=new Array,this.isBridged=!1,this.template=null,this.isSpiro=!1,this.isFused=!1,this.radius=0,this.centralAngle=0,this.canFlip=!0}return _createClass(e,[{key:"clone",value:function t(){var t=new e(this.ringbond,this.sourceId,this.target);return t.id=this.id,t.members=ArrayHelper.clone(this.members),t.insiders=ArrayHelper.clone(this.insiders),t.neighbours=ArrayHelper.clone(this.neighbours),t.positioned=this.positioned,t.center=this.center.clone(),t.rings=ArrayHelper.clone(this.rings),t.isBridged=this.isBridged,t.template=this.template,t.isSpiro=this.isSpiro,t.isFused=this.isFused,t.radius=this.radius,t.centralAngle=this.centralAngle,t.canFlip=this.canFlip,t}},{key:"allowsFlip",value:function(){return this.canFlip&&this.members.length>4}},{key:"setFlipped",value:function(){this.members.length<8&&(this.canFlip=!1)}},{key:"getSize",value:function(){return this.members.length}},{key:"getPolygon",value:function(e){for(var t=[],r=0;r<this.members.length;r++)t.push(e[this.members[r]].position);return t}},{key:"getAngle",value:function(){return Math.PI-this.centralAngle}},{key:"eachMember",value:function(e,t,r,i){r=r||0===r?r:this.members[0];for(var n=r,s=0;null!=n&&s<100;){var o=n;if(t(o),n=e[n].getNextInRing(e,this.id,i),i=o,n==r&&(n=null),99==s)throw console.log("Smiles-drawer was not able to loop over the members of this ring.",this),"Smiles-drawer was not able to loop over the members of this ring.";s++}}},{key:"getOrderedNeighbours",value:function(e){for(var t=[],r=0;r<this.neighbours.length;r++){var i=RingConnection.getVertices(e,this.id,this.neighbours[r]);t.push({n:i.length,neighbour:this.neighbours[r]})}return t.sort(function(e,t){return t.n-e.n}),t}},{key:"isAromatic",value:function(e){for(var t=0;t<this.members.length;t++){var r=e[this.members[t]].value.element.charAt(0);if(r==r.toUpperCase())return!1}return!0}},{key:"contains",value:function(e){for(var t=0;t<this.members.length;t++)if(this.members[t]==e)return!0;return!1}},{key:"thisOrNeighboursContain",value:function(t,r){for(var i=0;i<this.neighbours.length;i++)if(e.getRing(t,this.neighbours[i]).contains(r))return!0;return!!this.contains(r)}},{key:"hasSource",value:function(){return!(void 0===this.sourceId||null===this.sourceId)}},{key:"hasTarget",value:function(){return!(void 0===this.targetId||null===this.targetId)}},{key:"hasSourceAndTarget",value:function(){return this.hasSource()&&this.hasTarget()}}],[{key:"getRing",value:function(e,t){for(var r=0;r<e.length;r++)if(e[r].id==t)return e[r]}}]),e}(),RingConnection=function(){function e(t,r){_classCallCheck(this,e),this.id=null,this.rings=new Pair(t.id,r.id),this.vertices=[];for(var i=0;i<t.members.length;i++)for(var n=t.members[i],s=0;s<r.members.length;s++){var o=r.members[s];n===o&&this.addVertex(n)}}return _createClass(e,[{key:"addVertex",value:function(e){ArrayHelper.contains(this.vertices,{value:e})||this.vertices.push(e)}},{key:"isBridge",value:function(e){if(this.vertices.length>2)return!0;for(var t=0;t<this.vertices.length;t++){if(e[this.vertices[t]].value.rings.length>2)return!0}return!1}},{key:"updateOther",value:function(e,t){this.rings.first===t?this.rings.second=e:this.rings.first=e}}],[{key:"isBridge",value:function(e,t,r,i){for(var n=null,s=0;s<e.length;s++){n=e[s];var o=n.rings;if(o.first===r&&o.second===i||o.first===i&&o.second===r)return n.isBridge(t)}return!1}},{key:"getNeighbours",value:function(e,t){for(var r=[],i=0;i<e.length;i++){var n=e[i].rings;n.first===t?r.push(n.second):n.second===t&&r.push(n.first)}return r}},{key:"getVertices",value:function(e,t,r){for(var i=0;i<e.length;i++){var n=e[i];if(n.rings.first==t&&n.rings.second==r||n.rings.first==r&&n.rings.second==t)return n.vertices}}}]),e}(),smiles=function(){function e(t,r,i,n){this.message=t,this.expected=r,this.found=i,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function t(t){function r(e){var r,i,n=rt[e];if(n)return n;for(r=e-1;!rt[r];)r--;for(n=rt[r],n={line:n.line,column:n.column,seenCR:n.seenCR};r<e;)i=t.charAt(r),"\n"===i?(n.seenCR||n.line++,n.column=1,n.seenCR=!1):"\r"===i||"\u2028"===i||"\u2029"===i?(n.line++,n.column=1,n.seenCR=!0):(n.column++,n.seenCR=!1),r++;return rt[e]=n,n}function i(e,t){var i=r(e),n=r(t);return{start:{offset:e,line:i.line,column:i.column},end:{offset:t,line:n.line,column:n.column}}}function n(e){et<it||(et>it&&(it=et,nt=[]),nt.push(e))}function s(t,r,i,n){return null!==r&&function(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}(r),new e(null!==t?t:function(e,t){var r,i,n,s=new Array(e.length);for(n=0;n<e.length;n++)s[n]=e[n].description;return r=e.length>1?s.slice(0,-1).join(", ")+" or "+s[e.length-1]:s[0],i=t?'"'+function(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0100-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1000-\uFFFF]/g,function(e){return"\\u"+t(e)})}(t)+'"':"end of input","Expected "+r+" but "+i+" found."}(r,i),r,i,n)}function o(){var e,t,r,i,n,s,u,c,g,v;if(e=et,t=et,(r=h())!==R){for(i=[],n=a();n!==R;)i.push(n),n=a();if(i!==R){for(n=[],s=et,u=l(),u===R&&(u=null),u!==R?(c=f(),c!==R?(u=[u,c],s=u):(et=s,s=R)):(et=s,s=R);s!==R;)n.push(s),s=et,u=l(),u===R&&(u=null),u!==R?(c=f(),c!==R?(u=[u,c],s=u):(et=s,s=R)):(et=s,s=R);if(n!==R){for(s=[],u=a();u!==R;)s.push(u),u=a();if(s!==R)if(u=l(),u===R&&(u=null),u!==R)if(c=o(),c===R&&(c=null),c!==R){for(g=[],v=a();v!==R;)g.push(v),v=a();g!==R?(r=[r,i,n,s,u,c,g],t=r):(et=t,t=R)}else et=t,t=R;else et=t,t=R;else et=t,t=R}else et=t,t=R}else et=t,t=R}else et=t,t=R;return t!==R&&(tt=e,t=L(t)),e=t}function a(){var e,r,i,s,a,h;return e=et,r=et,40===t.charCodeAt(et)?(i=S,et++):(i=R,0===st&&n(T)),i!==R?(s=l(),s===R&&(s=null),s!==R?(a=o(),a!==R?(41===t.charCodeAt(et)?(h=B,et++):(h=R,0===st&&n(H)),h!==R?(i=[i,s,a,h],r=i):(et=r,r=R)):(et=r,r=R)):(et=r,r=R)):(et=r,r=R),r!==R&&(tt=e,r=M(r)),e=r}function h(){var e,t;return e=et,t=c(),t===R&&(t=g())===R&&(t=u())===R&&(t=v()),t!==R&&(tt=e,t=I(t)),e=t}function l(){var e,r;return e=et,P.test(t.charAt(et))?(r=t.charAt(et),et++):(r=R,0===st&&n(W)),r!==R&&(tt=e,r=O(r)),e=r}function u(){var e,r,i,s,o,a,h,l,u,c;return e=et,r=et,91===t.charCodeAt(et)?(i=F,et++):(i=R,0===st&&n(E)),i!==R?(s=C(),s===R&&(s=null),s!==R?(t.substr(et,2)===D?(o=D,et+=2):(o=R,0===st&&n(_)),o===R&&(t.substr(et,2)===z?(o=z,et+=2):(o=R,0===st&&n(U)),o===R&&(o=g())===R&&(o=d())===R&&(o=v())),o!==R?(a=p(),a===R&&(a=null),a!==R?(h=x(),h===R&&(h=null),h!==R?(l=y(),l===R&&(l=null),l!==R?(u=k(),u===R&&(u=null),u!==R?(93===t.charCodeAt(et)?(c=j,et++):(c=R,0===st&&n(X)),c!==R?(i=[i,s,o,a,h,l,u,c],r=i):(et=r,r=R)):(et=r,r=R)):(et=r,r=R)):(et=r,r=R)):(et=r,r=R)):(et=r,r=R)):(et=r,r=R)):(et=r,r=R),r!==R&&(tt=e,r=q(r)),e=r}function c(){var e,r,i,s;return e=et,r=et,66===t.charCodeAt(et)?(i=G,et++):(i=R,0===st&&n(Y)),i!==R?(114===t.charCodeAt(et)?(s=K,et++):(s=R,0===st&&n(Z)),s===R&&(s=null),s!==R?(i=[i,s],r=i):(et=r,r=R)):(et=r,r=R),r===R&&(r=et,67===t.charCodeAt(et)?(i=$,et++):(i=R,0===st&&n(J)),i!==R?(108===t.charCodeAt(et)?(s=Q,et++):(s=R,0===st&&n(ee)),s===R&&(s=null),s!==R?(i=[i,s],r=i):(et=r,r=R)):(et=r,r=R),r===R&&(te.test(t.charAt(et))?(r=t.charAt(et),et++):(r=R,0===st&&n(re)))),r!==R&&(tt=e,r=ie(r)),e=r}function g(){var e,r;return e=et,ne.test(t.charAt(et))?(r=t.charAt(et),et++):(r=R,0===st&&n(se)),r!==R&&(tt=e,r=I(r)),e=r}function v(){var e,r;return e=et,42===t.charCodeAt(et)?(r=oe,et++):(r=R,0===st&&n(ae)),r!==R&&(tt=e,r=he(r)),e=r}function d(){var e,r,i,s;return e=et,r=et,le.test(t.charAt(et))?(i=t.charAt(et),et++):(i=R,0===st&&n(ue)),i!==R?(ce.test(t.charAt(et))?(s=t.charAt(et),et++):(s=R,0===st&&n(ge)),s===R&&(s=null),s!==R?(i=[i,s],r=i):(et=r,r=R)):(et=r,r=R),r!==R&&(tt=e,r=ve(r)),e=r}function f(){var e,r,i,s,o;return e=et,r=et,37===t.charCodeAt(et)?(i=de,et++):(i=R,0===st&&n(fe)),i!==R?(pe.test(t.charAt(et))?(s=t.charAt(et),et++):(s=R,0===st&&n(ye)),s!==R?(me.test(t.charAt(et))?(o=t.charAt(et),et++):(o=R,0===st&&n(be)),o!==R?(i=[i,s,o],r=i):(et=r,r=R)):(et=r,r=R)):(et=r,r=R),r===R&&(me.test(t.charAt(et))?(r=t.charAt(et),et++):(r=R,0===st&&n(be))),r!==R&&(tt=e,r=xe(r)),e=r}function p(){var e,r,i,s,o,a,h;return e=et,r=et,64===t.charCodeAt(et)?(i=ke,et++):(i=R,0===st&&n(Ce)),i!==R?(64===t.charCodeAt(et)?(s=ke,et++):(s=R,0===st&&n(Ce)),s===R&&(s=et,t.substr(et,2)===Ae?(o=Ae,et+=2):(o=R,0===st&&n(we)),o!==R?(Re.test(t.charAt(et))?(a=t.charAt(et),et++):(a=R,0===st&&n(Ve)),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R),s===R&&(s=et,t.substr(et,2)===Ne?(o=Ne,et+=2):(o=R,0===st&&n(Le)),o!==R?(Re.test(t.charAt(et))?(a=t.charAt(et),et++):(a=R,0===st&&n(Ve)),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R),s===R&&(s=et,t.substr(et,2)===Se?(o=Se,et+=2):(o=R,0===st&&n(Te)),o!==R?(Be.test(t.charAt(et))?(a=t.charAt(et),et++):(a=R,0===st&&n(He)),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R),s===R&&(s=et,t.substr(et,2)===Me?(o=Me,et+=2):(o=R,0===st&&n(Ie)),o!==R?(pe.test(t.charAt(et))?(a=t.charAt(et),et++):(a=R,0===st&&n(ye)),a!==R?(me.test(t.charAt(et))?(h=t.charAt(et),et++):(h=R,0===st&&n(be)),h===R&&(h=null),h!==R?(o=[o,a,h],s=o):(et=s,s=R)):(et=s,s=R)):(et=s,s=R),s===R&&(s=et,t.substr(et,2)===Pe?(o=Pe,et+=2):(o=R,0===st&&n(We)),o!==R?(pe.test(t.charAt(et))?(a=t.charAt(et),et++):(a=R,0===st&&n(ye)),a!==R?(me.test(t.charAt(et))?(h=t.charAt(et),et++):(h=R,0===st&&n(be)),h===R&&(h=null),h!==R?(o=[o,a,h],s=o):(et=s,s=R)):(et=s,s=R)):(et=s,s=R)))))),s===R&&(s=null),s!==R?(i=[i,s],r=i):(et=r,r=R)):(et=r,r=R),r!==R&&(tt=e,r=Oe(r)),e=r}function y(){var e,t;return e=et,t=m(),t===R&&(t=b()),t!==R&&(tt=e,t=Fe(t)),e=t}function m(){var e,r,i,s,o,a;return e=et,r=et,43===t.charCodeAt(et)?(i=Ee,et++):(i=R,0===st&&n(De)),i!==R?(43===t.charCodeAt(et)?(s=Ee,et++):(s=R,0===st&&n(De)),s===R&&(s=et,pe.test(t.charAt(et))?(o=t.charAt(et),et++):(o=R,0===st&&n(ye)),o!==R?(me.test(t.charAt(et))?(a=t.charAt(et),et++):(a=R,0===st&&n(be)),a===R&&(a=null),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R)),s===R&&(s=null),s!==R?(i=[i,s],r=i):(et=r,r=R)):(et=r,r=R),r!==R&&(tt=e,r=_e(r)),e=r}function b(){var e,r,i,s,o,a;return e=et,r=et,45===t.charCodeAt(et)?(i=ze,et++):(i=R,0===st&&n(Ue)),i!==R?(45===t.charCodeAt(et)?(s=ze,et++):(s=R,0===st&&n(Ue)),s===R&&(s=et,pe.test(t.charAt(et))?(o=t.charAt(et),et++):(o=R,0===st&&n(ye)),o!==R?(me.test(t.charAt(et))?(a=t.charAt(et),et++):(a=R,0===st&&n(be)),a===R&&(a=null),a!==R?(o=[o,a],s=o):(et=s,s=R)):(et=s,s=R)),s===R&&(s=null),s!==R?(i=[i,s],r=i):(et=r,r=R)):(et=r,r=R),r!==R&&(tt=e,r=je(r)),e=r}function x(){var e,r,i,s;return e=et,r=et,72===t.charCodeAt(et)?(i=Xe,et++):(i=R,0===st&&n(qe)),i!==R?(me.test(t.charAt(et))?(s=t.charAt(et),et++):(s=R,0===st&&n(be)),s===R&&(s=null),s!==R?(i=[i,s],r=i):(et=r,r=R)):(et=r,r=R),r!==R&&(tt=e,r=Ge(r)),e=r}function k(){var e,r,i,s,o,a,h;if(e=et,r=et,58===t.charCodeAt(et)?(i=Ye,et++):(i=R,0===st&&n(Ke)),i!==R){if(s=et,pe.test(t.charAt(et))?(o=t.charAt(et),et++):(o=R,0===st&&n(ye)),o!==R){for(a=[],me.test(t.charAt(et))?(h=t.charAt(et),et++):(h=R,0===st&&n(be));h!==R;)a.push(h),me.test(t.charAt(et))?(h=t.charAt(et),et++):(h=R,0===st&&n(be));a!==R?(o=[o,a],s=o):(et=s,s=R)}else et=s,s=R;s===R&&(Ze.test(t.charAt(et))?(s=t.charAt(et),et++):(s=R,0===st&&n($e))),s!==R?(i=[i,s],r=i):(et=r,r=R)}else et=r,r=R;return r!==R&&(tt=e,r=Je(r)),e=r}function C(){var e,r,i,s,o;return e=et,r=et,pe.test(t.charAt(et))?(i=t.charAt(et),et++):(i=R,0===st&&n(ye)),i!==R?(me.test(t.charAt(et))?(s=t.charAt(et),et++):(s=R,0===st&&n(be)),s===R&&(s=null),s!==R?(me.test(t.charAt(et))?(o=t.charAt(et),et++):(o=R,0===st&&n(be)),o===R&&(o=null),o!==R?(i=[i,s,o],r=i):(et=r,r=R)):(et=r,r=R)):(et=r,r=R),r!==R&&(tt=e,r=Qe(r)),e=r}var A,w=arguments.length>1?arguments[1]:{},R={},V={chain:o},N=o,L=function(e){for(var t=[],r=[],i=0;i<e[1].length;i++)t.push(e[1][i]);for(var i=0;i<e[2].length;i++){var n=e[2][i][0]?e[2][i][0]:"-";r.push({bond:n,id:e[2][i][1]})}for(var i=0;i<e[3].length;i++)t.push(e[3][i]);for(var i=0;i<e[6].length;i++)t.push(e[6][i]);return{atom:e[0],isBracket:!!e[0].element,branches:t,branchCount:t.length,ringbonds:r,ringbondCount:r.length,bond:e[4]?e[4]:"-",next:e[5],hasNext:!!e[5]}},S="(",T={type:"literal",value:"(",description:'"("'},B=")",H={type:"literal",value:")",description:'")"'},M=function(e){var t=e[1]?e[1]:"-";return e[2].branchBond=t,e[2]},I=function(e){return e},P=/^[\-=#$:\/\\.]/,W={type:"class",value:"[-=#$:/\\\\.]",description:"[-=#$:/\\\\.]"},O=function(e){return e},F="[",E={type:"literal",value:"[",description:'"["'},D="se",_={type:"literal",value:"se",description:'"se"'},z="as",U={type:"literal",value:"as",description:'"as"'},j="]",X={type:"literal",value:"]",description:'"]"'},q=function(e){return{isotope:e[1],element:e[2],chirality:e[3],hcount:e[4],charge:e[5],class:e[6]}},G="B",Y={type:"literal",value:"B",description:'"B"'},K="r",Z={type:"literal",value:"r",description:'"r"'},$="C",J={type:"literal",value:"C",description:'"C"'},Q="l",ee={type:"literal",value:"l",description:'"l"'},te=/^[NOPSFI]/,re={type:"class",value:"[NOPSFI]",description:"[NOPSFI]"},ie=function(e){return e.length>1?e.join(""):e},ne=/^[bcnops]/,se={type:"class",value:"[bcnops]",description:"[bcnops]"},oe="*",ae={type:"literal",value:"*",description:'"*"'},he=function(e){return e},le=/^[A-Z]/,ue={type:"class",value:"[A-Z]",description:"[A-Z]"},ce=/^[a-z]/,ge={type:"class",value:"[a-z]",description:"[a-z]"},ve=function(e){return e.join("")},de="%",fe={type:"literal",value:"%",description:'"%"'},pe=/^[1-9]/,ye={type:"class",value:"[1-9]",description:"[1-9]"},me=/^[0-9]/,be={type:"class",value:"[0-9]",description:"[0-9]"},xe=function(e){return 1==e.length?Number(e):Number(e.join("").replace("%",""))},ke="@",Ce={type:"literal",value:"@",description:'"@"'},Ae="TH",we={type:"literal",value:"TH",description:'"TH"'},Re=/^[12]/,Ve={type:"class",value:"[12]",description:"[12]"},Ne="AL",Le={type:"literal",value:"AL",description:'"AL"'},Se="SP",Te={type:"literal",value:"SP",description:'"SP"'},Be=/^[1-3]/,He={type:"class",value:"[1-3]",description:"[1-3]"
},Me="TB",Ie={type:"literal",value:"TB",description:'"TB"'},Pe="OH",We={type:"literal",value:"OH",description:'"OH"'},Oe=function(e){return e[1]?"@"==e[1]?"@@":e[1].join("").replace(",",""):"@"},Fe=function(e){return e},Ee="+",De={type:"literal",value:"+",description:'"+"'},_e=function(e){return e[1]?"+"!=e[1]?Number(e[1].join("")):2:1},ze="-",Ue={type:"literal",value:"-",description:'"-"'},je=function(e){return e[1]?"-"!=e[1]?-Number(e[1].join("")):-2:-1},Xe="H",qe={type:"literal",value:"H",description:'"H"'},Ge=function(e){return e[1]?Number(e[1]):1},Ye=":",Ke={type:"literal",value:":",description:'":"'},Ze=/^[0]/,$e={type:"class",value:"[0]",description:"[0]"},Je=function(e){return Number(e[1][0]+e[1][1].join(""))},Qe=function(e){return Number(e.join(""))},et=0,tt=0,rt=[{line:1,column:1,seenCR:!1}],it=0,nt=[],st=0;if("startRule"in w){if(!(w.startRule in V))throw new Error("Can't start parsing from rule \""+w.startRule+'".');N=V[w.startRule]}if((A=N())!==R&&et===t.length)return A;throw A!==R&&et<t.length&&n({type:"end",description:"end of input"}),s(null,nt,it<t.length?t.charAt(it):null,it<t.length?i(it,it+1):i(it,it))}return function(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}(e,Error),{SyntaxError:e,parse:t}}(),SmilesDrawer=function(){function e(t){_classCallCheck(this,e),this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.canvasWrapper=null,this.direction=1,this.totalOverlapScore=0,this.maxBonds={c:4,C:4,n:3,N:3,o:2,O:2},this.defaultOptions={shortBondLength:9,bondLength:16,bondSpacing:4,debug:!1,allowFlips:!1,drawingIterations:20,isomeric:!0,themes:{dark:{C:"#fff",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#141414"},light:{C:"#222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#fff"}}},this.opts=this.extend(!0,this.defaultOptions,t),this.theme=this.opts.themes.dark}return _createClass(e,[{key:"extend",value:function(){var e=this,t={},r=!1,i=0,n=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(r=arguments[0],i++);for(;i<n;i++){var s=arguments[i];!function(i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r&&"[object Object]"===Object.prototype.toString.call(i[n])?t[n]=e.extend(!0,t[n],i[n]):t[n]=i[n])}(s)}return t}},{key:"draw",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"dark",i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.data=e,this.canvasWrapper=new CanvasWrapper(t,this.opts.themes[r],this.opts.bondLength,this.opts.bondSpacing),this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.vertices=[],this.edges=[],this.rings=[],this.ringConnections=[],this.backupVertices=[],this.backupRings=[],this.initGraph(e),this.initRings(),this.annotateChirality(),!i){this.position();var n=this.getOverlapScore(),s=0,o=this.getBridgedRings().length,a=this.opts.drawingIterations;for(o>0&&(a=2);n.total>this.opts.bondLength/20&&s<a;){1===this.direction?this.direction=-1:this.direction===-1&&(this.direction=0),this.clearPositions(),this.position();var h=this.getOverlapScore();h.total<n.total?n=h:this.restorePositions(),s++}this.resolveSecondaryOverlaps(n.scores),this.totalOverlapScore=this.getOverlapScore().total,this.canvasWrapper.scale(this.vertices),this.drawEdges(this.opts.debug),this.drawVertices(this.opts.debug),this.canvasWrapper.reset()}}},{key:"edgeRingCount",value:function(e){var t=this.edges[e],r=this.vertices[t.sourceId],i=this.vertices[t.targetId];return Math.min(r.value.rings.length,i.value.rings.length)}},{key:"getBridgedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isBridged&&e.push(this.rings[t]);return e}},{key:"getFusedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isFused&&e.push(this.rings[t]);return e}},{key:"getSpiros",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isSpiro&&e.push(this.rings[t]);return e}},{key:"printRingInfo",value:function(){for(var e="",t=0;t<this.rings.length;t++){var r=this.rings[t];e+=r.id+";",e+=r.members.length+";",e+=r.neighbours.length+";",e+=r.isSpiro?"true;":"false;",e+=r.isFused?"true;":"false;",e+=r.isBridged?"true;":"false;",e+=r.rings.length+";",e+=r.insiders.length,e+="\n"}return e}},{key:"getTotalOverlapScore",value:function(){return this.totalOverlapScore}},{key:"getRingCount",value:function(){return this.rings.length}},{key:"hasBridgedRing",value:function(){for(var e=0;e<this.rings.length;e++)if(this.rings[e].isBridged)return!0;return!1}},{key:"getHeavyAtomCount",value:function(){for(var e=0,t=0;t<this.vertices.length;t++)"h"!==this.vertices[t].value.element.toLowerCase()&&e++;return e}},{key:"initGraph",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=new Atom(e.atom.element?e.atom.element:e.atom,e.bond);n.branchBond=e.branchBond,n.ringbonds=e.ringbonds,n.bracket=e.atom.element?e.atom:null,n.setOrder(r,t);var s=new Vertex(n),o=this.vertices[r];if(s.parentVertexId=r,this.addVertex(s),null!=r){this.vertices[r].children.push(s.id),this.vertices[r].spanningTreeChildren.push(s.id);var a=new Edge(r,s.id,1);a.bondType=i?s.value.branchBond:this.vertices[r].value.bondType;var h=this.addEdge(a);s.edges.push(h),o.edges.push(h)}if(n.bracket&&this.opts.isomeric)for(var l=0;l<n.bracket.hcount;l++)this.initGraph({atom:{element:"H",bond:"-"},ringbonds:[]},l+1,s.id);var u=e.ringbondCount+1;n.bracket&&(u+=n.bracket.hcount);for(var c=0;c<e.branchCount;c++)this.initGraph(e.branches[c],c+u,s.id,!0);e.hasNext&&this.initGraph(e.next,e.branchCount+u,s.id)}},{key:"getRingbondType",value:function(e,t){if(e.value.getRingbondCount()<1||t.value.getRingbondCount()<1)return null;for(var r=0;r<e.value.ringbonds.length;r++)for(var i=0;i<t.value.ringbonds.length;i++)if(e.value.ringbonds[r].id==t.value.ringbonds[i].id)return"-"==e.value.ringbonds[r].bondType?t.value.ringbonds[i].bond:e.value.ringbonds[r].bond;return null}},{key:"initRings",value:function(){for(var e=this,t={},r=this.vertices.length-1;r>=0;r--){var i=this.vertices[r];if(0!==i.value.ringbonds.length)for(var n=0;n<i.value.ringbonds.length;n++){var s=i.value.ringbonds[n].id;if(void 0===t[s])t[s]=i.id;else{var o=t[s],a=i.id,h=e.addEdge(new Edge(a,o,1)),l=e.vertices[a],u=e.vertices[o];l.children.push(o),u.children.push(a),l.edges.push(h),u.edges.push(h);var c=new Ring(s,a,o);e.addRing(c);for(var g=e.getRingVertices(c.sourceId,c.targetId),v=0;v<g.length;v++)c.members.push(g[v]),e.vertices[g[v]].value.rings.push(c.id);t[s]=void 0;var d=u.value.bracket?u.value.bracket.hcount:0,f=l.value.bracket?l.value.bracket.hcount:0;u.value.setOrder(a,n+1+f),l.value.setOrder(o,n+1+d)}}}for(var p=0;p<this.rings.length-1;p++)for(var y=p+1;y<this.rings.length;y++){var m=this.rings[p],b=this.rings[y],x=new RingConnection(m,b);x.vertices.length>0&&this.addRingConnection(x)}for(var k=0;k<this.rings.length;k++){var C=this.rings[k];C.neighbours=RingConnection.getNeighbours(this.ringConnections,C.id)}for(;this.rings.length>0;){for(var A=-1,w=0;w<this.rings.length;w++){var R=this.rings[w];this.isPartOfBridgedRing(R.id)&&(A=R.id)}if(A===-1)break;var V=this.getRing(A),N=this.getBridgedRingRings(V.id);this.createBridgedRing(N,V.sourceId);for(var L=0;L<N.length;L++)this.removeRing(N[L])}}},{key:"getBridgedRingRings",value:function(e){var t=new Array,r=this;return function e(i){var n=r.getRing(i);t.push(i);for(var s=0;s<n.neighbours.length;s++){var o=n.neighbours[s];t.indexOf(o)===-1&&o!==i&&RingConnection.isBridge(r.ringConnections,r.vertices,i,o)&&e(o)}}(e),ArrayHelper.unique(t)}},{key:"isPartOfBridgedRing",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].rings.contains(e)&&this.ringConnections[t].isBridge(this.vertices))return!0;return!1}},{key:"createBridgedRing",value:function(e,t){for(var r=new Array,i=new Array,n=new Array,s=(new Array,0);s<e.length;s++){for(var o=this.getRing(e[s]),a=0;a<o.members.length;a++)i.push(o.members[a]);for(var h=0;h<o.neighbours.length;h++)n.push(o.neighbours[h])}i=ArrayHelper.unique(i);for(var l=new Array,u=0;u<i.length;u++){var c=this.vertices[i[u]],g=ArrayHelper.intersection(e,c.value.rings);1==c.value.rings.length||1==g.length?r.push(c.id):l.push(c.id)}for(var v=new Array,d=new Array,f=0;f<l.length;f++){for(var p=this.vertices[l[f]],y=!1,m=0;m<p.edges.length;m++)1==this.edgeRingCount(p.edges[m])&&(y=!0);y?(p.value.isBridgeNode=!0,v.push(p.id)):(p.value.isBridge=!0,d.push(p.id))}var b=ArrayHelper.merge(r,v);n=ArrayHelper.unique(n),n=ArrayHelper.removeAll(n,e);for(var x=this.vertices[t],k=x.getNeighbours(),C=null,A=0;A<k.length;A++){var w=k[A];b.indexOf(w)!==-1&&(C=w)}var R=new Ring(-1,t,C);R.isBridged=!0,R.members=b,R.neighbours=n,R.insiders=d;for(var V=0;V<e.length;V++)R.rings.push(this.getRing(e[V]).clone());this.addRing(R);for(var N=0;N<d.length;N++){var L=this.vertices[d[N]];L.value.rings=new Array,L.value.bridgedRing=R.id}for(var S=0;S<b.length;S++){var T=this.vertices[b[S]];T.value.rings=ArrayHelper.removeAll(T.value.rings,e),T.value.rings.push(R.id)}for(var B=0;B<e.length;B++)for(var H=B+1;H<e.length;H++)this.removeRingConnectionsBetween(e[B],e[H]);for(var M=0;M<n.length;M++){for(var I=this.getRingConnections(n[M],e),P=0;P<I.length;P++)this.getRingConnection(I[P]).updateOther(R.id,n[M]);this.getRing(n[M]).neighbours.push(R.id)}return R}},{key:"getRingVertices",value:function(e,t){for(var r=this.dijkstra(e,t),i=[],n=[],s=t;null!=s;)i.push(s),s=r[s];for(var o=i.length-1;o>=0;o--)n.push(i[o]);return n}},{key:"dijkstra",value:function(e,t){for(var r=new Array(this.vertices.length),i=new Array(this.vertices.length),n=new Array(this.vertices.length),s=new Array(this.vertices.length),o=0;o<this.vertices.length;o++)i[o]=o==e?0:Number.MAX_VALUE,r[o]=null,n[o]=!1,s[o]=this.vertices[o].getNeighbours();for(;ArrayHelper.count(n,!1)>0;){var a=this.getMinDist(i,n);if(a==t)return r;n[a]=!0;for(var h=0;h<s[a].length;h++){var l=s[a][h],u=i[a]+this.getEdgeWeight(a,l);a==e&&l==t||a==t&&l==e||u<i[l]&&(i[l]=u,r[l]=a)}}}},{key:"getMinDist",value:function(e,t){for(var r=Number.MAX_VALUE,i=null,n=0;n<e.length;n++)t[n]||e[n]<r&&(i=n,r=e[i]);return i}},{key:"areVerticesInSameRing",value:function(e,t){for(var r=0;r<e.value.rings.length;r++)for(var i=0;i<t.value.rings.length;i++)if(e.value.rings[r]==t.value.rings[i])return!0;return!1}},{key:"getCommonRings",value:function(e,t){for(var r=[],i=0;i<e.value.rings.length;i++)for(var n=0;n<t.value.rings.length;n++)e.value.rings[i]==t.value.rings[n]&&r.push(e.value.rings[i]);return r}},{key:"getSmallestCommonRing",value:function(e,t){for(var r=this.getCommonRings(e,t),i=Number.MAX_VALUE,n=null,s=0;s<r.length;s++){var o=this.getRing(r[s]).getSize();o<i&&(i=o,n=this.getRing(r[s]))}return n}},{key:"getLargestCommonRing",value:function(e,t){for(var r=this.getCommonRings(e,t),i=0,n=null,s=0;s<r.length;s++){var o=this.getRing(r[s]).getSize();o>i&&(i=o,n=this.getRing(r[s]))}return n}},{key:"getVerticesAt",value:function(e,t,r){for(var i=new Array,n=0;n<this.vertices.length;n++){var s=this.vertices[n];if(s.id!==r&&s.positioned){e.distance(s.position)<=t&&i.push(s.id)}}return i}},{key:"getClosestVertex",value:function(e){for(var t=99999,r=null,i=0;i<this.vertices.length;i++){var n=this.vertices[i];if(n.id!==e.id){var s=e.position.distanceSq(n.position);s<t&&(t=s,r=n)}}return r}},{key:"getClosestEndpointVertex",value:function(e){for(var t=99999,r=null,i=0;i<this.vertices.length;i++){var n=this.vertices[i];if(!(n.id===e.id||n.getNeighbours().length>1)){var s=e.position.distanceSq(n.position);s<t&&(t=s,r=n)}}return r}},{key:"getBranch",value:function(e,t){var r=new Array,i=new Array,n=this;return r.push(e),function e(t,s){for(var o=n.vertices[t],a=0;a<o.value.rings.length;a++)i.push(o.value.rings[a]);for(var h=0;h<o.children.length;h++){var l=o.children[h];l===s||ArrayHelper.contains(r,{value:l})||(r.push(l),e(l,t))}var u=o.parentVertexId;u===s||null===u||ArrayHelper.contains(r,{value:u})||(r.push(u),e(u,t))}(e,t),{vertices:r,rings:ArrayHelper.unique(i)}}},{key:"addVertex",value:function(e){return e.id=this.vertices.length,this.vertices.push(e),e.id}},{key:"addEdge",value:function(e){return e.id=this.edges.length,this.edges.push(e),e.id}},{key:"addRing",value:function(e){return e.id=this.ringIdCounter++,this.rings.push(e),e.id}},{key:"removeRing",value:function(e){this.rings=this.rings.filter(function(t){return t.id!==e}),this.ringConnections=this.ringConnections.filter(function(t){return t.rings.first!==e&&t.rings.second!==e});for(var t=0;t<this.rings.length;t++){var r=this.rings[t];r.neighbours=r.neighbours.filter(function(t){return t!==e})}}},{key:"getRing",value:function(e){for(var t=0;t<this.rings.length;t++)if(this.rings[t].id==e)return this.rings[t]}},{key:"addRingConnection",value:function(e){return e.id=this.ringConnectionIdCounter++,this.ringConnections.push(e),e.id}},{key:"removeRingConnection",value:function(e){this.ringConnections=this.ringConnections.filter(function(t){return t.id!==e})}},{key:"removeRingConnectionsBetween",value:function(e,t){for(var r=new Array,i=0;i<this.ringConnections.length;i++){var n=this.ringConnections[i];(n.rings.first===e&&n.rings.second===t||n.rings.first===t&&n.rings.second===e)&&r.push(n.id)}for(var s=0;s<r.length;s++)this.removeRingConnection(r[s])}},{key:"getRingConnection",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].id==e)return this.ringConnections[t]}},{key:"getRingConnections",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=new Array;if(null===t)for(var i=0;i<this.ringConnections.length;i++){var n=this.ringConnections[i];n.rings.first!==e&&n.rings.second!==e||r.push(n.id)}else if(t.constructor!==Array)for(var s=0;s<this.ringConnections.length;s++){var o=this.ringConnections[s];(o.rings.first===e&&o.rings.second===t||o.rings.first===t&&o.rings.second===e)&&r.push(o.id)}else for(var a=0;a<this.ringConnections.length;a++)for(var h=0;h<t.length;h++){var l=t[h],u=this.ringConnections[a];(u.rings.first===e&&u.rings.second===l||u.rings.first===l&&u.rings.second===e)&&r.push(u.id)}return r}},{key:"getOverlapScore",value:function(){for(var e=0,t=new Float32Array(this.vertices.length),r=0;r<this.vertices.length;r++)t[r]=0;for(var i=0;i<this.vertices.length;i++)for(var n=i+1;n<this.vertices.length;n++){var s=this.vertices[i],o=this.vertices[n],a=Vector2.subtract(s.position,o.position).length();if(a<this.opts.bondLength){var h=this.opts.bondLength-a;e+=h,t[i]+=h,t[n]+=h}}for(var l=[],u=0;u<this.vertices.length;u++)l.push({id:u,score:t[u]});return l.sort(function(e,t){return t.score-e.score}),{total:e,scores:l}}},{key:"chooseSide",value:function(e,t,r){for(var i=e.getNeighbours(t.id),n=t.getNeighbours(e.id),s=i.length,o=n.length,a=ArrayHelper.merge(i,n),h=[0,0],l=0;l<a.length;l++){this.vertices[a[l]].position.sameSideAs(e.position,t.position,r[0])?h[0]++:h[1]++}for(var u=[0,0],c=0;c<this.vertices.length;c++){this.vertices[c].position.sameSideAs(e.position,t.position,r[0])?u[0]++:u[1]++}return{totalSideCount:u,totalPosition:u[0]>u[1]?0:1,sideCount:h,position:h[0]>h[1]?0:1,anCount:s,bnCount:o}}},{key:"areConnected",value:function(e,t){for(var r=0;r<this.edges.length;r++){var i=this.edges[r];if(i.sourceId===e&&i.targetId===t||i.sourceId===t&&i.targetId===e)return!0}return!1}},{key:"getEdgeWeight",value:function(e,t){for(var r=0;r<this.edges.length;r++){var i=this.edges[r];if(i.sourceId==e&&i.targetId==t||i.targetId==e&&i.sourceId==t)return i.weight}return null}},{key:"getEdge",value:function(e,t){for(var r=0;r<this.edges.length;r++){var i=this.edges[r];if(i.sourceId==e&&i.targetId==t||i.targetId==e&&i.sourceId==t)return i}return null}},{key:"forceLayout",value:function(e,t,r,i){for(var n=this.opts.bondLength,s=[],o=0;o<e.length;o++){var a=this.vertices[e[o]];if(a.value.isBridge)for(var h=a.getNeighbours(),l=0;l<h.length;l++){var u=h[l];ArrayHelper.contains(e,{value:u})||s.push(u)}}e=ArrayHelper.merge(e,s);for(var c=e.length+i.rings.length,g=new Array(e.length),v={},d=new Array(c),f=new Array,p=0;p<c;p++){d[p]=new Array(c);for(var y=0;y<c;y++)d[p][y]=0}for(var m=0;m<e.length;m++)g[m]=this.vertices[e[m]].id,v[g[m]]=m;for(var b=0;b<e.length-1;b++)for(var x=b;x<e.length;x++){var k=this.getEdge(g[b],this.vertices[e[x]].id);null!==k&&(d[b][x]=n,d[x][b]=n,f.push([b,x]))}for(var C=0;C<i.rings.length;C++)for(var A=i.rings[C],w=e.length+C,R=0;R<A.members.length;R++){var V=v[A.members[R]],N=MathHelper.polyCircumradius(n,A.getSize());d[V][w]=N,d[w][V]=N}for(var L=0;L<f.length;L++){for(var S=0;S<c;S++)d[S].push(0);d.push(new Array);for(var T=0;T<c+f.length;T++)d[c+L].push(0)}for(var B=0;B<i.rings.length;B++){for(var H=i.rings[B],M=e.length+B,I=H.getSize(),P=0;P<f.length;P++){var W=f[P][0];if(0!==d[M][W]){var O=MathHelper.apothem(d[M][W],I);d[M][c+P]=O,d[c+P][M]=O}}for(var F=0;F<i.rings.length;F++){var E=i.rings[F];if(0!==ArrayHelper.intersection(H.members,E.members).length){var D=e.length+F,_=E.getSize(),z=MathHelper.apothemFromSideLength(n,I)+MathHelper.apothemFromSideLength(n,_);d[M][D]=z,d[D][M]=z}}}c+=f.length;for(var U=c-f.length,j=new Array(c),X=new Array(c),q=new Array(c),G=new Array(c),Y=new Array(c),K=0;K<c;K++)G[K]=K>=e.length&&K<U,G[K]?Y[K]=i.rings[K-e.length].members.length:Y[K]=1;for(var Z=0;Z<c;Z++)if(j[Z]=new Vector2,X[Z]=new Vector2(t.x+Math.random()*n*5,t.y+Math.random()*n*5),q[Z]=!1,!(Z>=e.length)){var $=this.vertices[g[Z]];X[Z]=$.position.clone(),$.positioned&&2===i.rings.length&&(q[Z]=!0)}for(var J=n/2,Q=n/2,ee=2*n,te=0;te<500;te++){for(var re=0;re<c;re++)j[re].set(0,0);for(var ie=0;ie<f.length;ie++){var ne=U+ie,se=X[f[ie][0]],oe=X[f[ie][1]];X[ne]=Vector2.midpoint(se,oe)}for(var ae=0;ae<c-1;ae++)for(var he=ae+1;he<c;he++)if((!(te<250)||G[ae]&&G[he])&&!(te>250&&G[ae]&&G[he]||i.rings.length<3&&(G[ae]||G[he]))){var le=X[he].x-X[ae].x,ue=X[he].y-X[ae].y;if(0!==le&&0!==ue){var ce=le*le+ue*ue;ce<.01&&(le=.1*Math.random()+.1,ue=.1*Math.random()+.1,ce=le*le+ue*ue);var ge=Math.sqrt(ce);if(!(ge>d[ae][he])){var ve=J*J/ge;te>250&&(G[ae]||G[he])&&(ve*=Y[ae]*Y[he]);var de=ve*le/ge,fe=ve*ue/ge;q[ae]||(j[ae].x-=de,j[ae].y-=fe),q[he]||(j[he].x+=de,j[he].y+=fe)}}}for(var pe=0;pe<c-1;pe++)for(var ye=pe+1;ye<c;ye++)if(!(d[pe][ye]<=0)&&(!(te<250)||G[pe]&&G[ye])&&!(te>250&&G[pe]&&G[ye])){var me=X[ye].x-X[pe].x,be=X[ye].y-X[pe].y;if(0!==me&&0!==be){var xe=me*me+be*be;xe<.01&&(me=.1*Math.random()+.1,be=.1*Math.random()+.1,xe=me*me+be*be);var ke=Math.sqrt(xe);ke>ee&&(ke=ee,xe=ke*ke);var Ce=(xe-J*J)/J,Ae=d[pe][ye];Ce*=ke<Ae?.25:2.5;var we=Ce*me/ke,Re=Ce*be/ke;q[pe]||(j[pe].x+=we,j[pe].y+=Re),q[ye]||(j[ye].x-=we,j[ye].y-=Re)}}for(var Ve=0;Ve<f.length;Ve++){var Ne=U+Ve,Le=j[Ne],Se=f[Ve][0],Te=f[Ve][1];j[Se].x+=Le.x,j[Se].y+=Le.y,j[Te].x+=Le.x,j[Te].y+=Le.y}for(var Be=0;Be<c;Be++)if(!q[Be]){var He=.01*j[Be].x,Me=.01*j[Be].y;He>Q&&(He=Q),He<-Q&&(He=-Q),Me>Q&&(Me=Q),Me<-Q&&(Me=-Q);X[Be].x+=He,X[Be].y+=Me}if(te>200&&i.rings.length>2)for(var Ie=0;Ie<i.rings.length;Ie++){for(var Pe=i.rings[Ie],We=new Vector2,Oe=0;Oe<Pe.members.length;Oe++){var Fe=X[v[Pe.members[Oe]]];We.x+=Fe.x,We.y+=Fe.y}We.x/=Pe.members.length,We.y/=Pe.members.length,X[e.length+Ie]=We}}for(var Ee=0;Ee<c;Ee++)if(Ee<e.length)q[Ee]||(this.vertices[g[Ee]].position=X[Ee],this.vertices[g[Ee]].positioned=!0);else if(Ee<e.length+i.rings.length){var De=Ee-e.length;i.rings[De].center=X[Ee]}for(var _e=0;_e<e.length;_e++)for(var ze=this.vertices[e[_e]],Ue=this.vertices[ze.parentVertexId],je=ze.getNeighbours(),Xe=ze.getAngle(null,!0)-60,qe=0;qe<je.length;qe++)ze.value.isBridge||void 0!==Ue&&Ue.value.isBridge?this.createNextBond(this.vertices[je[qe]],ze,MathHelper.toRad(Xe)):0===this.vertices[je[qe]].value.rings.length&&(i.rings.length>2&&(t=this.getSubringCenter(i,ze)),this.createNextBond(this.vertices[je[qe]],ze,t)),Xe+=120}},{key:"getSubringCenter",value:function(e,t){for(var r=0;r<e.rings.length;r++)for(var i=e.rings[r],n=0;n<i.members.length;n++)if(i.members[n]===t.id)return i.center;return e.center}},{key:"drawEdges",value:function(e){for(var t=this,r=this,i=0;i<this.edges.length;i++)!function(i){var n=t.edges[i],s=t.vertices[n.sourceId],o=t.vertices[n.targetId],a=s.value.element,h=o.value.element,l=s.position,u=o.position,c=t.getEdgeNormals(n),g=(s.value.element.toUpperCase(),o.value.element.toUpperCase(),ArrayHelper.clone(c));if(ArrayHelper.each(g,function(e){e.multiply(10),e.add(l)}),"="===n.bondType||"="===t.getRingbondType(s,o)){var v=t.areVerticesInSameRing(s,o),d=t.chooseSide(s,o,g);if(v){var f=t.getLargestCommonRing(s,o),p=f.center;ArrayHelper.each(c,function(e){e.multiply(r.opts.bondSpacing)});var y=null;y=p.sameSideAs(s.position,o.position,Vector2.add(l,c[0]))?new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h):new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h),y.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(y),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else if(n.center){ArrayHelper.each(c,function(e){e.multiply(r.opts.bondSpacing/2)});var m=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h),b=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);m.shorten(t.opts.bondLength-t.opts.shortBondLength),b.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(m),t.canvasWrapper.drawLine(b)}else if(0==d.anCount&&d.bnCount>1||0==d.bnCount&&d.anCount>1){ArrayHelper.each(c,function(e){e.multiply(r.opts.bondSpacing/2)});var x=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h),k=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);t.canvasWrapper.drawLine(x),t.canvasWrapper.drawLine(k)}else if(d.sideCount[0]>d.sideCount[1]){ArrayHelper.each(c,function(e){e.multiply(r.opts.bondSpacing)});var C=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h);C.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(C),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else if(d.sideCount[0]<d.sideCount[1]){ArrayHelper.each(c,function(e){e.multiply(r.opts.bondSpacing)});var A=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);A.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(A),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else if(d.totalSideCount[0]>d.totalSideCount[1]){ArrayHelper.each(c,function(e){e.multiply(r.opts.bondSpacing)});var w=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h);w.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(w),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else if(d.totalSideCount[0]<=d.totalSideCount[1]){ArrayHelper.each(c,function(e){e.multiply(r.opts.bondSpacing)});var R=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);R.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(R),t.canvasWrapper.drawLine(new Line(l,u,a,h))}}else if("#"===n.bondType){ArrayHelper.each(c,function(e){e.multiply(r.opts.bondSpacing/1.5)});var V=new Line(Vector2.add(l,c[0]),Vector2.add(u,c[0]),a,h),N=new Line(Vector2.add(l,c[1]),Vector2.add(u,c[1]),a,h);V.shorten(t.opts.bondLength-t.opts.shortBondLength),N.shorten(t.opts.bondLength-t.opts.shortBondLength),t.canvasWrapper.drawLine(V),t.canvasWrapper.drawLine(N),t.canvasWrapper.drawLine(new Line(l,u,a,h))}else{var L=s.value.bracket&&s.value.bracket.chirality,S=o.value.bracket&&o.value.bracket.chirality;"up"===n.chiral?t.canvasWrapper.drawWedge(new Line(l,u,a,h,L,S)):"down"===n.chiral?t.canvasWrapper.drawDashedWedge(new Line(l,u,a,h,L,S)):t.canvasWrapper.drawLine(new Line(l,u,a,h,L,S))}if(e){var T=Vector2.midpoint(l,u);t.canvasWrapper.drawDebugText(T.x,T.y,"e: "+i)}}(i);for(var i=0;i<this.rings.length;i++){var n=this.rings[i];n.isAromatic(this.vertices)&&this.canvasWrapper.drawAromaticityRing(n)}}},{key:"drawVertices",value:function(e){for(var t=0;t<this.vertices.length;t++){var r=this.vertices[t],i=r.value,n=0,s=this.getBondCount(r),o=1==i.element.length?i.element.toUpperCase():i.element,a=this.maxBonds[o]-s,h=r.getTextDirection(this.vertices),l=r.isTerminal(),u="c"===i.element.toLowerCase();if(i.bracket&&(a=i.bracket.hcount,n=i.bracket.charge),(!u||i.explicit||l)&&this.canvasWrapper.drawText(r.position.x,r.position.y,o,a,h,l,n),e){var c="v: "+r.id+" "+ArrayHelper.print(i.ringbonds);this.canvasWrapper.drawDebugText(r.position.x,r.position.y,c)}}if(this.opts.debug)for(var g=0;g<this.rings.length;g++){var v=this.rings[g].center;this.canvasWrapper.drawDebugPoint(v.x,v.y,"r: "+this.rings[g].id)}}},{key:"position",value:function(){for(var e=0,t=0;t<this.rings.length&&(!this.rings[t].isBridged||(e=this.rings[t].members[t],1!==this.vertices[e].value.rings.length));t++);this.createNextBond(this.vertices[e]),this.resolvePrimaryOverlaps()}},{key:"clearPositions",value:function(){this.backupVertices=[],this.backupRings=[];for(var e=0;e<this.vertices.length;e++){var t=this.vertices[e];this.backupVertices.push(t.clone()),t.positioned=!1,t.position=new Vector2}for(var r=0;r<this.rings.length;r++){var i=this.rings[r];this.backupRings.push(i.clone()),i.positioned=!1,i.center=new Vector2}}},{key:"restorePositions",value:function(){for(var e=0;e<this.backupVertices.length;e++)this.vertices[e]=this.backupVertices[e];for(var t=0;t<this.backupRings.length;t++)this.rings[t]=this.backupRings[t]}},{key:"createRing",value:function(e,t){var r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!e.positioned){t=t?t:new Vector2(0,0);var s=e.getOrderedNeighbours(this.ringConnections),o=i?Vector2.subtract(i.position,t).angle():0,a=MathHelper.polyCircumradius(this.opts.bondLength,e.getSize());e.radius=a;var h=MathHelper.centralAngle(e.getSize());e.centralAngle=h;var l=o,u=this;if(e.eachMember(this.vertices,function(r){var i=u.vertices[r];i.positioned||(i.position.x=t.x+Math.cos(l)*a,i.position.y=t.y+Math.sin(l)*a),l+=h,(!e.isBridged||e.rings.length<3)&&(i.positioned=!0)},i?i.id:null,n?n.id:null),e.isBridged){var c=ArrayHelper.merge(e.members,e.insiders);this.forceLayout(c,t,i.id,e)}this.vertices[e.members[0]].value.addAnchoredRing(e.id),e.positioned=!0,e.center=t;for(var g=0;g<s.length;g++){var v=this.getRing(s[g].neighbour);if(!v.positioned){var d=RingConnection.getVertices(this.ringConnections,e.id,v.id);if(2==d.length)!function(){e.isFused=!0,v.isFused=!0;var t=r.vertices[d[0]],i=r.vertices[d[1]],n=Vector2.midpoint(t.position,i.position),s=Vector2.normals(t.position,i.position);ArrayHelper.each(s,function(e){e.normalize()});var o=MathHelper.polyCircumradius(r.opts.bondLength,v.getSize()),a=MathHelper.apothem(o,v.getSize());ArrayHelper.each(s,function(e){e.multiply(a)}),ArrayHelper.each(s,function(e){e.add(n)});var h=s[0];r.isPointInRing(h)&&(h=s[1]);var l=Vector2.subtract(t.position,h),u=Vector2.subtract(i.position,h);l.clockwise(u)===-1?r.createRing(v,h,t,i):r.createRing(v,h,i,t)}();else if(1==d.length){e.isSpiro=!0,v.isSpiro=!0;var f=this.vertices[d[0]],p=Vector2.subtract(t,f.position);p.invert(),p.normalize();var y=MathHelper.polyCircumradius(this.opts.bondLength,v.getSize());p.multiply(y),p.add(f.position),this.createRing(v,p,f)}}}for(var m=0;m<e.members.length;m++)for(var b=this.vertices[e.members[m]],x=b.getNeighbours(),k=0;k<x.length;k++)if(!e.thisOrNeighboursContain(this.rings,x[k])){var C=this.vertices[x[k]];this.createNextBond(C,b,e.center)}}}},{key:"rotateSubtree",value:function(e,t,r,i){var n=this;this.traverseTree(e,t,function(e){e.position.rotateAround(r,i);for(var t=0;t<e.value.anchoredRings.length;t++)n.rings[e.value.anchoredRings[t]].center.rotateAround(r,i)})}},{key:"getCurrentCenterOfMass",value:function(){for(var e=new Vector2,t=0,r=0;r<this.vertices.length;r++){var i=this.vertices[r];i.positioned&&(e.add(i.position),t++)}return e.divide(t)}},{key:"getCurrentCenterOfMassInNeigbourhood",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2*this.opts.bondLength,r=new Vector2,i=0,n=t*t,s=0;s<this.vertices.length;s++){var o=this.vertices[s];o.positioned&&e.distanceSq(o.position)<n&&(r.add(o.position),i++)}return r.divide(i)}},{key:"resolvePrimaryOverlaps",value:function(){for(var e=[],t=[],r=new Array(this.vertices.length),i=0;i<this.rings.length;i++)for(var n=this.rings[i],s=0;s<n.members.length;s++){var o=this.vertices[n.members[s]];if(!r[o.id]&&(r[o.id]=!0,o.getNeighbours().length>2)){for(var a=[],h=0;h<o.value.rings.length;h++)a.push(o.value.rings[h]);e.push({common:o,rings:a,vertices:this.getNonRingNeighbours(o.id)})}}for(var l=0;l<t.length;l++){var u=t[l],c=-u.vertex.position.getRotateToAngle(u.other.position,u.common.position);this.rotateSubtree(u.vertex.id,u.common.id,c+Math.PI,u.common.position)}for(var g=0;g<e.length;g++){var v=e[g];if(1==v.vertices.length){var d=v.vertices[0];if(1==d.getNeighbours().length){d.flippable=!0,d.flipCenter=v.common.id;for(var f=0;f<v.rings.length;f++)d.flipRings.push(v.rings[f])}}else if(2==v.vertices.length){var p=(2*Math.PI-this.getRing(v.rings[0]).getAngle())/6,y=v.vertices[0],m=v.vertices[1];if(y.backAngle-=p,m.backAngle+=p,this.rotateSubtree(y.id,v.common.id,p,v.common.position),this.rotateSubtree(m.id,v.common.id,-p,v.common.position),1==y.getNeighbours().length){y.flippable=!0,y.flipCenter=v.common.id,y.flipNeighbour=m.id;for(var b=0;b<v.rings.length;b++)y.flipRings.push(v.rings[b])}if(1==m.getNeighbours().length){m.flippable=!0,m.flipCenter=v.common.id,m.flipNeighbour=y.id;for(var x=0;x<v.rings.length;x++)m.flipRings.push(v.rings[x])}}}}},{key:"resolveSecondaryOverlaps",value:function(e){for(var t=0;t<e.length;t++)if(e[t].score>this.opts.bondLength/5){var r=this.vertices[e[t].id];if(r.flippable){var i=r.flipRings[0]?this.rings[r.flipRings[0]]:null,n=r.flipRings[1]?this.rings[r.flipRings[1]]:null,s=this.vertices[r.flipCenter].position;if(i&&n){var o=i.members.length>n.members.length?i:n;n=i.members.length<n.members.length?i:n,i=o}if(this.opts.allowFlips)i&&i.allowsFlip()?(r.position.rotateTo(i.center,s),i.setFlipped(),r.flipNeighbour):n&&n.allowsFlip()&&(r.position.rotateTo(n.center,s),n.setFlipped(),r.flipNeighbour);else{var a=this.getClosestEndpointVertex(r);if(a){var h=r.position.clockwise(a.previousPosition);r.position.rotateAround(-.5*h,r.previousPosition)}else i&&i.allowsFlip()&&(r.position.rotateTo(i.center,s),i.setFlipped())}}}}},{key:"createNextBond",value:function(e,t,r,i){if(!e.positioned){if(t)if(0!=t.value.rings.length||e.value.isBridge){if(t.value.isBridgeNode&&e.value.isBridge){var n=Vector2.subtract(r,t.position);n.normalize(),n.multiply(this.opts.bondLength),e.position.add(t.position),e.position.add(n),e.previousPosition=t.position,e.positioned=!0}else if(e.value.isBridge){var s=new Vector2(this.opts.bondLength,0);s.rotate(r),s.add(t.position),e.position=s,e.previousPosition=t.position,e.positioned=!0}else if(1==t.value.rings.length){var o=Vector2.subtract(r,t.position);o.invert(),o.normalize(),o.multiply(this.opts.bondLength),e.position.add(t.position),e.position.add(o),e.previousPosition=t.position,e.positioned=!0}else if(2==t.value.rings.length){var a=this.getRing(t.value.rings[0]),h=this.getRing(t.value.rings[1]),l=Vector2.subtract(h.center,a.center),u=Vector2.subtract(t.position,a.center),c=Vector2.scalarProjection(u,l);l.normalize(),l.multiply(c),l.add(a.center);var g=Vector2.subtract(l,t.position);g.invert(),g.normalize(),g.multiply(this.opts.bondLength),e.position.add(t.position),e.position.add(g),e.previousPosition=t.position,e.positioned=!0}}else{var v=new Vector2(this.opts.bondLength,0);v.rotate(r),v.add(t.position),e.position=v,e.previousPosition=t.position,e.positioned=!0}else{var d=new Vector2(this.opts.bondLength,0);d.rotate(MathHelper.toRad(-120)),e.previousPosition=d,e.position=new Vector2(this.opts.bondLength,0),e.angle=MathHelper.toRad(-120),e.positioned=!0}if(e.value.rings.length>0){
var f=this.getRing(e.value.rings[0]),p=Vector2.subtract(e.previousPosition,e.position);p.invert(),p.normalize();var y=MathHelper.polyCircumradius(this.opts.bondLength,f.getSize());p.multiply(y),p.add(e.position),this.createRing(f,p,e)}else{var m=e.getNeighbours();t&&(m=ArrayHelper.remove(m,t.id));var b=e.getAngle();if(1==m.length){var x=this.vertices[m[0]];if("#"===e.value.bondType||t&&"#"===t.value.bondType||"="===e.value.bondType&&t&&"="===t.value.bondType){e.value.explicit=!0;var k=this.getEdge(e.id,t.id),C=this.getEdge(e.id,x.id);k.center=!0,C.center=!0,x.angle=b,this.createNextBond(x,e,x.angle,-i)}else if(t&&t.value.rings.length>0){var A=MathHelper.toRad(60),w=-A,R=new Vector2(this.opts.bondLength,0),V=new Vector2(this.opts.bondLength,0);R.rotate(A).add(e.position),V.rotate(w).add(e.position);var N=this.getCurrentCenterOfMass(),L=R.distance(N),S=V.distance(N);x.angle=L<S?w:A,i=x.angle>0?-1:1,this.createNextBond(x,e,b+x.angle,i)}else{if(i)x.angle=MathHelper.toRad(60)*i,i=-i;else{var T=MathHelper.toRad(60),B=-T,H=new Vector2(this.opts.bondLength,0),M=new Vector2(this.opts.bondLength,0);H.rotate(T).add(e.position),M.rotate(B).add(e.position);var I=this.getCurrentCenterOfMass(),P=H.distance(I),W=M.distance(I);x.angle=P<W?B:T,i=x.angle>0?-1:1}this.createNextBond(x,e,b+x.angle,i)}}else if(2==m.length){var O=this.getTreeDepth(m[0],e.id),F=this.getTreeDepth(m[1],e.id),E=0,D=1;if(O>F&&(E=1,D=0),1===e.position.clockwise(e.previousPosition)){var _=this.vertices[m[E]],z=this.vertices[m[D]];z.angle=MathHelper.toRad(60),_.angle=-MathHelper.toRad(60),this.createNextBond(z,e,b+z.angle,-i),this.createNextBond(_,e,b+_.angle,-i)}else{var U=this.vertices[m[E]],j=this.vertices[m[D]];j.angle=-MathHelper.toRad(60),U.angle=MathHelper.toRad(60),this.createNextBond(U,e,b+U.angle,-i),this.createNextBond(j,e,b+j.angle,-i)}}else if(3==m.length){var X=this.getTreeDepth(m[0],e.id),q=this.getTreeDepth(m[1],e.id),G=this.getTreeDepth(m[2],e.id),Y=this.vertices[m[0]],K=this.vertices[m[1]],Z=this.vertices[m[2]];if(q>X&&q>G?(Y=this.vertices[m[1]],K=this.vertices[m[0]],Z=this.vertices[m[2]]):G>X&&G>q&&(Y=this.vertices[m[2]],K=this.vertices[m[0]],Z=this.vertices[m[1]]),1===this.getTreeDepth(K.id,e.id)&&1===this.getTreeDepth(Z.id,e.id)){var $=this.direction;0===this.direction&&($=Math.random()<.5?-1:1),i||(i=$),Y.angle=MathHelper.toRad(60)*i,this.createNextBond(Y,e,b+Y.angle,-i),e.value.bracket&&"@@"===e.value.bracket.chirality?(this.createNextBond(Z,e,b+MathHelper.toRad(30)*-i),this.createNextBond(K,e,b+MathHelper.toRad(90)*-i)):(this.createNextBond(K,e,b+MathHelper.toRad(30)*-i),this.createNextBond(Z,e,b+MathHelper.toRad(90)*-i))}else this.createNextBond(Y,e,b),this.createNextBond(K,e,b+MathHelper.toRad(90)),this.createNextBond(Z,e,b-MathHelper.toRad(90))}else if(4==m.length){var J=this.getTreeDepth(m[0],e.id),Q=this.getTreeDepth(m[1],e.id),ee=this.getTreeDepth(m[2],e.id),te=this.getTreeDepth(m[3],e.id),re=this.vertices[m[0]],ie=this.vertices[m[1]],ne=this.vertices[m[2]],se=this.vertices[m[3]];Q>J&&Q>ee&&Q>te?(re=this.vertices[m[1]],ie=this.vertices[m[0]],ne=this.vertices[m[2]],se=this.vertices[m[3]]):ee>J&&ee>Q&&ee>te?(re=this.vertices[m[2]],ie=this.vertices[m[0]],ne=this.vertices[m[1]],se=this.vertices[m[3]]):te>J&&te>Q&&te>ee&&(re=this.vertices[m[3]],ie=this.vertices[m[0]],ne=this.vertices[m[1]],se=this.vertices[m[2]]),this.createNextBond(re,e,b-MathHelper.toRad(36)),this.createNextBond(ie,e,b+MathHelper.toRad(36)),this.createNextBond(ne,e,b-MathHelper.toRad(108)),this.createNextBond(se,e,b+MathHelper.toRad(108))}}}}},{key:"getCommonRingbondNeighbour",value:function(e){for(var t=e.getNeighbours(),r=0;r<t.length;r++){var i=this.vertices[t[r]];if(ArrayHelper.containsAll(i.value.rings,e.value.rings))return i}return null}},{key:"isPointInRing",value:function(e){for(var t=0;t<this.rings.length;t++){var r=this.rings[t].getPolygon(this.vertices);if(e.isInPolygon(r))return!0}return!1}},{key:"isEdgeInRing",value:function(e){var t=this.vertices[e.sourceId],r=this.vertices[e.targetId];return this.areVerticesInSameRing(t,r)}},{key:"isRingAromatic",value:function(e){for(var t=0;t<e.members.length;t++)if(!this.isVertexInAromaticRing(e.members[t]))return!1;return!0}},{key:"isEdgeInAromaticRing",value:function(e){return this.isVertexInAromaticRing(e.sourceId)&&this.isVertexInAromaticRing(e.targetId)}},{key:"isVertexInAromaticRing",value:function(e){var t=this.vertices[e].value.element;return t==t.toLowerCase()}},{key:"getEdgeNormals",value:function(e){var t=this.vertices[e.sourceId].position,r=this.vertices[e.targetId].position,i=Vector2.normals(t,r);return ArrayHelper.each(i,function(e){e.normalize()}),i}},{key:"getTreeDepth",value:function(e,t){for(var r=this.vertices[e].getSpanningTreeNeighbours(t),i=0,n=0;n<r.length;n++){var s=r[n],o=this.getTreeDepth(s,e);o>i&&(i=o)}return i+1}},{key:"traverseTree",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];if(!(null!==i&&s>i+1)){for(var a=0;a<o.length;a++)if(o[a]===e)return;o.push(e);var h=this.vertices[e],l=h.getNeighbours(t);(!n||s>1)&&r(h);for(var u=0;u<l.length;u++)this.traverseTree(l[u],e,r,i,n,s+1,o)}}},{key:"getBondCount",value:function(e){for(var t=0,r=0;r<e.edges.length;r++)t+=this.edges[e.edges[r]].getBondCount();return t}},{key:"getNonRingNeighbours",value:function(e){for(var t=[],r=this.vertices[e],i=r.getNeighbours(),n=0;n<i.length;n++){var s=this.vertices[i[n]];0===ArrayHelper.intersection(r.value.rings,s.value.rings).length&&0==s.value.isBridge&&t.push(s)}return t}},{key:"annotateChirality",value:function(){for(var e=0;e<this.vertices.length;e++){var t=this.vertices[e];if(t.value.bracket&&"c"===t.value.element.toLowerCase()&&4===t.getNeighbours().length||t.value.bracket&&t.value.bracket.hcount>0&&3===t.getNeighbours().length){var r=t.value.bracket.chirality;if(null===r)continue;var i=t.getNeighbours(),n=new Array(i.length);this.vertices[t.parentVertexId].value.setOrder(t.id,0);for(var s=0;s<i.length;s++){var o=i[s];o!==t.parentVertexId?n[this.vertices[o].value.getOrder(t.id)]=o:n[0]=o}if("@"===r){var a=this.getEdge(n[3],t.id);"down"!==a.chiral&&(a.chiral="up");var h=this.getEdge(n[1],t.id);"up"!==h.chiral&&(h.chiral="down")}else if("@@"===r){var l=this.getEdge(n[1],t.id);"down"!==l.chiral&&(l.chiral="up");var u=this.getEdge(n[3],t.id);"up"!==u.chiral&&(u.chiral="down")}}}}}]),e}(),Vector2=function(){function e(t,r){_classCallCheck(this,e),0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=t.x,this.y=t.y):(this.x=t,this.y=r)}return _createClass(e,[{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=e,this.y=t,this}},{key:"clone",value:function(){return new e(this.x,this.y)}},{key:"toString",value:function(){return"("+this.x+","+this.y+")"}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"divide",value:function(e){return this.x/=e,this.y/=e,this}},{key:"multiply",value:function(e){return this.x*=e,this.y*=e,this}},{key:"invert",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(e){return Math.sqrt((e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y))}},{key:"distanceSq",value:function(e){return(e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y)}},{key:"clockwise",value:function(e){var t=this.y*e.x,r=this.x*e.y;return t>r?-1:t===r?0:1}},{key:"rotate",value:function(t){var r=new e;return r.x=this.x*Math.cos(t)-this.y*Math.sin(t),r.y=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=r.x,this.y=r.y,this}},{key:"rotateAround",value:function(e,t){var r=Math.sin(e),i=Math.cos(e);this.x-=t.x,this.y-=t.y;var n=this.x*i-this.y*r,s=this.x*r+this.y*i;return this.x=n+t.x,this.y=s+t.y,this}},{key:"rotateTo",value:function(t,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.x+=.001,this.y-=.001;var n=e.subtract(this,r),s=e.subtract(t,r),o=e.angle(s,n);return this.rotateAround(o+i,r),this}},{key:"getRotateToAngle",value:function(t,r){var i=e.subtract(this,r),n=e.subtract(t,r);return e.angle(n,i)}},{key:"isInPolygon",value:function(e){for(var t=!1,r=0,i=e.length-1;r<e.length;i=r++)e[r].y>this.y!=e[i].y>this.y&&this.x<(e[i].x-e[r].x)*(this.y-e[r].y)/(e[i].y-e[r].y)+e[r].x&&(t=!t);return t}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"normalize",value:function(){return this.divide(this.length()),this}},{key:"normalized",value:function(){return e.divide(this,this.length())}},{key:"whichSide",value:function(e,t){return(this.x-e.x)*(t.y-e.y)-(this.y-e.y)*(t.x-e.x)}},{key:"sameSideAs",value:function(e,t,r){var i=this.whichSide(e,t),n=r.whichSide(e,t);return i<0&&n<0||0==i&&0==n||i>0&&n>0}}],[{key:"add",value:function(t,r){return new e(t.x+r.x,t.y+r.y)}},{key:"subtract",value:function(t,r){return new e(t.x-r.x,t.y-r.y)}},{key:"multiply",value:function(t,r){return r.x&&r.y?new e(t.x*r.x,t.y*r.y):new e(t.x*r,t.y*r)}},{key:"multiplyScalar",value:function(t,r){return new e(t).multiply(r)}},{key:"midpoint",value:function(t,r){return new e((t.x+r.x)/2,(t.y+r.y)/2)}},{key:"normals",value:function(t,r){var i=e.subtract(r,t);return[new e(-i.y,i.x),new e(i.y,-i.x)]}},{key:"divide",value:function(t,r){return r.x&&r.y?new e(t.x/r.x,t.y/r.y):new e(t.x/r,t.y/r)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"angle",value:function(t,r){var i=e.dot(t,r);return Math.acos(i/(t.length()*r.length()))}},{key:"scalarProjection",value:function(t,r){var i=r.normalized();return e.dot(t,i)}}]),e}(),Vertex=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,e),this.id=null,this.value=t,this.position=new Vector2(r?r:0,i?i:0),this.previousPosition=new Vector2(0,0),this.parentVertexId=null,this.children=[],this.spanningTreeChildren=[],this.edges=[],this.positioned=!1,this.angle=0,this.backAngle=0,this.flippable=!1,this.flipCenter=null,this.flipNeighbour=null,this.flipRings=new Array}return _createClass(e,[{key:"isTerminal",value:function(){return null===this.parentVertexId&&this.children.length<2||0===this.children.length}},{key:"clone",value:function t(){var t=new e(this.value,this.position.x,this.position.y);return t.id=this.id,t.previousPosition=new Vector2(this.previousPosition.x,this.previousPosition.y),t.parentVertexId=this.parentVertexId,t.children=ArrayHelper.clone(this.children),t.spanningTreeChildren=ArrayHelper.clone(this.spanningTreeChildren),t.edges=ArrayHelper.clone(this.edges),t.positioned=this.positioned,t.angle=this.angle,t.backAngle=this.backAngle,t.flippable=this.flippable,t.flipCenter=this.flipCenter,t.flipRings=ArrayHelper.clone(this.flipRings),t}},{key:"equals",value:function(e){return this.id===e.id}},{key:"getAngle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=null;return r=e?Vector2.subtract(this.position,e):Vector2.subtract(this.position,this.previousPosition),t?MathHelper.toDeg(r.angle()):r.angle()}},{key:"getTextDirection",value:function(e){for(var t=this.getNeighbours(),r=[],i=0;i<t.length;i++)r.push(this.getAngle(e[t[i]].position));var n=MathHelper.meanAngle(r),s=Math.PI/2;return n=Math.round(Math.round(n/s)*s,3),2==n?"down":n==-2?"up":0===n||n===-0?"right":3==n||n==-3?"left":"down"}},{key:"getNeighbours",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=[],r=0;r<this.children.length;r++)void 0!==e&&e==this.children[r]||t.push(this.children[r]);return null!=this.parentVertexId&&(void 0!==e&&e==this.parentVertexId||t.push(this.parentVertexId)),t}},{key:"getCommonNeighbours",value:function(e){for(var t=new Array,r=this.getNeighbours(),i=e.getNeighbours(),n=0;n<r.length;n++)for(var s=0;s<i.length;s++)r[n]===i[s]&&t.push(r[n]);return t}},{key:"isNeighbour",value:function(e){if(this.parentVertexId===e)return!0;for(var t=0;t<this.children.length;t++)if(this.children[t]===e)return!0}},{key:"getSpanningTreeNeighbours",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=[],r=0;r<this.spanningTreeChildren.length;r++)void 0!==e&&e==this.spanningTreeChildren[r]||t.push(this.spanningTreeChildren[r]);return null!=this.parentVertexId&&(void 0!==e&&e==this.parentVertexId||t.push(this.parentVertexId)),t}},{key:"getNextInRing",value:function(e,t,r){for(var i=this.getNeighbours(),n=0;n<i.length;n++)if(ArrayHelper.contains(e[i[n]].value.rings,{value:t})&&i[n]!=r)return i[n];return null}}]),e}();