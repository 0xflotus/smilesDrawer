"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,t){var r=[],i=!0,n=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(e){n=!0,s=e}finally{try{!i&&o.return&&o.return()}finally{if(n)throw s}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),SmilesDrawer={Version:"1.0.0"};SmilesDrawer.clean=function(e){return e.replace(/[^A-Za-z0-9@\.\+\-\?!\(\)\[\]\{\}\/\\=#\$:\*]/g,"")},SmilesDrawer.apply=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"canvas[data-smiles]",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"light",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=new SmilesDrawer.Drawer(e),s=document.querySelectorAll(t),a=0;a<s.length;a++)!function(){var e=s[a];SmilesDrawer.parse(e.getAttribute("data-smiles"),function(t){n.draw(t,e,r,!1)},function(e){i&&i(e)})}()},SmilesDrawer.parse=function(e,t,r){try{t&&t(SmilesDrawer.Parser.parse(e))}catch(e){r&&r(e)}},Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(e){if(null==this)throw new TypeError("this is null or not defined");for(var t=Object(this),r=t.length>>>0,i=arguments[1],n=i>>0,s=n<0?Math.max(r+n,0):Math.min(n,r),a=arguments[2],o=void 0===a?r:a>>0,l=o<0?Math.max(r+o,0):Math.min(o,r);s<l;)t[s]=e,s++;return t}}),SmilesDrawer.ArrayHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"clone",value:function(e){var t=Array.isArray(e)?[]:{};for(var r in e){var i=e[r];"function"==typeof i.clone?t[r]=i.clone():t[r]="object"===(void 0===i?"undefined":_typeof(i))?SmilesDrawer.ArrayHelper.clone(i):i}return t}},{key:"print",value:function(e){if(0==e.length)return"";for(var t="(",r=0;r<e.length;r++)t+=e[r].id?e[r].id+", ":e[r]+", ";return(t=t.substring(0,t.length-2))+")"}},{key:"each",value:function(e,t){for(var r=0;r<e.length;r++)t(e[r])}},{key:"get",value:function(e,t,r){for(var i=0;i<e.length;i++)if(e[i][t]==r)return e[i]}},{key:"contains",value:function(e,t){if(t.property||t.func){if(t.func){for(var r=0;r<e.length;r++)if(t.func(e[r]))return!0}else for(var i=0;i<e.length;i++)if(e[i][t.property]==t.value)return!0}else for(var n=0;n<e.length;n++)if(e[n]==t.value)return!0;return!1}},{key:"intersection",value:function(e,t){for(var r=new Array,i=0;i<e.length;i++)for(var n=0;n<t.length;n++)e[i]===t[n]&&r.push(e[i]);return r}},{key:"unique",value:function(e){var t={};return e.filter(function(e){return void 0===t[e]&&(t[e]=!0)})}},{key:"count",value:function(e,t){for(var r=0,i=0;i<e.length;i++)e[i]===t&&r++;return r}},{key:"toggle",value:function(e,t){for(var r=[],i=!1,n=0;n<e.length;n++)e[n]!==t?r.push(e[n]):i=!0;return i||r.push(t),r}},{key:"remove",value:function(e,t){for(var r=[],i=0;i<e.length;i++)e[i]!==t&&r.push(e[i]);return r}},{key:"removeUnique",value:function(e,t){var r=array.indexOf(t);return r>-1&&e.splice(r,1),e}},{key:"removeAll",value:function(e,t){return e.filter(function(e){return-1===t.indexOf(e)})}},{key:"merge",value:function(e,t){for(var r=new Array(e.length+t.length),i=0;i<e.length;i++)r[i]=e[i];for(var n=0;n<t.length;n++)r[e.length+n]=t[n];return r}},{key:"containsAll",value:function(e,t){for(var r=0,i=0;i<e.length;i++)for(var n=0;n<t.length;n++)e[i]===t[n]&&r++;return r===t.length}},{key:"sortByAtomicNumberDesc",value:function(e){var t=e.map(function(e,t){return{index:t,value:e.atomicNumber.split(".").map(Number)}});return t.sort(function(e,t){for(var r=Math.min(t.value.length,e.value.length),i=0;i<r&&t.value[i]===e.value[i];)i++;return i===r?t.value.length-e.value.length:t.value[i]-e.value[i]}),t.map(function(t){return e[t.index]})}},{key:"deepCopy",value:function(e){for(var t=[],r=0;r<e.length;r++){var i=e[r];i instanceof Array?t[r]=SmilesDrawer.ArrayHelper.deepCopy(i):t[r]=i}return t}}]),e}(),SmilesDrawer.Atom=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-";_classCallCheck(this,e),this.element=1===t.length?t.toUpperCase():t,this.drawExplicit=!1,this.ringbonds=[],this.rings=[],this.bondType=r,this.isBridge=!1,this.isBridgeNode=!1,this.originalRings=[],this.bridgedRing=null,this.anchoredRings=[],this.bracket=null,this.chiral=0,this.order={},this.attachedPseudoElements={},this.hasAttachedPseudoElements=!1,this.isDrawn=!0,this.isConnectedToRing=!1,this.neighbouringElements=[],this.isPartOfAromaticRing=t!==this.element,this.bondCount=0}return _createClass(e,[{key:"addNeighbouringElement",value:function(e){this.neighbouringElements.push(e)}},{key:"attachPseudoElement",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=r+e;this.attachedPseudoElements[i]?this.attachedPseudoElements[i].count+=1:this.attachedPseudoElements[i]={element:e,count:1,hydrogenCount:r,previousElement:t},this.hasAttachedPseudoElements=!0}},{key:"getAttachedPseudoElements",value:function(){var e={},t=this;return Object.keys(this.attachedPseudoElements).sort().forEach(function(r){e[r]=t.attachedPseudoElements[r]}),e}},{key:"getAttachedPseudoElementsCount",value:function(){return Object.keys(this.attachedPseudoElements).length}},{key:"addAnchoredRing",value:function(e){SmilesDrawer.ArrayHelper.contains(this.anchoredRings,{value:e})||this.anchoredRings.push(e)}},{key:"getRingbondCount",value:function(){return this.ringbonds.length}},{key:"canRotate",value:function(){return"-"===this.bondType&&0==this.rings.length}},{key:"hasRingbonds",value:function(){return this.ringbonds.length>0}},{key:"getMaxRingbond",value:function(){for(var e=0,t=0;t<this.ringbonds.length;t++)this.ringbonds[t].id>e&&(e=this.ringbonds[t].id);return e}},{key:"isInRing",value:function(){return this.rings.length>0}},{key:"hasRing",value:function(e){for(var t=0;t<this.rings;t++)if(e===this.rings[t])return!0;return!1}},{key:"backupRings",value:function(){this.originalRings=[];for(var e=0;e<this.rings.length;e++)this.originalRings.push(this.rings[e])}},{key:"restoreRings",value:function(){this.rings=[];for(var e=0;e<this.originalRings.length;e++)this.rings.push(this.originalRings[e])}},{key:"haveCommonRingbond",value:function(e,t){for(var r=0;r<e.ringbonds.length;r++)for(var i=0;i<t.ringbonds.length;i++)if(e.ringbonds[r].id==t.ringbonds[i].id)return!0;return!1}},{key:"maxCommonRingbond",value:function(e,t){for(var r=0,i=0,n=0,s=0;s<e.ringbonds.length;s++){e.ringbonds[s].id>i&&(i=e.ringbonds[s].id);for(var a=0;a<t.ringbonds.length;a++)t.ringbonds[a].id>n?n=t.ringbonds[a].id:i==n&&(r=i)}return r}},{key:"getOrder",value:function(e){return this.order[e]}},{key:"setOrder",value:function(e,t){this.order[e]=t}},{key:"neighbouringElementsEqual",value:function(e){if(e.length!==this.neighbouringElements.length)return!1;e.sort(),this.neighbouringElements.sort();for(var t=0;t<this.neighbouringElements.length;t++)if(e[t]!==this.neighbouringElements[t])return!1;return!0}},{key:"getAtomicNumber",value:function(){return e.atomicNumbers[this.element]}}],[{key:"sortByAtomicNumber",value:function(t,r){for(var i=new Array(t.length),n=0;n<t.length;n++){var s=r[t[n]],a=e.atomicNumbers[s.value.element];i[n]={atomicNumber:a.toString(),vertexId:s.id}}return SmilesDrawer.ArrayHelper.sortByAtomicNumberDesc(i)}},{key:"hasDuplicateAtomicNumbers",value:function(e){for(var t={},r=0;r<e.length;r++){var i=e[r];if(void 0!==t[i.atomicNumber])return!0;t[i.atomicNumber]=!0}return!1}},{key:"getDuplicateAtomicNumbers",value:function(e){for(var t={},r=[],i=0;i<e.length;i++){var n=e[i];void 0===t[n.atomicNumber]&&(t[n.atomicNumber]=[]),t[n.atomicNumber].push(i)}for(var s in t){var a=t[s];a.length>1&&r.push(a)}return r}}]),e}(),SmilesDrawer.Atom.maxBonds={C:4,N:3,O:2,P:3,S:2,B:3,F:1,I:1,Cl:1,Br:1},SmilesDrawer.Atom.atomicNumbers={H:1,He:2,Li:3,Be:4,B:5,b:5,C:6,c:6,N:7,n:7,O:8,o:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,p:15,S:16,s:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103,Rf:104,Db:105,Sg:106,Bh:107,Hs:108,Mt:109,Ds:110,Rg:111,Cn:112,Uut:113,Uuq:114,Uup:115,Uuh:116,Uus:117,Uuo:118},SmilesDrawer.Atom.mass={H:1,He:2,Li:3,Be:4,B:5,b:5,C:6,c:6,N:7,n:7,O:8,o:8,F:9,Ne:10,Na:11,Mg:12,Al:13,Si:14,P:15,p:15,S:16,s:16,Cl:17,Ar:18,K:19,Ca:20,Sc:21,Ti:22,V:23,Cr:24,Mn:25,Fe:26,Co:27,Ni:28,Cu:29,Zn:30,Ga:31,Ge:32,As:33,Se:34,Br:35,Kr:36,Rb:37,Sr:38,Y:39,Zr:40,Nb:41,Mo:42,Tc:43,Ru:44,Rh:45,Pd:46,Ag:47,Cd:48,In:49,Sn:50,Sb:51,Te:52,I:53,Xe:54,Cs:55,Ba:56,La:57,Ce:58,Pr:59,Nd:60,Pm:61,Sm:62,Eu:63,Gd:64,Tb:65,Dy:66,Ho:67,Er:68,Tm:69,Yb:70,Lu:71,Hf:72,Ta:73,W:74,Re:75,Os:76,Ir:77,Pt:78,Au:79,Hg:80,Tl:81,Pb:82,Bi:83,Po:84,At:85,Rn:86,Fr:87,Ra:88,Ac:89,Th:90,Pa:91,U:92,Np:93,Pu:94,Am:95,Cm:96,Bk:97,Cf:98,Es:99,Fm:100,Md:101,No:102,Lr:103,Rf:104,Db:105,Sg:106,Bh:107,Hs:108,Mt:109,Ds:110,Rg:111,Cn:112,Uut:113,Uuq:114,Uup:115,Uuh:116,Uus:117,Uuo:118},SmilesDrawer.CanvasWrapper=function(){function e(t,r,i){_classCallCheck(this,e),"string"==typeof t||t instanceof String?this.canvas=document.getElementById(t):this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.colors=r,this.opts=i,this.drawingWidth=0,this.drawingHeight=0,this.offsetX=0,this.offsetY=0,this.fontLarge=this.opts.fontSizeLarge+"pt Helvetica, Arial, sans-serif",this.fontSmall=this.opts.fontSizeSmall+"pt Helvetica, Arial, sans-serif",this.updateSize(this.opts.width,this.opts.height),this.clear()}return _createClass(e,[{key:"updateSize",value:function(e,t){this.devicePixelRatio=window.devicePixelRatio||1,this.backingStoreRatio=this.ctx.webkitBackingStorePixelRatio||this.ctx.mozBackingStorePixelRatio||this.ctx.msBackingStorePixelRatio||this.ctx.oBackingStorePixelRatio||this.ctx.backingStorePixelRatio||1,this.ratio=this.devicePixelRatio/this.backingStoreRatio,1!==this.ratio?(this.canvas.width=e*this.ratio,this.canvas.height=t*this.ratio,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.ctx.setTransform(this.ratio,0,0,this.ratio,0,0)):(this.canvas.width=e*this.ratio,this.canvas.height=t*this.ratio)}},{key:"setTheme",value:function(e){this.colors=e}},{key:"scale",value:function(e){for(var t=-Number.MAX_VALUE,r=-Number.MAX_VALUE,i=Number.MAX_VALUE,n=Number.MAX_VALUE,s=0;s<e.length;s++){var a=e[s].position;t<a.x&&(t=a.x),r<a.y&&(r=a.y),i>a.x&&(i=a.x),n>a.y&&(n=a.y)}t+=20,r+=20,i-=20,n-=20,this.drawingWidth=t-i,this.drawingHeight=r-n;var o=this.canvas.offsetWidth/this.drawingWidth,l=this.canvas.offsetHeight/this.drawingHeight,h=o<l?o:l;this.ctx.scale(h,h),this.offsetX=-i,this.offsetY=-n,o<l?this.offsetY+=this.canvas.offsetHeight/(2*h)-this.drawingHeight/2:this.offsetX+=this.canvas.offsetWidth/(2*h)-this.drawingWidth/2}},{key:"reset",value:function(){this.ctx.setTransform(1,0,0,1,0,0)}},{key:"getColor",value:function(e){return e=e.toUpperCase(),e in this.colors?this.colors[e]:this.colors.C}},{key:"drawCircle",value:function(e,t,r,i){var n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",o=this.ctx,l=this.offsetX,h=this.offsetY;o.save(),o.lineWidth=1.5,o.beginPath(),o.arc(e+l,t+h,r,0,SmilesDrawer.MathHelper.twoPI,!0),o.closePath(),s?(n?(o.fillStyle="#f00",o.fill()):(o.strokeStyle="#f00",o.stroke()),this.drawDebugText(e,t,a)):n?(o.fillStyle=i,o.fill()):(o.strokeStyle=i,o.stroke()),o.restore()}},{key:"drawLine",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var i=this.ctx,n=this.offsetX,s=this.offsetY,a=e.clone().shorten(6),o=a.getLeftVector().clone(),l=a.getRightVector().clone();o.x+=n,o.y+=s,l.x+=n,l.y+=s,t||(i.save(),i.globalCompositeOperation="destination-out",i.beginPath(),i.moveTo(o.x,o.y),i.lineTo(l.x,l.y),i.lineCap="round",i.lineWidth=2*this.opts.bondThickness,i.strokeStyle=this.getColor("BACKGROUND"),i.stroke(),i.globalCompositeOperation="source-over",i.restore()),o=e.getLeftVector().clone(),l=e.getRightVector().clone(),o.x+=n,o.y+=s,l.x+=n,l.y+=s,i.save(),i.beginPath(),i.moveTo(o.x,o.y),i.lineTo(l.x,l.y),i.lineCap="round",i.lineWidth=this.opts.bondThickness;var h=this.ctx.createLinearGradient(o.x,o.y,l.x,l.y);h.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),h.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),t&&i.setLineDash([1,1]),r<1&&(i.globalAlpha=r),i.strokeStyle=h,i.stroke(),i.restore()}}},{key:"drawWedge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var r=this.ctx,i=this.offsetX,n=this.offsetY,s=e.clone().shorten(8),a=s.getLeftVector().clone(),o=s.getRightVector().clone();a.x+=i,a.y+=n,o.x+=i,o.y+=n,a=e.getLeftVector().clone(),o=e.getRightVector().clone(),a.x+=i,a.y+=n,o.x+=i,o.y+=n,r.save();var l=SmilesDrawer.Vector2.normals(a,o);l[0].normalize(),l[1].normalize();var h=e.getRightChiral(),u=a,g=o;h&&(u=o,g=a);var c=SmilesDrawer.Vector2.add(u,SmilesDrawer.Vector2.multiplyScalar(l[0],.75)),v=SmilesDrawer.Vector2.add(g,SmilesDrawer.Vector2.multiplyScalar(l[0],t)),d=SmilesDrawer.Vector2.add(g,SmilesDrawer.Vector2.multiplyScalar(l[1],t)),f=SmilesDrawer.Vector2.add(u,SmilesDrawer.Vector2.multiplyScalar(l[1],.75));r.beginPath(),r.moveTo(c.x,c.y),r.lineTo(v.x,v.y),r.lineTo(d.x,d.y),r.lineTo(f.x,f.y);var p=this.ctx.createRadialGradient(o.x,o.y,this.opts.bondLength,o.x,o.y,0);p.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),p.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),r.fillStyle=p,r.fill(),r.restore()}}},{key:"drawDashedWedge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;if(!(isNaN(e.from.x)||isNaN(e.from.y)||isNaN(e.to.x)||isNaN(e.to.y))){var r=this.ctx,i=this.offsetX,n=this.offsetY,s=e.getLeftVector().clone(),a=e.getRightVector().clone();s.x+=i,s.y+=n,a.x+=i,a.y+=n,r.save();var o=SmilesDrawer.Vector2.normals(s,a);o[0].normalize(),o[1].normalize();var l=e.getRightChiral(),h=void 0,u=void 0,g=void 0,c=void 0,v=e.clone();l?(h=a,u=s,v.shortenRight(3),g=v.getRightVector().clone(),c=v.getLeftVector().clone()):(h=s,u=a,v.shortenLeft(3),g=v.getLeftVector().clone(),c=v.getRightVector().clone()),g.x+=i,g.y+=n,c.x+=i,c.y+=n;var d=SmilesDrawer.Vector2.add(h,SmilesDrawer.Vector2.multiplyScalar(o[0],.75)),f=SmilesDrawer.Vector2.add(u,SmilesDrawer.Vector2.multiplyScalar(o[0],t/2)),p=SmilesDrawer.Vector2.add(u,SmilesDrawer.Vector2.multiplyScalar(o[1],t/2)),m=SmilesDrawer.Vector2.add(h,SmilesDrawer.Vector2.multiplyScalar(o[1],.75));r.beginPath(),r.moveTo(d.x,d.y),r.lineTo(f.x,f.y),r.lineTo(p.x,p.y),r.lineTo(m.x,m.y);var y=this.ctx.createRadialGradient(a.x,a.y,this.bondLength,a.x,a.y,0);y.addColorStop(.4,this.getColor(e.getLeftElement())||this.getColor("C")),y.addColorStop(.6,this.getColor(e.getRightElement())||this.getColor("C")),r.fillStyle=y,r.fill(),r.globalCompositeOperation="destination-out",r.beginPath(),r.moveTo(g.x,g.y),r.lineTo(c.x,c.y),r.lineCap="butt",r.lineWidth=t,r.setLineDash([1,1]),r.strokeStyle=this.getColor("BACKGROUND"),r.stroke(),r.globalCompositeOperation="source-over",r.restore()}}},{key:"drawDebugText",value:function(e,t,r){var i=this.ctx;i.save(),i.font="5px Droid Sans, sans-serif",i.textAlign="start",i.textBaseline="top",i.fillStyle="#ff0000",i.fillText(r,e+this.offsetX,t+this.offsetY),i.restore()}},{key:"drawBall",value:function(e,t,r){var i=this.ctx;i.save(),i.beginPath(),i.arc(e+this.offsetX,t+this.offsetY,this.opts.bondLength/4.5,0,SmilesDrawer.MathHelper.twoPI,!1),i.fillStyle=this.getColor(r),i.fill(),i.restore()}},{key:"drawPoint",value:function(e,t,r){var i=this.ctx,n=this.offsetX,s=this.offsetY;i.save(),i.globalCompositeOperation="destination-out",i.beginPath(),i.arc(e+n,t+s,1.5,0,SmilesDrawer.MathHelper.twoPI,!0),i.closePath(),i.fill(),i.globalCompositeOperation="source-over",i.beginPath(),i.arc(e+this.offsetX,t+this.offsetY,.75,0,SmilesDrawer.MathHelper.twoPI,!1),i.fillStyle=this.getColor(r),i.fill(),i.restore()}},{key:"drawText",value:function(e,t,r,i,n,s,a,o){var l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{},h=this.ctx,u=this.offsetX,g=this.offsetY;h.save();var c=this.opts.fontSizeLarge;this.opts.fontSizeSmall;h.textAlign="start",h.textBaseline="alphabetic";var v="+",d=0;a&&(2===a?v="2+":-1===a?v="-":-2===a&&(v="2-"),h.font=this.fontSmall,d=h.measureText(v).width);var f="0",p=0;o>0&&(f=o,h.font=this.fontSmall,p=h.measureText(f).width),h.font=this.fontLarge,h.fillStyle=this.getColor("BACKGROUND");var m=h.measureText(r);m.totalWidth=m.width+d,m.height=parseInt(this.fontLarge,10);var y=m.width>c?m.width:this.opts.fontSizeLarge;y/=1.25,h.globalCompositeOperation="destination-out",h.beginPath(),h.arc(e+u,t+g,y,0,SmilesDrawer.MathHelper.twoPI,!0),h.closePath(),h.fill(),h.globalCompositeOperation="source-over";var S=-m.width/2,b=-m.width/2;h.fillStyle=this.getColor(r),h.fillText(r,e+u+S,t+this.opts.fontSizeLarge/2+g),S+=m.width,a&&(h.font=this.fontSmall,h.fillText(v,e+u+S,t-this.opts.fontSizeSmall/5+g),S+=d),o>0&&(h.font=this.fontSmall,h.fillText(f,e+u+b-p,t-this.opts.fontSizeSmall/5+g),b-=p),h.font=this.fontLarge;var w=0,A=0;if(1===i){var C=e+u,x=t+g+c/2;w=h.measureText("H").width,b-=w,"left"===n?C+=b:"right"===n?C+=S:"up"===n&&s?C+=S:"down"===n&&s?C+=S:"up"!==n||s?"down"!==n||s||(x+=this.opts.fontSizeLarge+this.opts.fontSizeLarge/4,C-=w/2):(x-=this.opts.fontSizeLarge+this.opts.fontSizeLarge/4,C-=w/2),h.fillText("H",C,x),S+=w}else if(i>1){var D=e+u,k=t+g+c/2;w=h.measureText("H").width,h.font=this.fontSmall,A=h.measureText(i).width,b-=w+A,"left"===n?D+=b:"right"===n?D+=S:"up"===n&&s?D+=S:"down"===n&&s?D+=S:"up"!==n||s?"down"!==n||s||(k+=this.opts.fontSizeLarge+this.opts.fontSizeLarge/4,D-=w/2):(k-=this.opts.fontSizeLarge+this.opts.fontSizeLarge/4,D-=w/2),h.font=this.fontLarge,h.fillText("H",D,k),h.font=this.fontSmall,h.fillText(i,D+w/2+A,k+this.opts.fontSizeSmall/5),S+=w+w/2+A}for(var R in l)if(l.hasOwnProperty(R)){var V=0,T=0,I=l[R].element,N=l[R].count,P=l[R].hydrogenCount;h.font=this.fontLarge,N>1&&P>0&&(V=h.measureText("(").width,T=h.measureText(")").width);var L=h.measureText(I).width,M=0;w=0,P>0&&(w=h.measureText("H").width),h.font=this.fontSmall,N>1&&(M=h.measureText(N).width),A=0,P>1&&(A=h.measureText(P).width),h.font=this.fontLarge;var B=e+u,H=t+g+c/2;h.fillStyle=this.getColor(I),N>0&&(b-=M),N>1&&P>0&&("left"===n?(b-=T,h.fillText(")",B+b,H)):(h.fillText("(",B+S,H),S+=V)),"left"===n?(b-=L,h.fillText(I,B+b,H)):(h.fillText(I,B+S,H),S+=L),P>0&&("left"===n?(b-=w+A,h.fillText("H",B+b,H),P>1&&(h.font=this.fontSmall,h.fillText(P,B+b+w,H+this.opts.fontSizeSmall/5))):(h.fillText("H",B+S,H),S+=w,P>1&&(h.font=this.fontSmall,h.fillText(P,B+S,H+this.opts.fontSizeSmall/5),S+=A))),h.font=this.fontLarge,N>1&&P>0&&("left"===n?(b-=V,h.fillText("(",B+b,H)):(h.fillText(")",B+S,H),S+=T)),h.font=this.fontSmall,N>1&&("left"===n?h.fillText(N,B+b+V+T+w+A+L,H+this.opts.fontSizeSmall/5):(h.fillText(N,B+S,H+this.opts.fontSizeSmall/5),S+=M))}h.restore()}},{key:"drawDebugPoint",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#f00";this.drawCircle(e,t,2,i,!0,!0,r)}},{key:"drawAromaticityRing",value:function(e){var t=this.ctx,r=SmilesDrawer.MathHelper.apothemFromSideLength(this.opts.bondLength,e.getSize());t.save(),t.strokeStyle=this.getColor("C"),t.lineWidth=this.opts.bondThickness,t.beginPath(),t.arc(e.center.x+this.offsetX,e.center.y+this.offsetY,r-this.opts.bondSpacing,0,2*Math.PI,!0),t.closePath(),t.stroke(),t.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight)}}]),e}(),SmilesDrawer.Drawer=function(){function e(t){_classCallCheck(this,e),this.graph=null,this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.canvasWrapper=null,this.totalOverlapScore=0,this.defaultOptions={width:500,height:500,bondThickness:.6,bondLength:14.4,shortBondLength:12.24,bondSpacing:2.592,atomVisualization:"default",isomeric:!1,debug:!1,terminalCarbons:!1,explicitHydrogens:!1,compactDrawing:!0,fontSizeLarge:6,fontSizeSmall:4,themes:{dark:{C:"#fff",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",H:"#fff",BACKGROUND:"#141414"},light:{C:"#222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",H:"#222",BACKGROUND:"#fff"}}},this.opts=this.extend(!0,this.defaultOptions,t),this.theme=this.opts.themes.dark}return _createClass(e,[{key:"extend",value:function(){var e=this,t={},r=!1,i=0,n=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(r=arguments[0],i++);for(;i<n;i++){var s=arguments[i];!function(i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r&&"[object Object]"===Object.prototype.toString.call(i[n])?t[n]=e.extend(!0,t[n],i[n]):t[n]=i[n])}(s)}return t}},{key:"draw",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"light",i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.data=e,this.canvasWrapper=new SmilesDrawer.CanvasWrapper(t,this.opts.themes[r],this.opts),this.infoOnly=i,this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.graph=new SmilesDrawer.Graph(e,this.opts.isomeric),this.rings=[],this.ringConnections=[],this.originalRings=[],this.originalRingConnections=[],this.bridgedRing=!1,this.initRings(),!this.explicitHydrogens)for(var n=0;n<this.graph.vertices.length;n++)"H"===this.graph.vertices[n].value.element&&(this.graph.vertices[n].value.isDrawn=!1);if(this.opts.isomeric&&this.annotateChirality(),!this.infoOnly){this.position(),this.restoreRingInformation(),this.resolvePrimaryOverlaps();var s=this.getOverlapScore();this.totalOverlapScore=this.getOverlapScore().total;for(var n=0;n<this.graph.edges.length;n++){var a=this.graph.edges[n];if(this.isEdgeRotatable(a)){var o=this.getTreeDepth(a.sourceId,a.targetId),l=this.getTreeDepth(a.targetId,a.sourceId),h=a.targetId,u=a.sourceId;o>l&&(h=a.sourceId,u=a.targetId);if(this.getSubtreeOverlapScore(u,h,s.vertexScores).value>1){var g=this.graph.vertices[h],c=this.graph.vertices[u],v=c.getNeighbours(h);if(1===v.length){var d=this.graph.vertices[v[0]],f=d.position.getRotateAwayFromAngle(g.position,c.position,SmilesDrawer.MathHelper.toRad(120));this.rotateSubtree(d.id,c.id,f,c.position);var p=this.getOverlapScore().total;p>this.totalOverlapScore?this.rotateSubtree(d.id,c.id,-f,c.position):this.totalOverlapScore=p}else if(2==v.length){if(c.value.rings.length+g.value.rings.length>0)continue;var m=this.graph.vertices[v[0]],y=this.graph.vertices[v[1]],S=m.position.getRotateAwayFromAngle(g.position,c.position,SmilesDrawer.MathHelper.toRad(120)),b=y.position.getRotateAwayFromAngle(g.position,c.position,SmilesDrawer.MathHelper.toRad(120));this.rotateSubtree(m.id,c.id,S,c.position),this.rotateSubtree(y.id,c.id,b,c.position);var w=this.getOverlapScore().total;w>this.totalOverlapScore?(this.rotateSubtree(m.id,c.id,-S,c.position),this.rotateSubtree(y.id,c.id,-b,c.position)):this.totalOverlapScore=w}s=this.getOverlapScore()}}}this.resolveSecondaryOverlaps(s.scores),this.canvasWrapper.scale(this.graph.vertices),this.opts.compactDrawing&&"default"===this.opts.atomVisualization&&this.initPseudoElements(),this.drawEdges(this.opts.debug),this.drawVertices(this.opts.debug),this.canvasWrapper.reset()}}},{key:"edgeRingCount",value:function(e){var t=this.graph.edges[e],r=this.graph.vertices[t.sourceId],i=this.graph.vertices[t.targetId];return Math.min(r.value.rings.length,i.value.rings.length)}},{key:"getBridgedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isBridged&&e.push(this.rings[t]);return e}},{key:"getFusedRings",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isFused&&e.push(this.rings[t]);return e}},{key:"getSpiros",value:function(){for(var e=[],t=0;t<this.rings.length;t++)this.rings[t].isSpiro&&e.push(this.rings[t]);return e}},{key:"printRingInfo",value:function(){for(var e="",t=0;t<this.rings.length;t++){var r=this.rings[t];e+=r.id+";",e+=r.members.length+";",e+=r.neighbours.length+";",e+=r.isSpiro?"true;":"false;",e+=r.isFused?"true;":"false;",e+=r.isBridged?"true;":"false;",e+=r.rings.length+";",e+="\n"}return e}},{key:"getTotalOverlapScore",value:function(){return this.totalOverlapScore}},{key:"getRingCount",value:function(){return this.rings.length}},{key:"hasBridgedRing",value:function(){return this.bridgedRing}},{key:"getHeavyAtomCount",value:function(){for(var e=0,t=0;t<this.graph.vertices.length;t++)"H"!==this.graph.vertices[t].value.element&&e++;return e}},{key:"getRingbondType",value:function(e,t){if(e.value.getRingbondCount()<1||t.value.getRingbondCount()<1)return null;for(var r=0;r<e.value.ringbonds.length;r++)for(var i=0;i<t.value.ringbonds.length;i++)if(e.value.ringbonds[r].id===t.value.ringbonds[i].id)return"-"===e.value.ringbonds[r].bondType?t.value.ringbonds[i].bond:e.value.ringbonds[r].bond;return null}},{key:"initRings",value:function(){for(var e=new Map,t=this.graph.vertices.length-1;t>=0;t--){var r=this.graph.vertices[t];if(0!==r.value.ringbonds.length)for(var i=0;i<r.value.ringbonds.length;i++){var n=r.value.ringbonds[i].id;if(e.has(n)){var s=r.id,a=e.get(n),o=this.graph.addEdge(new SmilesDrawer.Edge(s,a,1)),l=this.graph.vertices[a];r.addChild(a),r.value.addNeighbouringElement(l.value.element),l.addChild(s),l.value.addNeighbouringElement(r.value.element),r.edges.push(o),l.edges.push(o),e.delete(n)}else e.set(n,r.id)}}var h=SmilesDrawer.SSSR.getRings(this.graph);if(null!==h){for(var t=0;t<h.length;t++)for(var u=[].concat(_toConsumableArray(h[t])),g=this.addRing(new SmilesDrawer.Ring(u)),i=0;i<u.length;i++)this.graph.vertices[u[i]].value.rings.push(g);for(var t=0;t<this.rings.length-1;t++)for(var i=t+1;i<this.rings.length;i++){var c=this.rings[t],v=this.rings[i],d=new SmilesDrawer.RingConnection(c,v);d.vertices.size>0&&this.addRingConnection(d)}for(var t=0;t<this.rings.length;t++){var f=this.rings[t];f.neighbours=SmilesDrawer.RingConnection.getNeighbours(this.ringConnections,f.id)}for(var t=0;t<this.rings.length;t++){var p=this.rings[t];this.graph.vertices[p.members[0]].value.addAnchoredRing(p.id)}for(this.backupRingInformation();this.rings.length>0;){for(var m=-1,t=0;t<this.rings.length;t++){var y=this.rings[t];this.isPartOfBridgedRing(y.id)&&!y.isBridged&&(m=y.id)}if(-1===m)break;var S=this.getRing(m),b=this.getBridgedRingRings(S.id);this.bridgedRing=!0,this.createBridgedRing(b,S.members[0]);for(var t=0;t<b.length;t++)this.removeRing(b[t])}}}},{key:"getBridgedRingRings",value:function(e){var t=[],r=this;return function e(i){var n=r.getRing(i);t.push(i);for(var s=0;s<n.neighbours.length;s++){var a=n.neighbours[s];-1===t.indexOf(a)&&a!==i&&SmilesDrawer.RingConnection.isBridge(r.ringConnections,r.graph.vertices,i,a)&&e(a)}}(e),SmilesDrawer.ArrayHelper.unique(t)}},{key:"isPartOfBridgedRing",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].containsRing(e)&&this.ringConnections[t].isBridge(this.graph.vertices))return!0;return!1}},{key:"createBridgedRing",value:function(e,t){for(var r=[],i=[],n=[],s=0;s<e.length;s++){var a=this.getRing(e[s]);a.isPartOfBridged=!0;for(var o=0;o<a.members.length;o++)i.push(a.members[o]);for(var o=0;o<a.neighbours.length;o++)n.push(a.neighbours[o])}i=SmilesDrawer.ArrayHelper.unique(i);for(var l=[],s=0;s<i.length;s++){var h=this.graph.vertices[i[s]],u=SmilesDrawer.ArrayHelper.intersection(e,h.value.rings);1===h.value.rings.length||1===u.length?r.push(h.id):l.push(h.id)}for(var g=[],c=[],s=0;s<l.length;s++){for(var v=this.graph.vertices[l[s]],d=!1,f=0;f<v.edges.length;f++)1===this.edgeRingCount(v.edges[f])&&(d=!0);d?(v.value.isBridgeNode=!0,g.push(v.id)):(v.value.isBridge=!0,c.push(v.id))}var p=SmilesDrawer.ArrayHelper.merge(r,g);p=SmilesDrawer.ArrayHelper.merge(p,c),n=SmilesDrawer.ArrayHelper.unique(n),n=SmilesDrawer.ArrayHelper.removeAll(n,e);var m=new SmilesDrawer.Ring(p);m.isBridged=!0,m.neighbours=n;for(var s=0;s<e.length;s++)m.rings.push(this.getRing(e[s]).clone());this.addRing(m);for(var s=0;s<m.members.length;s++)this.graph.vertices[m.members[s]].value.bridgedRing=m.id;for(var s=0;s<c.length;s++){this.graph.vertices[c[s]].value.rings=[]}for(var s=0;s<p.length;s++){var y=this.graph.vertices[p[s]];y.value.rings=SmilesDrawer.ArrayHelper.removeAll(y.value.rings,e),y.value.rings.push(m.id)}for(var s=0;s<e.length;s++)for(var o=s+1;o<e.length;o++)this.removeRingConnectionsBetween(e[s],e[o]);for(var s=0;s<n.length;s++){for(var S=this.getRingConnections(n[s],e),o=0;o<S.length;o++)this.getRingConnection(S[o]).updateOther(m.id,n[s]);this.getRing(n[s]).neighbours.push(m.id)}return m}},{key:"areVerticesInSameRing",value:function(e,t){for(var r=0;r<e.value.rings.length;r++)for(var i=0;i<t.value.rings.length;i++)if(e.value.rings[r]===t.value.rings[i])return!0;return!1}},{key:"getCommonRings",value:function(e,t){for(var r=[],i=0;i<e.value.rings.length;i++)for(var n=0;n<t.value.rings.length;n++)e.value.rings[i]==t.value.rings[n]&&r.push(e.value.rings[i]);return r}},{key:"getSmallestCommonRing",value:function(e,t){for(var r=this.getCommonRings(e,t),i=Number.MAX_VALUE,n=null,s=0;s<r.length;s++){var a=this.getRing(r[s]).getSize();a<i&&(i=a,n=this.getRing(r[s]))}return n}},{key:"getLargestOrAromaticCommonRing",value:function(e,t){for(var r=this.getCommonRings(e,t),i=0,n=null,s=0;s<r.length;s++){var a=this.getRing(r[s]),o=a.getSize();if(a.isBenzeneLike(this.graph.vertices))return a;o>i&&(i=o,n=a)}return n}},{key:"getVerticesAt",value:function(e,t,r){for(var i=[],n=0;n<this.graph.vertices.length;n++){var s=this.graph.vertices[n];if(s.id!==r&&s.positioned){e.distance(s.position)<=t&&i.push(s.id)}}return i}},{key:"getClosestVertex",value:function(e){for(var t=99999,r=null,i=0;i<this.graph.vertices.length;i++){var n=this.graph.vertices[i];if(n.id!==e.id){var s=e.position.distanceSq(n.position);s<t&&(t=s,r=n)}}return r}},{key:"getClosestEndpointVertex",value:function(e){for(var t=99999,r=null,i=0;i<this.graph.vertices.length;i++){var n=this.graph.vertices[i];if(!(n.id===e.id||n.getNeighbourCount()>1)){var s=e.position.distanceSq(n.position);s<t&&(t=s,r=n)}}return r}},{key:"addRing",value:function(e){return e.id=this.ringIdCounter++,this.rings.push(e),e.id}},{key:"removeRing",value:function(e){this.rings=this.rings.filter(function(t){return t.id!==e}),this.ringConnections=this.ringConnections.filter(function(t){return t.firstRingId!==e&&t.secondRingId!==e});for(var t=0;t<this.rings.length;t++){var r=this.rings[t];r.neighbours=r.neighbours.filter(function(t){return t!==e})}}},{key:"getRing",value:function(e){
for(var t=0;t<this.rings.length;t++)if(this.rings[t].id==e)return this.rings[t]}},{key:"addRingConnection",value:function(e){return e.id=this.ringConnectionIdCounter++,this.ringConnections.push(e),e.id}},{key:"removeRingConnection",value:function(e){this.ringConnections=this.ringConnections.filter(function(t){return t.id!==e})}},{key:"removeRingConnectionsBetween",value:function(e,t){for(var r=[],i=0;i<this.ringConnections.length;i++){var n=this.ringConnections[i];(n.firstRingId===e&&n.secondRingId===t||n.firstRingId===t&&n.secondRingId===e)&&r.push(n.id)}for(var i=0;i<r.length;i++)this.removeRingConnection(r[i])}},{key:"getRingConnection",value:function(e){for(var t=0;t<this.ringConnections.length;t++)if(this.ringConnections[t].id==e)return this.ringConnections[t]}},{key:"getRingConnections",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=[];if(null===t)for(var i=0;i<this.ringConnections.length;i++){var n=this.ringConnections[i];n.firstRingId!==e&&n.secondRingId!==e||r.push(n.id)}else if(t.constructor!==Array)for(var i=0;i<this.ringConnections.length;i++){var s=this.ringConnections[i];(s.firstRingId===e&&s.secondRingId===t||s.firstRingId===t&&s.secondRingId===e)&&r.push(s.id)}else for(var i=0;i<this.ringConnections.length;i++)for(var a=0;a<t.length;a++){var o=t[a],l=this.ringConnections[i];(l.firstRingId===e&&l.secondRingId===o||l.firstRingId===o&&l.secondRingId===e)&&r.push(l.id)}return r}},{key:"isRingConnection",value:function(e,t){for(var r=0;r<this.ringConnections.length;r++){var i=this.ringConnections[r];if(2===i.vertices.size&&(i.vertices.has(e)&&i.vertices.has(t)))return!0}return!1}},{key:"getOverlapScore",value:function(){for(var e=0,t=new Float32Array(this.graph.vertices.length),r=0;r<this.graph.vertices.length;r++)t[r]=0;for(var r=0;r<this.graph.vertices.length;r++)for(var i=r+1;i<this.graph.vertices.length;i++){var n=this.graph.vertices[r],s=this.graph.vertices[i],a=SmilesDrawer.Vector2.subtract(n.position,s.position).length();if(a<this.opts.bondLength){var o=(this.opts.bondLength-a)/this.opts.bondLength;e+=o,t[r]+=o,t[i]+=o}}for(var l=[],r=0;r<this.graph.vertices.length;r++)l.push({id:r,score:t[r]});return l.sort(function(e,t){return t.score-e.score}),{total:e,scores:l,vertexScores:t}}},{key:"chooseSide",value:function(e,t,r){for(var i=e.getNeighbours(t.id),n=t.getNeighbours(e.id),s=i.length,a=n.length,o=SmilesDrawer.ArrayHelper.merge(i,n),l=[0,0],h=0;h<o.length;h++){this.graph.vertices[o[h]].position.sameSideAs(e.position,t.position,r[0])?l[0]++:l[1]++}for(var u=[0,0],h=0;h<this.graph.vertices.length;h++){this.graph.vertices[h].position.sameSideAs(e.position,t.position,r[0])?u[0]++:u[1]++}return{totalSideCount:u,totalPosition:u[0]>u[1]?0:1,sideCount:l,position:l[0]>l[1]?0:1,anCount:s,bnCount:a}}},{key:"areConnected",value:function(e,t){for(var r=0;r<this.graph.edges.length;r++){var i=this.graph.edges[r];if(i.sourceId===e&&i.targetId===t||i.sourceId===t&&i.targetId===e)return!0}return!1}},{key:"getEdgeWeight",value:function(e,t){for(var r=0;r<this.graph.edges.length;r++){var i=this.graph.edges[r];if(i.sourceId==e&&i.targetId==t||i.targetId==e&&i.sourceId==t)return i.weight}return null}},{key:"setRingCenter",value:function(e){for(var t=e.getSize(),r=new SmilesDrawer.Vector2,i=0;i<t;i++)r.add(this.graph.vertices[e.members[i]].position);e.center=r.divide(t)}},{key:"getSubringCenter",value:function(e,t){for(var r=t.value.originalRings,i=e.center,n=Number.MAX_VALUE,s=0;s<r.length;s++)for(var a=0;a<e.rings.length;a++)r[s]===e.rings[a].id&&e.rings[a].getSize()<n&&(i=e.rings[a].center,n=e.rings[a].getSize());return i}},{key:"drawEdges",value:function(e){var t=this,r=Array(this.graph.edges.length);if(r.fill(!1),this.graph.traverseBF(0,function(i){for(var n=t.graph.getEdges(i.id),s=0;s<n.length;s++){var a=n[s];r[a]||(r[a]=!0,t.drawEdge(a,e))}}),!this.bridgedRing)for(var i=0;i<this.rings.length;i++){var n=this.rings[i];this.isRingAromatic(n)&&this.canvasWrapper.drawAromaticityRing(n)}}},{key:"drawEdge",value:function(e,t){var r=this,i=this.graph.edges[e],n=this.graph.vertices[i.sourceId],s=this.graph.vertices[i.targetId],a=n.value.element,o=s.value.element;if(n.value.isDrawn&&s.value.isDrawn||"default"!==this.opts.atomVisualization){var l=n.position,h=s.position,u=this.getEdgeNormals(i),g=SmilesDrawer.ArrayHelper.clone(u);if(g[0].multiplyScalar(10).add(l),g[1].multiplyScalar(10).add(l),"="===i.bondType||"="===this.getRingbondType(n,s)||i.isPartOfAromaticRing&&this.bridgedRing){var c=this.areVerticesInSameRing(n,s),v=this.chooseSide(n,s,g);if(c){var d=this.getLargestOrAromaticCommonRing(n,s),f=d.center;SmilesDrawer.ArrayHelper.each(u,function(e){e.multiplyScalar(r.opts.bondSpacing)});var p=null;p=f.sameSideAs(n.position,s.position,SmilesDrawer.Vector2.add(l,u[0]))?new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[0]),SmilesDrawer.Vector2.add(h,u[0]),a,o):new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[1]),SmilesDrawer.Vector2.add(h,u[1]),a,o),p.shorten(this.opts.bondLength-this.opts.shortBondLength),i.isPartOfAromaticRing?this.canvasWrapper.drawLine(p,!0,.25):this.canvasWrapper.drawLine(p),this.canvasWrapper.drawLine(new SmilesDrawer.Line(l,h,a,o))}else if(i.center){SmilesDrawer.ArrayHelper.each(u,function(e){e.multiplyScalar(r.opts.bondSpacing/2)});var m=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[0]),SmilesDrawer.Vector2.add(h,u[0]),a,o),y=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[1]),SmilesDrawer.Vector2.add(h,u[1]),a,o);this.canvasWrapper.drawLine(m),this.canvasWrapper.drawLine(y)}else if(0==v.anCount&&v.bnCount>1||0==v.bnCount&&v.anCount>1){SmilesDrawer.ArrayHelper.each(u,function(e){e.multiplyScalar(r.opts.bondSpacing/2)});var S=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[0]),SmilesDrawer.Vector2.add(h,u[0]),a,o),b=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[1]),SmilesDrawer.Vector2.add(h,u[1]),a,o);this.canvasWrapper.drawLine(S),this.canvasWrapper.drawLine(b)}else if(v.sideCount[0]>v.sideCount[1]){SmilesDrawer.ArrayHelper.each(u,function(e){e.multiplyScalar(r.opts.bondSpacing)});var w=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[0]),SmilesDrawer.Vector2.add(h,u[0]),a,o);w.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(w),this.canvasWrapper.drawLine(new SmilesDrawer.Line(l,h,a,o))}else if(v.sideCount[0]<v.sideCount[1]){SmilesDrawer.ArrayHelper.each(u,function(e){e.multiplyScalar(r.opts.bondSpacing)});var A=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[1]),SmilesDrawer.Vector2.add(h,u[1]),a,o);A.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(A),this.canvasWrapper.drawLine(new SmilesDrawer.Line(l,h,a,o))}else if(v.totalSideCount[0]>v.totalSideCount[1]){SmilesDrawer.ArrayHelper.each(u,function(e){e.multiplyScalar(r.opts.bondSpacing)});var C=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[0]),SmilesDrawer.Vector2.add(h,u[0]),a,o);C.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(C),this.canvasWrapper.drawLine(new SmilesDrawer.Line(l,h,a,o))}else if(v.totalSideCount[0]<=v.totalSideCount[1]){SmilesDrawer.ArrayHelper.each(u,function(e){e.multiplyScalar(r.opts.bondSpacing)});var x=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[1]),SmilesDrawer.Vector2.add(h,u[1]),a,o);x.shorten(this.opts.bondLength-this.opts.shortBondLength),this.canvasWrapper.drawLine(x),this.canvasWrapper.drawLine(new SmilesDrawer.Line(l,h,a,o))}}else if("#"===i.bondType){SmilesDrawer.ArrayHelper.each(u,function(e){e.multiplyScalar(r.opts.bondSpacing/1.5)});var D=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[0]),SmilesDrawer.Vector2.add(h,u[0]),a,o),k=new SmilesDrawer.Line(SmilesDrawer.Vector2.add(l,u[1]),SmilesDrawer.Vector2.add(h,u[1]),a,o);this.canvasWrapper.drawLine(D),this.canvasWrapper.drawLine(k),this.canvasWrapper.drawLine(new SmilesDrawer.Line(l,h,a,o))}else if("."===i.bondType);else{var R=n.value.bracket&&n.value.bracket.chirality,V=s.value.bracket&&s.value.bracket.chirality;"up"===i.chiral?this.canvasWrapper.drawWedge(new SmilesDrawer.Line(l,h,a,o,R,V)):"down"===i.chiral?this.canvasWrapper.drawDashedWedge(new SmilesDrawer.Line(l,h,a,o,R,V)):this.canvasWrapper.drawLine(new SmilesDrawer.Line(l,h,a,o,R,V))}if(t){var T=SmilesDrawer.Vector2.midpoint(l,h);this.canvasWrapper.drawDebugText(T.x,T.y,"e: "+e)}}}},{key:"drawVertices",value:function(e){for(var t=0;t<this.graph.vertices.length;t++){var r=this.graph.vertices[t],i=r.value,n=0,s=0,a=this.getBondCount(r),o=i.element,l=SmilesDrawer.Atom.maxBonds[o]-a,h=r.getTextDirection(this.graph.vertices),u=!(!this.opts.terminalCarbons&&"C"===o&&!i.hasAttachedPseudoElements)&&r.isTerminal(),g="C"===i.element;if(i.bracket&&(l=i.bracket.hcount,n=i.bracket.charge,s=i.bracket.isotope),"allballs"===this.opts.atomVisualization)this.canvasWrapper.drawBall(r.position.x,r.position.y,o);else if(i.isDrawn&&(!g||i.drawExplicit||u||i.hasAttachedPseudoElements))"default"===this.opts.atomVisualization?this.canvasWrapper.drawText(r.position.x,r.position.y,o,l,h,u,n,s,i.getAttachedPseudoElements()):"balls"===this.opts.atomVisualization&&this.canvasWrapper.drawBall(r.position.x,r.position.y,o);else if(2===r.getNeighbourCount()){var c=this.graph.vertices[r.neighbours[0]].position,v=this.graph.vertices[r.neighbours[1]].position,d=SmilesDrawer.Vector2.threePointangle(r.position,c,v);Math.abs(Math.PI-d)<.1&&this.canvasWrapper.drawPoint(r.position.x,r.position.y,o)}if(e){var f="v: "+r.id+" "+SmilesDrawer.ArrayHelper.print(i.ringbonds);this.canvasWrapper.drawDebugText(r.position.x,r.position.y,f)}}if(this.opts.debug)for(var t=0;t<this.rings.length;t++){var p=this.rings[t].center;this.canvasWrapper.drawDebugPoint(p.x,p.y,"r: "+this.rings[t].id)}}},{key:"position",value:function(){for(var e=null,t=0;t<this.graph.vertices.length;t++)if(null!==this.graph.vertices[t].value.bridgedRing){e=this.graph.vertices[t];break}for(var t=0;t<this.rings.length;t++)this.rings[t].isBridged&&(e=this.graph.vertices[this.rings[t].members[0]]);this.rings.length>0&&null===e&&(e=this.graph.vertices[this.rings[0].members[0]]),null===e&&(e=this.graph.vertices[0]),this.createNextBond(e)}},{key:"clearPositions",value:function(){this.vertexPositionsBackup=[],this.ringPositionsBackup=[];for(var e=0;e<this.graph.vertices.length;e++){var t=this.graph.vertices[e];this.vertexPositionsBackup.push(t.position.clone()),t.positioned=!1,t.setPositionFromVector(new SmilesDrawer.Vector2)}for(var e=0;e<this.rings.length;e++){var r=this.rings[e];this.ringPositionsBackup.push(r.center.clone()),r.positioned=!1,r.center=new SmilesDrawer.Vector2}}},{key:"restorePositions",value:function(){for(var e=0;e<this.vertexPositionsBackup.length;e++)this.graph.vertices[e].setPositionFromVector(this.vertexPositionsBackup[e]),this.graph.vertices[e].positioned=!0;for(var e=0;e<this.ringPositionsBackup.length;e++)this.rings[e].center=this.ringPositionsBackup[e],this.rings[e].positioned=!0}},{key:"backupRingInformation",value:function(){this.originalRings=[],this.originalRingConnections=[];for(var e=0;e<this.rings.length;e++)this.originalRings.push(this.rings[e]);for(var e=0;e<this.ringConnections.length;e++)this.originalRingConnections.push(this.ringConnections[e]);for(var e=0;e<this.graph.vertices.length;e++)this.graph.vertices[e].value.backupRings()}},{key:"restoreRingInformation",value:function(){var e=this.getBridgedRings();this.rings=[],this.ringConnections=[];for(var t=0;t<e.length;t++)for(var r=e[t],i=0;i<r.rings.length;i++){var n=r.rings[i];this.originalRings[n.id].center=n.center}for(var t=0;t<this.originalRings.length;t++)this.rings.push(this.originalRings[t]);for(var t=0;t<this.originalRingConnections.length;t++)this.ringConnections.push(this.originalRingConnections[t]);for(var t=0;t<this.graph.vertices.length;t++)this.graph.vertices[t].value.restoreRings()}},{key:"createRing",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!e.positioned){t=t||new SmilesDrawer.Vector2(0,0);var s=e.getOrderedNeighbours(this.ringConnections),a=i?SmilesDrawer.Vector2.subtract(i.position,t).angle():0,o=SmilesDrawer.MathHelper.polyCircumradius(this.opts.bondLength,e.getSize()),l=SmilesDrawer.MathHelper.centralAngle(e.getSize());e.centralAngle=l;var h=a,u=this,g=i?i.id:null;if(-1===e.members.indexOf(g)&&(i&&(i.positioned=!1),g=e.members[0]),e.isBridged){this.graph.kkLayout(e.members,t,i.id,e,this.opts.bondLength),e.positioned=!0,this.setRingCenter(e),t=e.center;for(var c=0;c<e.rings.length;c++)this.setRingCenter(e.rings[c])}else e.eachMember(this.graph.vertices,function(r){var i=u.graph.vertices[r];i.positioned||i.setPosition(t.x+Math.cos(h)*o,t.y+Math.sin(h)*o),h+=l,(!e.isBridged||e.rings.length<3)&&(i.positioned=!0)},g,n?n.id:null);e.positioned=!0,e.center=t;for(var c=0;c<s.length;c++){var v=this.getRing(s[c].neighbour);if(!v.positioned){var d=SmilesDrawer.RingConnection.getVertices(this.ringConnections,e.id,v.id);if(2===d.length)!function(){e.isFused=!0,v.isFused=!0;var i=r.graph.vertices[d[0]],n=r.graph.vertices[d[1]],s=SmilesDrawer.Vector2.midpoint(i.position,n.position),a=SmilesDrawer.Vector2.normals(i.position,n.position);SmilesDrawer.ArrayHelper.each(a,function(e){e.normalize()});var o=SmilesDrawer.MathHelper.polyCircumradius(r.opts.bondLength,v.getSize()),l=SmilesDrawer.MathHelper.apothem(o,v.getSize());SmilesDrawer.ArrayHelper.each(a,function(e){e.multiplyScalar(l)}),SmilesDrawer.ArrayHelper.each(a,function(e){e.add(s)});var h=a[0];SmilesDrawer.Vector2.subtract(t,a[1]).length()>SmilesDrawer.Vector2.subtract(t,a[0]).length()&&(h=a[1]);var u=SmilesDrawer.Vector2.subtract(i.position,h),g=SmilesDrawer.Vector2.subtract(n.position,h);-1===u.clockwise(g)?v.positioned||r.createRing(v,h,i,n):v.positioned||r.createRing(v,h,n,i)}();else if(1===d.length){e.isSpiro=!0,v.isSpiro=!0;var f=this.graph.vertices[d[0]],p=SmilesDrawer.Vector2.subtract(t,f.position);p.invert(),p.normalize();var m=SmilesDrawer.MathHelper.polyCircumradius(this.opts.bondLength,v.getSize());p.multiplyScalar(m),p.add(f.position),v.positioned||this.createRing(v,p,f)}}}for(var c=0;c<e.members.length;c++)for(var y=this.graph.vertices[e.members[c]],S=y.getNeighbours(),b=0;b<S.length;b++){var w=this.graph.vertices[S[b]];w.positioned||(w.value.isConnectedToRing=!0,this.createNextBond(w,y,this.getSubringCenter(e,y)))}}}},{key:"rotateSubtree",value:function(e,t,r,i){var n=this;this.traverseTree(e,t,function(e){e.position.rotateAround(r,i);for(var t=0;t<e.value.anchoredRings.length;t++){var s=n.rings[e.value.anchoredRings[t]];s&&s.center.rotateAround(r,i)}})}},{key:"getSubtreeOverlapScore",value:function(e,t,r){var i=this,n=0,s=new SmilesDrawer.Vector2;return this.traverseTree(e,t,function(e){var t=r[e.id];n+=t;var a=i.graph.vertices[e.id].position.clone();a.multiplyScalar(t),s.add(a)}),s.divide(n),{value:n,center:s}}},{key:"getCurrentCenterOfMass",value:function(){for(var e=new SmilesDrawer.Vector2,t=0,r=0;r<this.graph.vertices.length;r++){var i=this.graph.vertices[r];i.positioned&&(e.add(i.position),t++)}return e.divide(t)}},{key:"getCurrentCenterOfMassInNeigbourhood",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2*this.opts.bondLength,r=new SmilesDrawer.Vector2,i=0,n=t*t,s=0;s<this.graph.vertices.length;s++){var a=this.graph.vertices[s];a.positioned&&e.distanceSq(a.position)<n&&(r.add(a.position),i++)}return r.divide(i)}},{key:"resolvePrimaryOverlaps",value:function(){for(var e=[],t=Array(this.graph.vertices.length),r=0;r<this.rings.length;r++)for(var i=this.rings[r],n=0;n<i.members.length;n++){var s=this.graph.vertices[i.members[n]];if(!t[s.id]){t[s.id]=!0;var a=this.getNonRingNeighbours(s.id);if(a.length>1){for(var o=[],l=0;l<s.value.rings.length;l++)o.push(s.value.rings[l]);e.push({common:s,rings:o,vertices:a})}}}for(var r=0;r<e.length;r++){var h=e[r];if(2===h.vertices.length){var u=h.vertices[0],g=h.vertices[1];if(!u.value.isDrawn||!g.value.isDrawn)continue;var c=(2*Math.PI-this.getRing(h.rings[0]).getAngle())/6;this.rotateSubtree(u.id,h.common.id,c,h.common.position),this.rotateSubtree(g.id,h.common.id,-c,h.common.position);var v=this.getOverlapScore(),d=this.getSubtreeOverlapScore(u.id,h.common.id,v.vertexScores),f=this.getSubtreeOverlapScore(g.id,h.common.id,v.vertexScores),p=d.value+f.value;this.rotateSubtree(u.id,h.common.id,-2*c,h.common.position),this.rotateSubtree(g.id,h.common.id,2*c,h.common.position),v=this.getOverlapScore(),d=this.getSubtreeOverlapScore(u.id,h.common.id,v.vertexScores),f=this.getSubtreeOverlapScore(g.id,h.common.id,v.vertexScores),d.value+f.value>p&&(this.rotateSubtree(u.id,h.common.id,2*c,h.common.position),this.rotateSubtree(g.id,h.common.id,-2*c,h.common.position))}}}},{key:"resolveSecondaryOverlaps",value:function(e){for(var t=0;t<e.length;t++)if(e[t].score>this.opts.bondLength/(4*this.opts.bondLength)){var r=this.graph.vertices[e[t].id];if(r.isTerminal()){var i=this.getClosestVertex(r);if(i){var n=null;n=i.isTerminal()?0===i.id?this.graph.vertices[1].position:i.previousPosition:0===i.id?this.graph.vertices[1].position:i.position;var s=0===r.id?this.graph.vertices[1].position:r.previousPosition;r.position.rotateAwayFrom(n,s,SmilesDrawer.MathHelper.toRad(20))}}}}},{key:"createNextBond",value:function(e,t,r,i){if(!e.positioned){if(t)if(1===t.value.originalRings.length){for(var n=Array(),s=t.getNeighbours(),a=0;a<s.length;a++){var o=this.graph.vertices[s[a]];o.positioned&&o.value.originalRings.length>0&&n.push(SmilesDrawer.Vector2.subtract(o.position,t.position))}var l=SmilesDrawer.Vector2.averageDirection(n);e.setPositionFromVector(l.invert().multiplyScalar(this.opts.bondLength).add(t.position)),e.previousPosition=t.position,e.positioned=!0}else if(t.value.originalRings.length>1){for(var h=Array(),u=t.getNeighbours(),a=0;a<u.length;a++){var g=this.graph.vertices[u[a]];g.positioned&&g.value.originalRings.length>1&&h.push(SmilesDrawer.Vector2.subtract(g.position,t.position))}console.log("1",e.id,u,h);var c=SmilesDrawer.Vector2.averageDirection(h);c.invert().multiplyScalar(this.opts.bondLength).add(t.position);for(var a=0;a<u.length;a++){var v=this.graph.vertices[u[a]];if(v.positioned&&SmilesDrawer.Vector2.threePointangle(c,t.position,v.position)>3.1){c.rotateAround(Math.PI,t.position);break}}e.previousPosition=t.position,e.setPositionFromVector(c),e.positioned=!0}else{var d=new SmilesDrawer.Vector2(this.opts.bondLength,0);d.rotate(r),d.add(t.position),e.globalAngle=r,e.setPositionFromVector(d),e.previousPosition=t.position,e.positioned=!0}else{var f=new SmilesDrawer.Vector2(this.opts.bondLength,0);f.rotate(SmilesDrawer.MathHelper.toRad(-120)),e.previousPosition=f,e.setPosition(this.opts.bondLength,0),e.angle=SmilesDrawer.MathHelper.toRad(-120),e.globalAngle=e.angle,null===e.value.bridgedRing&&(e.positioned=!0)}if(null!==e.value.bridgedRing){var p=this.getRing(e.value.bridgedRing),m=SmilesDrawer.Vector2.subtract(e.previousPosition,e.position);m.invert(),m.normalize();var y=SmilesDrawer.MathHelper.polyCircumradius(this.opts.bondLength,p.members.length);m.multiplyScalar(y),m.add(e.position),p.positioned||this.createRing(p,m,e)}else if(e.value.rings.length>0){var S=this.getRing(e.value.rings[0]),b=SmilesDrawer.Vector2.subtract(e.previousPosition,e.position);b.invert(),b.normalize();var w=SmilesDrawer.MathHelper.polyCircumradius(this.opts.bondLength,S.getSize());b.multiplyScalar(w),b.add(e.position),S.positioned||this.createRing(S,b,e)}else{var A=e.getNeighbours();t&&(A=SmilesDrawer.ArrayHelper.remove(A,t.id));var C=e.getAngle();if(1===A.length){var x=this.graph.vertices[A[0]];if("#"===e.value.bondType||t&&"#"===t.value.bondType||"="===e.value.bondType&&t&&"="===t.value.bondType){if(e.value.drawExplicit=!0,t){var D=this.graph.getEdge(e.id,t.id);D.center=!0}var k=this.graph.getEdge(e.id,x.id);k.center=!0,x.drawExplicit=!0,x.globalAngle=C,x.angle=0,this.createNextBond(x,e,x.globalAngle,-i)}else if(t&&t.value.rings.length>0){var R=SmilesDrawer.MathHelper.toRad(60),V=-R,T=new SmilesDrawer.Vector2(this.opts.bondLength,0),I=new SmilesDrawer.Vector2(this.opts.bondLength,0);T.rotate(R).add(e.position),I.rotate(V).add(e.position);var N=this.getCurrentCenterOfMass(),P=T.distance(N),L=I.distance(N);x.angle=P<L?V:R,i=x.angle>0?-1:1,x.globalAngle=C+x.angle,this.createNextBond(x,e,x.globalAngle,i)}else{if(i)x.angle=SmilesDrawer.MathHelper.toRad(60)*i,i=-i;else{var M=SmilesDrawer.MathHelper.toRad(60),B=-M,H=new SmilesDrawer.Vector2(this.opts.bondLength,0),E=new SmilesDrawer.Vector2(this.opts.bondLength,0);H.rotate(M).add(e.position),E.rotate(B).add(e.position);var O=this.getCurrentCenterOfMass(),z=H.distance(O),F=E.distance(O);x.angle=z<F?B:M,i=x.angle>0?-1:1}x.globalAngle=C+x.angle,this.createNextBond(x,e,x.globalAngle,i)}}else if(2===A.length){var _=this.getTreeDepth(A[0],e.id),W=this.getTreeDepth(A[1],e.id),j=this.getTreeDepth(t?t.id:null,e.id),q=0,U=1;_>W&&(q=1,U=0);var X=this.graph.vertices[A[q]],G=this.graph.vertices[A[U]];j<_&&j<W?1===e.position.clockwise(e.previousPosition)?(G.angle=SmilesDrawer.MathHelper.toRad(60),X.angle=-SmilesDrawer.MathHelper.toRad(60),G.globalAngle=C+G.angle,X.globalAngle=C+X.angle,this.createNextBond(G,e,G.globalAngle,-i),this.createNextBond(X,e,X.globalAngle,i)):(G.angle=-SmilesDrawer.MathHelper.toRad(60),X.angle=SmilesDrawer.MathHelper.toRad(60),G.globalAngle=C+G.angle,X.globalAngle=C+X.angle,this.createNextBond(X,e,X.globalAngle,i),this.createNextBond(G,e,G.globalAngle,-i)):1===e.position.clockwise(e.previousPosition)?(G.angle=SmilesDrawer.MathHelper.toRad(60),X.angle=-SmilesDrawer.MathHelper.toRad(60),G.globalAngle=C+G.angle,X.globalAngle=C+X.angle,this.createNextBond(G,e,G.globalAngle,-i),this.createNextBond(X,e,X.globalAngle,-i)):(G.angle=-SmilesDrawer.MathHelper.toRad(60),X.angle=SmilesDrawer.MathHelper.toRad(60),G.globalAngle=C+G.angle,X.globalAngle=C+X.angle,this.createNextBond(X,e,X.globalAngle,-i),this.createNextBond(G,e,G.globalAngle,-i))}else if(3===A.length){var Y=this.getTreeDepth(A[0],e.id),K=this.getTreeDepth(A[1],e.id),Z=this.getTreeDepth(A[2],e.id),$=this.graph.vertices[A[0]],J=this.graph.vertices[A[1]],Q=this.graph.vertices[A[2]];if(K>Y&&K>Z?($=this.graph.vertices[A[1]],J=this.graph.vertices[A[0]],Q=this.graph.vertices[A[2]]):Z>Y&&Z>K&&($=this.graph.vertices[A[2]],J=this.graph.vertices[A[0]],Q=this.graph.vertices[A[1]]),1===this.getTreeDepth(J.id,e.id)&&1===this.getTreeDepth(Q.id,e.id)&&this.getTreeDepth($.id,e.id)>1){if(i)$.angle=SmilesDrawer.MathHelper.toRad(60)*i,i=-i;else{var ee=SmilesDrawer.MathHelper.toRad(60),te=-ee,re=new SmilesDrawer.Vector2(this.opts.bondLength,0),ie=new SmilesDrawer.Vector2(this.opts.bondLength,0);re.rotate(ee).add(e.position),ie.rotate(te).add(e.position);var ne=this.getCurrentCenterOfMass(),se=re.distance(ne),ae=ie.distance(ne);$.angle=se<ae?te:ee,i=$.angle>0?-1:1}$.globalAngle=C+$.angle,this.createNextBond($,e,$.globalAngle,-i),e.value.bracket&&"@@"===e.value.bracket.chirality?(Q.angle=SmilesDrawer.MathHelper.toRad(30)*i,J.angle=SmilesDrawer.MathHelper.toRad(90)*i,Q.globalAngle=C+Q.angle,J.globalAngle=C+J.angle,this.createNextBond(Q,e,Q.globalAngle),this.createNextBond(J,e,J.globalAngle)):(J.angle=SmilesDrawer.MathHelper.toRad(30)*i,Q.angle=SmilesDrawer.MathHelper.toRad(90)*i,J.globalAngle=C+J.angle,Q.globalAngle=C+Q.angle,this.createNextBond(J,e,J.globalAngle),this.createNextBond(Q,e,Q.globalAngle))}else $.angle=0,J.angle=SmilesDrawer.MathHelper.toRad(90),Q.angle=-SmilesDrawer.MathHelper.toRad(90),$.globalAngle=C+$.angle,J.globalAngle=C+J.angle,Q.globalAngle=C+Q.angle,this.createNextBond($,e,$.globalAngle),this.createNextBond(J,e,J.globalAngle),this.createNextBond(Q,e,Q.globalAngle)}else if(4===A.length){var oe=this.getTreeDepth(A[0],e.id),le=this.getTreeDepth(A[1],e.id),he=this.getTreeDepth(A[2],e.id),ue=this.getTreeDepth(A[3],e.id),ge=this.graph.vertices[A[0]],ce=this.graph.vertices[A[1]],ve=this.graph.vertices[A[2]],de=this.graph.vertices[A[3]];le>oe&&le>he&&le>ue?(ge=this.graph.vertices[A[1]],ce=this.graph.vertices[A[0]],ve=this.graph.vertices[A[2]],de=this.graph.vertices[A[3]]):he>oe&&he>le&&he>ue?(ge=this.graph.vertices[A[2]],ce=this.graph.vertices[A[0]],ve=this.graph.vertices[A[1]],de=this.graph.vertices[A[3]]):ue>oe&&ue>le&&ue>he&&(ge=this.graph.vertices[A[3]],ce=this.graph.vertices[A[0]],ve=this.graph.vertices[A[1]],de=this.graph.vertices[A[2]]),ge.angle=-SmilesDrawer.MathHelper.toRad(36),ce.angle=SmilesDrawer.MathHelper.toRad(36),ve.angle=-SmilesDrawer.MathHelper.toRad(108),de.angle=SmilesDrawer.MathHelper.toRad(108),ge.globalAngle=C+ge.angle,ce.globalAngle=C+ce.angle,ve.globalAngle=C+ve.angle,de.globalAngle=C+de.angle,this.createNextBond(ge,e,ge.globalAngle),this.createNextBond(ce,e,ce.globalAngle),this.createNextBond(ve,e,ve.globalAngle),this.createNextBond(de,e,de.globalAngle)}}}}},{key:"getCommonRingbondNeighbour",value:function(e){for(var t=e.getNeighbours(),r=0;r<t.length;r++){var i=this.graph.vertices[t[r]];if(SmilesDrawer.ArrayHelper.All(i.value.rings,e.value.rings))return i}return null}},{key:"isPointInRing",value:function(e){for(var t=0;t<this.rings.length;t++){var r=this.rings[t];if(r.positioned){var i=SmilesDrawer.MathHelper.polyCircumradius(this.opts.bondLength,r.getSize()),n=i*i;if(e.distanceSq(r.center)<n)return!0}}return!1}},{key:"isEdgeInRing",value:function(e){var t=this.graph.vertices[e.sourceId],r=this.graph.vertices[e.targetId];return this.areVerticesInSameRing(t,r)}},{key:"isEdgeRotatable",value:function(e){var t=this.graph.vertices[e.sourceId],r=this.graph.vertices[e.targetId];return"-"===e.bondType&&(!(t.getNeighbourCount()+r.getNeighbourCount()<5)&&!(t.value.rings.length>0&&r.value.rings.length>0&&this.areVerticesInSameRing(t,r)))}},{key:"isRingAromatic",value:function(e){for(var t=0;t<e.members.length;t++){if(!this.graph.vertices[e.members[t]].value.isPartOfAromaticRing)return!1}return!0}},{key:"getEdgeNormals",value:function(e){var t=this.graph.vertices[e.sourceId].position,r=this.graph.vertices[e.targetId].position;return SmilesDrawer.Vector2.units(t,r)}},{key:"getTreeDepth",value:function(e,t){if(null===e||null===t)return 0;for(var r=this.graph.vertices[e].getSpanningTreeNeighbours(t),i=0,n=0;n<r.length;n++){var s=r[n],a=this.getTreeDepth(s,e);a>i&&(i=a)}return i+1}},{key:"traverseTree",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];if(!(null!==i&&s>i+1)){for(var o=0;o<a.length;o++)if(a[o]===e)return;a.push(e);var l=this.graph.vertices[e],h=l.getNeighbours(t);(!n||s>1)&&r(l);for(var u=0;u<h.length;u++)this.traverseTree(h[u],e,r,i,n,s+1,a)}}},{key:"getBondCount",value:function(e){for(var t=0,r=0;r<e.edges.length;r++)t+=this.graph.edges[e.edges[r]].getBondCount();return t}},{key:"getNonRingNeighbours",value:function(e){for(var t=[],r=this.graph.vertices[e],i=r.getNeighbours(),n=0;n<i.length;n++){var s=this.graph.vertices[i[n]];0===SmilesDrawer.ArrayHelper.intersection(r.value.rings,s.value.rings).length&&0==s.value.isBridge&&t.push(s)}return t}},{key:"annotateChirality",value:function(){}},{key:"initPseudoElements",value:function(){for(var e=0;e<this.graph.vertices.length;e++){for(var t=this.graph.vertices[e],r=t.getNeighbours(),i=[],n=0;n<r.length;n++)i.push(this.graph.vertices[r[n]]);if(!(t.getNeighbourCount()<3||t.value.rings.length>0)){for(var s=0,a=0,n=0;n<i.length;n++){var o=i[n],l=o.value.element,h=o.getNeighbourCount();"C"!==l&&"H"!==l&&1===h&&s++,h>1&&a++}if(!(a>1||s<2)){for(var u=null,n=0;n<i.length;n++){var g=i[n];g.getNeighbourCount()>1&&(u=g)}for(var n=0;n<i.length;n++){var c=i[n];if(!(c.getNeighbourCount()>1)){c.value.isDrawn=!1;var v=SmilesDrawer.Atom.maxBonds[c.value.element]-this.getBondCount(c);c.value.bracket&&(v=c.value.bracket.hcount),t.value.attachPseudoElement(c.value.element,u?u.value.element:null,v)}}}}}for(var e=0;e<this.graph.vertices.length;e++){var d=this.graph.vertices[e],f=d.value,p=f.element;if("C"!==p&&"H"!==p&&f.isDrawn){for(var m=d.getNeighbours(),y=[],n=0;n<m.length;n++)y.push(this.graph.vertices[m[n]]);for(var n=0;n<y.length;n++){var S=y[n].value;if(S.hasAttachedPseudoElements&&2===S.getAttachedPseudoElementsCount()){var b=S.getAttachedPseudoElements();b.hasOwnProperty("0O")&&b.hasOwnProperty("3C")&&(S.isDrawn=!1,d.value.attachPseudoElement("Ac","",0))}}}}}}]),e}(),SmilesDrawer.Edge=function(){function e(t,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;_classCallCheck(this,e),this.id=null,this.sourceId=t,this.targetId=r,this.weight=i,this.bondType="-",this.isPartOfAromaticRing=!1,this.center=!1,this.chiral=""}return _createClass(e,[{key:"getBondCount",value:function(){return e.bonds[this.bondType]}}],[{key:"bonds",get:function(){return{"-":1,"/":1,"\\":1,"=":2,"#":3,$:4}}}]),e}(),SmilesDrawer.Graph=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];_classCallCheck(this,e),this.vertices=[],this.edges=[],this.vertexIdsToEdgeId={},this.elementCount={},this.isomeric=r,this._time=0,this._init(t),this._initInfos()}return _createClass(e,[{key:"_init",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=new SmilesDrawer.Atom(e.atom.element?e.atom.element:e.atom,e.bond);n.branchBond=e.branchBond,n.ringbonds=e.ringbonds,n.bracket=e.atom.element?e.atom:null,n.setOrder(r,t);var s=new SmilesDrawer.Vertex(n),a=this.vertices[r];if(this.addVertex(s),null!==r){s.setParentVertexId(r),s.value.addNeighbouringElement(a.value.element),a.addChild(s.id),a.value.addNeighbouringElement(n.element),a.spanningTreeChildren.push(s.id);var o=new SmilesDrawer.Edge(r,s.id,1);o.bondType=i?s.value.branchBond:a.value.bondType;var l=this.addEdge(o);s.edges.push(l),a.edges.push(l)}if(n.bracket&&this.isomeric)for(var h=0;h<n.bracket.hcount;h++)this.isomeric&&this._init({atom:{element:"H",bond:"-"},ringbonds:[]},h+1,s.id);var u=e.ringbondCount+1;n.bracket&&(u+=n.bracket.hcount);for(var h=0;h<e.branchCount;h++)this._init(e.branches[h],h+u,s.id,!0);e.hasNext&&this._init(e.next,e.branchCount+u,s.id)}},{key:"_initInfos",value:function(){for(var e=0;e<this.vertices.length;e++){var t=this.vertices[e].value;void 0!==this.elementCount[t.element]?this.elementCount[t.element]+=1:this.elementCount[t.element]=0}}},{key:"clear",value:function(){this.vertices=[],this.edges=[],this.vertexIdsToEdgeId={}}},{key:"addVertex",value:function(e){return e.id=this.vertices.length,this.vertices.push(e),e.id}},{key:"addEdge",value:function(e){return e.id=this.edges.length,this.edges.push(e),this.vertexIdsToEdgeId[e.sourceId+"_"+e.targetId]=e.id,this.vertexIdsToEdgeId[e.targetId+"_"+e.sourceId]=e.id,e.isPartOfAromaticRing=this.vertices[e.sourceId].value.isPartOfAromaticRing&&this.vertices[e.targetId].value.isPartOfAromaticRing,e.id}},{key:"getEdge",value:function(e,t){var r=this.vertexIdsToEdgeId[e+"_"+t];return void 0===r?null:this.edges[r]}},{key:"getEdges",value:function(e){for(var t=Array(),r=this.vertices[e],i=0;i<r.neighbours.length;i++)t.push(this.vertexIdsToEdgeId[e+"_"+r.neighbours[i]]);return t}},{key:"hasEdge",value:function(e,t){return void 0!==this.vertexIdsToEdgeId[e+"_"+t]}},{key:"getVertexList",value:function(){for(var e=[this.vertices.length],t=0;t<this.vertices.length;t++)e[t]=this.vertices[t].id;return e}},{key:"getEdgeList",value:function(){for(var e=[this.edges.length],t=0;t<this.edges.length;t++)e[t]=[this.edges[t].sourceId,this.edges[t].targetId];return e}},{key:"getAdjacencyMatrix",value:function(){for(var e=this.vertices.length,t=Array(e),r=0;r<e;r++)t[r]=new Array(e),t[r].fill(0);for(var r=0;r<this.edges.length;r++){var i=this.edges[r];t[i.sourceId][i.targetId]=1,t[i.targetId][i.sourceId]=1}return t}},{key:"getComponentsAdjacencyMatrix",value:function(){
for(var e=this.vertices.length,t=Array(e),r=this.getBridges(),i=0;i<e;i++)t[i]=new Array(e),t[i].fill(0);for(var i=0;i<this.edges.length;i++){var n=this.edges[i];t[n.sourceId][n.targetId]=1,t[n.targetId][n.sourceId]=1}for(var i=0;i<r.length;i++)t[r[i][0]][r[i][1]]=0,t[r[i][1]][r[i][0]]=0;return t}},{key:"getSubgraphAdjacencyMatrix",value:function(e){for(var t=e.length,r=Array(t),i=0;i<t;i++){r[i]=new Array(t),r[i].fill(0);for(var n=0;n<t;n++)i!==n&&this.hasEdge(e[i],e[n])&&(r[i][n]=1)}return r}},{key:"getDistanceMatrix",value:function(){for(var e=this.vertices.length,t=this.getAdjacencyMatrix(),r=Array(e),i=0;i<e;i++)r[i]=Array(e),r[i].fill(1/0);for(var i=0;i<e;i++)for(var n=0;n<e;n++)1===t[i][n]&&(r[i][n]=1);for(var s=0;s<e;s++)for(var i=0;i<e;i++)for(var n=0;n<e;n++)r[i][n]>r[i][s]+r[s][n]&&(r[i][n]=r[i][s]+r[s][n]);return r}},{key:"getSubgraphDistanceMatrix",value:function(e){for(var t=e.length,r=this.getSubgraphAdjacencyMatrix(e),i=Array(t),n=0;n<t;n++)i[n]=Array(t),i[n].fill(1/0);for(var n=0;n<t;n++)for(var s=0;s<t;s++)1===r[n][s]&&(i[n][s]=1);for(var a=0;a<t;a++)for(var n=0;n<t;n++)for(var s=0;s<t;s++)i[n][s]>i[n][a]+i[a][s]&&(i[n][s]=i[n][a]+i[a][s]);return i}},{key:"getAdjacencyList",value:function(){for(var e=this.vertices.length,t=Array(e),r=0;r<e;r++){t[r]=[];for(var i=0;i<e;i++)r!==i&&this.hasEdge(this.vertices[r].id,this.vertices[i].id)&&t[r].push(i)}return t}},{key:"getSubgraphAdjacencyList",value:function(e){for(var t=e.length,r=Array(t),i=0;i<t;i++){r[i]=[];for(var n=0;n<t;n++)i!==n&&this.hasEdge(e[i],e[n])&&r[i].push(n)}return r}},{key:"getBridges",value:function(){var e=this.vertices.length,t=new Array(e),r=new Array(e),i=new Array(e),n=new Array(e),s=this.getAdjacencyList(),a=[];t.fill(!1),n.fill(null),this._time=0;for(var o=0;o<e;o++)t[o]||this._bridgeDfs(o,t,r,i,n,s,a);return a}},{key:"traverseBF",value:function(e,t){var r=this.vertices.length,i=new Array(r);i.fill(!1);for(var n=[e];n.length>0;){var s=n.shift(),a=this.vertices[s];t(a);for(var o=0;o<a.neighbours.length;o++){var l=a.neighbours[o];i[l]||(i[l]=!0,n.push(l))}}}},{key:"kkLayout",value:function(e,t,r,i,n){for(var s=e.length-1;s>=0;s--)for(var a=this.vertices[e[s]],o=0;o<a.neighbours.length;o++){var l=this.vertices[a.neighbours[o]];0===l.value.rings.length&&-1===e.indexOf(l.id)&&e.push(l.id)}for(var h=this.getSubgraphDistanceMatrix(e),u=e.length,g=SmilesDrawer.MathHelper.polyCircumradius(500,u),c=SmilesDrawer.MathHelper.centralAngle(u),v=0,d=Array(u),f=Array(u),s=0;s<u;s++){var p=this.vertices[e[s]];p.positioned?d[s]=[p.position.x,p.position.y]:d[s]=[t.x+Math.cos(v)*g,t.y+Math.sin(v)*g],f[s]=p.positioned,v+=c}for(var m=Array(u),s=0;s<u;s++){m[s]=new Array(u);for(var o=0;o<u;o++)m[s][o]=n*h[s][o]}for(var y=Array(u),s=0;s<u;s++){y[s]=Array(u);for(var o=0;o<u;o++)y[s][o]=10*Math.pow(h[s][o],-2)}for(var S=Array(u),b=Array(u),s=0;s<u;s++)S[s]=Array(u);for(var s=0;s<u;s++){for(var w=d[s],A=0,C=0,o=s;o<u;o++)if(s!==o){var x=d[o],D=1/Math.sqrt(Math.pow(w[0]-x[0],2)+Math.pow(w[1]-x[1],2));S[s][o]=[y[s][o]*(w[0]-x[0]-m[s][o]*(w[0]-x[0])*D),y[s][o]*(w[1]-x[1]-m[s][o]*(w[1]-x[1])*D)],S[o][s]=S[s][o],A+=S[s][o][0],C+=S[s][o][1]}b[s]=[A,C]}for(var k=function(e){var t=b[e];return[Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)),t]},R=1e9,V=0,T=[0,0],I=0,N=0,P=0;R>.01&&750>N;){N++;var L=function(){for(var e=0,t=0,r=[0,0],i=0;i<u;i++){var n=k(i),s=_slicedToArray(n,2),a=s[0],o=s[1];a>e&&!1===f[i]&&(e=a,t=i,r=o)}return[t,e,r]}(),M=_slicedToArray(L,3);for(V=M[0],R=M[1],T=M[2],I=R,P=0;I>1&&20>P;){P++,function(e,t){for(var r=0,i=0,n=0,s=d[e],a=m[e],o=y[e],l=0;l<u;l++)if(l!==e){var h=d[l],g=a[l],c=o[l],v=1/Math.pow(Math.pow(s[0]-h[0],2)+Math.pow(s[1]-h[1],2),1.5);r+=c*(1-g*Math.pow(s[1]-h[1],2)*v),i+=c*(1-g*Math.pow(s[0]-h[0],2)*v),n+=c*(g*(s[0]-h[0])*(s[1]-h[1])*v)}0===r&&(r=.1),0===i&&(i=.1),0===n&&(n=.1);var f=t[0]/r+t[1]/n;f/=n/r-i/n;var p=-(n*f+t[0])/r;d[e][0]+=p,d[e][1]+=f;var w=S[e];t=[0,0];for(var l=0;l<u;l++)if(e!==l){var A=d[l],C=w[l][0],x=w[l][1],D=1/Math.sqrt(Math.pow(s[0]-A[0],2)+Math.pow(s[1]-A[1],2)),k=o[l]*(s[0]-A[0]-a[l]*(s[0]-A[0])*D),R=o[l]*(s[1]-A[1]-a[l]*(s[1]-A[1])*D);w[l]=[k,R],t[0]+=k,t[1]+=R,b[l][0]+=k-C,b[l][1]+=R-x}b[e]=[t[0],t[1]]}(V,T);var B=k(V),H=_slicedToArray(B,2);I=H[0],T=H[1]}}for(var s=0;s<u;s++){var E=e[s];this.vertices[E].position.x=d[s][0],this.vertices[E].position.y=d[s][1],this.vertices[E].positioned=!0}}},{key:"_bridgeDfs",value:function(e,t,r,i,n,s,a){t[e]=!0,r[e]=i[e]=++this._time;for(var o=0;o<s[e].length;o++){var l=s[e][o];t[l]?l!==n[e]&&(i[e]=Math.min(i[e],r[l])):(n[l]=e,this._bridgeDfs(l,t,r,i,n,s,a),i[e]=Math.min(i[e],i[l]),i[l]>r[e]&&a.push([e,l]))}}}],[{key:"getConnectedComponents",value:function(t){var r=t.length,i=new Array(r),n=new Array,s=0;i.fill(!1);for(var a=0;a<r;a++)if(!i[a]){var o=Array();i[a]=!0,o.push(a),s++,e._ccGetDfs(a,i,t,o),o.length>1&&n.push(o)}return n}},{key:"getConnectedComponentCount",value:function(t){var r=t.length,i=new Array(r),n=0;i.fill(!1);for(var s=0;s<r;s++)i[s]||(i[s]=!0,n++,e._ccCountDfs(s,i,t));return n}},{key:"_ccCountDfs",value:function(t,r,i){for(var n=0;n<i[t].length;n++){i[t][n]&&!r[n]&&t!==n&&(r[n]=!0,e._ccCountDfs(n,r,i))}}},{key:"_ccGetDfs",value:function(t,r,i,n){for(var s=0;s<i[t].length;s++){i[t][s]&&!r[s]&&t!==s&&(r[s]=!0,n.push(s),e._ccGetDfs(s,r,i,n))}}}]),e}(),SmilesDrawer.Line=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new SmilesDrawer.Vector2(0,0),r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new SmilesDrawer.Vector(0,0),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];_classCallCheck(this,e),this.from=t,this.to=r,this.elementFrom=i,this.elementTo=n,this.chiralFrom=s,this.chiralTo=a}return _createClass(e,[{key:"clone",value:function(){return new SmilesDrawer.Line(this.from.clone(),this.to.clone(),this.elementFrom,this.elementTo)}},{key:"getLength",value:function(){return Math.sqrt(Math.pow(this.to.x-this.from.x,2)+Math.pow(this.to.y-this.from.y,2))}},{key:"getAngle",value:function(){return SmilesDrawer.Vector2.subtract(this.getRightVector(),this.getLeftVector()).angle()}},{key:"getRightVector",value:function(){return this.from.x<this.to.x?this.to:this.from}},{key:"getLeftVector",value:function(){return this.from.x<this.to.x?this.from:this.to}},{key:"getRightElement",value:function(){return this.from.x<this.to.x?this.elementTo:this.elementFrom}},{key:"getLeftElement",value:function(){return this.from.x<this.to.x?this.elementFrom:this.elementTo}},{key:"getRightChiral",value:function(){return this.from.x<this.to.x?this.chiralTo:this.chiralFrom}},{key:"getLeftChiral",value:function(){return this.from.x<this.to.x?this.chiralFrom:this.chiralTo}},{key:"setRightVector",value:function(e,t){return this.from.x<this.to.x?(this.to.x=e,this.to.y=t):(this.from.x=e,this.from.y=t),this}},{key:"setLeftVector",value:function(e,t){return this.from.x<this.to.x?(this.from.x=e,this.from.y=t):(this.to.x=e,this.to.y=t),this}},{key:"rotateToXAxis",value:function(){var e=this.getLeftVector();return this.setRightVector(e.x+this.getLength(),e.y),this}},{key:"rotate",value:function(e){var t=this.getLeftVector(),r=this.getRightVector(),i=Math.sin(e),n=Math.cos(e),s=n*(r.x-t.x)-i*(r.y-t.y)+t.x,a=i*(r.x-t.x)-n*(r.y-t.y)+t.y;return this.setRightVector(s,a),this}},{key:"shortenFrom",value:function(e){var t=SmilesDrawer.Vector2.subtract(this.to,this.from);return t.normalize(),t.multiplyScalar(e),this.from.add(t),this}},{key:"shortenTo",value:function(e){var t=SmilesDrawer.Vector2.subtract(this.from,this.to);return t.normalize(),t.multiplyScalar(e),this.to.add(t),this}},{key:"shortenRight",value:function(e){return this.from.x<this.to.x?this.shortenTo(e):this.shortenFrom(e),this}},{key:"shortenLeft",value:function(e){return this.from.x<this.to.x?this.shortenFrom(e):this.shortenTo(e),this}},{key:"shorten",value:function(e){var t=SmilesDrawer.Vector2.subtract(this.from,this.to);return t.normalize(),t.multiplyScalar(e/2),this.to.add(t),this.from.subtract(t),this}},{key:"getNormals",value:function(){var e=SmilesDrawer.Vector2.subtract(from,to);return[new SmilesDrawer.Vector2(-e.y,e.x),new SmilesDrawer.Vector2(e.y,-e.x)]}}]),e}(),SmilesDrawer.MathHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"round",value:function(e,t){return t=t||1,Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"meanAngle",value:function(e){for(var t=0,r=0,i=0;i<e.length;i++)t+=Math.sin(e[i]),r+=Math.cos(e[i]);return Math.atan2(t/e.length,r/e.length)}},{key:"innerAngle",value:function(e){return SmilesDrawer.MathHelper.toRad(180*(e-2)/e)}},{key:"polyCircumradius",value:function(e,t){return e/(2*Math.sin(Math.PI/t))}},{key:"apothem",value:function(e,t){return e*Math.cos(Math.PI/t)}},{key:"apothemFromSideLength",value:function(e,t){var r=SmilesDrawer.MathHelper.polyCircumradius(e,t);return SmilesDrawer.MathHelper.apothem(r,t)}},{key:"centralAngle",value:function(e){return SmilesDrawer.MathHelper.toRad(360/e)}},{key:"toDeg",value:function(e){return e*SmilesDrawer.MathHelper.degFactor}},{key:"toRad",value:function(e){return e*SmilesDrawer.MathHelper.radFactor}}]),e}(),SmilesDrawer.MathHelper.radFactor=Math.PI/180,SmilesDrawer.MathHelper.degFactor=180/Math.PI,SmilesDrawer.MathHelper.twoPI=2*Math.PI,SmilesDrawer.Parser=function(){function e(t,r,i,n){this.message=t,this.expected=r,this.found=i,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function t(t){function r(e){var r,i,n=rt[e];if(n)return n;for(r=e-1;!rt[r];)r--;for(n=rt[r],n={line:n.line,column:n.column,seenCR:n.seenCR};r<e;)i=t.charAt(r),"\n"===i?(n.seenCR||n.line++,n.column=1,n.seenCR=!1):"\r"===i||"\u2028"===i||"\u2029"===i?(n.line++,n.column=1,n.seenCR=!0):(n.column++,n.seenCR=!1),r++;return rt[e]=n,n}function i(e,t){var i=r(e),n=r(t);return{start:{offset:e,line:i.line,column:i.column},end:{offset:t,line:n.line,column:n.column}}}function n(e){et<it||(et>it&&(it=et,nt=[]),nt.push(e))}function s(t,r,i,n){return null!==r&&function(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}(r),new e(null!==t?t:function(e,t){var r,i,n,s=new Array(e.length);for(n=0;n<e.length;n++)s[n]=e[n].description;return r=e.length>1?s.slice(0,-1).join(", ")+" or "+s[e.length-1]:s[0],i=t?'"'+function(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0100-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1000-\uFFFF]/g,function(e){return"\\u"+t(e)})}(t)+'"':"end of input","Expected "+r+" but "+i+" found."}(r,i),r,i,n)}function a(){var e,t,r,i,n,s,u,g,c,v;if(e=et,t=et,(r=l())!==D){for(i=[],n=o();n!==D;)i.push(n),n=o();if(i!==D){for(n=[],s=et,u=h(),u===D&&(u=null),u!==D?(g=f(),g!==D?(u=[u,g],s=u):(et=s,s=D)):(et=s,s=D);s!==D;)n.push(s),s=et,u=h(),u===D&&(u=null),u!==D?(g=f(),g!==D?(u=[u,g],s=u):(et=s,s=D)):(et=s,s=D);if(n!==D){for(s=[],u=o();u!==D;)s.push(u),u=o();if(s!==D)if(u=h(),u===D&&(u=null),u!==D)if(g=a(),g===D&&(g=null),g!==D){for(c=[],v=o();v!==D;)c.push(v),v=o();c!==D?(r=[r,i,n,s,u,g,c],t=r):(et=t,t=D)}else et=t,t=D;else et=t,t=D;else et=t,t=D}else et=t,t=D}else et=t,t=D}else et=t,t=D;return t!==D&&(tt=e,t=V(t)),e=t}function o(){var e,r,i,s,o,l;return e=et,r=et,40===t.charCodeAt(et)?(i=T,et++):(i=D,0===st&&n(I)),i!==D?(s=h(),s===D&&(s=null),s!==D?(o=a(),o!==D?(41===t.charCodeAt(et)?(l=N,et++):(l=D,0===st&&n(P)),l!==D?(i=[i,s,o,l],r=i):(et=r,r=D)):(et=r,r=D)):(et=r,r=D)):(et=r,r=D),r!==D&&(tt=e,r=L(r)),e=r}function l(){var e,t;return e=et,t=g(),t===D&&(t=c())===D&&(t=u())===D&&(t=v()),t!==D&&(tt=e,t=M(t)),e=t}function h(){var e,r;return e=et,B.test(t.charAt(et))?(r=t.charAt(et),et++):(r=D,0===st&&n(H)),r!==D&&(tt=e,r=E(r)),e=r}function u(){var e,r,i,s,a,o,l,h,u,g;return e=et,r=et,91===t.charCodeAt(et)?(i=O,et++):(i=D,0===st&&n(z)),i!==D?(s=A(),s===D&&(s=null),s!==D?(t.substr(et,2)===F?(a=F,et+=2):(a=D,0===st&&n(_)),a===D&&(t.substr(et,2)===W?(a=W,et+=2):(a=D,0===st&&n(j)),a===D&&(a=c())===D&&(a=d())===D&&(a=v())),a!==D?(o=p(),o===D&&(o=null),o!==D?(l=b(),l===D&&(l=null),l!==D?(h=m(),h===D&&(h=null),h!==D?(u=w(),u===D&&(u=null),u!==D?(93===t.charCodeAt(et)?(g=q,et++):(g=D,0===st&&n(U)),g!==D?(i=[i,s,a,o,l,h,u,g],r=i):(et=r,r=D)):(et=r,r=D)):(et=r,r=D)):(et=r,r=D)):(et=r,r=D)):(et=r,r=D)):(et=r,r=D)):(et=r,r=D),r!==D&&(tt=e,r=X(r)),e=r}function g(){var e,r,i,s;return e=et,r=et,66===t.charCodeAt(et)?(i=G,et++):(i=D,0===st&&n(Y)),i!==D?(114===t.charCodeAt(et)?(s=K,et++):(s=D,0===st&&n(Z)),s===D&&(s=null),s!==D?(i=[i,s],r=i):(et=r,r=D)):(et=r,r=D),r===D&&(r=et,67===t.charCodeAt(et)?(i=$,et++):(i=D,0===st&&n(J)),i!==D?(108===t.charCodeAt(et)?(s=Q,et++):(s=D,0===st&&n(ee)),s===D&&(s=null),s!==D?(i=[i,s],r=i):(et=r,r=D)):(et=r,r=D),r===D&&(te.test(t.charAt(et))?(r=t.charAt(et),et++):(r=D,0===st&&n(re)))),r!==D&&(tt=e,r=ie(r)),e=r}function c(){var e,r;return e=et,ne.test(t.charAt(et))?(r=t.charAt(et),et++):(r=D,0===st&&n(se)),r!==D&&(tt=e,r=M(r)),e=r}function v(){var e,r;return e=et,42===t.charCodeAt(et)?(r=ae,et++):(r=D,0===st&&n(oe)),r!==D&&(tt=e,r=le(r)),e=r}function d(){var e,r,i,s;return e=et,r=et,he.test(t.charAt(et))?(i=t.charAt(et),et++):(i=D,0===st&&n(ue)),i!==D?(ge.test(t.charAt(et))?(s=t.charAt(et),et++):(s=D,0===st&&n(ce)),s===D&&(s=null),s!==D?(i=[i,s],r=i):(et=r,r=D)):(et=r,r=D),r!==D&&(tt=e,r=ve(r)),e=r}function f(){var e,r,i,s,a;return e=et,r=et,37===t.charCodeAt(et)?(i=de,et++):(i=D,0===st&&n(fe)),i!==D?(pe.test(t.charAt(et))?(s=t.charAt(et),et++):(s=D,0===st&&n(me)),s!==D?(ye.test(t.charAt(et))?(a=t.charAt(et),et++):(a=D,0===st&&n(Se)),a!==D?(i=[i,s,a],r=i):(et=r,r=D)):(et=r,r=D)):(et=r,r=D),r===D&&(ye.test(t.charAt(et))?(r=t.charAt(et),et++):(r=D,0===st&&n(Se))),r!==D&&(tt=e,r=be(r)),e=r}function p(){var e,r,i,s,a,o,l;return e=et,r=et,64===t.charCodeAt(et)?(i=we,et++):(i=D,0===st&&n(Ae)),i!==D?(64===t.charCodeAt(et)?(s=we,et++):(s=D,0===st&&n(Ae)),s===D&&(s=et,t.substr(et,2)===Ce?(a=Ce,et+=2):(a=D,0===st&&n(xe)),a!==D?(De.test(t.charAt(et))?(o=t.charAt(et),et++):(o=D,0===st&&n(ke)),o!==D?(a=[a,o],s=a):(et=s,s=D)):(et=s,s=D),s===D&&(s=et,t.substr(et,2)===Re?(a=Re,et+=2):(a=D,0===st&&n(Ve)),a!==D?(De.test(t.charAt(et))?(o=t.charAt(et),et++):(o=D,0===st&&n(ke)),o!==D?(a=[a,o],s=a):(et=s,s=D)):(et=s,s=D),s===D&&(s=et,t.substr(et,2)===Te?(a=Te,et+=2):(a=D,0===st&&n(Ie)),a!==D?(Ne.test(t.charAt(et))?(o=t.charAt(et),et++):(o=D,0===st&&n(Pe)),o!==D?(a=[a,o],s=a):(et=s,s=D)):(et=s,s=D),s===D&&(s=et,t.substr(et,2)===Le?(a=Le,et+=2):(a=D,0===st&&n(Me)),a!==D?(pe.test(t.charAt(et))?(o=t.charAt(et),et++):(o=D,0===st&&n(me)),o!==D?(ye.test(t.charAt(et))?(l=t.charAt(et),et++):(l=D,0===st&&n(Se)),l===D&&(l=null),l!==D?(a=[a,o,l],s=a):(et=s,s=D)):(et=s,s=D)):(et=s,s=D),s===D&&(s=et,t.substr(et,2)===Be?(a=Be,et+=2):(a=D,0===st&&n(He)),a!==D?(pe.test(t.charAt(et))?(o=t.charAt(et),et++):(o=D,0===st&&n(me)),o!==D?(ye.test(t.charAt(et))?(l=t.charAt(et),et++):(l=D,0===st&&n(Se)),l===D&&(l=null),l!==D?(a=[a,o,l],s=a):(et=s,s=D)):(et=s,s=D)):(et=s,s=D)))))),s===D&&(s=null),s!==D?(i=[i,s],r=i):(et=r,r=D)):(et=r,r=D),r!==D&&(tt=e,r=Ee(r)),e=r}function m(){var e,t;return e=et,t=y(),t===D&&(t=S()),t!==D&&(tt=e,t=Oe(t)),e=t}function y(){var e,r,i,s,a,o;return e=et,r=et,43===t.charCodeAt(et)?(i=ze,et++):(i=D,0===st&&n(Fe)),i!==D?(43===t.charCodeAt(et)?(s=ze,et++):(s=D,0===st&&n(Fe)),s===D&&(s=et,pe.test(t.charAt(et))?(a=t.charAt(et),et++):(a=D,0===st&&n(me)),a!==D?(ye.test(t.charAt(et))?(o=t.charAt(et),et++):(o=D,0===st&&n(Se)),o===D&&(o=null),o!==D?(a=[a,o],s=a):(et=s,s=D)):(et=s,s=D)),s===D&&(s=null),s!==D?(i=[i,s],r=i):(et=r,r=D)):(et=r,r=D),r!==D&&(tt=e,r=_e(r)),e=r}function S(){var e,r,i,s,a,o;return e=et,r=et,45===t.charCodeAt(et)?(i=We,et++):(i=D,0===st&&n(je)),i!==D?(45===t.charCodeAt(et)?(s=We,et++):(s=D,0===st&&n(je)),s===D&&(s=et,pe.test(t.charAt(et))?(a=t.charAt(et),et++):(a=D,0===st&&n(me)),a!==D?(ye.test(t.charAt(et))?(o=t.charAt(et),et++):(o=D,0===st&&n(Se)),o===D&&(o=null),o!==D?(a=[a,o],s=a):(et=s,s=D)):(et=s,s=D)),s===D&&(s=null),s!==D?(i=[i,s],r=i):(et=r,r=D)):(et=r,r=D),r!==D&&(tt=e,r=qe(r)),e=r}function b(){var e,r,i,s;return e=et,r=et,72===t.charCodeAt(et)?(i=Ue,et++):(i=D,0===st&&n(Xe)),i!==D?(ye.test(t.charAt(et))?(s=t.charAt(et),et++):(s=D,0===st&&n(Se)),s===D&&(s=null),s!==D?(i=[i,s],r=i):(et=r,r=D)):(et=r,r=D),r!==D&&(tt=e,r=Ge(r)),e=r}function w(){var e,r,i,s,a,o,l;if(e=et,r=et,58===t.charCodeAt(et)?(i=Ye,et++):(i=D,0===st&&n(Ke)),i!==D){if(s=et,pe.test(t.charAt(et))?(a=t.charAt(et),et++):(a=D,0===st&&n(me)),a!==D){for(o=[],ye.test(t.charAt(et))?(l=t.charAt(et),et++):(l=D,0===st&&n(Se));l!==D;)o.push(l),ye.test(t.charAt(et))?(l=t.charAt(et),et++):(l=D,0===st&&n(Se));o!==D?(a=[a,o],s=a):(et=s,s=D)}else et=s,s=D;s===D&&(Ze.test(t.charAt(et))?(s=t.charAt(et),et++):(s=D,0===st&&n($e))),s!==D?(i=[i,s],r=i):(et=r,r=D)}else et=r,r=D;return r!==D&&(tt=e,r=Je(r)),e=r}function A(){var e,r,i,s,a;return e=et,r=et,pe.test(t.charAt(et))?(i=t.charAt(et),et++):(i=D,0===st&&n(me)),i!==D?(ye.test(t.charAt(et))?(s=t.charAt(et),et++):(s=D,0===st&&n(Se)),s===D&&(s=null),s!==D?(ye.test(t.charAt(et))?(a=t.charAt(et),et++):(a=D,0===st&&n(Se)),a===D&&(a=null),a!==D?(i=[i,s,a],r=i):(et=r,r=D)):(et=r,r=D)):(et=r,r=D),r!==D&&(tt=e,r=Qe(r)),e=r}var C,x=arguments.length>1?arguments[1]:{},D={},k={chain:a},R=a,V=function(e){for(var t=[],r=[],i=0;i<e[1].length;i++)t.push(e[1][i]);for(var i=0;i<e[2].length;i++){var n=e[2][i][0]?e[2][i][0]:"-";r.push({bond:n,id:e[2][i][1]})}for(var i=0;i<e[3].length;i++)t.push(e[3][i]);for(var i=0;i<e[6].length;i++)t.push(e[6][i]);return{atom:e[0],isBracket:!!e[0].element,branches:t,branchCount:t.length,ringbonds:r,ringbondCount:r.length,bond:e[4]?e[4]:"-",next:e[5],hasNext:!!e[5]}},T="(",I={type:"literal",value:"(",description:'"("'},N=")",P={type:"literal",value:")",description:'")"'},L=function(e){var t=e[1]?e[1]:"-";return e[2].branchBond=t,e[2]},M=function(e){return e},B=/^[\-=#$:\/\\.]/,H={type:"class",value:"[-=#$:/\\\\.]",description:"[-=#$:/\\\\.]"},E=function(e){return e},O="[",z={type:"literal",value:"[",description:'"["'},F="se",_={type:"literal",value:"se",description:'"se"'},W="as",j={type:"literal",value:"as",description:'"as"'},q="]",U={type:"literal",value:"]",description:'"]"'},X=function(e){return{isotope:e[1],element:e[2],chirality:e[3],hcount:e[4],charge:e[5],class:e[6]}},G="B",Y={type:"literal",value:"B",description:'"B"'},K="r",Z={type:"literal",value:"r",description:'"r"'},$="C",J={type:"literal",value:"C",description:'"C"'},Q="l",ee={type:"literal",value:"l",description:'"l"'},te=/^[NOPSFI]/,re={type:"class",value:"[NOPSFI]",description:"[NOPSFI]"},ie=function(e){return e.length>1?e.join(""):e},ne=/^[bcnops]/,se={type:"class",value:"[bcnops]",description:"[bcnops]"},ae="*",oe={type:"literal",value:"*",description:'"*"'},le=function(e){return e},he=/^[A-Z]/,ue={type:"class",value:"[A-Z]",description:"[A-Z]"},ge=/^[a-z]/,ce={type:"class",value:"[a-z]",description:"[a-z]"},ve=function(e){return e.join("")},de="%",fe={type:"literal",value:"%",description:'"%"'},pe=/^[1-9]/,me={type:"class",value:"[1-9]",description:"[1-9]"},ye=/^[0-9]/,Se={type:"class",value:"[0-9]",description:"[0-9]"},be=function(e){return 1==e.length?Number(e):Number(e.join("").replace("%",""))},we="@",Ae={type:"literal",value:"@",description:'"@"'},Ce="TH",xe={type:"literal",value:"TH",description:'"TH"'},De=/^[12]/,ke={type:"class",value:"[12]",description:"[12]"},Re="AL",Ve={type:"literal",value:"AL",description:'"AL"'},Te="SP",Ie={type:"literal",value:"SP",description:'"SP"'},Ne=/^[1-3]/,Pe={type:"class",value:"[1-3]",description:"[1-3]"},Le="TB",Me={type:"literal",value:"TB",description:'"TB"'},Be="OH",He={type:"literal",value:"OH",description:'"OH"'},Ee=function(e){return e[1]?"@"==e[1]?"@@":e[1].join("").replace(",",""):"@"},Oe=function(e){return e},ze="+",Fe={type:"literal",value:"+",description:'"+"'},_e=function(e){return e[1]?"+"!=e[1]?Number(e[1].join("")):2:1},We="-",je={type:"literal",value:"-",description:'"-"'},qe=function(e){return e[1]?"-"!=e[1]?-Number(e[1].join("")):-2:-1},Ue="H",Xe={type:"literal",value:"H",description:'"H"'},Ge=function(e){return e[1]?Number(e[1]):1},Ye=":",Ke={type:"literal",value:":",description:'":"'},Ze=/^[0]/,$e={type:"class",value:"[0]",description:"[0]"},Je=function(e){return Number(e[1][0]+e[1][1].join(""))},Qe=function(e){return Number(e.join(""))},et=0,tt=0,rt=[{line:1,column:1,seenCR:!1}],it=0,nt=[],st=0;if("startRule"in x){if(!(x.startRule in k))throw new Error("Can't start parsing from rule \""+x.startRule+'".');R=k[x.startRule]}if((C=R())!==D&&et===t.length)return C;throw C!==D&&et<t.length&&n({type:"end",description:"end of input"}),s(null,nt,it<t.length?t.charAt(it):null,it<t.length?i(it,it+1):i(it,it))}return function(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}(e,Error),{SyntaxError:e,parse:t}}(),SmilesDrawer.Ring=function(){function e(t){_classCallCheck(this,e),this.id=null,this.members=t,this.edges=[],this.insiders=[],this.neighbours=[],this.positioned=!1,this.center=new SmilesDrawer.Vector2,this.rings=[],this.isBridged=!1,this.isPartOfBridged=!1,this.isSpiro=!1,this.isFused=!1,this.centralAngle=0,this.canFlip=!0}return _createClass(e,[{key:"clone",value:function(){var t=new e(this.members);return t.id=this.id,t.insiders=SmilesDrawer.ArrayHelper.clone(this.insiders),t.neighbours=SmilesDrawer.ArrayHelper.clone(this.neighbours),t.positioned=this.positioned,t.center=this.center.clone(),t.rings=SmilesDrawer.ArrayHelper.clone(this.rings),t.isBridged=this.isBridged,t.isPartOfBridged=this.isPartOfBridged,t.isSpiro=this.isSpiro,t.isFused=this.isFused,t.centralAngle=this.centralAngle,t.canFlip=this.canFlip,t}},{key:"allowsFlip",value:function(){return this.canFlip&&this.members.length>4}},{key:"setFlipped",value:function(){this.members.length<8&&(this.canFlip=!1)}},{key:"getSize",value:function(){return this.members.length}},{key:"getPolygon",value:function(e){for(var t=[],r=0;r<this.members.length;r++)t.push(e[this.members[r]].position);return t}},{key:"getAngle",value:function(){return Math.PI-this.centralAngle}},{key:"eachMember",value:function(e,t,r,i){r=r||0===r?r:this.members[0];for(var n=r,s=0;null!=n&&s<100;){var a=n;if(t(a),n=e[n].getNextInRing(e,this.id,i),i=a,n==r&&(n=null),99==s)throw console.log("Smiles-drawer was not able to loop over the members of this ring.",this),"Smiles-drawer was not able to loop over the members of this ring.";s++}}},{key:"getOrderedNeighbours",value:function(e){for(var t=[],r=0;r<this.neighbours.length;r++){var i=SmilesDrawer.RingConnection.getVertices(e,this.id,this.neighbours[r]);t.push({n:i.size,neighbour:this.neighbours[r]})}return t.sort(function(e,t){return t.n-e.n}),t}},{key:"isBenzeneLike",value:function(e){var t=this.getDoubleBondCount(e),r=this.members.length;return 3===t&&6===r||2===t&&5===r}},{key:"getDoubleBondCount",value:function(e){for(var t=0,r=0;r<this.members.length;r++){var i=e[this.members[r]].value;"="!==i.bondType&&"="!==i.branchBond||t++}return t}},{key:"contains",value:function(e){for(var t=0;t<this.members.length;t++)if(this.members[t]==e)return!0;return!1}},{key:"thisOrNeighboursContain",value:function(t,r){for(var i=0;i<this.neighbours.length;i++)if(e.getRing(t,this.neighbours[i]).contains(r))return!0;return!!this.contains(r)}}],[{key:"getRing",value:function(e,t){for(var r=0;r<e.length;r++)if(e[r].id==t)return e[r]}}]),e}(),SmilesDrawer.RingConnection=function(){function e(t,r){_classCallCheck(this,e),this.id=null,this.firstRingId=t.id,this.secondRingId=r.id,this.vertices=new Set;for(var i=0;i<t.members.length;i++)for(var n=t.members[i],s=0;s<r.members.length;s++){var a=r.members[s];n===a&&this.addVertex(n)}}return _createClass(e,[{key:"addVertex",value:function(e){this.vertices.add(e)}},{key:"isBridge",value:function(e){if(this.vertices.size>2)return!0;var t=!0,r=!1,i=void 0;try{for(var n,s=this.vertices[Symbol.iterator]();!(t=(n=s.next()).done);t=!0){if(e[n.value].value.rings.length>2)return!0}}catch(e){r=!0,i=e}finally{try{!t&&s.return&&s.return()}finally{if(r)throw i}}return!1}},{key:"updateOther",value:function(e,t){this.firstRingId===t?this.secondRingId=e:this.firstRingId=e}},{key:"containsRing",value:function(e){return this.firstRingId===e||this.secondRingId===e}}],[{key:"isBridge",value:function(e,t,r,i){for(var n=null,s=0;s<e.length;s++)if(n=e[s],n.firstRingId===r&&n.secondRingId===i||n.firstRingId===i&&n.secondRingId===r)return n.isBridge(t);return!1}},{key:"getNeighbours",value:function(e,t){for(var r=[],i=0;i<e.length;i++){var n=e[i];n.firstRingId===t?r.push(n.secondRingId):n.secondRingId===t&&r.push(n.firstRingId)}return r}},{key:"getVertices",value:function(e,t,r){for(var i=0;i<e.length;i++){var n=e[i];if(n.firstRingId===t&&n.secondRingId===r||n.firstRingId===r&&n.secondRingId===t)return[].concat(_toConsumableArray(n.vertices))}}}]),e}(),SmilesDrawer.SSSR=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getRings",value:function(e){var t=e.getComponentsAdjacencyMatrix();if(0===t.length)return null;for(var r=SmilesDrawer.Graph.getConnectedComponents(t),i=new Array,n=0;n<r.length;n++){for(var s=r[n],a=e.getSubgraphAdjacencyMatrix(s),o=Array(a.length),l=Array(a.length),h=0;h<a.length;h++){l[h]=0,o[h]=0;for(var u=0;u<a[h].length;u++)o[h]+=a[h][u]}for(var g=SmilesDrawer.SSSR.getEdgeList(a).length,c=g-a.length+1,v=!0,h=0;h<o.length;h++)3!==o[h]&&(v=!1);v&&(c=2+g-a.length);for(var d=SmilesDrawer.SSSR.getPathIncludedDistanceMatrices(a),f=d.d,p=d.pe,m=d.pe_prime,y=SmilesDrawer.SSSR.getRingCandidates(f,p,m),S=SmilesDrawer.SSSR.getSSSR(y,f,a,p,m,o,l,c),b=0;b<S.length;b++){var w=new Array(S[b].length),A=0,C=!0,x=!1,D=void 0;try{for(var k,R=S[b][Symbol.iterator]();!(C=(k=R.next()).done);C=!0){var V=k.value;w[A++]=s[V]}}catch(e){x=!0,D=e}finally{try{!C&&R.return&&R.return()}finally{if(x)throw D}}i.push(w)}}return i}},{key:"matrixToString",value:function(e){for(var t="",r=0;r<e.length;r++){for(var i=0;i<e[r].length;i++)t+=e[r][i]+" ";t+="\n"}return t}},{key:"getPathIncludedDistanceMatrices",value:function(e){for(var t=e.length,r=Array(t),i=Array(t),n=Array(t),s=0,a=0,o=0,l=0;l<t;l++){r[l]=Array(t),i[l]=Array(t),n[l]=Array(t);for(var h=0;h<t;h++)r[l][h]=l===h||1===e[l][h]?e[l][h]:Number.POSITIVE_INFINITY,1===r[l][h]?i[l][h]=[[[l,h]]]:i[l][h]=[],n[l][h]=[]}for(var u=0;u<t;u++)for(var g=0;g<t;g++)for(var c=0;c<t;c++){var v=r[g][c],d=r[g][u]+r[u][c];if(v>d){if(v===d+1)for(n[g][c]=[i[g][c].length],s=0;s<i[g][c].length;s++)for(n[g][c][s]=[i[g][c][s].length],a=0;a<i[g][c][s].length;a++)for(n[g][c][s][a]=[i[g][c][s][a].length],o=0;o<i[g][c][s][a].length;o++)n[g][c][s][a][o]=[i[g][c][s][a][0],i[g][c][s][a][1]];else n[g][c]=[];for(r[g][c]=d,i[g][c]=[[]],s=0;s<i[g][u][0].length;s++)i[g][c][0].push(i[g][u][0][s]);for(s=0;s<i[u][c][0].length;s++)i[g][c][0].push(i[u][c][0][s])}else if(v===d){if(i[g][u].length&&i[u][c].length)if(i[g][c].length){var f=[];for(s=0;s<i[g][u][0].length;s++)f.push(i[g][u][0][s]);for(s=0;s<i[u][c][0].length;s++)f.push(i[u][c][0][s]);i[g][c].push(f)}else{var p=[];for(s=0;s<i[g][u][0].length;s++)p.push(i[g][u][0][s]);for(s=0;s<i[u][c][0].length;s++)p.push(i[u][c][0][s]);i[g][c][0]=p}}else if(v===d-1)if(n[g][c].length){for(var m=[],s=0;s<i[g][u][0].length;s++)m.push(i[g][u][0][s]);for(var s=0;s<i[u][c][0].length;s++)m.push(i[u][c][0][s]);n[g][c].push(m)}else{for(var y=[],s=0;s<i[g][u][0].length;s++)y.push(i[g][u][0][s]);for(var s=0;s<i[u][c][0].length;s++)y.push(i[u][c][0][s]);n[g][c][0]=y}}return{d:r,pe:i,pe_prime:n}}},{key:"getRingCandidates",value:function(e,t,r){for(var i=e.length,n=[],s=0,a=0;a<i;a++)for(var o=0;o<i;o++)0===e[a][o]||1===t[a][o].length&&0===r[a][o]||(s=0!==r[a][o].length?2*(e[a][o]+.5):2*e[a][o])!==1/0&&n.push([s,t[a][o],r[a][o]]);return n.sort(function(e,t){return e[0]-t[0]}),n}},{key:"getSSSR",value:function(t,r,i,n,s,a,o,l){for(var h=[],u=[],g=0;g<t.length;g++)if(t[g][0]%2!=0)for(var c=0;c<t[g][2].length;c++){for(var v=t[g][1][0].concat(t[g][2][c]),d=0;d<v.length;d++)v[d][0].constructor===Array&&(v[d]=v[d][0]);var f=e.bondsToAtoms(v);if(e.getBondCount(f,i)!==f.size||e.pathSetsContain(h,f,v,u,a,o)||(h.push(f),u=u.concat(v)),h.length===l)return h}else for(var p=0;p<t[g][1].length-1;p++){for(var m=t[g][1][p].concat(t[g][1][p+1]),d=0;d<m.length;d++)m[d][0].constructor===Array&&(m[d]=m[d][0]);var y=e.bondsToAtoms(m);if(e.getBondCount(y,i)!==y.size||e.pathSetsContain(h,y,m,u,a,o)||(h.push(y),u=u.concat(m)),h.length===l)return h}return h}},{key:"getEdgeCount",value:function(e){for(var t=0,r=e.length,i=0;i<r-1;i++)for(var n=i+1;n<r;n++)1===e[i][n]&&t++;return t}},{key:"getEdgeList",value:function(e){for(var t=e.length,r=[],i=0;i<t-1;i++)for(var n=i+1;n<t;n++)1===e[i][n]&&r.push([i,n]);return r}},{key:"bondsToAtoms",value:function(e){for(var t=new Set,r=0;r<e.length;r++)t.add(e[r][0]),t.add(e[r][1]);return t}},{key:"getBondCount",value:function(e,t){var r=0,i=!0,n=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done);i=!0){var l=a.value,h=!0,u=!1,g=void 0;try{for(var c,v=e[Symbol.iterator]();!(h=(c=v.next()).done);h=!0){var d=c.value;l!==d&&(r+=t[l][d])}}catch(e){u=!0,g=e}finally{try{!h&&v.return&&v.return()}finally{if(u)throw g}}}}catch(e){n=!0,s=e}finally{try{!i&&o.return&&o.return()}finally{if(n)throw s}}return r/2}},{key:"pathSetsContain",value:function(t,r,i,n,s,a){for(var o=0;o<t.length;o++){if(e.isSupersetOf(r,t[o]))return!0;if(t[o].size===r.size&&e.areSetsEqual(t[o],r))return!0}for(var l=0,h=!1,u=0;u<i.length;u++)for(var g=0;g<n.length;g++)(i[u][0]===n[g][0]&&i[u][1]===n[g][1]||i[u][1]===n[g][0]&&i[u][0]===n[g][1])&&l++,l===i.length&&(h=!0);var c=!1;if(h){var v=!0,d=!1,f=void 0;try{for(var p,m=r[Symbol.iterator]();!(v=(p=m.next()).done);v=!0){var y=p.value;if(console.log(y,a[y],s[y]),a[y]<s[y]){c=!0;break}}}catch(e){d=!0,f=e}finally{try{!v&&m.return&&m.return()}finally{if(d)throw f}}}if(h&&!c)return!0;var S=!0,b=!1,w=void 0;try{for(var A,C=r[Symbol.iterator]();!(S=(A=C.next()).done);S=!0){a[A.value]++}}catch(e){b=!0,w=e}finally{try{!S&&C.return&&C.return()}finally{if(b)throw w}}return!1}},{key:"areSetsEqual",value:function(e,t){if(e.size!==t.size)return!1;var r=!0,i=!1,n=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var o=s.value;if(!t.has(o))return!1}}catch(e){i=!0,n=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw n}}return!0}},{key:"isSupersetOf",value:function(e,t){var r=!0,i=!1,n=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var o=s.value;if(!e.has(o))return!1}}catch(e){i=!0,n=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw n}}return!0}}]),e}(),SmilesDrawer.Vector2=function(){function e(t,r){_classCallCheck(this,e),0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=t.x,this.y=t.y):(this.x=t,this.y=r)}return _createClass(e,[{key:"clone",value:function(){return new SmilesDrawer.Vector2(this.x,this.y)}},{key:"toString",value:function(){return"("+this.x+","+this.y+")"}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"subtract",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"divide",value:function(e){return this.x/=e,this.y/=e,this}},{key:"multiply",value:function(e){return this.x*=e.x,this.y*=e.y,this}},{key:"multiplyScalar",value:function(e){return this.x*=e,this.y*=e,this}},{key:"invert",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(e){
return Math.sqrt((e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y))}},{key:"distanceSq",value:function(e){return(e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y)}},{key:"clockwise",value:function(e){var t=this.y*e.x,r=this.x*e.y;return t>r?-1:t===r?0:1}},{key:"rotate",value:function(e){var t=new SmilesDrawer.Vector2,r=Math.cos(e),i=Math.sin(e);return t.x=this.x*r-this.y*i,t.y=this.x*i+this.y*r,this.x=t.x,this.y=t.y,this}},{key:"rotateAround",value:function(e,t){var r=Math.sin(e),i=Math.cos(e);this.x-=t.x,this.y-=t.y;var n=this.x*i-this.y*r,s=this.x*r+this.y*i;return this.x=n+t.x,this.y=s+t.y,this}},{key:"rotateTo",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.x+=.001,this.y-=.001;var i=SmilesDrawer.Vector2.subtract(this,t),n=SmilesDrawer.Vector2.subtract(e,t),s=SmilesDrawer.Vector2.angle(n,i);return this.rotateAround(s+r,t),this}},{key:"rotateAwayFrom",value:function(e,t,r){this.rotateAround(r,t);var i=this.distanceSq(e);this.rotateAround(-2*r,t),this.distanceSq(e)<i&&this.rotateAround(2*r,t)}},{key:"getRotateAwayFromAngle",value:function(e,t,r){var i=this.clone();i.rotateAround(r,t);var n=i.distanceSq(e);return i.rotateAround(-2*r,t),i.distanceSq(e)<n?r:-r}},{key:"getRotateTowardsAngle",value:function(e,t,r){var i=this.clone();i.rotateAround(r,t);var n=i.distanceSq(e);return i.rotateAround(-2*r,t),i.distanceSq(e)>n?r:-r}},{key:"getRotateToAngle",value:function(e,t){var r=SmilesDrawer.Vector2.subtract(this,t),i=SmilesDrawer.Vector2.subtract(e,t),n=SmilesDrawer.Vector2.angle(i,r);return Number.isNaN(n)?0:n}},{key:"isInPolygon",value:function(e){for(var t=!1,r=0,i=e.length-1;r<e.length;i=r++)e[r].y>this.y!=e[i].y>this.y&&this.x<(e[i].x-e[r].x)*(this.y-e[r].y)/(e[i].y-e[r].y)+e[r].x&&(t=!t);return t}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"normalize",value:function(){return this.divide(this.length()),this}},{key:"normalized",value:function(){return SmilesDrawer.Vector2.divide(this,this.length())}},{key:"whichSide",value:function(e,t){return(this.x-e.x)*(t.y-e.y)-(this.y-e.y)*(t.x-e.x)}},{key:"sameSideAs",value:function(e,t,r){var i=this.whichSide(e,t),n=r.whichSide(e,t);return i<0&&n<0||0==i&&0==n||i>0&&n>0}}],[{key:"add",value:function(e,t){return new SmilesDrawer.Vector2(e.x+t.x,e.y+t.y)}},{key:"subtract",value:function(e,t){return new SmilesDrawer.Vector2(e.x-t.x,e.y-t.y)}},{key:"multiply",value:function(e,t){return new SmilesDrawer.Vector2(e.x*t.x,e.y*t.y)}},{key:"multiplyScalar",value:function(e,t){return new SmilesDrawer.Vector2(e).multiply(t)}},{key:"midpoint",value:function(e,t){return new SmilesDrawer.Vector2((e.x+t.x)/2,(e.y+t.y)/2)}},{key:"normals",value:function(e,t){var r=SmilesDrawer.Vector2.subtract(t,e);return[new SmilesDrawer.Vector2(-r.y,r.x),new SmilesDrawer.Vector2(r.y,-r.x)]}},{key:"units",value:function(e,t){var r=SmilesDrawer.Vector2.subtract(t,e);return[new SmilesDrawer.Vector2(-r.y,r.x).normalize(),new SmilesDrawer.Vector2(r.y,-r.x).normalize()]}},{key:"divide",value:function(e,t){return t.x&&t.y?new SmilesDrawer.Vector2(e.x/t.x,e.y/t.y):new SmilesDrawer.Vector2(e.x/t,e.y/t)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"angle",value:function(e,t){var r=SmilesDrawer.Vector2.dot(e,t);return Math.acos(r/(e.length()*t.length()))}},{key:"threePointangle",value:function(e,t,r){var i=SmilesDrawer.Vector2.subtract(t,e),n=SmilesDrawer.Vector2.subtract(r,t),s=e.distance(t),a=t.distance(r);return Math.acos(SmilesDrawer.Vector2.dot(i,n)/(s*a))}},{key:"scalarProjection",value:function(e,t){var r=t.normalized();return SmilesDrawer.Vector2.dot(e,r)}},{key:"averageDirection",value:function(e){for(var t=new SmilesDrawer.Vector2(0,0),r=0;r<e.length;r++){var i=e[r];t.add(i)}return t.normalize()}}]),e}(),SmilesDrawer.Vertex=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,e),this.id=null,this.value=t,this.position=new SmilesDrawer.Vector2(r||0,i||0),this.previousPosition=new SmilesDrawer.Vector2(0,0),this.parentVertexId=null,this.children=[],this.spanningTreeChildren=[],this.edges=[],this.positioned=!1,this.angle=0,this.globalAngle=0,this.dir=1,this.neighbourCount=0,this.neighbours=[],this.neighbouringElements=[]}return _createClass(e,[{key:"setPosition",value:function(e,t){this.position.x=e,this.position.y=t}},{key:"setPositionFromVector",value:function(e){this.position.x=e.x,this.position.y=e.y}},{key:"addChild",value:function(e){this.neighbourCount++,this.children.push(e),this.neighbours.push(e),this.value.bondCount++}},{key:"setParentVertexId",value:function(e){this.neighbourCount++,this.parentVertexId=e,this.neighbours.push(e),this.value.bondCount++}},{key:"isTerminal",value:function(){return!!this.value.hasAttachedPseudoElements||(null===this.parentVertexId&&this.children.length<2||0===this.children.length)}},{key:"clone",value:function(){var t=new e(this.value,this.position.x,this.position.y);return t.id=this.id,t.previousPosition=new SmilesDrawer.Vector2(this.previousPosition.x,this.previousPosition.y),t.parentVertexId=this.parentVertexId,t.children=SmilesDrawer.ArrayHelper.clone(this.children),t.spanningTreeChildren=SmilesDrawer.ArrayHelper.clone(this.spanningTreeChildren),t.edges=SmilesDrawer.ArrayHelper.clone(this.edges),t.positioned=this.positioned,t.angle=this.angle,t}},{key:"equals",value:function(e){return this.id===e.id}},{key:"getAngle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=null;return r=e?SmilesDrawer.Vector2.subtract(this.position,e):SmilesDrawer.Vector2.subtract(this.position,this.previousPosition),t?SmilesDrawer.MathHelper.toDeg(r.angle()):r.angle()}},{key:"getTextDirection",value:function(e){for(var t=this.getDrawnNeighbours(e),r=[],i=0;i<t.length;i++)r.push(this.getAngle(e[t[i]].position));var n=SmilesDrawer.MathHelper.meanAngle(r),s=Math.PI/2;return n=Math.round(Math.round(n/s)*s,3),2===n?"down":-2===n?"up":0===n||-0===n?"right":3===n||-3===n?"left":"down"}},{key:"getNeighbours",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null===e)return this.neighbours;for(var t=[],r=0;r<this.neighbours.length;r++)this.neighbours[r]!==e&&t.push(this.neighbours[r]);return t}},{key:"getDrawnNeighbours",value:function(e){for(var t=[],r=0;r<this.neighbours.length;r++)e[this.neighbours[r]].value.isDrawn&&t.push(this.neighbours[r]);return t}},{key:"getNeighbourCount",value:function(){return this.neighbourCount}},{key:"getCommonNeighbours",value:function(e){for(var t=new Array,r=this.getNeighbours(),i=e.getNeighbours(),n=0;n<r.length;n++)for(var s=0;s<i.length;s++)r[n]===i[s]&&t.push(r[n]);return t}},{key:"isNeighbour",value:function(e){if(this.parentVertexId===e)return!0;for(var t=0;t<this.children.length;t++)if(this.children[t]===e)return!0}},{key:"getSpanningTreeNeighbours",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=[],r=0;r<this.spanningTreeChildren.length;r++)void 0!==e&&e==this.spanningTreeChildren[r]||t.push(this.spanningTreeChildren[r]);return null!=this.parentVertexId&&(void 0!==e&&e==this.parentVertexId||t.push(this.parentVertexId)),t}},{key:"getNextInRing",value:function(e,t,r){for(var i=this.getNeighbours(),n=0;n<i.length;n++)if(SmilesDrawer.ArrayHelper.contains(e[i[n]].value.rings,{value:t})&&i[n]!=r)return i[n];return null}}]),e}();